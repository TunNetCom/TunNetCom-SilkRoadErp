# ============================================================
# Deploy SilkRoad API & WebApp to SocieteNizar Kubernetes
# ============================================================

pool:
  name: OnPremAgents
  demands:
    - Agent.Name -equals nizar-server

variables:
- group: silkroad-prod
- name: kubeNamespace
  value: silkroad-prod-societe
- name: deploymentApiName
  value: silkroad-api-societe
- name: deploymentWebappName
  value: silkroad-webapp-societe
- name: manifestPath
  value: src/deployments/societeNizar-deploy.yaml

stages:
- stage: Deploy
  displayName: Deploy to Nizar Soukra Kubernetes
  jobs:
  - job: DeployJob
    displayName: K8s Deployment
    steps:

    # --------------------------------------------------
    # 0ï¸âƒ£ Check Cluster Access
    # --------------------------------------------------
    - script: |
        echo "ğŸ” Checking cluster access"
        kubectl version --client
        kubectl cluster-info
      displayName: 'Check Kubernetes Cluster'

    # --------------------------------------------------
    # 1ï¸âƒ£ Ensure DB Connection Secret
    # --------------------------------------------------
    - script: |
        echo "ğŸ” Creating / Updating DB Secret (Societe Nizar)"

        kubectl create secret generic silkroad-connection-secret \
          -n $(kubeNamespace) \
          --from-literal=ConnectionStrings__DefaultConnection="$(Connection_String_SteNizar)" \
          --dry-run=client -o yaml | kubectl apply -f -
      displayName: 'Ensure DB Secret'

    - script: |
        echo "ğŸ‘¤ Running as user:"
        whoami

        echo "ğŸ“‚ Kubeconfig location:"
        ls -la ~/.kube || true

        echo "ğŸ“„ Kubeconfig content (safe):"
        kubectl config view --minify || true

        echo "ğŸ” Cluster access test:"
        kubectl get nodes -o wide
      displayName: 'Preflight: Kubernetes Access Check'


    # --------------------------------------------------
    # 2ï¸âƒ£ Apply Kubernetes Manifests
    # --------------------------------------------------
    - script: |
        echo "ğŸš€ Applying Kubernetes manifests"
        kubectl apply -f $(manifestPath)
      displayName: 'Apply Manifests'

    # --------------------------------------------------
    # 3ï¸âƒ£ Update Images
    # --------------------------------------------------
    - script: |
        echo "ğŸ”„ Updating images"

        kubectl set image deployment/$(deploymentApiName) \
          api=tunnetcom/silkroad:latest-api \
          -n $(kubeNamespace)

        kubectl set image deployment/$(deploymentWebappName) \
          webapp=tunnetcom/silkroad:latest-webapp \
          -n $(kubeNamespace)
      displayName: 'Update Images'

    # --------------------------------------------------
    # 4ï¸âƒ£ Force Rollout
    # --------------------------------------------------
    - script: |
        echo "ğŸ”„ Forcing rollout"

        kubectl rollout restart deployment/$(deploymentApiName) -n $(kubeNamespace)
        kubectl rollout restart deployment/$(deploymentWebappName) -n $(kubeNamespace)
      displayName: 'Force Rollout'

    # --------------------------------------------------
    # 5ï¸âƒ£ Wait for Rollout
    # --------------------------------------------------
    - script: |
        kubectl rollout status deployment/$(deploymentApiName) -n $(kubeNamespace) --timeout=300s
        kubectl rollout status deployment/$(deploymentWebappName) -n $(kubeNamespace) --timeout=300s
      displayName: 'Wait for Rollout'

    # --------------------------------------------------
    # 6ï¸âƒ£ Verify
    # --------------------------------------------------
    - script: |
        kubectl get pods -n $(kubeNamespace) -o wide
      displayName: 'Verify Deployment'
