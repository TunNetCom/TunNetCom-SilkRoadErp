
pool:
  name: Default   # your self-hosted agent

variables:
  kubeNamespace: nizar-prod
  kubeContext: onprem-k8s

  deploymentApiName: silkroad-api-nizar
  deploymentWebappName: silkroad-webapp-nizar

  manifestPath: src/deployments/prod-deployment-nizar.yaml

# ============================================================
# üß© STAGE: DEPLOY TO KUBERNETES
# ============================================================
stages:
- stage: Deploy
  displayName: Deploy to Nizar Kubernetes
  jobs:
  - job: DeployJob
    displayName: K8s Deployment
    steps:

    # ------------------------------------------------------------
    # 1Ô∏è‚É£ KUBECTL VERSION & CLUSTER INFO
    # ------------------------------------------------------------
    - script: |
        echo "üîç Cluster info"
        kubectl version --client
        kubectl cluster-info
      displayName: 'Check Kubernetes Cluster'

    # ------------------------------------------------------------
    # 2Ô∏è‚É£ FORCE ROLLOUT (DELETE OLD PODS)
    # ------------------------------------------------------------
    - script: |
        echo "üßπ Deleting old pods to force fresh image pull..."

        kubectl delete pods -n $(kubeNamespace) \
          -l app=silkroad-api-nizar --ignore-not-found

        kubectl delete pods -n $(kubeNamespace) \
          -l app=silkroad-webapp-nizar --ignore-not-found

        echo "‚è≥ Waiting for pod termination..."
        sleep 10
      displayName: 'Force Rollout'

    # ------------------------------------------------------------
    # 3Ô∏è‚É£ APPLY MANIFESTS
    # ------------------------------------------------------------
    - script: |
        echo "üöÄ Applying Nizar manifests..."
        ls -lah src/deployments
        kubectl apply -f $(manifestPath)
      displayName: 'Apply Kubernetes Manifests'

    # ------------------------------------------------------------
    # 4Ô∏è‚É£ WAIT FOR DEPLOYMENT ROLLOUT
    # ------------------------------------------------------------
    - script: |
        echo "‚è≥ Waiting for deployments to be ready..."

        kubectl rollout status deployment/$(deploymentApiName) \
          -n $(kubeNamespace) --timeout=180s

        kubectl rollout status deployment/$(deploymentWebappName) \
          -n $(kubeNamespace) --timeout=180s
      displayName: 'Wait for Rollout'

    # ------------------------------------------------------------
    # 5Ô∏è‚É£ VERIFY IMAGE PULL (SAFE & NON-BLOCKING)
    # ------------------------------------------------------------
    - script: |
        set +e
        echo "üîç Verifying pulled image digests..."

        for deploy in $(deploymentApiName) $(deploymentWebappName); do
          echo ""
          echo "üì¶ Deployment: $deploy"

          POD=$(kubectl get pods -n $(kubeNamespace) \
            --field-selector=status.phase=Running \
            -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)

          if [ -z "$POD" ]; then
            echo "‚ö†Ô∏è  No running pod found yet"
            kubectl get pods -n $(kubeNamespace)
            continue
          fi

          echo "Pod: $POD"
          kubectl describe pod $POD -n $(kubeNamespace) \
            | grep -A 6 "Image:"
        done
      displayName: 'Verify Image Pull'
      continueOnError: true

    # ------------------------------------------------------------
    # 6Ô∏è‚É£ FINAL STATUS
    # ------------------------------------------------------------
    - script: |
        echo "‚úÖ Deployment finished"
        kubectl get pods -n $(kubeNamespace)
        kubectl get svc -n $(kubeNamespace)
      displayName: 'Final Status'
