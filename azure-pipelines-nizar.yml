pool:
  name: OnPremAgents

variables:
  dockerRepository: 'tunnetcom/silkroad'
  apiTag: 'latest-api'
  webappTag: 'latest-webapp'
  kubeNamespace: 'silkroad-prod-nizar'
  deploymentApiName: 'silkroad-api-nizar'
  deploymentWebappName: 'silkroad-webapp-nizar'

stages:
# ============================================================
# DEPLOY STAGE TO ON-PREM KUBERNETES (NIZAR NAMESPACE)
# ============================================================
- stage: Deploy
  displayName: Deploy to Nizar Namespace
  jobs:
  - job: DeployJob
    displayName: Deploy SilkRoad to silkroad-prod-nizar
    pool:
      name: OnPremAgents
    steps:

    # 1Ô∏è‚É£ Debug manifests
    - script: |
        set -e
        cd $(Build.SourcesDirectory)/src/deployments
        echo "üìÇ Listing Nizar YAML files:"
        ls -l *nizar*.yaml
      displayName: 'Debug: list Nizar manifests'

    # 2Ô∏è‚É£ Create / Update DB Connection Secret
    - script: |
        set -e
        echo "üîê Creating / Updating DB connection secret in Nizar namespace"
        kubectl create secret generic silkroad-connection-secret \
          -n $(kubeNamespace) \
          --from-literal=ConnectionStrings__DefaultConnection="$(CONNECTION_STRING)" \
          --dry-run=client -o yaml | kubectl apply -f -
      displayName: 'Create DB Connection Secret'

    # 3Ô∏è‚É£ Apply manifests + FORCE fresh images
    - script: |
        set -e

        echo "üîç Cluster info"
        kubectl version --client
        kubectl cluster-info

        echo ""
        echo "üßπ Deleting old pods to force fresh image pull..."
        kubectl delete pods -n $(kubeNamespace) -l app=silkroad-api --ignore-not-found=true
        kubectl delete pods -n $(kubeNamespace) -l app=silkroad-webapp --ignore-not-found=true

        echo "‚è≥ Waiting for pod termination..."
        sleep 5

        echo ""
        echo "üöÄ Applying Nizar manifests..."
        kubectl apply -f prod-deployment-nizar.yaml -n $(kubeNamespace)
        kubectl apply -f prod-service-nizar.yaml -n $(kubeNamespace) || true

        echo ""
        echo "üîç Verifying deployment images:"
        kubectl get deployment $(deploymentApiName) -n $(kubeNamespace) \
          -o jsonpath='{.spec.template.spec.containers[0].image}'
        echo ""
        kubectl get deployment $(deploymentWebappName) -n $(kubeNamespace) \
          -o jsonpath='{.spec.template.spec.containers[0].image}'
        echo ""

        echo ""
        echo "‚è≥ Waiting for rollout..."
        kubectl rollout status deployment/$(deploymentApiName) -n $(kubeNamespace) --timeout=5m
        kubectl rollout status deployment/$(deploymentWebappName) -n $(kubeNamespace) --timeout=5m

        echo ""
        echo "üìä Final pod status:"
        kubectl get pods -n $(kubeNamespace) -o wide
      displayName: 'Deploy to Nizar K8s Namespace'

    # 4Ô∏è‚É£ Post-deploy verification (digest proof)
    - script: |
        set -e
        echo "üîç Verifying image digests..."

        for app in silkroad-api silkroad-webapp; do
          POD=$(kubectl get pods -n $(kubeNamespace) -l app=$app -o jsonpath='{.items[0].metadata.name}')
          echo ""
          echo "üì¶ Pod: $POD"
          kubectl describe pod $POD -n $(kubeNamespace) | grep -A 5 "Image:"
        done
      displayName: 'Verify Image Pull'
      continueOnError: true
