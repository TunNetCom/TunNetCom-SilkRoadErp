# ============================================================
# Deploy SilkRoad API & WebApp to On-Prem Kubernetes (Nizar)
# ============================================================
trigger: none
pr: none

pool:
  name: OnPremAgents

variables:
- group: silkroad-prod   # Contains Connection_String_Nizar
- name: kubeNamespace
  value: silkroad-prod-nizar
- name: deploymentApiName
  value: silkroad-api-nizar
- name: deploymentWebappName
  value: silkroad-webapp-nizar
- name: manifestPath
  value: src/deployments/prod-deployment-nizar.yaml

stages:
- stage: Deploy
  displayName: Deploy to Nizar Kubernetes
  jobs:
  - job: DeployJob
    displayName: K8s Deployment
    steps:

    # --------------------------------------------------
    # 0Ô∏è‚É£ Check Cluster Access
    # --------------------------------------------------
    - script: |
        echo "üîç Checking cluster access"
        kubectl version --client
        kubectl cluster-info
      displayName: 'Check Kubernetes Cluster'

    # --------------------------------------------------
    # 1Ô∏è‚É£ Ensure DB Connection Secret
    # --------------------------------------------------
    - script: |
        echo "üîê Ensuring DB connection secret exists"

        if [ -z "$Connection_String_Nizar" ]; then
          echo "‚ùå Connection_String_Nizar is EMPTY"
          exit 1
        fi

        kubectl create secret generic silkroad-connection-secret \
          -n $(kubeNamespace) \
          --from-literal=ConnectionStrings__DefaultConnection="$Connection_String_Nizar" \
          --dry-run=client -o yaml | kubectl apply -f -

        echo "‚úÖ DB secret ensured"
      displayName: 'Ensure DB Secret'
      env:
        Connection_String_Nizar: $(Connection_String_Nizar)

    # --------------------------------------------------
    # 2Ô∏è‚É£ Apply Kubernetes Manifests
    # --------------------------------------------------
    - script: |
        echo "üöÄ Applying Kubernetes manifests"
        kubectl apply -f $(manifestPath)
        echo "‚úÖ Manifests applied"
      displayName: 'Apply Manifests'

    # --------------------------------------------------
    # 3Ô∏è‚É£ Update Deployment Images to Latest Tags
    # --------------------------------------------------
    - script: |
        echo "üîÑ Updating deployment images to latest tags (this forces fresh image pull)..."
        
        echo "üìù Setting API image to: tunnetcom/silkroad:latest-api"
        kubectl set image deployment/$(deploymentApiName) \
          api=tunnetcom/silkroad:latest-api \
          -n $(kubeNamespace)
        
        echo "üìù Setting WebApp image to: tunnetcom/silkroad:latest-webapp"
        kubectl set image deployment/$(deploymentWebappName) \
          webapp=tunnetcom/silkroad:latest-webapp \
          -n $(kubeNamespace)
        
        echo "‚úÖ Image tags updated in deployments"
        
        # Verify the changes
        echo ""
        echo "=== Verification: Current Deployment Images ==="
        kubectl get deployment $(deploymentApiName) -n $(kubeNamespace) -o jsonpath='{.spec.template.spec.containers[0].image}' && echo ""
        kubectl get deployment $(deploymentWebappName) -n $(kubeNamespace) -o jsonpath='{.spec.template.spec.containers[0].image}' && echo ""
      displayName: 'Update Deployment Images'

    # --------------------------------------------------
    # 4Ô∏è‚É£ Force Image Refresh (CRITICAL STEP)
    # --------------------------------------------------
    - script: |
        echo "üîÑ Forcing rollout to pull latest images"
        
        # Method 1: Use kubectl rollout restart (most reliable)
        echo "üîÑ Restarting API deployment..."
        kubectl rollout restart deployment/$(deploymentApiName) -n $(kubeNamespace)
        
        echo "üîÑ Restarting WebApp deployment..."
        kubectl rollout restart deployment/$(deploymentWebappName) -n $(kubeNamespace)
        
        # Method 2: Also patch with unique annotation to force pod template change
        TIMESTAMP=$(date +%s)
        echo "üìù Patching deployments with build annotations (BuildId: $(Build.BuildId), Timestamp: $TIMESTAMP)"
        
        kubectl patch deployment $(deploymentApiName) \
          -n $(kubeNamespace) \
          -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"ci-build\":\"$(Build.BuildId)\",\"force-image-pull\":\"$(Build.BuildId)-$TIMESTAMP\",\"deployment.kubernetes.io/revision\":null}}}}}"
        
        kubectl patch deployment $(deploymentWebappName) \
          -n $(kubeNamespace) \
          -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"ci-build\":\"$(Build.BuildId)\",\"force-image-pull\":\"$(Build.BuildId)-$TIMESTAMP\",\"deployment.kubernetes.io/revision\":null}}}}}"
        
        # Method 3: Delete existing pods to ensure fresh start
        echo "üóëÔ∏è  Deleting existing pods to force fresh image pull..."
        kubectl delete pods -n $(kubeNamespace) -l app=silkroad-api-nizar --ignore-not-found=true || true
        kubectl delete pods -n $(kubeNamespace) -l app=silkroad-webapp-nizar --ignore-not-found=true || true

        echo "‚è≥ Waiting for pods to start terminating..."
        sleep 10
      displayName: 'Force Image Refresh'

    # --------------------------------------------------
    # 5Ô∏è‚É£ Wait for Rollout Completion
    # --------------------------------------------------
    - script: |
        echo "‚è≥ Waiting for API rollout to complete..."
        kubectl rollout status deployment/$(deploymentApiName) \
          -n $(kubeNamespace) --timeout=300s
        
        if [ $? -eq 0 ]; then
          echo "‚úÖ API rollout completed successfully"
        else
          echo "‚ùå API rollout failed or timed out"
          echo "Checking rollout history..."
          kubectl rollout history deployment/$(deploymentApiName) -n $(kubeNamespace)
          exit 1
        fi

        echo ""
        echo "‚è≥ Waiting for WebApp rollout to complete..."
        kubectl rollout status deployment/$(deploymentWebappName) \
          -n $(kubeNamespace) --timeout=300s
        
        if [ $? -eq 0 ]; then
          echo "‚úÖ WebApp rollout completed successfully"
        else
          echo "‚ùå WebApp rollout failed or timed out"
          echo "Checking rollout history..."
          kubectl rollout history deployment/$(deploymentWebappName) -n $(kubeNamespace)
          exit 1
        fi
        
        echo ""
        echo "‚è≥ Waiting additional 10 seconds for pods to fully initialize..."
        sleep 10
      displayName: 'Wait for Rollout'

    # --------------------------------------------------
    # 6Ô∏è‚É£ Check for Image Pull Errors
    # --------------------------------------------------
    - script: |
        echo "üîç Checking for image pull errors..."
        echo ""
        echo "=== Recent Events (last 20) ==="
        kubectl get events -n $(kubeNamespace) --sort-by='.lastTimestamp' | tail -20
        
        echo ""
        echo "=== API Pod Events ==="
        API_POD=$(kubectl get pods -n $(kubeNamespace) -l app=silkroad-api-nizar -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        if [ -n "$API_POD" ]; then
          kubectl describe pod $API_POD -n $(kubeNamespace) | grep -A 10 "Events:" || echo "No events found"
        fi
        
        echo ""
        echo "=== WebApp Pod Events ==="
        WEBAPP_POD=$(kubectl get pods -n $(kubeNamespace) -l app=silkroad-webapp-nizar -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        if [ -n "$WEBAPP_POD" ]; then
          kubectl describe pod $WEBAPP_POD -n $(kubeNamespace) | grep -A 10 "Events:" || echo "No events found"
        fi
      displayName: 'Check Image Pull Errors'
      continueOnError: true

    # --------------------------------------------------
    # 7Ô∏è‚É£ Verify Image Pull and Deployment
    # --------------------------------------------------
    - script: |
        echo "üîç Verifying deployed images and pod status"
        echo ""
        echo "=== Current Pod Status ==="
        kubectl get pods -n $(kubeNamespace) -o wide
        
        echo ""
        echo "=== API Deployment Details ==="
        API_POD=$(kubectl get pods -n $(kubeNamespace) -l app=silkroad-api-nizar -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        if [ -n "$API_POD" ]; then
          echo "Pod Name: $API_POD"
          echo "Image: $(kubectl get pod $API_POD -n $(kubeNamespace) -o jsonpath='{.spec.containers[0].image}')"
          echo "Image Pull Policy: $(kubectl get pod $API_POD -n $(kubeNamespace) -o jsonpath='{.spec.containers[0].imagePullPolicy}')"
          echo "Image ID: $(kubectl get pod $API_POD -n $(kubeNamespace) -o jsonpath='{.status.containerStatuses[0].imageID}')"
          echo "Pod Status: $(kubectl get pod $API_POD -n $(kubeNamespace) -o jsonpath='{.status.phase}')"
          echo "Ready: $(kubectl get pod $API_POD -n $(kubeNamespace) -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}')"
          echo "Created: $(kubectl get pod $API_POD -n $(kubeNamespace) -o jsonpath='{.metadata.creationTimestamp}')"
          echo ""
        else
          echo "‚ùå No API pod found!"
        fi

        echo "=== WebApp Deployment Details ==="
        WEBAPP_POD=$(kubectl get pods -n $(kubeNamespace) -l app=silkroad-webapp-nizar -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        if [ -n "$WEBAPP_POD" ]; then
          echo "Pod Name: $WEBAPP_POD"
          echo "Image: $(kubectl get pod $WEBAPP_POD -n $(kubeNamespace) -o jsonpath='{.spec.containers[0].image}')"
          echo "Image Pull Policy: $(kubectl get pod $WEBAPP_POD -n $(kubeNamespace) -o jsonpath='{.spec.containers[0].imagePullPolicy}')"
          echo "Image ID: $(kubectl get pod $WEBAPP_POD -n $(kubeNamespace) -o jsonpath='{.status.containerStatuses[0].imageID}')"
          echo "Pod Status: $(kubectl get pod $WEBAPP_POD -n $(kubeNamespace) -o jsonpath='{.status.phase}')"
          echo "Ready: $(kubectl get pod $WEBAPP_POD -n $(kubeNamespace) -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}')"
          echo "Created: $(kubectl get pod $WEBAPP_POD -n $(kubeNamespace) -o jsonpath='{.metadata.creationTimestamp}')"
          echo ""
        else
          echo "‚ùå No WebApp pod found!"
        fi
        
        echo "=== Deployment Annotations ==="
        echo "API Deployment Annotations:"
        kubectl get deployment $(deploymentApiName) -n $(kubeNamespace) -o jsonpath='{.spec.template.metadata.annotations}' || echo "Could not get annotations"
        echo ""
        echo "WebApp Deployment Annotations:"
        kubectl get deployment $(deploymentWebappName) -n $(kubeNamespace) -o jsonpath='{.spec.template.metadata.annotations}' || echo "Could not get annotations"
      displayName: 'Verify Image Pull'
      continueOnError: true

    # --------------------------------------------------
    # 8Ô∏è‚É£ Final Status
    # --------------------------------------------------
    - script: |
        echo "‚úÖ Deployment completed successfully"
        kubectl get all -n $(kubeNamespace)
      displayName: 'Final Status'
