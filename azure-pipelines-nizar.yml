pool:
  name: OnPremAgents

variables:
  dockerRepository: 'tunnetcom/silkroad'
  apiTag: 'latest-api'
  webappTag: 'latest-webapp'
  kubeNamespace: 'silkroad-prod-nizar'
  deploymentApiName: 'silkroad-api-nizar'
  deploymentWebappName: 'silkroad-webapp-nizar'

stages:
# ============================================================
# DEPLOY STAGE TO ON-PREM KUBERNETES (NIZAR NAMESPACE)
# ============================================================
- stage: Deploy
  displayName: Deploy to Nizar Namespace
  jobs:
  - job: DeployJob
    displayName: Deploy SilkRoad to silkroad-prod-nizar
    steps:

    # 1Ô∏è‚É£ Debug manifests
    - script: |
        cd $(Build.SourcesDirectory)/src/deployments || { echo '‚ùå Deployment folder not found'; exit 1; }
        echo "üìÇ Listing Nizar YAML files:"
        ls -l *nizar*.yaml
      displayName: 'Debug: list Nizar manifests'

    # 2Ô∏è‚É£ Create / Update DB Connection Secret
    - script: |
        echo "üîê Creating / Updating DB connection secret in Nizar namespace"
        kubectl create secret generic silkroad-connection-secret \
          -n $(kubeNamespace) \
          --from-literal=ConnectionStrings__DefaultConnection="$(CONNECTION_STRING)" \
          --dry-run=client -o yaml | kubectl apply -f -
      displayName: 'Create DB Connection Secret'

    # 3Ô∏è‚É£ Apply manifests & rollout
    - script: |
        kubectl version --client
        kubectl cluster-info

        echo "üöÄ Applying Nizar manifests..."
        kubectl apply -f prod-configmap-nizar.yaml -n $(kubeNamespace)
        kubectl apply -f prod-deployment-nizar.yaml -n $(kubeNamespace)
        kubectl apply -f prod-service-nizar.yaml -n $(kubeNamespace)  || true
        kubectl apply -f prod-ingress-nizar.yaml -n $(kubeNamespace)  || true

        echo "üîÅ Forcing rollout for Nizar..."
        kubectl rollout restart deployment/$(deploymentApiName) -n $(kubeNamespace)  || true
        kubectl rollout restart deployment/$(deploymentWebappName) -n $(kubeNamespace)  || true

        echo "‚è≥ Waiting for Nizar rollout..."
        kubectl rollout status deployment/$(deploymentApiName) -n $(kubeNamespace) --timeout=5m || { echo '‚ùå API rollout failed'; exit 1; }
        kubectl rollout status deployment/$(deploymentWebappName) -n $(kubeNamespace) --timeout=5m || { echo '‚ùå WebApp rollout failed'; exit 1; }

        echo "‚úÖ Successfully deployed SilkRoad to Nizar namespace: $(kubeNamespace)"
        echo "üìä Showing deployment status:"
        kubectl get pods -n $(kubeNamespace)
        kubectl get svc -n $(kubeNamespace)
        kubectl get ingress -n $(kubeNamespace)
      displayName: Deploy to Nizar K8s Namespace
