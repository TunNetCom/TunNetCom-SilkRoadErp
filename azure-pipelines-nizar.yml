pool:
  name: OnPremAgents

variables:
  dockerRepository: 'tunnetcom/silkroad'
  apiTag: 'latest-api'
  webappTag: 'latest-webapp'
  kubeNamespace: 'silkroad-prod-nizar'
  deploymentApiName: 'silkroad-api-nizar'
  deploymentWebappName: 'silkroad-webapp-nizar'

stages:
# ============================================================
# DEPLOY STAGE TO ON-PREM KUBERNETES (NIZAR NAMESPACE)
# ============================================================
- stage: Deploy
  displayName: Deploy to Nizar Namespace
  jobs:
  - job: DeployJob
    displayName: Deploy SilkRoad to silkroad-prod-nizar
    steps:

    # 1ï¸âƒ£ Debug manifests
    - script: |
        cd $(Build.SourcesDirectory)/src/deployments || { echo 'âŒ Deployment folder not found'; exit 1; }
        echo "ðŸ“‚ Listing Nizar YAML files:"
        ls -l *nizar*.yaml
      displayName: 'Debug: list Nizar manifests'

    # 2ï¸âƒ£ Create / Update DB Connection Secret
    - script: |
        echo "ðŸ” Creating / Updating DB connection secret in Nizar namespace"
        kubectl create secret generic silkroad-connection-secret \
          -n $(kubeNamespace) \
          --from-literal=ConnectionStrings__DefaultConnection="$(CONNECTION_STRING)" \
          --dry-run=client -o yaml | kubectl apply -f -
      displayName: 'Create DB Connection Secret'

    # 3ï¸âƒ£ Apply manifests & rollout
    - script: |
        kubectl version --client
        kubectl cluster-info

        echo "ðŸš€ Applying Nizar manifests..."
        kubectl apply -f prod-configmap-nizar.yaml -n $(kubeNamespace)
        kubectl apply -f prod-deployment-nizar.yaml -n $(kubeNamespace)
        kubectl apply -f prod-service-nizar.yaml -n $(kubeNamespace)  || true
        kubectl apply -f prod-ingress-nizar.yaml -n $(kubeNamespace)  || true

        echo "ðŸ”„ Forcing image refresh by patching deployment annotations..."
        kubectl patch deployment $(deploymentApiName) \
          -n $(kubeNamespace) \
          -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"ci-build\":\"$(Build.BuildId)\",\"force-image-pull\":\"$(Build.BuildId)-$(date +%s)\"}}}}}" || true

        kubectl patch deployment $(deploymentWebappName) \
          -n $(kubeNamespace) \
          -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"ci-build\":\"$(Build.BuildId)\",\"force-image-pull\":\"$(Build.BuildId)-$(date +%s)\"}}}}}" || true

        echo "ðŸ—‘ï¸  Deleting existing pods to force fresh image pull..."
        kubectl delete pods -n $(kubeNamespace) -l app=silkroad-api-nizar --ignore-not-found=true || true
        kubectl delete pods -n $(kubeNamespace) -l app=silkroad-webapp-nizar --ignore-not-found=true || true

        echo "â³ Waiting for pods to be recreated and ready..."
        sleep 10

        echo "â³ Waiting for Nizar rollout..."
        kubectl rollout status deployment/$(deploymentApiName) -n $(kubeNamespace) --timeout=5m || { echo 'âŒ API rollout failed'; exit 1; }
        kubectl rollout status deployment/$(deploymentWebappName) -n $(kubeNamespace) --timeout=5m || { echo 'âŒ WebApp rollout failed'; exit 1; }

        echo "ðŸ” Verifying image digests..."
        echo "=== API Pod Image ==="
        API_POD=$(kubectl get pods -n $(kubeNamespace) -l app=silkroad-api-nizar -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        if [ -n "$API_POD" ]; then
          kubectl get pod $API_POD -n $(kubeNamespace) -o jsonpath='{.status.containerStatuses[0].imageID}' || echo "Could not get image ID"
          echo ""
        fi

        echo "=== WebApp Pod Image ==="
        WEBAPP_POD=$(kubectl get pods -n $(kubeNamespace) -l app=silkroad-webapp-nizar -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        if [ -n "$WEBAPP_POD" ]; then
          kubectl get pod $WEBAPP_POD -n $(kubeNamespace) -o jsonpath='{.status.containerStatuses[0].imageID}' || echo "Could not get image ID"
          echo ""
        fi

        echo "âœ… Successfully deployed SilkRoad to Nizar namespace: $(kubeNamespace)"
        echo "ðŸ“Š Showing deployment status:"
        kubectl get pods -n $(kubeNamespace)
        kubectl get svc -n $(kubeNamespace)
        kubectl get ingress -n $(kubeNamespace)
      displayName: Deploy to Nizar K8s Namespace
