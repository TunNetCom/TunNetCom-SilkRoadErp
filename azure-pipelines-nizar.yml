trigger:
- master

pool:
  name: OnPremAgents

variables:
  dockerRepository: 'tunnetcom/silkroad'
  apiTag: 'latest-api'
  webappTag: 'latest-webapp'
  kubeNamespace: 'silkroad-prod-nizar'
  deploymentApiName: 'silkroad-api-nizar'
  deploymentWebappName: 'silkroad-webapp-nizar'

stages:
# ============================================================
# DEPLOY STAGE TO ON-PREM KUBERNETES (NIZAR NAMESPACE)
# ============================================================
- stage: Deploy
  displayName: Deploy to Nizar Namespace
  jobs:
  - job: DeployJob
    displayName: Deploy SilkRoad to silkroad-prod-nizar

    steps:
    - script: |
        echo "ğŸ“ Navigating to deployment manifests..."
        cd $(Build.SourcesDirectory)/src/deployments || { echo 'âŒ Deployment folder not found'; exit 1; }

        echo "ğŸ“‚ Listing Nizar YAML files:"
        ls -l *nizar*.yaml

        echo "ğŸ” Checking cluster access..."
        kubectl version --client || { echo 'âŒ kubectl missing'; exit 1; }
        kubectl cluster-info || { echo 'âŒ cluster unreachable'; exit 1; }

        echo "âœ… Cluster accessible. Proceeding with Nizar deployment..."

        echo "ğŸš€ Applying Nizar manifests..."
        kubectl apply -f prod-configmap-nizar.yaml -n $(kubeNamespace)
        kubectl apply -f prod-deployment-nizar.yaml -n $(kubeNamespace)
        kubectl apply -f prod-service-nizar.yaml -n $(kubeNamespace)  || true
        kubectl apply -f prod-ingress-nizar.yaml -n $(kubeNamespace)  || true

        echo "ğŸ” Forcing rollout for Nizar..."
        kubectl rollout restart deployment/$(deploymentApiName) -n $(kubeNamespace)  || true
        kubectl rollout restart deployment/$(deploymentWebappName) -n $(kubeNamespace)  || true

        echo "â³ Waiting for Nizar rollout..."
        kubectl rollout status deployment/$(deploymentApiName) -n $(kubeNamespace) --timeout=5m || { echo 'âŒ API rollout failed'; exit 1; }
        kubectl rollout status deployment/$(deploymentWebappName) -n $(kubeNamespace) --timeout=5m || { echo 'âŒ WebApp rollout failed'; exit 1; }

        echo "âœ… Successfully deployed SilkRoad to Nizar namespace: $(kubeNamespace)"
        
        echo "ğŸ“Š Showing deployment status:"
        kubectl get pods -n $(kubeNamespace)
        kubectl get svc -n $(kubeNamespace)
        kubectl get ingress -n $(kubeNamespace)
      displayName: Deploy to Nizar K8s Namespace