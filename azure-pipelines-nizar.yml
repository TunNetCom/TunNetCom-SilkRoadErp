

pool:
  name: OnPremAgents

variables:
  kubeNamespace: silkroad-prod-nizar

  deploymentApiName: silkroad-api-nizar
  deploymentWebappName: silkroad-webapp-nizar

  manifestPath: src/deployments/prod-deployment-nizar.yaml

stages:
- stage: Deploy
  displayName: Deploy to Nizar Kubernetes
  jobs:
  - job: DeployJob
    displayName: K8s Deployment
    steps:

    - script: |
        echo "üîç Cluster info"
        kubectl version --client
        kubectl cluster-info
      displayName: 'Check Kubernetes Cluster'

    - script: |
        echo "üßπ Forcing rollout by deleting pods"

        kubectl delete pods -n $(kubeNamespace) \
          -l app=silkroad-api-nizar --ignore-not-found

        kubectl delete pods -n $(kubeNamespace) \
          -l app=silkroad-webapp-nizar --ignore-not-found

        sleep 10
      displayName: 'Force Rollout'

    - script: |
        echo "üöÄ Applying manifests"
        ls -lah src/deployments
        kubectl apply -f $(manifestPath)
      displayName: 'Apply Manifests'

    - script: |
        echo "‚è≥ Waiting for rollout"

        kubectl rollout status deployment/$(deploymentApiName) \
          -n $(kubeNamespace) --timeout=180s

        kubectl rollout status deployment/$(deploymentWebappName) \
          -n $(kubeNamespace) --timeout=180s
      displayName: 'Wait for Rollout'

    - script: |
        echo "üîç Verifying images"
        kubectl get pods -n $(kubeNamespace) -o wide
        kubectl describe pod -n $(kubeNamespace) | grep -A 5 Image
      displayName: 'Verify Image Pull'
      continueOnError: true

    - script: |
        echo "‚úÖ Deployment complete"
        kubectl get all -n $(kubeNamespace)
      displayName: 'Final Status'
