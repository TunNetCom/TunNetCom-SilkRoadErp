pool:
  name: OnPremAgents

variables:
  dockerRepository: 'tunnetcom/silkroad'
  apiTag: 'latest-api'
  webappTag: 'latest-webapp'
  kubeNamespace: 'silkroad-prod-nizar'
  deploymentApiName: 'silkroad-api-nizar'
  deploymentWebappName: 'silkroad-webapp-nizar'

stages:
# ============================================================
# DEPLOY STAGE TO ON-PREM KUBERNETES (NIZAR)
# ============================================================
- stage: Deploy
  displayName: Deploy to Nizar Namespace
  jobs:
  - job: DeployJob
    displayName: Deploy SilkRoad to silkroad-prod-nizar
    steps:

    # ============================================================
    # 1Ô∏è‚É£ DEBUG & VERIFY FILES
    # ============================================================
    - script: |
        set -e
        echo "üìÇ Build sources directory:"
        echo "$(Build.SourcesDirectory)"

        echo ""
        echo "üìÇ Moving to deployment directory..."
        cd $(Build.SourcesDirectory)/src/deployments || {
          echo "‚ùå src/deployments directory not found"
          exit 1
        }

        echo ""
        echo "üìÑ Listing Nizar deployment files:"
        ls -la prod-*-nizar.yaml
      displayName: 'Debug: verify Nizar manifests'

    # ============================================================
    # 2Ô∏è‚É£ CREATE / UPDATE DB SECRET
    # ============================================================
    - script: |
        set -e
        echo "üîê Creating / updating DB connection secret..."
        kubectl create secret generic silkroad-connection-secret \
          -n $(kubeNamespace) \
          --from-literal=ConnectionStrings__DefaultConnection="$(CONNECTION_STRING)" \
          --dry-run=client -o yaml | kubectl apply -f -
      displayName: 'Create DB Connection Secret'

    # ============================================================
    # 3Ô∏è‚É£ APPLY MANIFESTS & FORCE IMAGE RE-PULL
    # ============================================================
    - script: |
        set -e

        echo "üìÇ Switching to deployment directory..."
        cd $(Build.SourcesDirectory)/src/deployments

        echo ""
        echo "üîç Kubernetes cluster info"
        kubectl version --client
        kubectl cluster-info

        echo ""
        echo "üßπ Deleting existing pods to force fresh image pull..."
        kubectl delete pods -n $(kubeNamespace) -l app=silkroad-api --ignore-not-found=true
        kubectl delete pods -n $(kubeNamespace) -l app=silkroad-webapp --ignore-not-found=true

        echo "‚è≥ Waiting for pod termination..."
        sleep 5

        echo ""
        echo "üöÄ Applying Nizar Kubernetes manifests..."
        kubectl apply -f prod-deployment-nizar.yaml -n $(kubeNamespace)
        kubectl apply -f prod-service-nizar.yaml -n $(kubeNamespace) || true

        echo ""
        echo "üîç Verifying deployment image references:"
        echo "API image:"
        kubectl get deployment $(deploymentApiName) -n $(kubeNamespace) \
          -o jsonpath='{.spec.template.spec.containers[0].image}'
        echo ""
        echo "WebApp image:"
        kubectl get deployment $(deploymentWebappName) -n $(kubeNamespace) \
          -o jsonpath='{.spec.template.spec.containers[0].image}'
        echo ""

        echo ""
        echo "‚è≥ Waiting for rollout to complete..."
        kubectl rollout status deployment/$(deploymentApiName) -n $(kubeNamespace) --timeout=5m
        kubectl rollout status deployment/$(deploymentWebappName) -n $(kubeNamespace) --timeout=5m

        echo ""
        echo "üìä Current pod status:"
        kubectl get pods -n $(kubeNamespace) -o wide
      displayName: 'Deploy to Nizar Kubernetes Namespace'

    # ============================================================
    # 4Ô∏è‚É£ POST-DEPLOY IMAGE DIGEST VERIFICATION
    # ============================================================
    - script: |
        set -e
        echo "üîç Verifying pulled image digests..."

        for app in silkroad-api silkroad-webapp; do
          POD=$(kubectl get pods -n $(kubeNamespace) -l app=$app -o jsonpath='{.items[0].metadata.name}')
          echo ""
          echo "üì¶ Pod: $POD"
          kubectl describe pod $POD -n $(kubeNamespace) | grep -A 6 "Image:"
        done
      displayName: 'Verify Image Pull'
      continueOnError: true
