# ============================================================
# Deploy SilkRoad API & WebApp to On-Prem Kubernetes (Nizar)
# ============================================================

pool:
  name: OnPremAgents

variables:
- group: silkroad-prod   # <-- the variable group where Connection_String_Nizar is defined
- name: kubeNamespace
  value: silkroad-prod-nizar
- name: deploymentApiName
  value: silkroad-api-nizar
- name: deploymentWebappName
  value: silkroad-webapp-nizar
- name: manifestPath
  value: src/deployments/prod-deployment-nizar.yaml


stages:
- stage: Deploy
  displayName: Deploy to Nizar Kubernetes
  jobs:
  - job: DeployJob
    displayName: K8s Deployment
    steps:

    # -----------------------------
    # 0ï¸âƒ£ Check Cluster Info
    # -----------------------------
    - script: |
        echo "ðŸ” Cluster info"
        kubectl version --client
        kubectl cluster-info
      displayName: 'Check Kubernetes Cluster'

    # -----------------------------
    # 1ï¸âƒ£ Ensure DB Secret
    # -----------------------------
    - script: |
        echo "ðŸ” Ensuring DB connection secret exists"

        if [ -z "$Connection_String_Nizar" ]; then
          echo "âŒ Connection_String_Nizar is EMPTY"
          exit 1
        fi

        kubectl create secret generic silkroad-connection-secret \
          -n $(kubeNamespace) \
          --from-literal=ConnectionStrings__DefaultConnection="$Connection_String_Nizar" \
          --dry-run=client -o yaml | kubectl apply -f -

        echo "âœ… DB secret ensured"
      displayName: 'Ensure DB Secret'
      env:
        Connection_String_Nizar: $(Connection_String_Nizar)

    # -----------------------------
    # 2ï¸âƒ£ Force Rollout by Deleting Old Pods
    # -----------------------------
    - script: |
        echo "ðŸ§¹ Forcing rollout by deleting pods"

        kubectl delete pods -n $(kubeNamespace) \
          -l app=$(deploymentApiName) --ignore-not-found

        kubectl delete pods -n $(kubeNamespace) \
          -l app=$(deploymentWebappName) --ignore-not-found

        sleep 10
      displayName: 'Force Rollout'

    # -----------------------------
    # 3ï¸âƒ£ Apply Kubernetes Manifests
    # -----------------------------
    - script: |
        echo "ðŸš€ Applying manifests"
        ls -lah $(manifestPath)
        kubectl apply -f $(manifestPath)
      displayName: 'Apply Manifests'

    # -----------------------------
    # 4ï¸âƒ£ Wait for Deployment Rollout
    # -----------------------------
    - script: |
        echo "â³ Waiting for rollout"
        kubectl rollout status deployment/$(deploymentApiName) \
          -n $(kubeNamespace) --timeout=180s

        kubectl rollout status deployment/$(deploymentWebappName) \
          -n $(kubeNamespace) --timeout=180s
      displayName: 'Wait for Rollout'

    # -----------------------------
    # 5ï¸âƒ£ Verify Images
    # -----------------------------
    - script: |
        echo "ðŸ” Verifying images"
        kubectl get pods -n $(kubeNamespace) -o wide
        kubectl describe pod -n $(kubeNamespace) | grep -A 5 Image
      displayName: 'Verify Image Pull'
      continueOnError: true

    # -----------------------------
    # 6ï¸âƒ£ Final Status
    # -----------------------------
    - script: |
        echo "âœ… Deployment complete"
        kubectl get all -n $(kubeNamespace)
      displayName: 'Final Status'
