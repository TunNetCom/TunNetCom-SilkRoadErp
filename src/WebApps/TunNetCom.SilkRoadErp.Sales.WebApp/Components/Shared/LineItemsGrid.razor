@using Radzen
@using Radzen.Blazor
@using Microsoft.Extensions.Localization
@using Microsoft.JSInterop
@using TunNetCom.SilkRoadErp.Sales.Contracts.Common
@using TunNetCom.SilkRoadErp.Sales.Contracts.AppParameters
@using TunNetCom.SilkRoadErp.Sales.Contracts.ReceiptNote.Responses
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote.Responses
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Pages.Inventaires
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Products
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ReceiptNote
@using TunNetCom.SilkRoadErp.Sales.Contracts.Products
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@typeparam TItem where TItem : class, ILineItem
@inject IJSRuntime JSRuntime
@inject DialogService DialogService
@inject IDecimalFormatService DecimalFormatService
@inject IProductsApiClient ProductsApiClient
@inject ICurrentProductStateService CurrentProductStateService
@inject IReceiptNoteApiClient ReceiptNoteApiClient

<div id="@componentId">
<RadzenDataGrid @ref="ordersGrid" 
                AllowAlternatingRows="false"
                AllowPaging="true"
                Data="@(Items ?? new List<TItem>())" 
                TItem="TItem"
                ColumnWidth="200px">
    <HeaderTemplate>
        <div class="header-actions">
            <div class="action-buttons">
                <RadzenButton ButtonStyle="ButtonStyle.Success" 
                              Icon="add_circle" 
                              Text="@Localizer["add_new_order"]"
                              Click="@(async () => await InsertRow())" 
                              class="action-button success-button"
                              AriaLabel="@Localizer["add_new_order"]"
                              Disabled="@IsReadOnly" />

                <RadzenButton ButtonStyle="ButtonStyle.Info"
                              Icon="percent"
                              Text="@Localizer["apply_discount"]"
                              Variant="Variant.Flat"
                              Size="ButtonSize.Small"
                              Disabled="@(IsReadOnly || Items == null || !Items.Any())"
                              Click="@OpenDiscountDialog"
                              class="action-button"
                              AriaLabel="@Localizer["apply_discount_to_all"]" />

                <RadzenButton ButtonStyle="ButtonStyle.Info"
                              Icon="receipt"
                              Text="@Localizer["apply_vat"]"
                              Variant="Variant.Flat"
                              Size="ButtonSize.Small"
                              Disabled="@(IsReadOnly || Items == null || !Items.Any())"
                              Click="@OpenVatDialog"
                              class="action-button"
                              AriaLabel="@Localizer["apply_vat_to_all"]" />

                <RadzenButton ButtonStyle="ButtonStyle.Info"
                              Icon="shopping_cart"
                              Text="@Localizer["apply_purchase_info"]"
                              Variant="Variant.Flat"
                              Size="ButtonSize.Small"
                              Disabled="@(IsReadOnly || Items == null || !Items.Any())"
                              Click="@OpenPurchaseInfoDialogForAll"
                              class="action-button"
                              AriaLabel="@Localizer["apply_purchase_info"]" />

                @if (ShowPrintButton)
                {
                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                  Icon="print"
                                  Text="@Localizer["print"]"
                                  Variant="Variant.Flat"
                                  Disabled="@(Items == null || !Items.Any())"
                                  Click="@OnPrint"
                                  class="action-button"
                                  AriaLabel="@Localizer["print"]" />
                }

                @if (ShowSaveButton)
                {
                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                  Icon="save"
                                  Text="@Localizer["save"]"
                                  Variant="Variant.Flat"
                                  Click="@OnSave" 
                                  Disabled="@(Items == null || !Items.Any())"
                                  class="action-button"
                                  AriaLabel="@Localizer["save"]" />
                }
            </div>

            @if (ShowSummary)
            {
                <RadzenCard class="summary-card" Variant="Variant.Outlined">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" 
                                 Gap="1.5rem" 
                                 JustifyContent="JustifyContent.End"
                                 class="summary-stack">
                        @if (ShowTtcColumn)
                        {
                            <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                                @Localizer["total_net"]: <strong>@TotalTtc.FormatAmount()</strong>
                            </RadzenText>
                        }
                        <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                            @Localizer["total_gross"]: <strong>@TotalHt.FormatAmount()</strong>
                        </RadzenText>
                        @if (ShowVatColumn)
                        {
                            <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                                @Localizer["total_vat"]: <strong>@TotalVat.FormatAmount()</strong>
                            </RadzenText>
                        }
                    </RadzenStack>
                </RadzenCard>
            }
        </div>
    </HeaderTemplate>
    <Columns>
        <RadzenDataGridColumn Width="60px" 
                              TItem="TItem"
                              Title="#"
                              Frozen="true"
                              FrozenPosition="FrozenColumnPosition.Left">
            <Template Context="order">
                @((Items?.IndexOf(order) ?? -1) + 1)
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="600px" 
                              TItem="TItem"
                              Title="@Localizer["product"]">
            <Template Context="order">
                @{
                    var rowIndex = Items?.IndexOf(order) ?? -1;
                    var dropdownId = $"product-dropdown-{rowIndex}";
                }
                <RadzenDropDownDataGrid Style="width: 100%; max-width: 600px;"
                                        AllowClear="true"
                                        Value="@(GetProductReference != null ? GetProductReference(order) : string.Empty)"
                                        LoadData="@LoadProducts"
                                        AllowFiltering="true"
                                        Data="@(GetProductList(order))"
                                        Count="@ProductCount"
                                        Change="@(args => OnProductSelected(order, args))"
                                        TextProperty="@ProductTextProperty"
                                        ValueProperty="@ProductValueProperty"
                                        Name="@dropdownId"
                                        Disabled="@IsReadOnly" />
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="120px" 
                              Title="@Localizer["quantity"]">
            <Template Context="order">
                <RadzenNumeric TValue="int"
                               Value="order.Quantity"
                               Change="@(args => OnQuantityChanged(order, args))"
                               Style="width:100%;"
                               Name="Quantity"
                               Disabled="@IsReadOnly"/>
                <RadzenRequiredValidator Text="@Localizer["quantity_required"]" Component="Quantity" Popup="true" />
            </Template>
        </RadzenDataGridColumn>

        @* Partial delivery columns - only shown for DeliveryNoteDetailResponse *@
        @if (typeof(TItem) == typeof(DeliveryNoteDetailResponse))
        {
            var partialDeliveryTitle = Localizer["partial_delivery"];
            var deliveredQuantityTitle = Localizer["delivered_quantity"];
            var enablePartialDeliveryTitle = Localizer["enable_partial_delivery"];
            
            <RadzenDataGridColumn Width="80px" 
                                  Title="@partialDeliveryTitle">
                <Template Context="order">
                    @{
                        var deliveryNoteItem = order as DeliveryNoteDetailResponse;
                        if (deliveryNoteItem != null)
                        {
                            <RadzenCheckBox Value="@deliveryNoteItem.HasPartialDelivery"
                                            ValueChanged="@((bool value) => OnPartialDeliveryCheckboxChanged(deliveryNoteItem, value))"
                                            Disabled="@(IsReadOnly || string.IsNullOrEmpty(deliveryNoteItem.ProductReference))"
                                            Title="@enablePartialDeliveryTitle" />
                        }
                    }
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Width="120px" 
                                  Title="@deliveredQuantityTitle"
                                  Visible="@showDeliveredQuantityColumn">
                <Template Context="order">
                    @{
                        var deliveryNoteItem = order as DeliveryNoteDetailResponse;
                        if (deliveryNoteItem != null)
                        {
                            var hasPartialDelivery = deliveryNoteItem.HasPartialDelivery;
                            if (hasPartialDelivery)
                            {
                                <RadzenNumeric TValue="int"
                                               Value="@(deliveryNoteItem.DeliveredQuantity ?? deliveryNoteItem.Quantity)"
                                               Change="@(args => OnDeliveredQuantityChanged(deliveryNoteItem, args))"
                                               Disabled="@IsReadOnly"
                                               Style="width:100%;"
                                               Min="0"
                                               Max="@deliveryNoteItem.Quantity"
                                               Name="DeliveredQuantity"/>
                            }
                            else
                            {
                                <span style="color: #6b7280; visibility: hidden;">-</span>
                            }
                        }
                    }
                </Template>
            </RadzenDataGridColumn>
        }

        @* Reception columns - generic implementation for any TItem with reception tracking *@
        @if (ShowReceptionColumns && GetHasPartialReception != null && SetHasPartialReception != null)
        {
            <RadzenDataGridColumn Width="80px" 
                                  Title="@ReceptionColumnTitle">
                <Template Context="order">
                    <RadzenCheckBox Value="@GetHasPartialReception(order)"
                                    ValueChanged="@((bool value) => OnPartialReceptionCheckboxChanged(order, value))"
                                    Disabled="@(IsReadOnly || string.IsNullOrEmpty(GetProductReference?.Invoke(order)))"
                                    Title="Activer la réception partielle" />
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Width="120px" 
                                  Title="@ReceivedQuantityColumnTitle"
                                  Visible="@showReceivedQuantityColumn">
                <Template Context="order">
                    @if (GetHasPartialReception(order) && GetReceivedQuantity != null && SetReceivedQuantity != null)
                    {
                        <RadzenNumeric TValue="int"
                                       Value="@GetReceivedQuantity(order)"
                                       Change="@(args => OnReceivedQuantityChanged(order, args))"
                                       Disabled="@IsReadOnly"
                                       Style="width:100%;"
                                       Min="0"
                                       Max="@order.Quantity"
                                       Name="ReceivedQuantity"/>
                    }
                    else
                    {
                        <span style="color: #6b7280; visibility: hidden;">-</span>
                    }
                </Template>
            </RadzenDataGridColumn>
        }

        <RadzenDataGridColumn Width="200px" 
                              Title="@Localizer["unit_price_ht"]">
            <Template Context="order">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <RadzenNumeric TValue="decimal"
                                   Value="order.UnitPriceExcludingTax"
                                   Change="@(args => OnUnitPriceChanged(order, args))"
                                   Style="width:100%;"
                                   Format="@priceFormat"
                                   Name="UnitPrice"
                                   Disabled="@IsReadOnly"/>
                    @if (ShowPriceHistoryDialog && !string.IsNullOrEmpty(GetProductReference?.Invoke(order)))
                    {
                        <RadzenButton Icon="history" 
                                      ButtonStyle="ButtonStyle.Light" 
                                      Variant="Variant.Flat"
                                      Size="ButtonSize.Small" 
                                      Click="@(() => ShowPriceHistoryWithState(order))" 
                                      Title="@Localizer["price_history"]" />
                    }
                </div>
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="150px" 
                              Title="@Localizer["discount_percentage"]">
            <Template Context="order">
                <RadzenNumeric TValue="double"
                               Value="order.DiscountPercentage"
                               Change="@(args => OnDiscountChanged(order, args))"
                               Style="width:100%;"
                               Min="0"
                               Max="@((decimal)MaxDiscountPercentage)"
                               Step="0.01"
                               Format="@discountFormat"
                               Name="Discount"
                               Disabled="@IsReadOnly"/>
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="120px" Title="@Localizer["total_excluding_tax"]">
            <Template Context="order">
                @order.TotalExcludingTax.FormatAmount(decimalPlaces)
            </Template>
        </RadzenDataGridColumn>

        @if (ShowVatColumn)
        {
            <RadzenDataGridColumn Width="120px" 
                                  Title="@Localizer["vat_percentage"]">
                <Template Context="order">
                    <RadzenNumeric TValue="double"
                                   Value="order.VatPercentage"
                                   Change="@(args => OnVatChanged(order, args))"
                                   Style="width:100%;"
                                   Min="0"
                                   Max="@((decimal)MaxVatPercentage)"
                                   Step="0.01"
                                   Format="@vatFormat"
                                   Name="Vat"
                                   Disabled="@IsReadOnly"/>
                </Template>
            </RadzenDataGridColumn>
        }

        @if (ShowTtcColumn)
        {
            <RadzenDataGridColumn Title="@Localizer["total_including_tax"]">
                <Template Context="order">
                    @order.TotalIncludingTax.FormatAmount(decimalPlaces)
                </Template>
            </RadzenDataGridColumn>
        }

        @* Inventaire specific columns - only shown for InventaireLineWrapper *@
        @if (typeof(TItem) == typeof(InventaireLineWrapper))
        {
            var quantiteTheoriqueTitle = Localizer["quantite_theorique"];
            var dernierPrixAchatTitle = Localizer["dernier_prix_achat"];
            
            <RadzenDataGridColumn Width="120px" 
                                  Title="@quantiteTheoriqueTitle">
                <Template Context="order">
                    @{
                        var inventaireItem = order as InventaireLineWrapper;
                        if (inventaireItem != null)
                        {
                            @inventaireItem.QuantiteTheorique
                        }
                    }
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Width="150px" 
                                  Title="@dernierPrixAchatTitle">
                <Template Context="order">
                    @{
                        var inventaireItem = order as InventaireLineWrapper;
                        if (inventaireItem != null)
                        {
                            @inventaireItem.DernierPrixAchat.FormatAmount()
                        }
                    }
                </Template>
            </RadzenDataGridColumn>
        }

        <RadzenDataGridColumn Context="order" 
                              Width="120px"
                              Filterable="false" 
                              Sortable="false" 
                              TextAlign="TextAlign.Right"
                              Frozen="true" 
                              FrozenPosition="FrozenColumnPosition.Right">
            <Template Context="order">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="4px" JustifyContent="JustifyContent.End">
                    <RadzenButton ButtonStyle="ButtonStyle.Info" 
                                  Icon="shopping_cart" 
                                  Variant="Variant.Flat"
                                  Shade="Shade.Lighter" 
                                  Size="ButtonSize.Medium"
                                  Disabled="@(IsReadOnly || string.IsNullOrEmpty(GetProductReference?.Invoke(order)))" 
                                  class="rz-my-1"
                                  Click="@(() => OpenPurchaseInfoDialogForLine(order))" 
                                  @onclick:stopPropagation="true"
                                  Title="@Localizer["apply_purchase_info_to_line"]"
                                  aria-label="@Localizer["apply_purchase_info_to_line"]">
                    </RadzenButton>
                    <RadzenButton ButtonStyle="ButtonStyle.Danger" 
                                  Icon="delete" 
                                  Variant="Variant.Flat"
                                  Shade="Shade.Lighter" 
                                  Size="ButtonSize.Medium"
                                  Disabled="@IsReadOnly" 
                                  class="rz-my-1 rz-ms-1"
                                  Click="@(args => HandleDeleteItem(order))" 
                                  @onclick:stopPropagation="true"
                                  aria-label="Delete">
                    </RadzenButton>
                </RadzenStack>
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>
</div>

<style>
    .header-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
        padding: 12px 24px;
        border-bottom: 1px solid #e5e7eb;
        width: 100%;
    }

    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }

    .action-button {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 6px;
        transition: background-color 0.2s, box-shadow 0.2s;
        background-color: #3b82f6;
        border: none;
    }

    .action-button:hover:not(:disabled) {
        background-color: #2563eb;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .action-button:disabled {
        background-color: #d1d5db;
        cursor: not-allowed;
    }

    .success-button {
        background-color: #10b981;
    }

    .success-button:hover:not(:disabled) {
        background-color: #059669;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .summary-card {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        flex: 0 0 auto;
    }

    .summary-stack {
        gap: 1.5rem;
    }

    .summary-text {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        line-height: 1.5;
    }

    .summary-text strong {
        font-weight: 600;
    }

    @@media (max-width: 768px) {
        .header-actions {
            flex-direction: column;
            align-items: flex-start;
            padding: 12px 16px;
            gap: 12px;
        }

        .action-buttons {
            flex-direction: column;
            width: 100%;
            gap: 8px;
        }

        .action-button,
        .success-button {
            width: 100%;
            text-align: center;
            font-size: 12px;
            padding: 10px;
        }

        .summary-card {
            width: 100%;
            padding: 8px 12px;
        }

        .summary-stack {
            flex-direction: column;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .summary-text {
            font-size: 12px;
        }
    }
</style>

@code {
    [Parameter] public List<TItem> Items { get; set; } = new();
    [Parameter] public EventCallback<List<TItem>> ItemsChanged { get; set; }
    [Parameter] public EventCallback<TItem> OnDeleteItem { get; set; }
    [Parameter] public EventCallback<TItem> OnProductSelectedCallback { get; set; }
    [Parameter] public Func<LoadDataArgs, Task> LoadProducts { get; set; }
    [Parameter] public Func<TItem, List<TItem>> GetProductList { get; set; }
    [Parameter] public int ProductCount { get; set; }
    [Parameter] public GetAppParametersResponse AppParameters { get; set; }
    [Parameter] public EventCallback<string> OnShowPriceHistory { get; set; }
    [Parameter] public bool ShowPriceHistoryDialog { get; set; } = true;
    [Parameter] public bool ShowPrintButton { get; set; } = true;
    [Parameter] public bool ShowSaveButton { get; set; } = true;
    [Parameter] public bool ShowSummary { get; set; } = true;
    [Parameter] public bool ShowVatColumn { get; set; } = true;
    [Parameter] public bool ShowTtcColumn { get; set; } = true;
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnPrint { get; set; }
    [Parameter] public decimal TotalHt { get; set; }
    [Parameter] public decimal TotalVat { get; set; }
    [Parameter] public decimal TotalTtc { get; set; }
    [Parameter] public decimal TotalFodec { get; set; } = 0;
    [Parameter] public bool IsConstructorProvider { get; set; } = false;
    [Parameter] public bool AutoDetectConstructorProviderFromReceiptHistory { get; set; } = false;
    [Parameter] public IStringLocalizer<SharedResource> Localizer { get; set; }
    
    // Product-related properties accessors
    [Parameter] public Func<TItem, string> GetProductReference { get; set; }
    [Parameter] public Action<TItem, string> SetProductReference { get; set; }
    [Parameter] public Func<TItem, string> GetProductDescription { get; set; }
    [Parameter] public Action<TItem, string> SetProductDescription { get; set; }
    [Parameter] public string ProductTextProperty { get; set; } = "ProductReferenceAndDescription";
    [Parameter] public string ProductValueProperty { get; set; } = "ProductReference";
    [Parameter] public Func<TItem> CreateNewItem { get; set; }
    [Parameter] public double MaxDiscountPercentage { get; set; } = 99.99;
    [Parameter] public double MaxVatPercentage { get; set; } = 50.0;
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // Reception tracking parameters (for RetourMarchandiseFournisseur)
    [Parameter] public bool ShowReceptionColumns { get; set; } = false;
    [Parameter] public Func<TItem, bool>? GetHasPartialReception { get; set; }
    [Parameter] public Action<TItem, bool>? SetHasPartialReception { get; set; }
    [Parameter] public Func<TItem, int>? GetReceivedQuantity { get; set; }
    [Parameter] public Action<TItem, int>? SetReceivedQuantity { get; set; }
    [Parameter] public string ReceptionColumnTitle { get; set; } = "Réception partielle";
    [Parameter] public string ReceivedQuantityColumnTitle { get; set; } = "Qté reçue";

    RadzenDataGrid<TItem> ordersGrid;
    private DotNetObjectReference<LineItemsGrid<TItem>>? objRef;
    private string componentId = Guid.NewGuid().ToString();
    private bool showDeliveredQuantityColumn = false;
    private bool showReceivedQuantityColumn = false;
    private string priceFormat = AmountHelper.FORMAT_N3;
    private string discountFormat = AmountHelper.FORMAT_N2;
    private string vatFormat = AmountHelper.FORMAT_N2;
    private int decimalPlaces = AmountHelper.DEFAULT_DECIMAL_PLACES;
    private readonly Dictionary<string, ProductReceiptConstructorInfo> _receiptConstructorCache = new(StringComparer.OrdinalIgnoreCase);

    private sealed record ProductReceiptConstructorInfo(bool IsConstructor, string SupplierName);

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        decimalPlaces = await DecimalFormatService.GetDecimalPlacesAsync();
        priceFormat = await DecimalFormatService.GetDecimalFormatAsync();
        // Discount and VAT percentages typically use 2 decimal places
        discountFormat = AmountHelper.FORMAT_N2;
        vatFormat = AmountHelper.FORMAT_N2;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            var dotNetRefId = $"lineItemsGridDotNetRef_{componentId}";
            
            // Use the helper function from site.js
            await JSRuntime.InvokeVoidAsync("setupOrderLinesGridKeyboard", dotNetRefId, objRef);
            
            // Initialize column visibility
            if (typeof(TItem) == typeof(DeliveryNoteDetailResponse))
            {
                showDeliveredQuantityColumn = Items?.Any(item => item is DeliveryNoteDetailResponse dn && dn.HasPartialDelivery) ?? false;
            }
        }
    }

    [JSInvokable]
    public async Task HandleKeyboardInsert()
    {
        await InsertRow();
    }

    private async Task OnQuantityChanged(TItem order, object value)
    {
        if (value != null && int.TryParse(value.ToString(), out int quantity))
        {
            order.Quantity = quantity;
            
            // For DeliveryNoteDetailResponse, synchronize DeliveredQuantity ONLY if checkbox is NOT checked
            // DO NOT change HasPartialDelivery automatically - it must be set manually by user
            if (order is DeliveryNoteDetailResponse deliveryNoteItem)
            {
                if (!deliveryNoteItem.HasPartialDelivery)
                {
                    // If checkbox is not checked, set DeliveredQuantity = Quantity (synchronize)
                    deliveryNoteItem.DeliveredQuantity = quantity;
                }
                else
                {
                    // If checkbox is checked, ensure DeliveredQuantity doesn't exceed Quantity
                    if (deliveryNoteItem.DeliveredQuantity.HasValue && deliveryNoteItem.DeliveredQuantity.Value > quantity)
                    {
                        deliveryNoteItem.DeliveredQuantity = quantity;
                    }
                }
            }
            
            LineItemCalculator.CalculateTotals(order);
            UpdateCurrentProductState(order);
            await NotifyItemsChanged();
        }
    }

    private async Task OnUnitPriceChanged(TItem order, object value)
    {
        if (value != null && decimal.TryParse(value.ToString(), out decimal price))
        {
            order.UnitPriceExcludingTax = price;
            LineItemCalculator.CalculateTotals(order);
            UpdateCurrentProductState(order);
            await NotifyItemsChanged();
        }
    }

    private async Task OnDiscountChanged(TItem order, object value)
    {
        if (value != null && double.TryParse(value.ToString(), out double discount))
        {
            // Limit discount to MaxDiscountPercentage
            if (discount > MaxDiscountPercentage)
            {
                discount = MaxDiscountPercentage;
            }
            if (discount < 0)
            {
                discount = 0;
            }
            order.DiscountPercentage = discount;
            LineItemCalculator.CalculateTotals(order);
            UpdateCurrentProductState(order);
            await NotifyItemsChanged();
        }
    }

    private async Task OnVatChanged(TItem order, object value)
    {
        if (value != null && double.TryParse(value.ToString(), out double vat))
        {
            // Limit VAT to MaxVatPercentage
            if (vat > MaxVatPercentage)
            {
                vat = MaxVatPercentage;
            }
            if (vat < 0)
            {
                vat = 0;
            }
            order.VatPercentage = vat;
            LineItemCalculator.CalculateTotals(order);
            UpdateCurrentProductState(order);
            await NotifyItemsChanged();
        }
    }

    private async Task OnPartialDeliveryCheckboxChanged(DeliveryNoteDetailResponse order, bool isChecked)
    {
        if (order == null) return;
        
        // Set HasPartialDelivery explicitly - this is the ONLY way it should change
        order.HasPartialDelivery = isChecked;
        
        if (isChecked)
        {
            // When checkbox is checked, initialize DeliveredQuantity to Quantity if not set
            if (!order.DeliveredQuantity.HasValue)
            {
                order.DeliveredQuantity = order.Quantity;
            }
            // Show the delivered quantity column
            showDeliveredQuantityColumn = true;
        }
        else
        {
            // When checkbox is unchecked, reset DeliveredQuantity to Quantity
            order.DeliveredQuantity = order.Quantity;
            // Hide the column if no checkboxes are checked
            showDeliveredQuantityColumn = Items?.Any(item => item is DeliveryNoteDetailResponse dn && dn.HasPartialDelivery) ?? false;
        }
        await NotifyItemsChanged();
    }

    private async Task OnDeliveredQuantityChanged(DeliveryNoteDetailResponse order, object value)
    {
        if (order == null) return;
        
        if (value != null && int.TryParse(value.ToString(), out int deliveredQuantity))
        {
            // Ensure DeliveredQuantity doesn't exceed Quantity
            if (deliveredQuantity > order.Quantity)
            {
                deliveredQuantity = order.Quantity;
            }
            if (deliveredQuantity < 0)
            {
                deliveredQuantity = 0;
            }
            order.DeliveredQuantity = deliveredQuantity;
            await NotifyItemsChanged();
        }
    }

    // Generic reception tracking handlers
    private async Task OnPartialReceptionCheckboxChanged(TItem order, bool isChecked)
    {
        if (order == null || SetHasPartialReception == null) return;
        
        SetHasPartialReception(order, isChecked);
        
        if (isChecked)
        {
            // When checkbox is checked, initialize received quantity to 0 if not set
            if (GetReceivedQuantity != null && SetReceivedQuantity != null)
            {
                var currentQty = GetReceivedQuantity(order);
                if (currentQty == 0)
                {
                    // Keep it at 0, user will enter the received quantity
                }
            }
            // Show the received quantity column
            showReceivedQuantityColumn = true;
        }
        else
        {
            // When checkbox is unchecked, reset received quantity to 0
            if (SetReceivedQuantity != null)
            {
                SetReceivedQuantity(order, 0);
            }
            // Hide the column if no checkboxes are checked
            UpdateReceivedQuantityColumnVisibility();
        }
        await NotifyItemsChanged();
    }

    private async Task OnReceivedQuantityChanged(TItem order, object value)
    {
        if (order == null || SetReceivedQuantity == null) return;
        
        if (value != null && int.TryParse(value.ToString(), out int receivedQuantity))
        {
            // Ensure received quantity doesn't exceed Quantity
            if (receivedQuantity > order.Quantity)
            {
                receivedQuantity = order.Quantity;
            }
            if (receivedQuantity < 0)
            {
                receivedQuantity = 0;
            }
            SetReceivedQuantity(order, receivedQuantity);
            await NotifyItemsChanged();
        }
    }

    private void UpdateReceivedQuantityColumnVisibility()
    {
        if (GetHasPartialReception == null)
        {
            showReceivedQuantityColumn = false;
            return;
        }
        showReceivedQuantityColumn = Items?.Any(item => GetHasPartialReception(item)) ?? false;
    }

    private async Task OnProductSelected(TItem order, object value)
    {
        if (value != null && value is string productReference)
        {
            var selectedProduct = GetProductList(order)
                .FirstOrDefault(p => GetProductReference(p) == productReference);

            if (selectedProduct != null)
            {
                // Preserve existing quantity for InventaireLineWrapper (unless it's the default value 1 or 0)
                int? preservedQuantity = null;
                bool isInventaire = order is InventaireLineWrapper;
                if (isInventaire)
                {
                    // For inventaire, preserve quantity if it's not the default value (1) or 0
                    // This ensures we don't lose user-entered quantities
                    if (order.Quantity > 1)
                    {
                        preservedQuantity = order.Quantity;
                    }
                }
                
                if (SetProductDescription != null)
                {
                    SetProductDescription(order, GetProductDescription(selectedProduct));
                }
                if (SetProductReference != null)
                {
                    SetProductReference(order, productReference);
                }
                order.UnitPriceExcludingTax = selectedProduct.UnitPriceExcludingTax;
                
                // Restore preserved quantity for inventaire
                if (preservedQuantity.HasValue && isInventaire)
                {
                    order.Quantity = preservedQuantity.Value;
                }
                // Ensure quantity is at least 1 for inventaire if it was 0
                else if (isInventaire && order.Quantity <= 0)
                {
                    order.Quantity = 1;
                }
                
                // Always use product's discount values (they come from the product data)
                // If product discount is 0, use app parameters as fallback
                order.DiscountPercentage = selectedProduct.DiscountPercentage > 0 
                    ? selectedProduct.DiscountPercentage 
                    : (double)(AppParameters?.DiscountPercentage ?? 0);
                
                // Always use AppParameters.VatAmount as default VAT value from Systeme entity
                // Only use product VAT if it's explicitly set and different from default
                order.VatPercentage = (double)(AppParameters?.VatAmount ?? 0);
                
                // For inventaire, don't calculate totals here - let OnProductSelectedHandler do it
                // after updating the quantity with quantiteTheorique
                if (!isInventaire)
                {
                    LineItemCalculator.CalculateTotals(order);
                }
                
                // Call the callback first for inventaire so it can update quantity before we calculate totals
                if (OnProductSelectedCallback.HasDelegate)
                {
                    await OnProductSelectedCallback.InvokeAsync(order);
                }
                
                // Calculate totals for inventaire after callback has updated quantity
                if (isInventaire)
                {
                    LineItemCalculator.CalculateTotals(order);
                }
                
                await NotifyItemsChanged();
            }
        }
    }

    private async Task NotifyItemsChanged()
    {
        // Update column visibility based on checkbox states for reception tracking
        if (ShowReceptionColumns)
        {
            UpdateReceivedQuantityColumnVisibility();
        }
        
        // Update column visibility based on checkbox states
        if (typeof(TItem) == typeof(DeliveryNoteDetailResponse))
        {
            showDeliveredQuantityColumn = Items?.Any(item => item is DeliveryNoteDetailResponse dn && dn.HasPartialDelivery) ?? false;
        }
        
        if (ItemsChanged.HasDelegate)
        {
            await ItemsChanged.InvokeAsync(Items);
        }
        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Updates the current product state service and invokes the price history callback.
    /// This enables reactive updates in the ProductHistoryDialog.
    /// </summary>
    private async Task ShowPriceHistoryWithState(TItem order)
    {
        var productRef = GetProductReference?.Invoke(order) ?? string.Empty;
        var productDesc = GetProductDescription?.Invoke(order) ?? string.Empty;
        
        if (!string.IsNullOrEmpty(productRef))
        {
            var receiptInfo = await GetReceiptConstructorInfoAsync(productRef);
            var isConstructorEffective = IsConstructorProvider || (receiptInfo?.IsConstructor ?? false);

            // Update the state service with current line item values
            var state = new CurrentProductState(
                ProductReference: productRef,
                ProductName: productDesc,
                UnitPriceHt: order.UnitPriceExcludingTax,
                TotalHt: order.TotalExcludingTax,
                TotalTtc: order.TotalIncludingTax,
                DiscountPercentage: order.DiscountPercentage,
                VatPercentage: order.VatPercentage,
                IsConstructorProvider: isConstructorEffective,
                FodecPercentage: isConstructorEffective ? (AppParameters?.PourcentageFodec ?? 0) : 0,
                Quantity: order.Quantity
            );
            CurrentProductStateService.UpdateState(state);
            
            // Invoke the callback to open the dialog
            if (OnShowPriceHistory.HasDelegate)
            {
                await OnShowPriceHistory.InvokeAsync(productRef);
            }
        }
    }

    /// <summary>
    /// Updates the current product state in the state service.
    /// Called when line item values change to keep the dialog reactive.
    /// </summary>
    private void UpdateCurrentProductState(TItem order)
    {
        var productRef = GetProductReference?.Invoke(order) ?? string.Empty;
        var productDesc = GetProductDescription?.Invoke(order) ?? string.Empty;
        
        // Only update if there's a product selected and the state service has a matching product
        if (!string.IsNullOrEmpty(productRef) && 
            CurrentProductStateService.State?.ProductReference == productRef)
        {
            var isConstructorEffective = CurrentProductStateService.State.IsConstructorProvider;
            var state = new CurrentProductState(
                ProductReference: productRef,
                ProductName: productDesc,
                UnitPriceHt: order.UnitPriceExcludingTax,
                TotalHt: order.TotalExcludingTax,
                TotalTtc: order.TotalIncludingTax,
                DiscountPercentage: order.DiscountPercentage,
                VatPercentage: order.VatPercentage,
                IsConstructorProvider: isConstructorEffective,
                FodecPercentage: isConstructorEffective ? (AppParameters?.PourcentageFodec ?? 0) : 0,
                Quantity: order.Quantity
            );
            CurrentProductStateService.UpdateState(state);
        }
    }

    private async Task<ProductReceiptConstructorInfo?> GetReceiptConstructorInfoAsync(string productRef)
    {
        if (!AutoDetectConstructorProviderFromReceiptHistory || string.IsNullOrWhiteSpace(productRef))
        {
            return null;
        }

        if (_receiptConstructorCache.TryGetValue(productRef, out var cached))
        {
            return cached;
        }

        try
        {
            var result = await ReceiptNoteApiClient.GetReceiptNotesByProductReferenceAsync(productRef, 1, 1);
            var first = result?.Items?.FirstOrDefault();
            var info = new ProductReceiptConstructorInfo(first?.Constructeur ?? false, first?.Provider ?? string.Empty);
            _receiptConstructorCache[productRef] = info;
            return info;
        }
        catch
        {
            var info = new ProductReceiptConstructorInfo(false, string.Empty);
            _receiptConstructorCache[productRef] = info;
            return info;
        }
    }

    private async Task OpenDiscountDialog()
    {
        if (Items == null || !Items.Any())
        {
            return;
        }

        var result = await DialogService.OpenAsync<ApplyDiscountDialog>(
            Localizer["apply_discount_to_all"],
            new Dictionary<string, object> { { "MaxValue", MaxDiscountPercentage } },
            new DialogOptions() 
            { 
                Width = "400px",
                Resizable = false,
                Draggable = true
            });

        if (result is double discountValue)
        {
            await ApplyDiscountToAll(discountValue);
        }
    }

    private async Task OpenVatDialog()
    {
        if (Items == null || !Items.Any())
        {
            return;
        }

        // Use AppParameters.VatAmount as default value if available
        var initialVatValue = AppParameters?.VatAmount ?? 0;
        
        var result = await DialogService.OpenAsync<ApplyVatDialog>(
            Localizer["apply_vat_to_all"],
            new Dictionary<string, object> 
            { 
                { "MaxValue", MaxVatPercentage },
                { "InitialValue", (double)initialVatValue }
            },
            new DialogOptions() 
            { 
                Width = "400px",
                Resizable = false,
                Draggable = true
            });

        if (result is double vatValue)
        {
            await ApplyVatToAll(vatValue);
        }
    }

    private async Task ApplyDiscountToAll(double discount)
    {
        // Limit discount to MaxDiscountPercentage
        if (discount > MaxDiscountPercentage)
        {
            discount = MaxDiscountPercentage;
        }
        if (discount < 0)
        {
            discount = 0;
        }

        // Apply discount to all items
        foreach (var item in Items)
        {
            item.DiscountPercentage = discount;
            LineItemCalculator.CalculateTotals(item);
        }

        await NotifyItemsChanged();
    }

    private async Task ApplyVatToAll(double vat)
    {
        // Limit VAT to MaxVatPercentage
        if (vat > MaxVatPercentage)
        {
            vat = MaxVatPercentage;
        }
        if (vat < 0)
        {
            vat = 0;
        }

        // Apply VAT to all items
        foreach (var item in Items)
        {
            item.VatPercentage = vat;
            LineItemCalculator.CalculateTotals(item);
        }

        await NotifyItemsChanged();
    }

    private async Task OpenPurchaseInfoDialogForLine(TItem item)
    {
        if (item == null || string.IsNullOrEmpty(GetProductReference?.Invoke(item)))
        {
            return;
        }

        var result = await DialogService.OpenAsync<ApplyPurchaseInfoDialog>(
            Localizer["apply_purchase_info_to_line"],
            new Dictionary<string, object>(),
            new DialogOptions() 
            { 
                Width = "400px",
                Resizable = false,
                Draggable = true
            });

        if (result is ApplyPurchaseInfoDialog.PurchaseInfoSource source)
        {
            await ApplyPurchaseInfoToItem(item, source);
        }
    }

    private async Task OpenPurchaseInfoDialogForAll()
    {
        if (Items == null || !Items.Any())
        {
            return;
        }

        var result = await DialogService.OpenAsync<ApplyPurchaseInfoDialog>(
            Localizer["apply_purchase_info"],
            new Dictionary<string, object>(),
            new DialogOptions() 
            { 
                Width = "400px",
                Resizable = false,
                Draggable = true
            });

        if (result is ApplyPurchaseInfoDialog.PurchaseInfoSource source)
        {
            // Apply to all items that have a product selected
            foreach (var item in Items)
            {
                var productRef = GetProductReference?.Invoke(item);
                if (!string.IsNullOrEmpty(productRef))
                {
                    await ApplyPurchaseInfoToItem(item, source);
                }
            }
        }
    }

    private async Task ApplyPurchaseInfoToItem(TItem item, ApplyPurchaseInfoDialog.PurchaseInfoSource source)
    {
        var productRef = GetProductReference?.Invoke(item);
        if (string.IsNullOrEmpty(productRef))
        {
            return;
        }

        if (source == ApplyPurchaseInfoDialog.PurchaseInfoSource.Product)
        {
            // Get product info
            var productResult = await ProductsApiClient.GetAsync(productRef, CancellationToken.None);
            if (productResult.IsT0)
            {
                var product = productResult.AsT0;
                item.UnitPriceExcludingTax = product.PurchasingPrice;
                item.DiscountPercentage = product.DiscountPourcentageOfPurchasing;
                item.VatPercentage = product.VatRate;
                LineItemCalculator.CalculateTotals(item);
            }
        }
        else if (source == ApplyPurchaseInfoDialog.PurchaseInfoSource.LastReceipt)
        {
            // Get last purchase info from receipt notes
            var purchaseInfoResult = await ProductsApiClient.GetDernieresInfosAchatAsync(productRef, CancellationToken.None);
            if (purchaseInfoResult.IsT0)
            {
                var purchaseInfo = purchaseInfoResult.AsT0;
                item.UnitPriceExcludingTax = purchaseInfo.PrixHt;
                item.DiscountPercentage = purchaseInfo.Remise;
                item.VatPercentage = purchaseInfo.Tva;
                LineItemCalculator.CalculateTotals(item);
            }
            else
            {
                // Fallback to product values if no receipt note found
                var productResult = await ProductsApiClient.GetAsync(productRef, CancellationToken.None);
                if (productResult.IsT0)
                {
                    var product = productResult.AsT0;
                    item.UnitPriceExcludingTax = product.PurchasingPrice;
                    item.DiscountPercentage = product.DiscountPourcentageOfPurchasing;
                    item.VatPercentage = product.VatRate;
                    LineItemCalculator.CalculateTotals(item);
                }
            }
        }

        await NotifyItemsChanged();
    }

    async Task InsertRow()
    {
        try
        {
            if (CreateNewItem == null)
            {
                throw new InvalidOperationException("CreateNewItem parameter must be provided");
            }

            var order = CreateNewItem();
            
            // For DeliveryNoteDetailResponse, initialize DeliveredQuantity to Quantity and HasPartialDelivery to false
            if (order is DeliveryNoteDetailResponse deliveryNoteItem)
            {
                deliveryNoteItem.DeliveredQuantity = deliveryNoteItem.Quantity;
                deliveryNoteItem.HasPartialDelivery = false; // Always start with checkbox unchecked
            }
            
            // Always use AppParameters values as defaults from Systeme entity
            if (AppParameters != null)
            {
                order.DiscountPercentage = (double)AppParameters.DiscountPercentage;
                order.VatPercentage = (double)AppParameters.VatAmount;
            }
            else
            {
                // Fallback to 0 if AppParameters is not loaded yet
                order.DiscountPercentage = 0;
                order.VatPercentage = 0;
            }
            
            if (Items == null)
            {
                Items = new List<TItem>();
            }
            
            Items.Add(order);
            await NotifyItemsChanged();
            await ordersGrid.Reload();
            
            // Focus on the product dropdown of the newly added row
            await Task.Delay(300); // Increased delay to ensure DOM is fully updated
            var newRowIndex = Items.Count - 1;
            await FocusProductDropdown(newRowIndex);
            
            // Ensure the button remains clickable by removing focus from dropdown if needed
            await Task.Delay(100);
        }
        catch (Exception ex)
        {
            // Log error if needed
            System.Diagnostics.Debug.WriteLine($"Error in InsertRow: {ex.Message}");
        }
    }

    private async Task FocusProductDropdown(int rowIndex)
    {
        try
        {
            var dropdownName = $"product-dropdown-{rowIndex}";
            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    setTimeout(function() {{
                        // Try to find the input by name attribute first
                        var input = document.querySelector('input[name=""{dropdownName}""]');
                        
                        // If not found, find the last row in the grid and get its product dropdown
                        if (!input) {{
                            var rows = document.querySelectorAll('tbody tr');
                            if (rows.length > 0) {{
                                var lastRow = rows[rows.length - 1];
                                var cells = lastRow.querySelectorAll('td');
                                // Product column is typically the second column (index 1)
                                if (cells.length > 1) {{
                                    var productCell = cells[1];
                                    input = productCell.querySelector('input[type=""text""]');
                                }}
                            }}
                        }}
                        
                        if (input) {{
                            // Focus the input first
                            input.focus();
                            
                            // Wait a bit then open the dropdown by clicking the trigger button
                            setTimeout(function() {{
                                var dropdown = input.closest('.rz-dropdown');
                                if (dropdown) {{
                                    // Find the dropdown trigger button
                                    var trigger = dropdown.querySelector('.rz-dropdown-trigger');
                                    if (!trigger) {{
                                        // Alternative: find button with dropdown icon
                                        trigger = dropdown.querySelector('button[aria-haspopup=""listbox""]');
                                    }}
                                    if (!trigger) {{
                                        // Last resort: find any button in the dropdown
                                        trigger = dropdown.querySelector('button');
                                    }}
                                    
                                    if (trigger) {{
                                        // Check if dropdown is already open
                                        var isOpen = dropdown.classList.contains('rz-dropdown-open') || 
                                                     dropdown.querySelector('.rz-dropdown-panel') ||
                                                     dropdown.querySelector('.rz-dropdown-list');
                                        
                                        if (!isOpen) {{
                                            // Use mousedown and mouseup instead of click to avoid double-trigger
                                            var mouseDownEvent = new MouseEvent('mousedown', {{
                                                bubbles: true,
                                                cancelable: true,
                                                view: window
                                            }});
                                            var mouseUpEvent = new MouseEvent('mouseup', {{
                                                bubbles: true,
                                                cancelable: true,
                                                view: window
                                            }});
                                            trigger.dispatchEvent(mouseDownEvent);
                                            setTimeout(function() {{
                                                trigger.dispatchEvent(mouseUpEvent);
                                            }}, 10);
                                        }}
                                    }} else {{
                                        // Fallback: just focus the input, don't click
                                        input.focus();
                                    }}
                                }}
                            }}, 250);
                        }}
                    }}, 200);
                }})();
            ");
        }
        catch
        {
            // Silently fail if focus cannot be set
        }
    }

    private async Task HandleDeleteItem(TItem order)
    {
        if (Items == null)
        {
            return;
        }
        
        // Try to remove by reference first (most reliable for exact match)
        if (Items.Contains(order))
        {
            Items.Remove(order);
        }
        else
        {
            // Try to find by Id if the item has an Id property
            var itemType = order.GetType();
            var idProperty = itemType.GetProperty("Id");
            if (idProperty != null)
            {
                var orderId = idProperty.GetValue(order);
                if (orderId != null && Convert.ToInt32(orderId) > 0)
                {
                    var itemToRemove = Items.FirstOrDefault(t =>
                    {
                        var tId = idProperty.GetValue(t);
                        return tId != null && Convert.ToInt32(tId) == Convert.ToInt32(orderId) && Convert.ToInt32(tId) > 0;
                    });
                    if (itemToRemove != null)
                    {
                        Items.Remove(itemToRemove);
                    }
                }
            }
        }

        // Notify parent of the change
        await NotifyItemsChanged();
        
        // Reload the grid
        await ordersGrid.Reload();
        
        // Also call the parent's delete handler if provided
        if (OnDeleteItem.HasDelegate)
        {
            await OnDeleteItem.InvokeAsync(order);
        }
    }
}
