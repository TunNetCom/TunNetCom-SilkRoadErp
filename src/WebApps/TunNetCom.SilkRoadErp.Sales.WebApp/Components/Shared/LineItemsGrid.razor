@using Radzen.Blazor
@using Microsoft.Extensions.Localization
@using Microsoft.JSInterop
@using TunNetCom.SilkRoadErp.Sales.Contracts.Common
@using TunNetCom.SilkRoadErp.Sales.Contracts.AppParameters
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@typeparam TItem where TItem : class, ILineItem
@inject IJSRuntime JSRuntime

<div id="@componentId">
<RadzenDataGrid @ref="ordersGrid" 
                AllowAlternatingRows="false"
                AllowPaging="true"
                Data="@Items" 
                TItem="TItem"
                ColumnWidth="200px">
    <HeaderTemplate>
        <div class="header-actions">
            <div class="action-buttons">
                <RadzenButton ButtonStyle="ButtonStyle.Success" 
                              Icon="add_circle" 
                              Text="@Localizer["add_new_order"]"
                              Click="@(async () => await InsertRow())" 
                              class="action-button success-button"
                              AriaLabel="@Localizer["add_new_order"]" />

                @if (ShowPrintButton)
                {
                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                  Icon="print"
                                  Text="@Localizer["print"]"
                                  Variant="Variant.Flat"
                                  Disabled="@(!Items.Any())"
                                  Click="@OnPrint"
                                  class="action-button"
                                  AriaLabel="@Localizer["print"]" />
                }

                @if (ShowSaveButton)
                {
                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                  Icon="save"
                                  Text="@Localizer["save"]"
                                  Variant="Variant.Flat"
                                  Click="@OnSave" 
                                  Disabled="@(!Items.Any())"
                                  class="action-button"
                                  AriaLabel="@Localizer["save"]" />
                }
            </div>

            @if (ShowSummary)
            {
                <RadzenCard class="summary-card" Variant="Variant.Outlined">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" 
                                 Gap="1.5rem" 
                                 JustifyContent="JustifyContent.End"
                                 class="summary-stack">
                        <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                            @Localizer["total_net"]: <strong>@TotalTtc.FormatAmount()</strong>
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                            @Localizer["total_gross"]: <strong>@TotalHt.FormatAmount()</strong>
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                            @Localizer["total_vat"]: <strong>@TotalVat.FormatAmount()</strong>
                        </RadzenText>
                    </RadzenStack>
                </RadzenCard>
            }
        </div>
    </HeaderTemplate>
    <Columns>
        <RadzenDataGridColumn Width="60px" 
                              TItem="TItem"
                              Title="#"
                              Frozen="true"
                              FrozenPosition="FrozenColumnPosition.Left">
            <Template Context="order">
                @(Items.IndexOf(order) + 1)
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="600px" 
                              TItem="TItem"
                              Title="@Localizer["product"]">
            <Template Context="order">
                @{
                    var rowIndex = Items.IndexOf(order);
                    var dropdownId = $"product-dropdown-{rowIndex}";
                }
                <RadzenDropDownDataGrid Style="width: 100%; max-width: 600px;"
                                        AllowClear="true"
                                        Value="@(GetProductReference != null ? GetProductReference(order) : string.Empty)"
                                        LoadData="@LoadProducts"
                                        AllowFiltering="true"
                                        Data="@(GetProductList(order))"
                                        Count="@ProductCount"
                                        Change="@(args => OnProductSelected(order, args))"
                                        TextProperty="@ProductTextProperty"
                                        ValueProperty="@ProductValueProperty"
                                        Name="@dropdownId" />
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="120px" 
                              Title="@Localizer["quantity"]">
            <Template Context="order">
                <RadzenNumeric TValue="int"
                               Value="order.Quantity"
                               Change="@(args => OnQuantityChanged(order, args))"
                               Style="width:100%;"
                               Name="Quantity"/>
                <RadzenRequiredValidator Text="@Localizer["quantity_required"]" Component="Quantity" Popup="true" />
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="200px" 
                              Title="@Localizer["unit_price_ht"]">
            <Template Context="order">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <RadzenNumeric TValue="decimal"
                                   Value="order.UnitPriceExcludingTax"
                                   Change="@(args => OnUnitPriceChanged(order, args))"
                                   Style="width:100%;"
                                   Format="@GetPriceFormat()"
                                   Name="UnitPrice"/>
                    @if (ShowPriceHistoryDialog && !string.IsNullOrEmpty(GetProductReference?.Invoke(order)))
                    {
                        <RadzenButton Icon="history" 
                                      ButtonStyle="ButtonStyle.Light" 
                                      Variant="Variant.Flat"
                                      Size="ButtonSize.Small" 
                                      Click="@(() => OnShowPriceHistory.InvokeAsync(GetProductReference(order)))" 
                                      Title="@Localizer["price_history"]" />
                    }
                </div>
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="150px" 
                              Title="@Localizer["discount_percentage"]">
            <Template Context="order">
                <RadzenNumeric TValue="double"
                               Value="order.DiscountPercentage"
                               Change="@(args => OnDiscountChanged(order, args))"
                               Style="width:100%;"
                               Min="0"
                               Max="50"
                               Step="0.01"
                               Format="N2"
                               Name="Discount"/>
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Title="@Localizer["total_excluding_tax"]">
            <Template Context="order">
                @order.TotalExcludingTax.FormatAmount()
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="120px" 
                              Title="@Localizer["vat_percentage"]">
            <Template Context="order">
                <RadzenNumeric TValue="double"
                               Value="order.VatPercentage"
                               Change="@(args => OnVatChanged(order, args))"
                               Style="width:100%;"
                               Min="0"
                               Max="50"
                               Step="0.01"
                               Format="N2"
                               Name="Vat"/>
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Title="@Localizer["total_including_tax"]">
            <Template Context="order">
                @order.TotalIncludingTax.FormatAmount()
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Context="order" 
                              Width="80px"
                              Filterable="false" 
                              Sortable="false" 
                              TextAlign="TextAlign.Right"
                              Frozen="true" 
                              FrozenPosition="FrozenColumnPosition.Right">
            <Template Context="order">
                <RadzenButton ButtonStyle="ButtonStyle.Danger" 
                              Icon="delete" 
                              Variant="Variant.Flat"
                              Shade="Shade.Lighter" 
                              Size="ButtonSize.Medium" 
                              class="rz-my-1 rz-ms-1"
                              Click="@(args => HandleDeleteItem(order))" 
                              @onclick:stopPropagation="true"
                              aria-label="Delete">
                </RadzenButton>
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>
</div>

<style>
    .header-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
        padding: 12px 24px;
        border-bottom: 1px solid #e5e7eb;
        width: 100%;
    }

    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }

    .action-button {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 6px;
        transition: background-color 0.2s, box-shadow 0.2s;
        background-color: #3b82f6;
        border: none;
    }

    .action-button:hover:not(:disabled) {
        background-color: #2563eb;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .action-button:disabled {
        background-color: #d1d5db;
        cursor: not-allowed;
    }

    .success-button {
        background-color: #10b981;
    }

    .success-button:hover:not(:disabled) {
        background-color: #059669;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .summary-card {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        flex: 0 0 auto;
    }

    .summary-stack {
        gap: 1.5rem;
    }

    .summary-text {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        line-height: 1.5;
    }

    .summary-text strong {
        font-weight: 600;
    }

    @@media (max-width: 768px) {
        .header-actions {
            flex-direction: column;
            align-items: flex-start;
            padding: 12px 16px;
            gap: 12px;
        }

        .action-buttons {
            flex-direction: column;
            width: 100%;
            gap: 8px;
        }

        .action-button,
        .success-button {
            width: 100%;
            text-align: center;
            font-size: 12px;
            padding: 10px;
        }

        .summary-card {
            width: 100%;
            padding: 8px 12px;
        }

        .summary-stack {
            flex-direction: column;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .summary-text {
            font-size: 12px;
        }
    }
</style>

@code {
    [Parameter] public List<TItem> Items { get; set; } = new();
    [Parameter] public EventCallback<List<TItem>> ItemsChanged { get; set; }
    [Parameter] public EventCallback<TItem> OnDeleteItem { get; set; }
    [Parameter] public EventCallback<TItem> OnProductSelectedCallback { get; set; }
    [Parameter] public Func<LoadDataArgs, Task> LoadProducts { get; set; }
    [Parameter] public Func<TItem, List<TItem>> GetProductList { get; set; }
    [Parameter] public int ProductCount { get; set; }
    [Parameter] public GetAppParametersResponse AppParameters { get; set; }
    [Parameter] public EventCallback<string> OnShowPriceHistory { get; set; }
    [Parameter] public bool ShowPriceHistoryDialog { get; set; } = true;
    [Parameter] public bool ShowPrintButton { get; set; } = true;
    [Parameter] public bool ShowSaveButton { get; set; } = true;
    [Parameter] public bool ShowSummary { get; set; } = true;
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnPrint { get; set; }
    [Parameter] public decimal TotalHt { get; set; }
    [Parameter] public decimal TotalVat { get; set; }
    [Parameter] public decimal TotalTtc { get; set; }
    [Parameter] public IStringLocalizer<SharedResource> Localizer { get; set; }
    
    // Product-related properties accessors
    [Parameter] public Func<TItem, string> GetProductReference { get; set; }
    [Parameter] public Action<TItem, string> SetProductReference { get; set; }
    [Parameter] public Func<TItem, string> GetProductDescription { get; set; }
    [Parameter] public Action<TItem, string> SetProductDescription { get; set; }
    [Parameter] public string ProductTextProperty { get; set; } = "ProductReferenceAndDescription";
    [Parameter] public string ProductValueProperty { get; set; } = "ProductReference";
    [Parameter] public Func<TItem> CreateNewItem { get; set; }

    RadzenDataGrid<TItem> ordersGrid;
    private DotNetObjectReference<LineItemsGrid<TItem>>? objRef;
    private string componentId = Guid.NewGuid().ToString();

    private string GetPriceFormat()
    {
        // Format with thousands separator and 2 decimal places (e.g., 1,234.56)
        // Using "N2" format: Number with 2 decimal places and thousands separator
        return "N2";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            var dotNetRefId = $"lineItemsGridDotNetRef_{componentId}";
            
            // Use the helper function from site.js
            await JSRuntime.InvokeVoidAsync("setupOrderLinesGridKeyboard", dotNetRefId, objRef);
        }
    }

    [JSInvokable]
    public async Task HandleKeyboardInsert()
    {
        await InsertRow();
    }

    private async Task OnQuantityChanged(TItem order, object value)
    {
        if (value != null && int.TryParse(value.ToString(), out int quantity))
        {
            order.Quantity = quantity;
            LineItemCalculator.CalculateTotals(order);
            await NotifyItemsChanged();
        }
    }

    private async Task OnUnitPriceChanged(TItem order, object value)
    {
        if (value != null && decimal.TryParse(value.ToString(), out decimal price))
        {
            order.UnitPriceExcludingTax = price;
            LineItemCalculator.CalculateTotals(order);
            await NotifyItemsChanged();
        }
    }

    private async Task OnDiscountChanged(TItem order, object value)
    {
        if (value != null && double.TryParse(value.ToString(), out double discount))
        {
            // Limit discount to 50%
            if (discount > 50)
            {
                discount = 50;
            }
            if (discount < 0)
            {
                discount = 0;
            }
            order.DiscountPercentage = discount;
            LineItemCalculator.CalculateTotals(order);
            await NotifyItemsChanged();
        }
    }

    private async Task OnVatChanged(TItem order, object value)
    {
        if (value != null && double.TryParse(value.ToString(), out double vat))
        {
            // Limit VAT to 50%
            if (vat > 50)
            {
                vat = 50;
            }
            if (vat < 0)
            {
                vat = 0;
            }
            order.VatPercentage = vat;
            LineItemCalculator.CalculateTotals(order);
            await NotifyItemsChanged();
        }
    }

    private async Task OnProductSelected(TItem order, object value)
    {
        if (value != null && value is string productReference)
        {
            var selectedProduct = GetProductList(order)
                .FirstOrDefault(p => GetProductReference(p) == productReference);

            if (selectedProduct != null)
            {
                if (SetProductDescription != null)
                {
                    SetProductDescription(order, GetProductDescription(selectedProduct));
                }
                if (SetProductReference != null)
                {
                    SetProductReference(order, productReference);
                }
                order.UnitPriceExcludingTax = selectedProduct.UnitPriceExcludingTax;
                
                // Always use product's discount and VAT values (they come from the product data)
                // If product values are 0, use app parameters as fallback
                order.DiscountPercentage = selectedProduct.DiscountPercentage > 0 
                    ? selectedProduct.DiscountPercentage 
                    : (AppParameters?.DiscountPercentage ?? 0);
                order.VatPercentage = selectedProduct.VatPercentage > 0 
                    ? selectedProduct.VatPercentage 
                    : (AppParameters?.VatAmount ?? 0);
                
                LineItemCalculator.CalculateTotals(order);
                await NotifyItemsChanged();
                
                if (OnProductSelectedCallback.HasDelegate)
                {
                    await OnProductSelectedCallback.InvokeAsync(order);
                }
            }
        }
    }

    private async Task NotifyItemsChanged()
    {
        if (ItemsChanged.HasDelegate)
        {
            await ItemsChanged.InvokeAsync(Items);
        }
        await InvokeAsync(StateHasChanged);
    }

    async Task InsertRow()
    {
        try
        {
            if (CreateNewItem == null)
            {
                throw new InvalidOperationException("CreateNewItem parameter must be provided");
            }

            var order = CreateNewItem();
            
            if (AppParameters != null)
            {
                order.DiscountPercentage = AppParameters.DiscountPercentage;
                order.VatPercentage = AppParameters.VatAmount;
            }
            
            Items.Add(order);
            await NotifyItemsChanged();
            await ordersGrid.Reload();
            
            // Focus on the product dropdown of the newly added row
            await Task.Delay(300); // Increased delay to ensure DOM is fully updated
            var newRowIndex = Items.Count - 1;
            await FocusProductDropdown(newRowIndex);
            
            // Ensure the button remains clickable by removing focus from dropdown if needed
            await Task.Delay(100);
        }
        catch (Exception ex)
        {
            // Log error if needed
            System.Diagnostics.Debug.WriteLine($"Error in InsertRow: {ex.Message}");
        }
    }

    private async Task FocusProductDropdown(int rowIndex)
    {
        try
        {
            var dropdownName = $"product-dropdown-{rowIndex}";
            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    setTimeout(function() {{
                        // Try to find the input by name attribute first
                        var input = document.querySelector('input[name=""{dropdownName}""]');
                        
                        // If not found, find the last row in the grid and get its product dropdown
                        if (!input) {{
                            var rows = document.querySelectorAll('tbody tr');
                            if (rows.length > 0) {{
                                var lastRow = rows[rows.length - 1];
                                var cells = lastRow.querySelectorAll('td');
                                // Product column is typically the second column (index 1)
                                if (cells.length > 1) {{
                                    var productCell = cells[1];
                                    input = productCell.querySelector('input[type=""text""]');
                                }}
                            }}
                        }}
                        
                        if (input) {{
                            // Focus the input first
                            input.focus();
                            
                            // Wait a bit then open the dropdown by clicking the trigger button
                            setTimeout(function() {{
                                var dropdown = input.closest('.rz-dropdown');
                                if (dropdown) {{
                                    // Find the dropdown trigger button
                                    var trigger = dropdown.querySelector('.rz-dropdown-trigger');
                                    if (!trigger) {{
                                        // Alternative: find button with dropdown icon
                                        trigger = dropdown.querySelector('button[aria-haspopup=""listbox""]');
                                    }}
                                    if (!trigger) {{
                                        // Last resort: find any button in the dropdown
                                        trigger = dropdown.querySelector('button');
                                    }}
                                    
                                    if (trigger) {{
                                        // Check if dropdown is already open
                                        var isOpen = dropdown.classList.contains('rz-dropdown-open') || 
                                                     dropdown.querySelector('.rz-dropdown-panel') ||
                                                     dropdown.querySelector('.rz-dropdown-list');
                                        
                                        if (!isOpen) {{
                                            // Use mousedown and mouseup instead of click to avoid double-trigger
                                            var mouseDownEvent = new MouseEvent('mousedown', {{
                                                bubbles: true,
                                                cancelable: true,
                                                view: window
                                            }});
                                            var mouseUpEvent = new MouseEvent('mouseup', {{
                                                bubbles: true,
                                                cancelable: true,
                                                view: window
                                            }});
                                            trigger.dispatchEvent(mouseDownEvent);
                                            setTimeout(function() {{
                                                trigger.dispatchEvent(mouseUpEvent);
                                            }}, 10);
                                        }}
                                    }} else {{
                                        // Fallback: just focus the input, don't click
                                        input.focus();
                                    }}
                                }}
                            }}, 250);
                        }}
                    }}, 200);
                }})();
            ");
        }
        catch
        {
            // Silently fail if focus cannot be set
        }
    }

    private async Task HandleDeleteItem(TItem order)
    {
        // Try to remove by reference first (most reliable for exact match)
        if (Items.Contains(order))
        {
            Items.Remove(order);
        }
        else
        {
            // Try to find by Id if the item has an Id property
            var itemType = order.GetType();
            var idProperty = itemType.GetProperty("Id");
            if (idProperty != null)
            {
                var orderId = idProperty.GetValue(order);
                if (orderId != null && Convert.ToInt32(orderId) > 0)
                {
                    var itemToRemove = Items.FirstOrDefault(t =>
                    {
                        var tId = idProperty.GetValue(t);
                        return tId != null && Convert.ToInt32(tId) == Convert.ToInt32(orderId) && Convert.ToInt32(tId) > 0;
                    });
                    if (itemToRemove != null)
                    {
                        Items.Remove(itemToRemove);
                    }
                }
            }
        }

        // Notify parent of the change
        await NotifyItemsChanged();
        
        // Reload the grid
        await ordersGrid.Reload();
        
        // Also call the parent's delete handler if provided
        if (OnDeleteItem.HasDelegate)
        {
            await OnDeleteItem.InvokeAsync(order);
        }
    }
}

