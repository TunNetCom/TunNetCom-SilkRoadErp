@using Radzen.Blazor
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote.Responses
@using TunNetCom.SilkRoadErp.Sales.Contracts.AppParameters
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales

<RadzenDataGrid @ref="ordersGrid" 
                AllowAlternatingRows="false"
                AllowPaging="true"
                Data="@Items" 
                TItem="DeliveryNoteDetailResponse"
                ColumnWidth="200px">
    <HeaderTemplate>
        <div class="header-actions">
            <div class="action-buttons">
                <RadzenButton ButtonStyle="ButtonStyle.Success" 
                              Icon="add_circle" 
                              Text="@Localizer["add_new_order"]"
                              Click="@InsertRow" 
                              class="action-button success-button"
                              AriaLabel="@Localizer["add_new_order"]" />

                @if (ShowPrintButton)
                {
                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                  Icon="print"
                                  Text="@Localizer["print"]"
                                  Variant="Variant.Flat"
                                  Disabled="@(!Items.Any())"
                                  class="action-button"
                                  AriaLabel="@Localizer["print"]" />
                }

                @if (ShowSaveButton)
                {
                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                  Icon="save"
                                  Text="@Localizer["save"]"
                                  Variant="Variant.Flat"
                                  Click="@OnSave" 
                                  Disabled="@(!Items.Any())"
                                  class="action-button"
                                  AriaLabel="@Localizer["save"]" />
                }
            </div>

            @if (ShowSummary)
            {
                <RadzenCard class="summary-card" Variant="Variant.Outlined">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" 
                                 Gap="1.5rem" 
                                 JustifyContent="JustifyContent.End"
                                 class="summary-stack">
                        <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                            @Localizer["total_net"]: <strong>@TotalTtc.FormatAmount()</strong>
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                            @Localizer["total_gross"]: <strong>@TotalHt.FormatAmount()</strong>
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                            @Localizer["total_vat"]: <strong>@TotalVat.FormatAmount()</strong>
                        </RadzenText>
                    </RadzenStack>
                </RadzenCard>
            }
        </div>
    </HeaderTemplate>
    <Columns>
        <RadzenDataGridColumn Width="60px" 
                              TItem="DeliveryNoteDetailResponse"
                              Title="#"
                              Frozen="true"
                              FrozenPosition="FrozenColumnPosition.Left">
            <Template Context="order">
                @(Items.IndexOf(order) + 1)
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="600px" 
                              TItem="DeliveryNoteDetailResponse"
                              Property="@nameof(DeliveryNoteDetailResponse.ProductReferenceAndDescription)"
                              Title="@Localizer["product"]">
            <Template Context="order">
                <RadzenDropDownDataGrid Style="width: 100%; max-width: 600px;"
                                        AllowClear="true"
                                        @bind-Value="order.ProductReference"
                                        LoadData="@LoadProducts"
                                        AllowFiltering="true"
                                        Data="@(GetProductList(order))"
                                        Count="@ProductCount"
                                        Change="@(args => OnProductSelected(order, args))"
                                        TextProperty="@nameof(DeliveryNoteDetailResponse.ProductReferenceAndDescription)"
                                        ValueProperty="@nameof(DeliveryNoteDetailResponse.ProductReference)"
                                        Name="DropDownDataGridFilteringLoadData" />
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="100px" 
                              Property="@nameof(DeliveryNoteDetailResponse.Quantity)"
                              Title="@Localizer["quantity"]">
            <Template Context="order">
                <RadzenNumeric TValue="int"
                               Value="order.Quantity"
                               Change="@(args => OnQuantityChanged(order, args))"
                               Style="width:100%;"
                               Name="Quantity"/>
                <RadzenRequiredValidator Text="@Localizer["quantity_required"]" Component="Quantity" Popup="true" />
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="150px" 
                              Property="@nameof(DeliveryNoteDetailResponse.UnitPriceExcludingTax)" 
                              Title="@Localizer["unit_price_ht"]">
            <Template Context="order">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <RadzenNumeric TValue="decimal"
                                   Value="order.UnitPriceExcludingTax"
                                   Change="@(args => OnUnitPriceChanged(order, args))"
                                   Style="width:100%;"
                                   Name="UnitPrice"/>
                    @if (ShowPriceHistoryDialog && !string.IsNullOrEmpty(order.ProductReference))
                    {
                        <RadzenButton Icon="history" 
                                      ButtonStyle="ButtonStyle.Light" 
                                      Variant="Variant.Flat"
                                      Size="ButtonSize.Small" 
                                      Click="@(() => OnShowPriceHistory.InvokeAsync(order.ProductReference))" 
                                      Title="@Localizer["price_history"]" />
                    }
                </div>
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="100px" 
                              Property="@nameof(DeliveryNoteDetailResponse.DiscountPercentage)"
                              Title="@Localizer["discount_percentage"]">
            <Template Context="order">
                <RadzenNumeric TValue="double"
                               Value="order.DiscountPercentage"
                               Change="@(args => OnDiscountChanged(order, args))"
                               Style="width:100%;"
                               Name="Discount"/>
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Property="@nameof(DeliveryNoteDetailResponse.TotalExcludingTax)" 
                              Title="@Localizer["total_excluding_tax"]">
            <Template Context="order">
                @order.TotalExcludingTax.FormatAmount()
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Width="100px" 
                              Property="@nameof(DeliveryNoteDetailResponse.VatPercentage)" 
                              Title="@Localizer["vat_percentage"]">
            <Template Context="order">
                <RadzenNumeric TValue="double"
                               Value="order.VatPercentage"
                               Change="@(args => OnVatChanged(order, args))"
                               Style="width:100%;"
                               Name="Vat"/>
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Property="@nameof(DeliveryNoteDetailResponse.TotalIncludingTax)" 
                              Title="@Localizer["total_including_tax"]">
            <Template Context="order">
                @order.TotalIncludingTax.FormatAmount()
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Context="order" 
                              Filterable="false" 
                              Sortable="false" 
                              TextAlign="TextAlign.Right"
                              Frozen="true" 
                              FrozenPosition="FrozenColumnPosition.Right">
            <Template Context="order">
                <RadzenButton ButtonStyle="ButtonStyle.Danger" 
                              Icon="delete" 
                              Variant="Variant.Flat"
                              Shade="Shade.Lighter" 
                              Size="ButtonSize.Medium" 
                              class="rz-my-1 rz-ms-1"
                              Click="@(args => HandleDeleteItem(order))" 
                              @onclick:stopPropagation="true"
                              aria-label="Delete">
                </RadzenButton>
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

<style>
    .header-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
        padding: 12px 24px;
        border-bottom: 1px solid #e5e7eb;
        width: 100%;
    }

    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }

    .action-button {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 6px;
        transition: background-color 0.2s, box-shadow 0.2s;
        background-color: #3b82f6;
        border: none;
    }

    .action-button:hover:not(:disabled) {
        background-color: #2563eb;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .action-button:disabled {
        background-color: #d1d5db;
        cursor: not-allowed;
    }

    .success-button {
        background-color: #10b981;
    }

    .success-button:hover:not(:disabled) {
        background-color: #059669;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .summary-card {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        flex: 0 0 auto;
    }

    .summary-stack {
        gap: 1.5rem;
    }

    .summary-text {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        line-height: 1.5;
    }

    .summary-text strong {
        font-weight: 600;
    }

    @@media (max-width: 768px) {
        .header-actions {
            flex-direction: column;
            align-items: flex-start;
            padding: 12px 16px;
            gap: 12px;
        }

        .action-buttons {
            flex-direction: column;
            width: 100%;
            gap: 8px;
        }

        .action-button,
        .success-button {
            width: 100%;
            text-align: center;
            font-size: 12px;
            padding: 10px;
        }

        .summary-card {
            width: 100%;
            padding: 8px 12px;
        }

        .summary-stack {
            flex-direction: column;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .summary-text {
            font-size: 12px;
        }
    }
</style>

@code {
    [Parameter] public List<DeliveryNoteDetailResponse> Items { get; set; } = new();
    [Parameter] public EventCallback<List<DeliveryNoteDetailResponse>> ItemsChanged { get; set; }
    [Parameter] public EventCallback<DeliveryNoteDetailResponse> OnDeleteItem { get; set; }
    [Parameter] public EventCallback<DeliveryNoteDetailResponse> OnProductSelectedCallback { get; set; }
    [Parameter] public Func<LoadDataArgs, Task> LoadProducts { get; set; }
    [Parameter] public Func<DeliveryNoteDetailResponse, List<DeliveryNoteDetailResponse>> GetProductList { get; set; }
    [Parameter] public int ProductCount { get; set; }
    [Parameter] public GetAppParametersResponse AppParameters { get; set; }
    [Parameter] public EventCallback<string> OnShowPriceHistory { get; set; }
    [Parameter] public bool ShowPriceHistoryDialog { get; set; } = true;
    [Parameter] public bool ShowPrintButton { get; set; } = true;
    [Parameter] public bool ShowSaveButton { get; set; } = true;
    [Parameter] public bool ShowSummary { get; set; } = true;
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public decimal TotalHt { get; set; }
    [Parameter] public decimal TotalVat { get; set; }
    [Parameter] public decimal TotalTtc { get; set; }
    [Parameter] public IStringLocalizer<SharedResource> Localizer { get; set; }

    RadzenDataGrid<DeliveryNoteDetailResponse> ordersGrid;

    private async Task OnQuantityChanged(DeliveryNoteDetailResponse order, object value)
    {
        if (value != null && int.TryParse(value.ToString(), out int quantity))
        {
            order.Quantity = quantity;
            LineItemCalculator.CalculateTotals(order);
            await NotifyItemsChanged();
        }
    }

    private async Task OnUnitPriceChanged(DeliveryNoteDetailResponse order, object value)
    {
        if (value != null && decimal.TryParse(value.ToString(), out decimal price))
        {
            order.UnitPriceExcludingTax = price;
            LineItemCalculator.CalculateTotals(order);
            await NotifyItemsChanged();
        }
    }

    private async Task OnDiscountChanged(DeliveryNoteDetailResponse order, object value)
    {
        if (value != null && double.TryParse(value.ToString(), out double discount))
        {
            order.DiscountPercentage = discount;
            LineItemCalculator.CalculateTotals(order);
            await NotifyItemsChanged();
        }
    }

    private async Task OnVatChanged(DeliveryNoteDetailResponse order, object value)
    {
        if (value != null && double.TryParse(value.ToString(), out double vat))
        {
            order.VatPercentage = vat;
            LineItemCalculator.CalculateTotals(order);
            await NotifyItemsChanged();
        }
    }

    private async Task OnProductSelected(DeliveryNoteDetailResponse order, object value)
    {
        if (value != null && value is string productReference)
        {
            var selectedProduct = GetProductList(order)
                .FirstOrDefault(p => p.ProductReference == productReference);

            if (selectedProduct != null)
            {
                order.Description = selectedProduct.Description;
                order.ProductReference = selectedProduct.ProductReference;
                order.UnitPriceExcludingTax = selectedProduct.UnitPriceExcludingTax;
                
                if (AppParameters != null)
                {
                    order.DiscountPercentage = AppParameters.DiscountPercentage;
                    order.VatPercentage = AppParameters.VatAmount;
                }
                
                LineItemCalculator.CalculateTotals(order);
                await NotifyItemsChanged();
                
                if (OnProductSelectedCallback.HasDelegate)
                {
                    await OnProductSelectedCallback.InvokeAsync(order);
                }
            }
        }
    }

    private async Task NotifyItemsChanged()
    {
        if (ItemsChanged.HasDelegate)
        {
            await ItemsChanged.InvokeAsync(Items);
        }
        await InvokeAsync(StateHasChanged);
    }

    async Task InsertRow()
    {
        var order = new DeliveryNoteDetailResponse
        {
            Quantity = 1
        };
        
        if (AppParameters != null)
        {
            order.DiscountPercentage = AppParameters.DiscountPercentage;
            order.VatPercentage = AppParameters.VatAmount;
        }
        
        Items.Add(order);
        await NotifyItemsChanged();
        await ordersGrid.Reload();
    }

    private async Task HandleDeleteItem(DeliveryNoteDetailResponse order)
    {
        // Try to remove by reference first (most reliable for exact match)
        if (Items.Contains(order))
        {
            Items.Remove(order);
        }
        else if (order.Id > 0)
        {
            // If reference match fails but item has Id, find by Id
            var itemToRemove = Items.FirstOrDefault(t => t.Id == order.Id && t.Id > 0);
            if (itemToRemove != null)
            {
                Items.Remove(itemToRemove);
            }
        }

        // Notify parent of the change
        await NotifyItemsChanged();
        
        // Reload the grid
        await ordersGrid.Reload();
        
        // Also call the parent's delete handler if provided
        if (OnDeleteItem.HasDelegate)
        {
            await OnDeleteItem.InvokeAsync(order);
        }
    }

}

