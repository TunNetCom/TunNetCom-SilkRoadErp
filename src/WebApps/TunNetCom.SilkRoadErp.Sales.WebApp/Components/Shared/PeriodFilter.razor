@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using Radzen.Blazor
@inject IStringLocalizer<SharedResource> Localizer

<div class="search-field" style="margin-right: 15px;">
    <label for="periodFilter">@Localizer["period_filter"]</label>
    <RadzenDropDown id="periodFilter"
                   @bind-Value="SelectedPeriod"
                   Data="@periodOptions"
                   TextProperty="Label"
                   ValueProperty="Value"
                   Placeholder="@Localizer["select_period"]"
                   Change="@OnPeriodFilterChanged"
                   class="w-100 search-input" />
</div>
@if (SelectedPeriod == "CustomPeriod")
{
    <div class="search-field" style="margin-right: 15px;">
        <label for="startDate">@Localizer["start_date"]</label>
        <RadzenDatePicker id="startDate"
                          Value="@StartDate"
                          ValueChanged="EventCallback.Factory.Create<DateTime?>(this, OnStartDateChanged)"
                          DateFormat="dd/MM/yyyy"
                          Placeholder="@Localizer["start_date"]"
                          class="w-100 " />
    </div>
    <div class="search-field" style="margin-right: 15px;">
        <label for="endDate">@Localizer["end_date"]</label>
        <RadzenDatePicker id="endDate"
                          Value="@EndDate"
                          ValueChanged="EventCallback.Factory.Create<DateTime?>(this, OnEndDateChanged)"
                          DateFormat="dd/MM/yyyy"
                          Placeholder="@Localizer["end_date"]"
                          class="w-100 " />
    </div>
}

@code {
    [Parameter] public string SelectedPeriod { get; set; } = "CurrentMonth";
    [Parameter] public EventCallback<string> SelectedPeriodChanged { get; set; }
    [Parameter] public DateTime? StartDate { get; set; }
    [Parameter] public EventCallback<DateTime?> StartDateChanged { get; set; }
    [Parameter] public DateTime? EndDate { get; set; }
    [Parameter] public EventCallback<DateTime?> EndDateChanged { get; set; }
    [Parameter] public EventCallback OnPeriodChanged { get; set; }

    private List<PeriodOption> periodOptions = new();

    protected override void OnInitialized()
    {
        periodOptions = new List<PeriodOption>
        {
            new PeriodOption { Value = "CurrentMonth", Label = Localizer["current_month"] },
            new PeriodOption { Value = "LastMonth", Label = Localizer["last_month"] },
            new PeriodOption { Value = "CurrentYear", Label = Localizer["current_year"] },
            new PeriodOption { Value = "CustomPeriod", Label = Localizer["custom_period"] }
        };
    }

    private async Task OnPeriodFilterChanged(object? value)
    {
        if (value != null)
        {
            SelectedPeriod = value.ToString() ?? "CurrentMonth";
            await SelectedPeriodChanged.InvokeAsync(SelectedPeriod);
            
            var (startDate, endDate) = PeriodFilterHelper.GetDateRangeFromPeriod(SelectedPeriod, StartDate, EndDate);
            StartDate = startDate;
            EndDate = endDate;
            
            await StartDateChanged.InvokeAsync(StartDate);
            await EndDateChanged.InvokeAsync(EndDate);
            await OnPeriodChanged.InvokeAsync();
        }
    }

    private async Task OnStartDateChanged(DateTime? value)
    {
        StartDate = value;
        await StartDateChanged.InvokeAsync(StartDate);
        await OnPeriodChanged.InvokeAsync();
    }

    private async Task OnEndDateChanged(DateTime? value)
    {
        EndDate = value;
        await EndDateChanged.InvokeAsync(EndDate);
        await OnPeriodChanged.InvokeAsync();
    }

    public class PeriodOption
    {
        public string Value { get; set; } = string.Empty;
        public string Label { get; set; } = string.Empty;
    }
}

