@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.DeliveryNote
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ReceiptNote
@using TunNetCom.SilkRoadErp.Sales.Contracts
@using TunNetCom.SilkRoadErp.Sales.Contracts.Common
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote.Responses
@using TunNetCom.SilkRoadErp.Sales.Contracts.ReceiptNote.Responses
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using System.Globalization
@using Radzen
@using Radzen.Blazor
@inject IDeliveryNoteApiClient deliveryNoteService
@inject IReceiptNoteApiClient receiptNoteService
@inject DialogService DialogService

<RadzenTabs>
    <Tabs>
        <RadzenTabsItem Text="Ventes">
            <RadzenDataGrid Data="@deliveryNotePagedList?.Items" 
                           TItem="DeliveryNoteDetailResponse" 
                           AllowSorting="true" 
                           AllowPaging="true" 
                           PageSize="10"
                           Count="@(deliveryNotePagedList?.TotalCount ?? 0)"
                           LoadData="@LoadDeliveryNotesData">
                    <EmptyTemplate>
                        <p style="color: lightgrey; font-size: 24px; text-align: center; margin: 2rem;">No records to display.</p>
                    </EmptyTemplate>
                    <Columns>
                        <RadzenDataGridColumn Property="@nameof(DeliveryNoteDetailResponse.Provider)" Title="Provider Name" Width="150px"/>
                        <RadzenDataGridColumn Property="@nameof(DeliveryNoteDetailResponse.Date)" Title="Delivery Date" Width="150px">
                            <Template Context="item">
                                @item.Date.ToString("dd/MM/yyyy", CultureInfo.GetCultureInfo("fr-FR"))
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(DeliveryNoteDetailResponse.Description)" Title="Description" Width="200px"/>
                        <RadzenDataGridColumn Property="@nameof(DeliveryNoteDetailResponse.UnitPriceExcludingTax)" Title="Unit Price (Excl. Tax)" Width="150px">
                            <Template Context="item">
                                @item.UnitPriceExcludingTax.ToString(DecimalFormatConstants.FORMAT_N3, CultureInfo.GetCultureInfo("fr-FR"))
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(DeliveryNoteDetailResponse.DiscountPercentage)" Title="Discount (%)" Width="100px">
                            <Template Context="item">
                                @item.DiscountPercentage.ToString(DecimalFormatConstants.FORMAT_N2, CultureInfo.GetCultureInfo("fr-FR"))
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(DeliveryNoteDetailResponse.VatPercentage)" Title="VAT (%)" Width="100px">
                            <Template Context="item">
                                @item.VatPercentage.ToString(DecimalFormatConstants.FORMAT_N2, CultureInfo.GetCultureInfo("fr-FR"))
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(DeliveryNoteDetailResponse.NetTtcUnitaire)" Title="Net TTC Unitaire" Width="150px">
                            <Template Context="item">
                                @item.NetTtcUnitaire.ToString(DecimalFormatConstants.FORMAT_N3, CultureInfo.GetCultureInfo("fr-FR"))
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(DeliveryNoteDetailResponse.PrixHtFodec)" Title="Price HT Fodec" Width="150px">
                            <Template Context="item">
                                @(item.PrixHtFodec?.ToString(DecimalFormatConstants.FORMAT_N3, CultureInfo.GetCultureInfo("fr-FR")) ?? "-")
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
        </RadzenTabsItem>
        
        <RadzenTabsItem Text="Achats">
            <RadzenDataGrid Data="@receiptNotePagedList?.Items" 
                           TItem="ReceiptNoteDetailResponse" 
                           AllowSorting="true" 
                           AllowPaging="true" 
                           PageSize="10"
                           Count="@(receiptNotePagedList?.TotalCount ?? 0)"
                           LoadData="@LoadReceiptNotesData">
                    <EmptyTemplate>
                        <p style="color: lightgrey; font-size: 24px; text-align: center; margin: 2rem;">No records to display.</p>
                    </EmptyTemplate>
                    <Columns>
                        <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailResponse.Provider)" Title="Provider Name" Width="150px"/>
                        <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailResponse.Date)" Title="Receipt Date" Width="150px">
                            <Template Context="item">
                                @item.Date.ToString("dd/MM/yyyy", CultureInfo.GetCultureInfo("fr-FR"))
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailResponse.Description)" Title="Description" Width="200px"/>
                        <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailResponse.UnitPriceExcludingTax)" Title="Unit Price (Excl. Tax)" Width="150px">
                            <Template Context="item">
                                @item.UnitPriceExcludingTax.ToString(DecimalFormatConstants.FORMAT_N3, CultureInfo.GetCultureInfo("fr-FR"))
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailResponse.DiscountPercentage)" Title="Discount (%)" Width="100px">
                            <Template Context="item">
                                @item.DiscountPercentage.ToString(DecimalFormatConstants.FORMAT_N2, CultureInfo.GetCultureInfo("fr-FR"))
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailResponse.VatPercentage)" Title="VAT (%)" Width="100px">
                            <Template Context="item">
                                @item.VatPercentage.ToString(DecimalFormatConstants.FORMAT_N2, CultureInfo.GetCultureInfo("fr-FR"))
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailResponse.TotalExcludingTax)" Title="Total HT" Width="150px">
                            <Template Context="item">
                                @item.TotalExcludingTax.ToString(DecimalFormatConstants.FORMAT_N3, CultureInfo.GetCultureInfo("fr-FR"))
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailResponse.TotalIncludingTax)" Title="Total TTC" Width="150px">
                            <Template Context="item">
                                @item.TotalIncludingTax.ToString(DecimalFormatConstants.FORMAT_N3, CultureInfo.GetCultureInfo("fr-FR"))
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
        </RadzenTabsItem>
    </Tabs>
</RadzenTabs>

<style>
    .rz-datatable thead th {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

@if (ShowClose)
{
    <div style="margin-top: 20px;">
        <RadzenButton Text="Close" Click="@(() => DialogService.Close())" />
    </div>
}

@code {
    [Parameter] public string ProductReference { get; set; } = string.Empty;
    [Parameter] public bool ShowClose { get; set; } = true;
    private PagedList<DeliveryNoteDetailResponse>? deliveryNotePagedList;
    private PagedList<ReceiptNoteDetailResponse>? receiptNotePagedList;

    protected override async Task OnInitializedAsync()
    {
        // Data will be loaded when the grids call LoadData
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reset paged lists when ProductReference changes
        deliveryNotePagedList = null;
        receiptNotePagedList = null;
        StateHasChanged();
    }

    private async Task LoadDeliveryNotesData(LoadDataArgs args)
    {
        if (string.IsNullOrWhiteSpace(ProductReference))
        {
            deliveryNotePagedList = new PagedList<DeliveryNoteDetailResponse>(new List<DeliveryNoteDetailResponse>(), 0, 1, 10);
            return;
        }

        try
        {
            var pageSize = args.Top ?? 10;
            var pageNumber = args.Skip.HasValue && pageSize > 0 ? (args.Skip.Value / pageSize) + 1 : 1;

            var result = await deliveryNoteService.GetDeliveryNotesAsync(ProductReference, pageNumber, pageSize);
            deliveryNotePagedList = result ?? new PagedList<DeliveryNoteDetailResponse>(new List<DeliveryNoteDetailResponse>(), 0, pageNumber, pageSize);
        }
        catch (HttpRequestException)
        {
            // Handle API errors (e.g., network issues, 500 errors)
            deliveryNotePagedList = new PagedList<DeliveryNoteDetailResponse>(new List<DeliveryNoteDetailResponse>(), 0, 1, 10);
        }
        catch (Exception)
        {
            // Log other exceptions
            deliveryNotePagedList = new PagedList<DeliveryNoteDetailResponse>(new List<DeliveryNoteDetailResponse>(), 0, 1, 10);
        }
    }

    private async Task LoadReceiptNotesData(LoadDataArgs args)
    {
        if (string.IsNullOrWhiteSpace(ProductReference))
        {
            receiptNotePagedList = new PagedList<ReceiptNoteDetailResponse>(new List<ReceiptNoteDetailResponse>(), 0, 1, 10);
            return;
        }

        try
        {
            var pageSize = args.Top ?? 10;
            var pageNumber = args.Skip.HasValue && pageSize > 0 ? (args.Skip.Value / pageSize) + 1 : 1;

            var result = await receiptNoteService.GetReceiptNotesByProductReferenceAsync(ProductReference, pageNumber, pageSize);
            receiptNotePagedList = result ?? new PagedList<ReceiptNoteDetailResponse>(new List<ReceiptNoteDetailResponse>(), 0, pageNumber, pageSize);
        }
        catch (HttpRequestException)
        {
            // Handle API errors (e.g., network issues, 500 errors)
            receiptNotePagedList = new PagedList<ReceiptNoteDetailResponse>(new List<ReceiptNoteDetailResponse>(), 0, 1, 10);
        }
        catch (Exception)
        {
            // Log other exceptions
            receiptNotePagedList = new PagedList<ReceiptNoteDetailResponse>(new List<ReceiptNoteDetailResponse>(), 0, 1, 10);
        }
    }
}

