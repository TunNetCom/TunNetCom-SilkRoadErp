@using Radzen
@using Radzen.Blazor
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Infrastructure
@inject DialogService DialogService
@inject IStringLocalizer<SharedResource> Localizer
@inject IPrinterService PrinterService
@inject IConfiguration Configuration

<RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="1rem">
    <RadzenText TextStyle="TextStyle.Body1">
        @Localizer["select_printer"]
    </RadzenText>
    
    @if (isLoadingPrinters)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText>@Localizer["loading_printers"]</RadzenText>
    }
    else if (printers.Any())
    {
        @if (isBrowserPrinting)
        {
            <RadzenAlert AlertStyle="AlertStyle.Info">
                <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="font-weight: bold;">
                        @Localizer["browser_print_info_title"] ?? "Toutes les imprimantes seront disponibles"
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">
                        @Localizer["browser_print_info"] ?? "Le dialogue d'impression du navigateur s'ouvrira avec toutes vos imprimantes disponibles, y compris:"
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin-left: 1rem;">
                        • HP, Epson, Canon, etc.<br/>
                        • Microsoft Print to PDF<br/>
                        • Autres imprimantes installées
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Style="font-style: italic; margin-top: 0.5rem;">
                        Vous pourrez sélectionner votre imprimante dans le dialogue du navigateur.
                    </RadzenText>
                </RadzenStack>
            </RadzenAlert>
        }

        <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.5rem">
            <RadzenLabel Text="@Localizer["printer"]" />
            <RadzenDropDown @bind-Value="selectedPrinterName"
                           Data="@printers"
                           TextProperty="Name"
                           ValueProperty="Name"
                           Placeholder="@Localizer["select_printer"]"
                           Style="width: 100%;"
                           Disabled="@isBrowserPrinting" />
        </RadzenStack>

        <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.5rem">
            <RadzenLabel Text="@Localizer["copies"]" />
            <RadzenNumeric @bind-Value="copies" 
                          Min="1" 
                          Max="99" 
                          Style="width: 100%;" />
        </RadzenStack>

        <RadzenCheckBox @bind-Value="duplex" Name="Duplex">
            @Localizer["duplex_printing"]
        </RadzenCheckBox>
    }
    else
    {
        <RadzenText TextStyle="TextStyle.Body2" Style="color: #dc3545;">
            @Localizer["no_printers_available"]
        </RadzenText>
    }

    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End" Style="margin-top: 1rem;">
        <RadzenButton Text="@Localizer["Cancel"]" 
                      ButtonStyle="ButtonStyle.Light" 
                      Click="@(() => DialogService.Close(false))" />
        <RadzenButton Text="@Localizer["print"]" 
                      ButtonStyle="ButtonStyle.Success" 
                      Disabled="@(string.IsNullOrEmpty(selectedPrinterName) || isLoadingPrinters)"
                      Click="@OnConfirm" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter] public byte[]? PdfBytes { get; set; }

    private List<PrinterInfo> printers = new();
    private string? selectedPrinterName;
    private int copies = 1;
    private bool duplex = false;
    private bool isLoadingPrinters = true;
    private bool isBrowserPrinting = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadPrinters();
    }

    private async Task LoadPrinters()
    {
        isLoadingPrinters = true;
        try
        {
            printers = await PrinterService.GetAvailablePrintersAsync();
            
            // Check if we're using browser printing (when remote service is not configured)
            var serviceUrl = Configuration["Printing:ServiceUrl"];
            isBrowserPrinting = string.IsNullOrEmpty(serviceUrl) || 
                               (printers.Count == 1 && printers[0].Name == "Browser Print Dialog");
            
            // Select default printer if available
            var defaultPrinter = printers.FirstOrDefault(p => p.IsDefault);
            if (defaultPrinter != null)
            {
                selectedPrinterName = defaultPrinter.Name;
            }
            else if (printers.Any())
            {
                selectedPrinterName = printers.First().Name;
            }
        }
        catch (Exception ex)
        {
            // Log error but continue with empty list
            Console.WriteLine($"Error loading printers: {ex.Message}");
        }
        finally
        {
            isLoadingPrinters = false;
        }
    }

    private void OnConfirm()
    {
        if (!string.IsNullOrEmpty(selectedPrinterName) && PdfBytes != null)
        {
            var result = new PrinterSelectionResult
            {
                PrinterName = selectedPrinterName,
                Copies = copies,
                Duplex = duplex,
                PdfBytes = PdfBytes
            };
            DialogService.Close(result);
        }
        else
        {
            DialogService.Close(false);
        }
    }
}
