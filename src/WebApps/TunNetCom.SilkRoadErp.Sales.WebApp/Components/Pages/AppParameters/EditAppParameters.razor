@page "/app_parameters"
@using TunNetCom.SilkRoadErp.Sales.Contracts.AppParameters
@using Radzen.Blazor
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.HttpClients
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AppParameters
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using System.Globalization
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services
@inject IAppParametersClient appParametersService
@inject NavigationManager navigationManager
@inject IStringLocalizer<SharedResource> localizer

<RadzenCard Style="padding: 20px; max-width: 900px; margin: auto;">
    <RadzenTemplateForm Data="@system" Submit="@OnSubmit">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.Center" Style="margin-bottom: 0.5rem;">
            <h3>App Parameters</h3>
        </RadzenStack>

        <RadzenTabs RenderMode="TabRenderMode.Client">
            <Tabs>
                <RadzenTabsItem Text="Informations générales" Icon="info">
                    <RadzenRow Class="g-2 mb-4">
                        <RadzenColumn Size="12" SizeSM="6" Class="d-flex flex-column gap-3">
                            <RadzenFormField Text="@localizer["Nom"]">
                                <Start><RadzenIcon Icon="person" /></Start>
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="system.NomSociete" Name="Nom" Style="width: 100%;" />
                                </ChildContent>
                            </RadzenFormField>

                            <RadzenFormField Text="@localizer["Mail"]">
                                <Start><RadzenIcon Icon="email" /></Start>
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="system.Email" Name="Mail" Style="width: 100%;" />
                                </ChildContent>
                            </RadzenFormField>

                            <RadzenFormField Text="@localizer["Tel"]">
                                <Start><RadzenIcon Icon="call" /></Start>
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="system.Tel" Name="Tel" Style="width: 100%;" />
                                </ChildContent>
                            </RadzenFormField>

                            <RadzenFormField Text="@localizer["Fax"]">
                                <Start><RadzenIcon Icon="call" /></Start>
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="system.Fax" Name="Fax" Style="width: 100%;" />
                                </ChildContent>
                            </RadzenFormField>

                            <RadzenFormField Text="@localizer["Adresse"]">
                                <Start><RadzenIcon Icon="home" /></Start>
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="system.Adresse" Name="Adresse" Style="width: 100%;" />
                                </ChildContent>
                            </RadzenFormField>

                            <RadzenFormField Text="@localizer["Adresse_retenu"]">
                                <Start><RadzenIcon Icon="home" /></Start>
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="system.AdresseRetenu" Name="AdresseRetenu" Style="width: 100%;" />
                                </ChildContent>
                            </RadzenFormField>
                        </RadzenColumn>

                        <RadzenColumn Size="12" SizeSM="6" Class="d-flex flex-column gap-3">
                            <RadzenFormField Text="@localizer["matricule_fiscale"]">
                                <Start><RadzenIcon Icon="badge" /></Start>
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="system.MatriculeFiscale" Name="Matricule" Style="width: 100%;" />
                                </ChildContent>
                            </RadzenFormField>

                            <RadzenFormField Text="@localizer["CodeTva"]">
                                <Start><RadzenIcon Icon="code" /></Start>
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="system.CodeTva" Name="CodeTva" Style="width: 100%;" />
                                </ChildContent>
                            </RadzenFormField>

                            <RadzenFormField Text="@localizer["CodeCat"]">
                                <Start><RadzenIcon Icon="category" /></Start>
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="system.CodeCategorie" Name="CodeCat" Style="width: 100%;" />
                                </ChildContent>
                            </RadzenFormField>

                            <RadzenFormField Text="@localizer["EtbSec"]">
                                <Start><RadzenIcon Icon="business" /></Start>
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="system.EtbSecondaire" Name="EtbSec" Style="width: 100%;" />
                                </ChildContent>
                            </RadzenFormField>

                            <RadzenFormField Text="RIB">
                                <Start><RadzenIcon Icon="account_balance" /></Start>
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="system.Rib" Name="Rib" Style="width: 100%;" />
                                </ChildContent>
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenTabsItem>

                <RadzenTabsItem Text="Fiscal & Taxes" Icon="account_balance">
                    <RadzenAlert AlertStyle="AlertStyle.Info" Style="margin-bottom: 20px;">
                        <RadzenIcon Icon="info" Style="margin-right: 8px;" />
                        <strong>Note importante :</strong> Les paramètres suivants ont été déplacés vers les exercices comptables (Accounting Year) : Timbre Fiscal, Taux FODEC, Taux de Retenue à la Source, Montant TVA par défaut, Seuil Retenue à la Source, et les 4 taux de TVA (0%, 7%, 13%, 19%). 
                        Veuillez les configurer dans la section <a href="/accounting-years" style="color: #1976d2; text-decoration: underline;">Exercices Comptables</a>.
                    </RadzenAlert>
                    <RadzenRow Class="g-2 mb-4">
                        <RadzenColumn Size="12" SizeSM="6" Class="d-flex flex-column gap-3">

                            <RadzenFormField Text="@localizer["discount_percentage"]">
                                <Start><RadzenIcon Icon="percent" /></Start>
                                <ChildContent>
                                    <RadzenNumeric @bind-Value="system.DiscountPercentage" Name="DiscountPercentage" Style="width: 100%;" Format="@AmountHelper.FORMAT_N2" Step="0.01" />
                                </ChildContent>
                            </RadzenFormField>
                        </RadzenColumn>

                        <RadzenColumn Size="12" SizeSM="6" Class="d-flex flex-column gap-3">
                            <RadzenFormField Text="Nombre de décimales">
                                <Start><RadzenIcon Icon="numbers" /></Start>
                                <ChildContent>
                                    <RadzenDropDown TValue="int" @bind-Value="system.DecimalPlaces" Data="@(new[] { new { Value = 2, Text = "2" }, new { Value = 3, Text = "3" } })" TextProperty="Text" ValueProperty="Value" Style="width: 100%;" Name="DecimalPlaces" />
                                </ChildContent>
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenTabsItem>

                <RadzenTabsItem Text="Paramètres de stock" Icon="inventory">
                    <RadzenRow Class="g-2 mb-4">
                        <RadzenColumn Size="12" Class="d-flex flex-column gap-3">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="Radzen.AlignItems.Center" Style="width: fit-content;">
                                <RadzenCheckBox @bind-Value="system.BloquerVenteStockInsuffisant" Name="BloquerVenteStockInsuffisant" />
                                <RadzenLabel Text="Bloquer la vente en cas de stock insuffisant" Style="margin: 0;" />
                            </RadzenStack>
                            <RadzenLabel Text="Si activé, les ventes seront bloquées lorsque le stock disponible est insuffisant. Si désactivé, un avertissement sera affiché mais la vente sera autorisée." Style="color: #666; font-size: 0.9em; margin-top: 5px;" />
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenTabsItem>
            </Tabs>
        </RadzenTabs>

        <RadzenRow Style="margin-top: 15px;">
            <RadzenColumn Size="12" Style="text-align: center;">
                <RadzenButton ButtonType="Radzen.ButtonType.Submit"
                Text="@localizer["save_label"]"
                Icon="save"
                Style="width: 200px;" />
            </RadzenColumn>
        </RadzenRow>
    </RadzenTemplateForm>
</RadzenCard>

@code {
    private GetAppParametersResponse system = new GetAppParametersResponse();
    [Inject] ToastService toastService { get; set; } = default!;
    [Inject] DialogService dialogService { get; set; } = default!;
    private CancellationToken cancellationToken = new CancellationToken();
    private EventCallback<GetAppParametersResponse> OnSubmit => EventCallback.Factory.Create<GetAppParametersResponse>(this, HandleValidSubmit);

    protected override async Task OnInitializedAsync()
    {
        var systemResult = await appParametersService.GetAppParametersAsync(cancellationToken);
        if (systemResult.IsT0)
        {
            system = systemResult.AsT0;
            return;
        }
        navigationManager.NavigateTo("/error");
    }

    private async Task HandleValidSubmit(GetAppParametersResponse model)
    {

        var updateAppParametersResult = await appParametersService.UpdateAppParametersAsync(
            new UpdateAppParametersRequest
				{
					NomSociete = system.NomSociete,
					Email = system.Email,
					Tel = system.Tel,
					Fax = system.Fax,
					Adresse = system.Adresse,
					MatriculeFiscale = system.MatriculeFiscale,
					CodeTva = system.CodeTva,
					CodeCategorie = system.CodeCategorie,
					AdresseRetenu = system.AdresseRetenu,
					EtbSecondaire = system.EtbSecondaire,
					Rib = system.Rib,
					DiscountPercentage = system.DiscountPercentage,
					BloquerVenteStockInsuffisant = system.BloquerVenteStockInsuffisant,
					DecimalPlaces = system.DecimalPlaces
				}, cancellationToken);

        if (updateAppParametersResult.IsT0)
        {
            if (updateAppParametersResult.AsT0 == ResponseTypes.Success)
            {
                toastService.Notify(new(ToastType.Success, $"Updated app parameters with success "));
                navigationManager.NavigateTo("/app_parameters");
                return;
            }

            navigationManager.NavigateTo("/error");
            return;
        }

		await ShowErrorsDialog(updateAppParametersResult.AsT1.ToErrorsList());
    }

    private async Task ShowErrorsDialog(List<string> errorList)
    {
        await dialogService.OpenAsync("Validation Errors", ds => @<div style="padding:10px;">
        <ul style="margin:0; padding-left: 20px;">
            @foreach (var error in errorList)
        {
            <li>@error</li>
        }
        </ul>
    </div>, new DialogOptions()
          {
              CloseDialogOnOverlayClick = true,
              Draggable = true,
              Resizable = true
          });
    }

}
