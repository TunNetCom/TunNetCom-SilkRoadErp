@page "/manage-invoice"

@using Microsoft.Extensions.Localization
@using Radzen.Blazor
@using Radzen
@using BlazorBootstrap
@using System.Globalization
@using TunNetCom.SilkRoadErp.Sales.Contracts.Customers
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote.Requests
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote.Responses
@using TunNetCom.SilkRoadErp.Sales.Contracts.Invoice
@using TunNetCom.SilkRoadErp.Sales.Contracts.Sorting
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Customers
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.DeliveryNote
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Invoices
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AppParameters
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.RetenueSourceClient
@using TunNetCom.SilkRoadErp.Sales.Contracts.RetenueSourceClient
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Reports.Invoices.PrintInvoiceWithDetails
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Reports.Invoices.RetenueSource

@inject ICustomersApiClient customerService
@inject IInvoicesApiClient invoicesService
@inject IDeliveryNoteApiClient deliveryNoteService
@inject IAppParametersClient appParametersClient
@inject IRetenueSourceClientApiClient retenueSourceClientApiClient
@inject NavigationManager navigationManager
@inject IStringLocalizer<SharedResource> Localizer
@inject ToastService toastService
@inject NotificationService NotificationService
@inject PrintRetenuSourceService PrintRetenuSourceService
@inject PrintFullInvoiceService PrintFullInvoiceService
@inject DialogService DialogService
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Infrastructure.IPrintService PrintService
@inject TunNetCom.SilkRoadErp.Sales.HttpClients.Services.PrintHistory.IPrintHistoryClient PrintHistoryClient
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Pages.DeliveryNotes
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Pages.PrintHistory
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using static TunNetCom.SilkRoadErp.Sales.Domain.Entites.DocumentTypes

<div style="padding: 0.5rem 1.5rem 1.5rem 1.5rem; min-height: 100vh;">
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
        <label style="font-weight: 600;
                      font-size: 0.9rem;
                      white-space: nowrap;
                      margin: 0;">
            @Localizer["select_customer"]
        </label>
        <RadzenDropDownDataGrid AllowClear="true"
                                IsLoading="@isLoadingCustomers"
                                @bind-Value="@SelectedCustomerId"
                                LoadData="@LoadCustomers"
                                AllowFiltering="true"
                                Style="flex: 1;
                                       max-width: 500px;
                                       border-radius: 8px;
                                       border: 1px solid #e0e0e0;
                                       transition: all 0.2s ease;"
                                Data="@_filteredCustomers"
                                TextProperty="@nameof(CustomerResponse.Name)"
                                ValueProperty="@nameof(CustomerResponse.Id)"
                                Placeholder="@Localizer["select_customer"]"
                                Class="custom-dropdown">
            <Columns>
                <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Id)"
                                              Title="ID"
                                              Width="100px" />
                <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Name)"
                                              Title="Name"
                                              Width="300px" />
            </Columns>
        </RadzenDropDownDataGrid>
        <!-- Print Buttons -->
        <div style="display: flex; gap: 0.75rem; margin-left: auto;">
            <RadzenButton ButtonStyle="ButtonStyle.Light"
                          Size="ButtonSize.Small"
                          Style="padding: 0.25rem 0.75rem; border-radius: 4px;"
                          Click="@PrintRetenuSourceClick">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <RadzenIcon Icon="description" Style="font-size: 14px;" />
                    <span style="font-size: 0.85rem;">Retenu</span>
                </div>
            </RadzenButton>
            <RadzenButton ButtonStyle="ButtonStyle.Light"
                          Size="ButtonSize.Small"
                          Style="padding: 0.25rem 0.75rem; border-radius: 4px;"
                          Click="@PrintInvoiceClick">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <RadzenIcon Icon="get_app" Style="font-size: 14px;" />
                    <span style="font-size: 0.85rem;">Facture</span>
                </div>
            </RadzenButton>
        </div>
    </div>

    <!-- Main Content -->
    <RadzenRow Gap="2rem">
       
        <!-- Invoiced Delivery Notes Section -->
        <RadzenColumn Size="12" SizeMD="6" SizeLG="6">
            <RadzenCard Variant="Variant.Flat"
                        Style="padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                            <RadzenDataGrid @ref="_grid"
                                            AllowRowSelectOnRowClick="true"
                                            AllowFiltering="true"
                                            FilterPopupRenderMode="PopupRenderMode.OnDemand"
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                            AllowPaging="true"
                                            PageSize="_defaultPageSize"
                                            PagerHorizontalAlign="HorizontalAlign.Left"
                                            ShowPagingSummary="true"
                                            Count="_getDeliveryNotesWithSummariesResponse.GetDeliveryNoteBaseInfos.TotalCount"
                                            AllowSorting="true"
                                            GotoFirstPageOnSort="true"
                                            TItem="GetDeliveryNoteBaseInfos"
                                            Data="@_getDeliveryNotesWithSummariesResponse.GetDeliveryNoteBaseInfos.Items"
                                            LoadData="@LoadInvoicedDeliveryNoteData"
                                            SelectionMode="DataGridSelectionMode.Multiple"
                                            IsLoading="@isLoadingDeliveryNotesInCurrentInvoice"
                                            @bind-Value="@_selectedDeliveryNotesToDetach"
                                            Style="border: none;"
                                            Class="custom-grid">
                                <EmptyTemplate>
                                    <p style="font-size: 24px; text-align: center; margin: 2rem;">No records to display.</p>
                                </EmptyTemplate>
                                <HeaderTemplate>
                                    <div style="display: flex; align-items: center; margin-bottom: 0.75rem; gap: 1rem;">
                                        <div style="font-size: 1.1rem; font-weight: 600;">
                                            @Localizer["delivery_notes_details"]
                                        </div>
                                        <div style="margin-left: auto;">
                                            <RadzenButton Text="@Localizer["detach_from_invoice"]"
                                                          Click="@DetachDeliveryNotesFromInvoice"
                                                          Disabled="@(SelectedInvoiceId == 0 || !_selectedDeliveryNotesToDetach.Any())"
                                                          ButtonStyle="ButtonStyle.Primary"
                                                          Size="ButtonSize.Small"
                                                          Style="border-radius: 6px; padding: 0.4rem 0.8rem; font-weight: 500; font-size: 0.85rem;" />
                                        </div>
                                    </div>
                                </HeaderTemplate>
                                <Columns>
                                    <RadzenDataGridColumn Property="@nameof(GetDeliveryNoteBaseInfos.Number)"
                                                          Title="@Localizer["number"]"
                                                          Width="140px" />
                                    <RadzenDataGridColumn Property="@nameof(GetDeliveryNoteBaseInfos.GrossAmount)"
                                                          Title="@Localizer["total_ex_tax"]"
                                                          Width="140px">
                                        <Template Context="detail">
                                            @detail.GrossAmount.FormatAmount()
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn Property="@nameof(GetDeliveryNoteBaseInfos.NetAmount)"
                                                          Title="@Localizer["net_payer"]"
                                                          Width="140px">
                                        <Template Context="detail">
                                            @detail.NetAmount.FormatAmount()
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                            <!-- Delivery Notes Summary -->
                            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e0e0e0; flex-wrap: wrap;">
                                <span style="font-size: 0.85rem; color: #666;">
                                    @Localizer["total_net"]: <strong style="color: #333;">@_getDeliveryNotesWithSummariesResponse?.TotalNetAmount.FormatAmount()</strong>
                                </span>
                                <span style="font-size: 0.85rem; color: #666;">
                                    @Localizer["total_gross"]: <strong style="color: #333;">@_getDeliveryNotesWithSummariesResponse?.TotalGrossAmount.FormatAmount()</strong>
                                </span>
                                <span style="font-size: 0.85rem; color: #666;">
                                    @Localizer["total_vat"]: <strong style="color: #333;">@_getDeliveryNotesWithSummariesResponse?.TotalVatAmount.FormatAmount()</strong>
                                </span>
                            </div>
            </RadzenCard>
        </RadzenColumn>
         <!-- Invoices Section -->
        <RadzenColumn Size="12" SizeMD="6" SizeLG="6">
            <RadzenCard Variant="Variant.Flat"
                        Style="padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <RadzenDataGrid @ref="InvoiceGrid"
                                AllowFiltering="true"
                                AllowPaging="true"
                                PageSize="_defaultPageSize"
                                PagerHorizontalAlign="HorizontalAlign.Left"
                                ShowPagingSummary="true"
                                AllowSorting="true"
                                Count="@getInvoiceListWithSummary.Invoices.TotalCount"
                                Data="@getInvoiceListWithSummary.Invoices.Items"
                                LoadData="@LoadInvoiceData"
                                @bind-Value="@SelectedInvoice"
                                IsLoading="@isLoadingInvoices"
                                SelectionMode="DataGridSelectionMode.Single"
                                Style="border: none;"
                                Class="custom-grid">
                    <EmptyTemplate>
                        <p style="font-size: 24px; text-align: center; margin: 2rem;">No records to display.</p>
                    </EmptyTemplate>
                    <HeaderTemplate>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding-bottom: 0.75rem;">
                            <div style="font-size: 1.1rem; font-weight: 600;">
                                @Localizer["customer_invoice_details"]
                            </div>
                            <RadzenButton Icon="add"
                                          Text="@Localizer["create_new_invoice"]"
                                          ButtonStyle="ButtonStyle.Success"
                                          Size="ButtonSize.Small"
                                          Disabled="@(SelectedCustomerId <= 0)"
                                          Click="@CreateNewInvoice"
                                          Style="border-radius: 6px; padding: 0.4rem 0.8rem; font-weight: 500; font-size: 0.85rem;" />
                        </div>
                    </HeaderTemplate>
                    <Columns>
                        <RadzenDataGridColumn Property="@nameof(InvoiceResponse.Number)"
                                              Title="@Localizer["invoice_number"]"
                                              Width="140px" />
                        <RadzenDataGridColumn Property="@nameof(InvoiceResponse.Date)"
                                              Title="@Localizer["date"]"
                                              FormatString="{0:d}"
                                              Width="140px" />
                        <RadzenDataGridColumn Property="@nameof(InvoiceResponse.TotalIncludingTaxAmount)"
                                              Title="@Localizer["total_incl_tax"]"
                                              Width="140px">
                            <Template Context="detail">
                                @detail.TotalIncludingTaxAmount.FormatAmount()
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Title="@Localizer["retenue_status"]"
                                              Width="120px">
                            <Template Context="detail">
                                @if (detail.TotalIncludingTaxAmount >= _seuilRetenueSource)
                                {
                                    var hasRetenue = _retenueMap.ContainsKey(detail.Number);
                                    @if (hasRetenue)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="@Localizer["retenue_exists"]" />
                                    }
                                    else
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@Localizer["retenue_not_exists"]" />
                                    }
                                }
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Title="@Localizer["retenue_action"]"
                                              Width="120px">
                            <Template Context="detail">
                                @if (detail.TotalIncludingTaxAmount >= _seuilRetenueSource)
                                {
                                    <RadzenButton Icon="@(_retenueMap.ContainsKey(detail.Number) ? "edit" : "add")" 
                                                  ButtonStyle="ButtonStyle.Info" 
                                                  Size="ButtonSize.Small"
                                                  Title="@Localizer["retenue_source"]"
                                                  Click="@(() => OpenRetenueDialog(detail.Number, detail.TotalIncludingTaxAmount))" />
                                }
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
                <!-- Invoice Summary -->
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e0e0e0; flex-wrap: wrap;">
                    <span style="font-size: 0.85rem; color: #666;">
                        @Localizer["total_net"]: <strong style="color: #333;">@getInvoiceListWithSummary.TotalIncludingTaxAmount.FormatAmount()</strong>
                    </span>
                    <span style="font-size: 0.85rem; color: #666;">
                        @Localizer["total_gross"]: <strong style="color: #333;">@getInvoiceListWithSummary.TotalExcludingTaxAmount.FormatAmount()</strong>
                    </span>
                    <span style="font-size: 0.85rem; color: #666;">
                        @Localizer["total_vat"]: <strong style="color: #333;">@getInvoiceListWithSummary.TotalVATAmount.FormatAmount()</strong>
                    </span>
                </div>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Uninvoiced Delivery Notes Section -->
    <RadzenRow Style="margin-top: 2rem;">
        <RadzenColumn Size="12">
            <RadzenCard Variant="Variant.Flat"
                        Style="padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <RadzenDataGrid @ref="_grid"
                                AllowRowSelectOnRowClick="true"
                                AllowFiltering="true"
                                FilterPopupRenderMode="PopupRenderMode.OnDemand"
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                AllowPaging="true"
                                PagerHorizontalAlign="HorizontalAlign.Left"
                                ShowPagingSummary="true"
                                PageSize="_defaultPageSize"
                                Count="@_uninvoicedDeliveryNotesSummary.GetDeliveryNoteBaseInfos.TotalCount"
                                AllowSorting="true"
                                Data="@_uninvoicedDeliveryNotesSummary.GetDeliveryNoteBaseInfos.Items"
                                LoadData="LoadUninvoicedDeliveryNotesData"
                                IsLoading="@isLoadingUninvoicedDeliveryNotes"
                                SelectionMode="DataGridSelectionMode.Multiple"
                                @bind-Value="@_selectedDeliveryNotesToAttach"
                                Style="border: none;"
                                Class="custom-grid">
                    <EmptyTemplate>
                        <p style="font-size: 24px; text-align: center; margin: 2rem;">No records to display.</p>
                    </EmptyTemplate>
                    <HeaderTemplate>
                        <div style="display: flex; align-items: center; margin-bottom: 0.75rem; gap: 1rem;">
                            <div style="font-size: 1.1rem; font-weight: 600;">
                                @Localizer["uninvoiced_delivery_notes_details"]
                            </div>
                            <div style="margin-left: auto;">
                                <RadzenButton Click="@(args => AttachDeliveryNoteToInvoiceClick("Primary button"))"
                                              Text="@Localizer["attach_delivery_note_to_invoice"]"
                                              ButtonStyle="ButtonStyle.Primary"
                                              Size="ButtonSize.Small"
                                              Style="border-radius: 6px; padding: 0.4rem 0.8rem; font-weight: 500; font-size: 0.85rem;" />
                            </div>
                        </div>
                    </HeaderTemplate>
                    <Columns>
                        <RadzenDataGridColumn Property="@nameof(GetDeliveryNoteBaseInfos.Number)"
                                              Title="@Localizer["number"]"
                                              Width="140px" />
                        <RadzenDataGridColumn Property="@nameof(GetDeliveryNoteBaseInfos.NetAmount)"
                                              Title="@Localizer["total_ex_tax"]"
                                              Width="140px">
                            <Template Context="detail">
                                @detail.NetAmount.FormatAmount()
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(GetDeliveryNoteBaseInfos.GrossAmount)"
                                              Title="@Localizer["net_payer"]"
                                              Width="140px">
                            <Template Context="detail">
                                @detail.GrossAmount.FormatAmount()
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
                <!-- Uninvoiced Delivery Notes Summary -->
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e0e0e0; flex-wrap: wrap;">
                    <span style="font-size: 0.85rem; color: #666;">
                        @Localizer["total_net"]: <strong style="color: #333;">@_uninvoicedDeliveryNotesSummary?.TotalNetAmount.FormatAmount()</strong>
                    </span>
                    <span style="font-size: 0.85rem; color: #666;">
                        @Localizer["total_gross"]: <strong style="color: #333;">@_uninvoicedDeliveryNotesSummary?.TotalGrossAmount.FormatAmount()</strong>
                    </span>
                    <span style="font-size: 0.85rem; color: #666;">
                        @Localizer["total_vat"]: <strong style="color: #333;">@_uninvoicedDeliveryNotesSummary?.TotalVatAmount.FormatAmount()</strong>
                    </span>
                </div>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
</div>

<style>
    .custom-dropdown {
        --rz-dropdown-border-hover: #4f46e5;
        --rz-dropdown-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
    }
    .custom-dropdown .rz-dropdown-panel {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }
    .custom-dropdown .rz-dropdown-item:hover {
        background: #f9fafb;
    }
    .custom-dropdown:hover {
        border-color: #007bff;
    }
    .custom-grid .rz-datatable {
        border: none !important;
        background-color: transparent;
    }
    .custom-grid .rz-datatable-thead {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
    }
    .custom-grid .rz-datatable-tbody tr:hover {
        background-color: #f1f3f5;
    }
</style>
@code {
    #region Fields and Properties
    private const int _defaultPageSize = 5;
    private int _selectedCustomerId;
    private int SelectedCustomerId
    {
        get => _selectedCustomerId;
        set
        {
            if (_selectedCustomerId != value)
            {
                _selectedCustomerId = value;
                SelectedInvoiceId = 0;
                SelectedInvoice = new List<InvoiceResponse>();
                getInvoiceListWithSummary = new GetInvoiceListWithSummary();
                _uninvoicedDeliveryNotes = new List<GetDeliveryNoteBaseInfos>();
                _uninvoicedDeliveryNotesSummary = new GetDeliveryNotesWithSummariesResponse();
                _getDeliveryNotesWithSummariesResponse = new GetDeliveryNotesWithSummariesResponse();
                if (value > 0)
                {
                    _ = LoadInvoicesForCustomers();
                    _ = LoadUninvoicedDeliveryNotes(value);
                }
            }
        }
    }
    private int _selectedInvoiceId;
    private int SelectedInvoiceId
    {
        get => _selectedInvoiceId;
        set
        {
            if (_selectedInvoiceId != value)
            {
                _selectedInvoiceId = value;
                _ = LoadInvoicesForCustomers();
                _ = LoadDeliveryNotesForSelectedInvoice(value);
            }
        }
    }
    private IList<InvoiceResponse> _selectedInvoices = new List<InvoiceResponse>();
    private IList<InvoiceResponse> SelectedInvoice
    {
        get => _selectedInvoices;
        set
        {
            _selectedInvoices = value;
            var selectedInvoice = _selectedInvoices?.FirstOrDefault();
            _ = LoadDeliveryNotesForSelectedInvoice(selectedInvoice?.Number ?? 0);
        }
    }

    bool isLoadingCustomers = false;
    bool isLoadingInvoices = false;
    bool isLoadingDeliveryNotesInCurrentInvoice = false;
    bool isLoadingUninvoicedDeliveryNotes = false;
    private List<CustomerResponse> _filteredCustomers { get; set; } = new();
    private GetInvoiceListWithSummary getInvoiceListWithSummary { get; set; } = new GetInvoiceListWithSummary();
    private IList<GetDeliveryNoteBaseInfos> _selectedDeliveryNoteIdsToDetach = new List<GetDeliveryNoteBaseInfos>();
    private IList<GetDeliveryNoteBaseInfos> _uninvoicedDeliveryNotes { get; set; } = new List<GetDeliveryNoteBaseInfos>();
    private IList<GetDeliveryNoteBaseInfos> _selectedDeliveryNotesToAttach { get; set; } = new List<GetDeliveryNoteBaseInfos>();
    private CancellationTokenSource _cancellationTokenSource = new();
    private RadzenDataGrid<GetDeliveryNoteBaseInfos> _grid;
    private RadzenDataGrid<InvoiceResponse> InvoiceGrid;
    private GetDeliveryNotesWithSummariesResponse _uninvoicedDeliveryNotesSummary = new GetDeliveryNotesWithSummariesResponse();
    private GetDeliveryNotesWithSummariesResponse _getDeliveryNotesWithSummariesResponse = new GetDeliveryNotesWithSummariesResponse();
    private IList<GetDeliveryNoteBaseInfos> _selectedDeliveryNotesToDetach
    {
        get => _selectedDeliveryNoteIdsToDetach;
        set => _selectedDeliveryNoteIdsToDetach = value;
    }
    private Dictionary<int, bool> _retenueMap = new Dictionary<int, bool>();
    private decimal _seuilRetenueSource = 1000;
    private double _tauxRetenu = 0;
    #endregion

    #region Lifecycle Methods
    protected override async Task OnInitializedAsync()
    {
        await SearchClients();
        await LoadAppParameters();
    }

    private async Task LoadAppParameters()
    {
        try
        {
            var appParamsResult = await appParametersClient.GetAppParametersAsync(_cancellationTokenSource.Token);
            if (appParamsResult.IsT0)
            {
                var appParams = appParamsResult.AsT0;
                _seuilRetenueSource = appParams.SeuilRetenueSource;
                _tauxRetenu = appParams.PourcentageRetenu;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["error"],
                Detail = $"Failed to load app parameters: {ex.Message}"
            });
        }
    }

    public void Dispose()
    {
        _cancellationTokenSource.Cancel();
        _cancellationTokenSource.Dispose();
    }
    #endregion

    #region Data Loading Methods
    private async Task LoadCustomers(LoadDataArgs args)
    {
        isLoadingCustomers = true;
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = _defaultPageSize,
            SearchKeyword = args.Filter
        };

        try
        {
            var pagedCustomers = await customerService.GetAsync(parameters, _cancellationTokenSource.Token);
            _filteredCustomers = pagedCustomers.Items;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Failed to load customers: {ex.Message}"
            });
            _filteredCustomers = new List<CustomerResponse>();
        }

        isLoadingCustomers = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task SearchClients()
    {
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = _defaultPageSize,
            SearchKeyword = null
        };

        _filteredCustomers = (await customerService.GetAsync(parameters, _cancellationTokenSource.Token)).Items;
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadDeliveryNotesForSelectedInvoice(int invoiceNum)
    {
        SelectedInvoiceId = invoiceNum;
        _getDeliveryNotesWithSummariesResponse = await deliveryNoteService.GetDeliveryNotesWithSummariesAsync(
                customerId: SelectedCustomerId,
                invoiceId: SelectedInvoiceId,
                isInvoiced: true,
                sortOrder: null,
                sortProperty: null,
                pageNumber: 1,
                pageSize: _defaultPageSize,
				searchKeyword: null,
                startDate:null,
				EndDate: null,
                cancellationToken: _cancellationTokenSource.Token
            );

        //TODO manage the case when no delivery notes are found
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadInvoicesForCustomers()
    {
        var parameters = new QueryStringParameters
        {
            //TODO remove magic numbers
            PageNumber = 1,
            PageSize = _defaultPageSize,
            SearchKeyword = null
        };

        if (SelectedCustomerId <= 0)
        {
            getInvoiceListWithSummary = new GetInvoiceListWithSummary();
            await InvokeAsync(StateHasChanged);
            return;
        }

        var result = await invoicesService.GetInvoicesByCustomerIdWithSummary(
            SelectedCustomerId,
            parameters,
            _cancellationTokenSource.Token);

        if (result.IsT0)
        {
            getInvoiceListWithSummary = result.AsT0;
            // Load retenue status for all invoices
            await LoadRetenueStatus();
        }

        if (result.IsT1)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = result.AsT1.Detail
            });
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadRetenueStatus()
    {
        _retenueMap.Clear();
        if (getInvoiceListWithSummary?.Invoices?.Items == null)
        {
            return;
        }

        foreach (var invoice in getInvoiceListWithSummary.Invoices.Items)
        {
            try
            {
                var retenueResult = await retenueSourceClientApiClient.GetRetenueSourceClientAsync(invoice.Number, _cancellationTokenSource.Token);
                // Only set to true if the result is successful (IsSuccess = true means the API returned 200 OK with data)
                // If IsSuccess = false, it means either 404 (not found) or another error
                _retenueMap[invoice.Number] = retenueResult.IsSuccess;
            }
            catch
            {
                // On any exception, assume no retenue exists
                _retenueMap[invoice.Number] = false;
            }
        }
    }

    private async Task OpenRetenueDialog(int numFacture, decimal montantTTC)
    {
        try
        {
            // Check if retenue already exists
            var existingRetenueResult = await retenueSourceClientApiClient.GetRetenueSourceClientAsync(numFacture, _cancellationTokenSource.Token);
            var isEditMode = existingRetenueResult.IsSuccess;
            var existingNumTej = isEditMode ? existingRetenueResult.Value?.NumTej : null;
            
            // Load existing PDF if in edit mode
            string? existingPdfBase64 = null;
            if (isEditMode && existingRetenueResult.Value?.HasPdf == true)
            {
                try
                {
                    var pdfResult = await retenueSourceClientApiClient.GetRetenueSourceClientPdfAsync(numFacture, _cancellationTokenSource.Token);
                    if (pdfResult.IsSuccess)
                    {
                        existingPdfBase64 = Convert.ToBase64String(pdfResult.Value);
                    }
                }
                catch (Exception ex)
                {
                    // Log but don't block the dialog
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Warning,
                        Summary = Localizer["warning"],
                        Detail = $"Impossible de charger le PDF existant: {ex.Message}"
                    });
                }
            }

            var dialogOptions = new DialogOptions
            {
                Width = "500px",
                Resizable = true,
                Draggable = true
            };

            var result = await DialogService.OpenAsync<RetenueSourceDialog>(
                Localizer["retenue_source"],
                new Dictionary<string, object>
                {
                    { "NumFacture", numFacture },
                    { "MontantTTC", montantTTC },
                    { "TauxRetenu", _tauxRetenu },
                    { "SeuilRetenueSource", _seuilRetenueSource },
                    { "ExistingNumTej", existingNumTej },
                    { "IsEditMode", isEditMode },
                    { "ExistingPdfBase64", existingPdfBase64 }
                },
                dialogOptions);

            if (result is RetenueSourceDialog.RetenueSourceDialogResult dialogResult)
            {
                if (isEditMode)
                {
                    // Update existing retenue
                    var updateRequest = new UpdateRetenueSourceClientRequest
                    {
                        NumTej = dialogResult.NumTej ?? string.Empty,
                        PdfContent = dialogResult.PdfContent
                    };

                    var updateResult = await retenueSourceClientApiClient.UpdateRetenueSourceClientAsync(numFacture, updateRequest, _cancellationTokenSource.Token);
                    if (updateResult.IsSuccess)
                    {
                        toastService.Notify(new(ToastType.Success, Localizer["retenue_source"] + " " + Localizer["updated_with_success"]));
                    }
                    else
                    {
                        toastService.Notify(new(ToastType.Danger, updateResult.Errors.FirstOrDefault()?.Message ?? Localizer["Unexpected_Error"]));
                    }
                }
                else
                {
                    // Create new retenue
                    var createRequest = new CreateRetenueSourceClientRequest
                    {
                        NumFacture = numFacture,
                        NumTej = dialogResult.NumTej ?? string.Empty,
                        PdfContent = dialogResult.PdfContent
                    };

                    var createResult = await retenueSourceClientApiClient.CreateRetenueSourceClientAsync(createRequest, _cancellationTokenSource.Token);
                    if (createResult.IsT0)
                    {
                        toastService.Notify(new(ToastType.Success, Localizer["retenue_source"] + " " + Localizer["created_with_success"]));
                    }
                    else
                    {
                        var badRequest = createResult.AsT1;
                        toastService.Notify(new(ToastType.Danger, badRequest.Detail ?? "Erreur lors de la création"));
                    }
                }

                // Reload retenue status from API to ensure accuracy
                await LoadRetenueStatus();
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Error"],
                Detail = $"Erreur: {ex.Message}"
            });
        }
    }

    private async Task LoadUninvoicedDeliveryNotes(int selectedCustomerId)
    {
        SelectedCustomerId = selectedCustomerId;

        try
        {
            _uninvoicedDeliveryNotesSummary = await deliveryNoteService.GetDeliveryNotesWithSummariesAsync(
                customerId: SelectedCustomerId,
                invoiceId: null,
                isInvoiced: false,
                sortOrder: null,
                sortProperty: null,
                pageNumber: 1,
                pageSize: _defaultPageSize,
                searchKeyword: null,
                startDate:null,
                EndDate: null,
                cancellationToken: _cancellationTokenSource.Token
            );
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Failed to load uninvoiced delivery notes: {ex.Message}"
            });
            _uninvoicedDeliveryNotes = new List<GetDeliveryNoteBaseInfos>();
        }

        await InvokeAsync(StateHasChanged);
    }

    async Task OnSort(DataGridColumnSortEventArgs<GetDeliveryNoteBaseInfos> args)
    {
        var columnName = args.Column.Property;
        var sortOrder = args.SortOrder;
        await FetchSortedDeliveryNotesAsync(columnName, sortOrder.ToString());
    }

    private async Task FetchSortedDeliveryNotesAsync(string columnName, string sortOrder)
    {
        _getDeliveryNotesWithSummariesResponse = await deliveryNoteService.GetDeliveryNotesWithSummariesAsync(
            customerId: SelectedCustomerId,
            invoiceId: SelectedInvoiceId,
            isInvoiced: true,
            pageNumber: 1,
            pageSize: _defaultPageSize,
            sortOrder: sortOrder,
            sortProperty: columnName,
            searchKeyword: null,
            startDate:null,
            EndDate: null,
            cancellationToken: _cancellationTokenSource.Token);
    }

    private async Task AttachDeliveryNoteToInvoiceClick(string text)
    {
        if (SelectedInvoiceId > 0 && _selectedDeliveryNotesToAttach?.Any() == true)
        {
            var deliveryNoteIds = _selectedDeliveryNotesToAttach.Select(dn => dn.Number).ToList();
            var attachToInvoiceRequest = new AttachToInvoiceRequest
            {
                InvoiceId = SelectedInvoiceId,
                DeliveryNoteIds = deliveryNoteIds
            };

            var result = await deliveryNoteService.AttachToInvoiceAsync(attachToInvoiceRequest, default);

            if (result)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = Localizer["success"],
                    Detail = Localizer["delivery_notes_attached"]
                });

                _selectedDeliveryNotesToAttach = new List<GetDeliveryNoteBaseInfos>();

                await LoadInvoicesForCustomers();
                await LoadDeliveryNotesForSelectedInvoice(SelectedInvoiceId);
                await LoadUninvoicedDeliveryNotes(_selectedCustomerId);

            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"]
                });
            }
        }
        else
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = Localizer["select_invoice_and_delivery_notes"]
            });
        }
    }

    private async Task DetachDeliveryNotesFromInvoice()
    {
        try
        {
            var deliveryNoteIds = _selectedDeliveryNotesToDetach.Select(dn => dn.Number).ToList();
            var request = new DetachFromInvoiceRequest
            {
                InvoiceId = SelectedInvoiceId,
                DeliveryNoteIds = deliveryNoteIds
            };

            var result = await deliveryNoteService.DetachFromInvoiceAsync(request, _cancellationTokenSource.Token);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = Localizer["success"],
                Detail = Localizer["delivery_notes_detached"]
            });
            await LoadInvoicesForCustomers();
            await LoadUninvoicedDeliveryNotes(_selectedCustomerId);
            await LoadDeliveryNotesForSelectedInvoice(_selectedInvoiceId);

            _selectedDeliveryNotesToDetach = new List<GetDeliveryNoteBaseInfos>();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = ex.Message
            });
            Console.WriteLine($"Error detaching delivery notes from invoice: {ex.Message}");
        }
    }

    void OnPage(PagerEventArgs args)
    {

    }

    async Task LoadInvoiceData(LoadDataArgs args)
    {
        string _sortProperty = null;
        string _sortOrder = null;
        if (args.Sorts != null && args.Sorts.Any())
        {
            var sort = args.Sorts.First();
            _sortProperty = sort.Property;
            _sortOrder = sort.SortOrder == SortOrder.Ascending ? SortConstants.Ascending : SortConstants.Descending;
        }
        var parameters = new QueryStringParameters
        {
            PageNumber = (args.Skip.Value / _defaultPageSize) + 1,
            PageSize = _defaultPageSize,
            SearchKeyword = args.Filter,
            SortOrder = _sortOrder,
            SortProprety = _sortProperty
        };
        if (SelectedCustomerId <= 0)
        {
            getInvoiceListWithSummary = new GetInvoiceListWithSummary();
            await InvokeAsync(StateHasChanged);
            return;
        }

        isLoadingInvoices = true;
        await Task.Yield(); // Forces UI to update and show spinner
        var result = await invoicesService.GetInvoicesByCustomerIdWithSummary(SelectedCustomerId, parameters, _cancellationTokenSource.Token);
        if (result.IsT0)
        {
            getInvoiceListWithSummary = result.AsT0;
        }

        if (result.IsT1)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = result.AsT1.Detail
            });
        }

        isLoadingInvoices = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadInvoicedDeliveryNoteData(LoadDataArgs args)
    {
        if (SelectedCustomerId <= 0 || SelectedInvoiceId <= 0)
        {
            return;
        }

        try
        {
            string _sortProperty = null;
            string _sortOrder = null;
            if (args.Sorts != null && args.Sorts.Any())
            {
                var sort = args.Sorts.First();
                _sortProperty = sort.Property;
                _sortOrder = sort.SortOrder == SortOrder.Ascending ? SortConstants.Ascending : SortConstants.Descending;
            }

            isLoadingDeliveryNotesInCurrentInvoice = true;
            _getDeliveryNotesWithSummariesResponse = await deliveryNoteService.GetDeliveryNotesWithSummariesAsync(
                    customerId: SelectedCustomerId,
                    invoiceId: SelectedInvoiceId,
                    isInvoiced: true,
                    sortOrder: _sortOrder,
                    sortProperty: _sortProperty,
                    pageNumber: (args.Skip.Value / _defaultPageSize) + 1,
                    pageSize: _defaultPageSize,
                    searchKeyword: null,
                    startDate:null,
                    EndDate: null,
                    cancellationToken: _cancellationTokenSource.Token
                            );

            isLoadingDeliveryNotesInCurrentInvoice = false;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Failed to load uninvoiced delivery notes: {ex.Message}"
            });
            _uninvoicedDeliveryNotes = new List<GetDeliveryNoteBaseInfos>();
        }
    }

    private async Task LoadUninvoicedDeliveryNotesData(LoadDataArgs args)
    {
        try
        {
            if (SelectedCustomerId <= 0)
            {
                return;
            }

            string _sortProperty = string.Empty;
            string _sortOrder = string.Empty;

            if (args.Sorts != null && args.Sorts.Any())
            {
                var sort = args.Sorts.First();
                _sortProperty = sort.Property;
                _sortOrder = sort.SortOrder == SortOrder.Ascending ? SortConstants.Ascending : SortConstants.Descending;
            }

            isLoadingUninvoicedDeliveryNotes = true;
            _uninvoicedDeliveryNotesSummary = await deliveryNoteService.GetDeliveryNotesWithSummariesAsync(
                customerId: SelectedCustomerId,
                invoiceId: null,
                isInvoiced: false,
                sortOrder: _sortOrder,
                sortProperty: _sortProperty,
                pageNumber: (args.Skip.Value / _defaultPageSize) + 1,
                pageSize: _defaultPageSize,
                searchKeyword: null,
                startDate:null,
                EndDate: null,
                cancellationToken: _cancellationTokenSource.Token);

            isLoadingUninvoicedDeliveryNotes = false;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Failed to load uninvoiced delivery notes: {ex.Message}"
            });
            _uninvoicedDeliveryNotes = new List<GetDeliveryNoteBaseInfos>();
        }
    }
    #endregion

    #region Create Invoice Methods
    async Task CreateNewInvoice()
    {
        if (SelectedCustomerId <= 0)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = Localizer["select_a_customer_before"]
            });
            return;
        }

        var result = await DialogService.OpenAsync<CreateInvoiceDialog>(
            Localizer["create_new_invoice"],
            new Dictionary<string, object> { { "InitialDate", DateTime.Now.Date } },
            new DialogOptions()
            {
                Width = "400px",
                Resizable = false,
                Draggable = true
            });

        if (result is DateTime selectedDate)
        {
            await CreateInvoiceWithDate(selectedDate);
        }
    }

    async Task CreateInvoiceWithDate(DateTime invoiceDate)
    {
        isLoadingInvoices = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var request = new CreateInvoiceRequest
            {
                Date = invoiceDate,
                ClientId = SelectedCustomerId
            };

            var result = await invoicesService.CreateInvoice(request, _cancellationTokenSource.Token);

            if (result.IsT0) // Success
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = Localizer["success"],
                    Detail = Localizer["invoice_created_successfully"]
                });

                // Refresh invoice list
                await LoadInvoicesForCustomers();
            }
            else if (result.IsT1) // BadRequestResponse
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = result.AsT1.Detail
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Failed to create invoice: {ex.Message}"
            });
        }
        finally
        {
            isLoadingInvoices = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    #endregion

    #region Print methods
    private async Task PrintRetenuSourceClick()
    {
        if (SelectedInvoiceId <= 0)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = Localizer["select_invoice"]
            });
            return;
        }

        var invoices = new List<int>() { SelectedInvoiceId };

        var pdfBytes = await PrintRetenuSourceService
        .GenerateRetenuSourcePdfAsync(invoices, cancellationToken: _cancellationTokenSource.Token);

        var fileName = $"Retenu à la source {SelectedInvoiceId}.pdf";
        await JS.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(pdfBytes.Value), "application/pdf");
    }

    private async Task PrintInvoiceClick()
    {
        if (SelectedInvoiceId <= 0)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = Localizer["select_invoice"]
            });
            return;
        }

        // Get current user info
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier);
        var usernameClaim = authState.User.FindFirst(ClaimTypes.Name);
        int? userId = userIdClaim != null && int.TryParse(userIdClaim.Value, out var uid) ? uid : null;
        string? username = usernameClaim?.Value;

        // Check if invoice has been printed before (for duplicata)
        bool isDuplicata = false;
        try
        {
            var existingHistory = await PrintHistoryClient.GetPrintHistoryByDocumentAsync(Facture, SelectedInvoiceId, _cancellationTokenSource.Token);
            isDuplicata = existingHistory.Any();
        }
        catch
        {
            // If we can't check, assume it's not a duplicata
        }

        var pdfBytes = await PrintFullInvoiceService
            .GenerateInvoicePdfAsync(SelectedInvoiceId, cancellationToken: _cancellationTokenSource.Token, isDuplicata: isDuplicata);

        var fileName = $"Invoice {SelectedInvoiceId}.pdf";
        
        // Use centralized print service with document tracking
        var printOptions = new TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Infrastructure.PrintOptions
        {
            Mode = TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Infrastructure.PrintMode.Download,
            FileName = fileName,
            DocumentType = Facture,
            DocumentId = SelectedInvoiceId,
            UserId = userId,
            Username = username,
            IsDuplicata = isDuplicata
        };

        await PrintService.PrintAsync(pdfBytes.Value, printOptions, _cancellationTokenSource.Token);
    }
    #endregion
}