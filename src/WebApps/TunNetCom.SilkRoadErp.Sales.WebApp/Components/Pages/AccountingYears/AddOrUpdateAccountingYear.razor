@page "/accounting-year/add"
@page "/accounting-year/edit/{Id:int}"
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.AccountingYear
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AccountingYear
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using Radzen.Blazor
@using Radzen
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> Localizer
@inject IAccountingYearApiClient AccountingYearService
@inject ToastService ToastService
@inject Radzen.NotificationService NotificationService
@inject IJSRuntime JSRuntime

<RadzenCard Style="padding: 20px; max-width: 1200px; margin: auto;">
    <RadzenTemplateForm Data="@accountingYear" Submit="@((CreateAccountingYearRequest formData) => OnFormSubmit(formData))">
        <div class="accounting-year-form-header">
            <h3>@(IsEditMode ? Localizer["Edit_Accounting_Year"] : Localizer["New_Accounting_Year"])</h3>
            <RadzenButton Icon="arrow_back" Text="@Localizer["Back"]"
                          ButtonStyle="ButtonStyle.Secondary"
                          Click="GoBack"
                          Variant="Variant.Outlined" />
        </div>

        <RadzenTabs RenderMode="TabRenderMode.Client">
            <Tabs>
                <RadzenTabsItem Text="Informations générales" Icon="info">
                <RadzenStack Gap="1.5rem">
                    <RadzenFormField Text="@($"{Localizer["Year"]} *")" class="rz-col-12">
                        <RadzenNumeric @bind-Value="accountingYear.Year" 
                                       Placeholder="@Localizer["Year_Placeholder"]" 
                                       Min="2000" 
                                       Max="2100" />
                    </RadzenFormField>

                    <RadzenFormField Text="@Localizer["Is_Active"]" class="rz-col-12">
                        <RadzenCheckBox @bind-Value="accountingYear.IsActive" />
                    </RadzenFormField>
                </RadzenStack>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Fiscal & Taxes" Icon="account_balance">
                <RadzenRow Class="g-2 mb-4">
                    <RadzenColumn Size="12" SizeSM="6" Class="d-flex flex-column gap-3">
                        <RadzenFormField Text="Timbre Fiscal">
                            <Start><RadzenIcon Icon="description" /></Start>
                            <ChildContent>
                                <RadzenNumeric @bind-Value="accountingYear.Timbre" Name="Timbre" Style="width: 100%;" Format="@AmountHelper.FORMAT_N3" Step="0.001" />
                            </ChildContent>
                        </RadzenFormField>

                        <RadzenFormField Text="Taux FODEC (%)">
                            <Start><RadzenIcon Icon="percent" /></Start>
                            <ChildContent>
                                <RadzenNumeric @bind-Value="accountingYear.PourcentageFodec" Name="PourcentageFodec" Style="width: 100%;" Format="@AmountHelper.FORMAT_N2" Step="0.01" />
                            </ChildContent>
                        </RadzenFormField>

                        <RadzenFormField Text="Taux Retenue à la Source (%)">
                            <Start><RadzenIcon Icon="assessment" /></Start>
                            <ChildContent>
                                <RadzenNumeric @bind-Value="accountingYear.PourcentageRetenu" Name="PourcentageRetenu" Style="width: 100%;" Format="@AmountHelper.FORMAT_N2" Step="0.01" />
                            </ChildContent>
                        </RadzenFormField>
                    </RadzenColumn>

                    <RadzenColumn Size="12" SizeSM="6" Class="d-flex flex-column gap-3">
                        <h4 style="margin-bottom: 15px;">Taux de TVA</h4>
                        
                        <RadzenFormField Text="Taux TVA 0%">
                            <Start><RadzenIcon Icon="percent" /></Start>
                            <ChildContent>
                                <RadzenNumeric @bind-Value="accountingYear.VatRate0" Name="VatRate0" Style="width: 100%;" Format="@AmountHelper.FORMAT_N2" Step="0.01" />
                            </ChildContent>
                        </RadzenFormField>

                        <RadzenFormField Text="Taux TVA 7%">
                            <Start><RadzenIcon Icon="percent" /></Start>
                            <ChildContent>
                                <RadzenNumeric @bind-Value="accountingYear.VatRate7" Name="VatRate7" Style="width: 100%;" Format="@AmountHelper.FORMAT_N2" Step="0.01" />
                            </ChildContent>
                        </RadzenFormField>

                        <RadzenFormField Text="Taux TVA 13%">
                            <Start><RadzenIcon Icon="percent" /></Start>
                            <ChildContent>
                                <RadzenNumeric @bind-Value="accountingYear.VatRate13" Name="VatRate13" Style="width: 100%;" Format="@AmountHelper.FORMAT_N2" Step="0.01" />
                            </ChildContent>
                        </RadzenFormField>

                        <RadzenFormField Text="Taux TVA 19%">
                            <Start><RadzenIcon Icon="percent" /></Start>
                            <ChildContent>
                                <RadzenNumeric @bind-Value="accountingYear.VatRate19" Name="VatRate19" Style="width: 100%;" Format="@AmountHelper.FORMAT_N2" Step="0.01" />
                            </ChildContent>
                        </RadzenFormField>

                        <RadzenFormField Text="Montant TVA par défaut">
                            <Start><RadzenIcon Icon="attach_money" /></Start>
                            <ChildContent>
                                <RadzenNumeric @bind-Value="accountingYear.VatAmount" Name="VatAmount" Style="width: 100%;" Format="@AmountHelper.FORMAT_N3" Step="0.001" />
                            </ChildContent>
                        </RadzenFormField>

                        <RadzenFormField Text="Seuil Retenue à la Source">
                            <Start><RadzenIcon Icon="trending_up" /></Start>
                            <ChildContent>
                                <RadzenNumeric @bind-Value="accountingYear.SeuilRetenueSource" Name="SeuilRetenueSource" Style="width: 100%;" Format="@AmountHelper.FORMAT_N3" Step="0.001" />
                            </ChildContent>
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenTabsItem>
            </Tabs>
        </RadzenTabs>

        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" JustifyContent="Radzen.JustifyContent.End" class="rz-col-12" Style="margin-top: 1.5rem;">
            <RadzenButton Text="@Localizer["Cancel"]" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Outlined" Click="GoBack" />
            <RadzenButton Text="@(IsEditMode ? Localizer["Update"] : Localizer["Create"])" 
                          ButtonType="Radzen.ButtonType.Submit"
                          ButtonStyle="ButtonStyle.Primary" 
                          IsBusy="@isSaving" />
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenCard>

<style>
    .accounting-year-form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e0e0e0;
    }

    .accounting-year-form-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }
</style>

@code {
    [Parameter] public int? Id { get; set; }
    
    private bool IsEditMode => Id.HasValue;
    private bool isSaving = false;
    private CreateAccountingYearRequest accountingYear = new();
    private CancellationTokenSource cancellationTokenSource = new();

    protected override async Task OnInitializedAsync()
    {
        if (IsEditMode && Id.HasValue)
        {
            try
            {
                var existingYear = await AccountingYearService.GetAccountingYearByIdAsync(Id.Value, cancellationTokenSource.Token);
                if (existingYear != null)
                {
                    accountingYear = new CreateAccountingYearRequest
                    {
                        Year = existingYear.Year,
                        IsActive = existingYear.IsActive,
                        Timbre = existingYear.Timbre,
                        PourcentageFodec = existingYear.PourcentageFodec,
                        VatRate0 = existingYear.VatRate0,
                        VatRate7 = existingYear.VatRate7,
                        VatRate13 = existingYear.VatRate13,
                        VatRate19 = existingYear.VatRate19,
                        PourcentageRetenu = existingYear.PourcentageRetenu,
                        VatAmount = existingYear.VatAmount,
                        SeuilRetenueSource = existingYear.SeuilRetenueSource
                    };
                }
            }
            catch (Exception ex)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["Error"],
                    Detail = $"{Localizer["Error_Loading_Accounting_Year"]}: {ex.Message}"
                });
            }
        }
    }

    async Task OnFormSubmit(CreateAccountingYearRequest formData)
    {
        // Don't use formData - it may not have values from tabs
        // Instead, use the current accountingYear model which should have the bound values
        // Force StateHasChanged to ensure all bindings are updated
        StateHasChanged();
        await Task.Delay(50);
        
        await SaveAccountingYear();
    }

    async Task SaveAccountingYear()
    {
        if (accountingYear.Year < 2000 || accountingYear.Year > 2100)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Validation"],
                Detail = Localizer["Year_Invalid_Range"]
            });
            return;
        }

        // Force form validation and update model
        // This ensures that values from RadzenNumeric fields are properly bound
        StateHasChanged();
        await Task.Delay(100); // Small delay to ensure binding is complete

        isSaving = true;
        try
        {
            if (IsEditMode && Id.HasValue)
            {
                var updateRequest = new UpdateAccountingYearRequest
                {
                    Year = accountingYear.Year,
                    IsActive = accountingYear.IsActive,
                    Timbre = accountingYear.Timbre,
                    PourcentageFodec = accountingYear.PourcentageFodec,
                    VatRate0 = accountingYear.VatRate0,
                    VatRate7 = accountingYear.VatRate7,
                    VatRate13 = accountingYear.VatRate13,
                    VatRate19 = accountingYear.VatRate19,
                    PourcentageRetenu = accountingYear.PourcentageRetenu,
                    VatAmount = accountingYear.VatAmount,
                    SeuilRetenueSource = accountingYear.SeuilRetenueSource
                };
                
                await AccountingYearService.UpdateAccountingYearAsync(Id.Value, updateRequest, cancellationTokenSource.Token);
                ToastService.Notify(new(ToastType.Success, Localizer["Accounting_Year_Updated"]));
                NavigationManager.NavigateTo("/accounting-years");
            }
            else
            {
                var result = await AccountingYearService.CreateAccountingYearAsync(accountingYear, cancellationTokenSource.Token);
                if (result > 0)
                {
                    ToastService.Notify(new(ToastType.Success, Localizer["Accounting_Year_Created"]));
                    NavigationManager.NavigateTo("/accounting-years");
                }
            }
        }
        catch (HttpRequestException ex)
        {
            string errorMessage;
            var message = ex.Message.ToLowerInvariant();
            
            if (message.Contains("accounting_year_used_cannot_modify") || 
                message.Contains("accounting year is used") || 
                message.Contains("used_cannot_modify") ||
                message.Contains("ne peut pas être modifié"))
            {
                errorMessage = Localizer["Accounting_Year_Used_Cannot_Modify"];
            }
            else if (message.Contains("accounting_year_already_exists") || 
                     message.Contains("accounting year already exists") ||
                     message.Contains("already_exists"))
            {
                errorMessage = Localizer["Accounting_Year_Already_Exists"];
            }
            else if (message.Contains("accounting_year_not_found") || message.Contains("accounting year not found"))
            {
                errorMessage = Localizer["Accounting_Year_Not_Found"];
            }
            else
            {
                // Try to extract a more user-friendly error message from the response
                var errorDetail = ex.Message;
                if (ex.Message.Contains("400"))
                {
                    errorDetail = Localizer["Error_Updating_Accounting_Year_Validation"];
                }
                errorMessage = $"{Localizer["Error_Saving"]}: {errorDetail}";
            }

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Error"],
                Detail = errorMessage,
                Duration = 10000 // Show for 10 seconds to ensure user sees it
            });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Error"],
                Detail = $"{Localizer["Error_Saving"]}: {ex.Message}"
            });
        }
        finally
        {
            isSaving = false;
        }
    }

    void GoBack()
    {
        NavigationManager.NavigateTo("/accounting-years");
    }

    public void Dispose()
    {
        cancellationTokenSource.Cancel();
        cancellationTokenSource.Dispose();
    }
}
