@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.PaiementClient
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.PaiementClient
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Customers
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Invoices
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.DeliveryNote
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Banque
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AccountingYear
@using TunNetCom.SilkRoadErp.Sales.Contracts.Customers
@using TunNetCom.SilkRoadErp.Sales.Contracts.Invoice
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote.Responses
@using TunNetCom.SilkRoadErp.Sales.Contracts.Sorting
@using TunNetCom.SilkRoadErp.Sales.Contracts.Banque
@using TunNetCom.SilkRoadErp.Sales.Domain.Entites
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@using Radzen.Blazor
@using Radzen
@inject IStringLocalizer<SharedResource> Localizer
@inject IPaiementClientApiClient PaiementClientService
@inject ICustomersApiClient CustomersService
@inject IInvoicesApiClient InvoicesService
@inject IDeliveryNoteApiClient DeliveryNoteService
@inject IBanqueApiClient BanqueService
@inject IAccountingYearApiClient AccountingYearService
@inject ToastService ToastService
@inject Radzen.NotificationService NotificationService
@inject DialogService DialogService
@inject IDecimalFormatService DecimalFormatService

<ErrorBoundary @ref="_errorBoundary">
    <ChildContent>
<RadzenStack Gap="1.5rem">
    @{
        // #region agent log
        try { DebugLog.Write("CreatePaiementFromBlDialog:render", "Rendering", new { d = DeliveryNoteId, c = CustomerId, i = InvoiceId }, "H3"); } catch { }
        // #endregion
    }
    <RadzenFormField Text="@Localizer["Numero"]" class="rz-col-12 rz-md-6">
        <RadzenTextBox @bind-Value="paiement.NumeroTransactionBancaire" Placeholder="@Localizer["Numero_Transaction_Bancaire"]" />
        <RadzenFormFieldDescription>@Localizer["Numero_Transaction_Bancaire_Description"]</RadzenFormFieldDescription>
    </RadzenFormField>

    <RadzenFormField Text="@($"{Localizer["Client"]} *")" class="rz-col-12 rz-md-6">
        <RadzenDropDownDataGrid AllowClear="false"
                                IsLoading="@isLoadingCustomers"
                                @bind-Value="@paiement.ClientId"
                                LoadData="@LoadCustomers"
                                AllowFiltering="true"
                                Style="width: 100%;"
                                Data="@_filteredCustomers"
                                TextProperty="@nameof(CustomerResponse.Name)"
                                ValueProperty="@nameof(CustomerResponse.Id)"
                                Placeholder="@Localizer["Select_Client"]"
                                Change="@OnClientChanged">
            <Columns>
                <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Id)" Title="ID" Width="80px" />
                <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Name)" Title="@Localizer["Nom"]" Width="220px" />
            </Columns>
        </RadzenDropDownDataGrid>
    </RadzenFormField>

    <RadzenFormField Text="@($"{Localizer["Exercice_Comptable"]} *")" class="rz-col-12 rz-md-6">
        <RadzenTextBox Value="@(activeAccountingYear?.Year.ToString() ?? Localizer["Chargement"])" 
                       ReadOnly="true" 
                       Style="width: 100%;" />
    </RadzenFormField>

    <RadzenFormField Text="@($"{Localizer["Montant"]} *")" class="rz-col-12 rz-md-6">
        <RadzenNumeric @bind-Value="paiement.Montant" Min="0" Format="@amountFormat" Style="width: 100%;" />
    </RadzenFormField>

    <RadzenFormField Text="@($"{Localizer["Date_Paiement"]} *")" class="rz-col-12 rz-md-6">
        <RadzenDatePicker @bind-Value="paiement.DatePaiement" DateFormat="dd/MM/yyyy" ShowTime="false" Style="width: 100%;" />
    </RadzenFormField>

    <RadzenFormField Text="@($"{Localizer["Methode_Paiement"]} *")" class="rz-col-12 rz-md-6">
        <RadzenDropDown @bind-Value="selectedMethodePaiement"
                        Data="@methodePaiementOptions"
                        TextProperty="Text"
                        ValueProperty="Value"
                        Placeholder="@Localizer["Select_Methode"]"
                        AllowClear="false"
                        Style="width: 100%;"
                        Change="@OnMethodePaiementChanged" />
    </RadzenFormField>

    @if (selectedMethodePaiement == MethodePaiementConsts.Cheque || selectedMethodePaiement == MethodePaiementConsts.Traite)
    {
        <RadzenFormField Text="@Localizer["Numero_Cheque_Traite"]" class="rz-col-12 rz-md-6">
            <RadzenTextBox @bind-Value="paiement.NumeroChequeTraite" Placeholder="@Localizer["Numero"]" />
        </RadzenFormField>

        <RadzenFormField Text="@Localizer["Banque"]" class="rz-col-12 rz-md-6">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Style="width: 100%;">
                <RadzenDropDown @bind-Value="paiement.BanqueId"
                                Data="@banques"
                                TextProperty="Nom"
                                ValueProperty="Id"
                                Placeholder="@Localizer["Select_Banque"]"
                                AllowClear="true"
                                Style="flex: 1;" />
                <RadzenButton Icon="add" Text="@Localizer["Nouvelle_Banque"]"
                              ButtonStyle="ButtonStyle.Success"
                              Variant="Variant.Outlined"
                              Size="ButtonSize.Small"
                              Click="@OpenAddBanqueDialog" />
            </RadzenStack>
        </RadzenFormField>

        @if (selectedMethodePaiement == MethodePaiementConsts.Traite)
        {
            <RadzenFormField Text="@Localizer["Date_Echeance"]" class="rz-col-12 rz-md-6">
                <RadzenDatePicker @bind-Value="paiement.DateEcheance" DateFormat="dd/MM/yyyy" ShowTime="false" Style="width: 100%;" />
            </RadzenFormField>
        }
    }

    @if (HasBothBlAndInvoice)
    {
        <RadzenFormField Text="@Localizer["Rattacher_A"]" class="rz-col-12">
            <RadzenRadioButtonList @bind-Value="attachmentChoice"
                                  Data="@attachmentOptions"
                                  TextProperty="Text"
                                  ValueProperty="Value"
                                  Orientation="Radzen.Orientation.Horizontal" />
        </RadzenFormField>
    }

    @if (ShowFactureList)
    {
        <RadzenFormField Text="@Localizer["Facture_Optionnel"]" class="rz-col-12 rz-md-6">
            <div class="rz-form-control" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--rz-base-300); border-radius: var(--rz-border-radius); padding: 0.5rem;">
                @if (isLoadingInvoices)
                {
                    <span>@Localizer["Chargement"]...</span>
                }
                else if (paiement.ClientId <= 0)
                {
                    <span class="rz-color-secondary">@Localizer["Select_Client"]</span>
                }
                else if (_filteredInvoices.Count == 0)
                {
                    <span class="rz-color-secondary">@Localizer["no_records_to_display"]</span>
                }
                else
                {
                    @foreach (var inv in _filteredInvoices)
                    {
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0;">
                            <RadzenCheckBox TValue="bool"
                                            Value="@selectedFactureIds.Contains(inv.Id)"
                                            Change="@(args => ToggleFactureSelection(inv.Id, args))" />
                            <span>@inv.Number</span>
                        </div>
                    }
                }
            </div>
        </RadzenFormField>
    }

    @if (ShowBlList)
    {
        <RadzenFormField Text="@Localizer["Bon_Livraison_Optionnel"]" class="rz-col-12 rz-md-6">
            <div class="rz-form-control" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--rz-base-300); border-radius: var(--rz-border-radius); padding: 0.5rem;">
                @if (isLoadingDeliveryNotes)
                {
                    <span>@Localizer["Chargement"]...</span>
                }
                else if (paiement.ClientId <= 0)
                {
                    <span class="rz-color-secondary">@Localizer["Select_Client"]</span>
                }
                else if (_filteredDeliveryNotes.Count == 0)
                {
                    <span class="rz-color-secondary">@Localizer["no_records_to_display"]</span>
                }
                else
                {
                    @foreach (var bl in _filteredDeliveryNotes)
                    {
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0;">
                            <RadzenCheckBox TValue="bool"
                                            Value="@selectedBonDeLivraisonIds.Contains(bl.Id)"
                                            Change="@(args => ToggleBonDeLivraisonSelection(bl.Id, args))" />
                            <span>@bl.Number</span>
                        </div>
                    }
                }
            </div>
        </RadzenFormField>
    }

    <RadzenFormField Text="@Localizer["Commentaire"]" class="rz-col-12">
        <RadzenTextArea @bind-Value="paiement.Commentaire" Placeholder="@Localizer["Commentaire_Optionnel"]" Rows="3" Style="width: 100%;" />
    </RadzenFormField>

    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" JustifyContent="Radzen.JustifyContent.End" class="rz-col-12">
        <RadzenButton Text="@Localizer["Annuler"]" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Outlined" Click="@Cancel" />
        <RadzenButton Text="@(IsEditMode ? Localizer["Modifier"] : Localizer["Creer"])" 
                      ButtonStyle="ButtonStyle.Primary" 
                      Click="@SavePaiement"
                      IsBusy="@isSaving" />
    </RadzenStack>
</RadzenStack>
    </ChildContent>
    <ErrorContent Context="ex">
        @{ LogRenderError(ex); }
        <p>@ex.Message</p>
    </ErrorContent>
</ErrorBoundary>

@code {
    private const string AttachmentFacture = "Facture";
    private const string AttachmentBl = "Bl";

    [Parameter] public int DeliveryNoteId { get; set; }
    [Parameter] public int CustomerId { get; set; }
    [Parameter] public int? InvoiceId { get; set; }
    [Parameter] public decimal? SuggestedAmount { get; set; }
    [Parameter] public int? PaiementId { get; set; }

    private bool IsEditMode => PaiementId.HasValue && PaiementId.Value > 0;
    private bool HasBothBlAndInvoice => DeliveryNoteId > 0 && InvoiceId.HasValue && InvoiceId.Value > 0;
    private bool ShowFactureList => HasBothBlAndInvoice ? attachmentChoice == AttachmentFacture : (InvoiceId.HasValue && InvoiceId.Value > 0);
    private bool ShowBlList => HasBothBlAndInvoice ? attachmentChoice == AttachmentBl : DeliveryNoteId > 0;

    private string _attachmentChoice = AttachmentBl;
    private string attachmentChoice
    {
        get => _attachmentChoice;
        set
        {
            if (_attachmentChoice != value)
            {
                _attachmentChoice = value;
                ApplyAttachmentChoice();
            }
        }
    }
    private List<AttachmentOption> attachmentOptions => new()
    {
        new AttachmentOption { Text = Localizer["Rattacher_Facture"], Value = AttachmentFacture },
        new AttachmentOption { Text = Localizer["Rattacher_BL"], Value = AttachmentBl }
    };

    private class AttachmentOption
    {
        public string Text { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
    }

    private bool isLoadingCustomers = false;
    private bool isLoadingInvoices = false;
    private bool isLoadingDeliveryNotes = false;
    private bool isSaving = false;
    private CreatePaiementClientRequest paiement = new();
    private GetActiveAccountingYearResponse? activeAccountingYear;
    private string? selectedMethodePaiement;
    private List<CustomerResponse> _filteredCustomers = new();
    private List<InvoiceResponse> _filteredInvoices = new();
    private List<GetDeliveryNoteBaseInfos> _filteredDeliveryNotes = new();
    private List<BanqueResponse> banques = new();
    private CancellationTokenSource cancellationTokenSource = new();
    private ErrorBoundary? _errorBoundary;

    private void LogRenderError(Exception ex)
    {
        // #region agent log
        DebugLog.Write("CreatePaiementFromBlDialog:ErrorBoundary", "Render crash caught", new { message = ex.Message, stackTrace = ex.StackTrace, toString = ex.ToString() }, "H3");
        // #endregion
    }
    private string amountFormat = AmountHelper.FORMAT_N3;
    private List<int> selectedFactureIds = new();
    private List<int> selectedBonDeLivraisonIds = new();

    private List<MethodePaiementOption> methodePaiementOptions = new();

    private class MethodePaiementOption
    {
        public string Text { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
    }

    protected override void OnParametersSet()
    {
        // #region agent log
        DebugLog.Write("CreatePaiementFromBlDialog.OnParametersSet", "Params received", new { DeliveryNoteId, CustomerId, InvoiceId, SuggestedAmount }, "H5");
        // #endregion
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
        // #region agent log
        DebugLog.Write("CreatePaiementFromBlDialog.OnInitializedAsync:entry", "Enter", new { DeliveryNoteId, CustomerId, InvoiceId, SuggestedAmount }, "H2");
        // #endregion
        amountFormat = await DecimalFormatService.GetDecimalFormatAsync();
        methodePaiementOptions = new()
        {
            new MethodePaiementOption { Text = Localizer["Espece"], Value = MethodePaiementConsts.Espece },
            new MethodePaiementOption { Text = Localizer["Cheque"], Value = MethodePaiementConsts.Cheque },
            new MethodePaiementOption { Text = Localizer["Traite"], Value = MethodePaiementConsts.Traite }
        };
        
        if (IsEditMode)
        {
            var loadResult = await PaiementClientService.GetPaiementClientAsync(PaiementId!.Value, cancellationTokenSource.Token);
            if (loadResult.IsFailed)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["Erreur"],
                    Detail = loadResult.Errors.FirstOrDefault()?.Message ?? Localizer["Erreur_Chargement_Paiements"]?.ToString() ?? "Erreur chargement paiement"
                });
                return;
            }
            var existing = loadResult.Value;
            paiement.ClientId = existing.ClientId;
            paiement.NumeroTransactionBancaire = existing.NumeroTransactionBancaire;
            paiement.Montant = existing.Montant;
            paiement.DatePaiement = existing.DatePaiement;
            paiement.MethodePaiement = existing.MethodePaiement;
            paiement.NumeroChequeTraite = existing.NumeroChequeTraite;
            paiement.BanqueId = existing.BanqueId;
            paiement.DateEcheance = existing.DateEcheance;
            paiement.Commentaire = existing.Commentaire;
            paiement.AccountingYearId = existing.AccountingYearId;
            selectedMethodePaiement = existing.MethodePaiement;
            selectedFactureIds = existing.FactureIds?.ToList() ?? new List<int>();
            selectedBonDeLivraisonIds = existing.BonDeLivraisonIds?.ToList() ?? new List<int>();
            if (selectedFactureIds.Any())
                _attachmentChoice = AttachmentFacture;
            else if (selectedBonDeLivraisonIds.Any())
                _attachmentChoice = AttachmentBl;
        }
        else
        {
            paiement.ClientId = CustomerId;
            if (HasBothBlAndInvoice)
            {
                if (attachmentChoice == AttachmentBl)
                {
                    selectedBonDeLivraisonIds = new List<int> { DeliveryNoteId };
                    selectedFactureIds = new List<int>();
                }
                else
                {
                    selectedFactureIds = new List<int> { InvoiceId!.Value };
                    selectedBonDeLivraisonIds = new List<int>();
                }
            }
            else
            {
                if (DeliveryNoteId > 0)
                    selectedBonDeLivraisonIds = new List<int> { DeliveryNoteId };
                if (InvoiceId.HasValue && InvoiceId.Value > 0)
                    selectedFactureIds = new List<int> { InvoiceId.Value };
            }
            paiement.DatePaiement = DateTime.Now;
            if (SuggestedAmount.HasValue && SuggestedAmount.Value > 0)
                paiement.Montant = SuggestedAmount.Value;
            selectedMethodePaiement = MethodePaiementConsts.Espece;
            paiement.MethodePaiement = MethodePaiementConsts.Espece;
        }
        
        await LoadActiveAccountingYearAsync();
        // #region agent log
        DebugLog.Write("CreatePaiementFromBlDialog:after LoadActiveAccountingYear", "done", null, "H2");
        // #endregion
        await LoadBanquesAsync();
        // #region agent log
        DebugLog.Write("CreatePaiementFromBlDialog:after LoadBanques", "done", new { banquesCount = banques.Count }, "H2");
        // #endregion
        await LoadCustomers(new LoadDataArgs { Filter = string.Empty });
        // #region agent log
        DebugLog.Write("CreatePaiementFromBlDialog:after LoadCustomers", "done", new { customersCount = _filteredCustomers.Count }, "H2");
        // #endregion
        var clientIdToLoad = IsEditMode ? paiement.ClientId : CustomerId;
        if (clientIdToLoad > 0)
        {
            await LoadInvoicesForClient(clientIdToLoad);
            await LoadDeliveryNotesForClient(clientIdToLoad);
        }
        // #region agent log
        DebugLog.Write("CreatePaiementFromBlDialog.OnInitializedAsync:exit", "Success", new { HasBothBlAndInvoice, ShowFactureList, ShowBlList }, "H2");
        // #endregion
        }
        catch (Exception ex)
        {
            // #region agent log
            DebugLog.Write("CreatePaiementFromBlDialog.OnInitializedAsync:exception", "Crash", new { exception = ex.ToString(), message = ex.Message }, "H2");
            // #endregion
            throw;
        }
    }

    async Task LoadActiveAccountingYearAsync()
    {
        try
        {
            activeAccountingYear = await AccountingYearService.GetActiveAccountingYearAsync();
            if (activeAccountingYear == null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["Attention"],
                    Detail = Localizer["No_Accounting_Year"]
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Accounting_Year"]}: {ex.Message}"
            });
        }
    }

    async Task LoadBanquesAsync()
    {
        try
        {
            banques = await BanqueService.GetBanquesAsync(cancellationTokenSource.Token);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Banques"]}: {ex.Message}"
            });
        }
    }

    async Task LoadCustomers(LoadDataArgs args)
    {
        isLoadingCustomers = true;
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 5,
            SearchKeyword = args?.Filter ?? string.Empty
        };

        try
        {
            var pagedCustomers = await CustomersService.GetAsync(parameters, cancellationTokenSource.Token);
            _filteredCustomers = pagedCustomers.Items;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Clients"]}: {ex.Message}"
            });
            _filteredCustomers = new List<CustomerResponse>();
        }

        isLoadingCustomers = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task OnClientChanged(object? value)
    {
        if (value is int clientId && clientId > 0)
        {
            await LoadInvoicesForClient(clientId);
            await LoadDeliveryNotesForClient(clientId);
        }
        else
        {
            _filteredInvoices = new List<InvoiceResponse>();
            _filteredDeliveryNotes = new List<GetDeliveryNoteBaseInfos>();
        }
    }

    async Task LoadInvoicesForClient(int clientId)
    {
        isLoadingInvoices = true;
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 50,
            SearchKeyword = null
        };

        try
        {
            var result = await InvoicesService.GetInvoicesByCustomerIdWithSummary(clientId, parameters, cancellationTokenSource.Token);
            if (result.IsT0)
            {
                _filteredInvoices = result.AsT0.Invoices.Items;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Factures"]}: {ex.Message}"
            });
        }

        isLoadingInvoices = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task LoadInvoices(LoadDataArgs args)
    {
        if (paiement.ClientId > 0)
        {
            await LoadInvoicesForClient(paiement.ClientId);
        }
    }

    async Task LoadDeliveryNotesForClient(int clientId)
    {
        isLoadingDeliveryNotes = true;
        try
        {
            var result = await DeliveryNoteService.GetDeliveryNotesWithSummariesAsync(
                customerId: clientId,
                invoiceId: null,
                isInvoiced: null,
                sortOrder: SortConstants.Ascending,
                sortProperty: nameof(GetDeliveryNoteBaseInfos.Number),
                pageNumber: 1,
                pageSize: 50,
                searchKeyword: null,
                startDate: null,
                EndDate: null,
                status: null,
                technicianId: null,
                tagIds: null,
                cancellationToken: cancellationTokenSource.Token);
            
            _filteredDeliveryNotes = result.GetDeliveryNoteBaseInfos.Items;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_BL"]}: {ex.Message}"
            });
        }

        isLoadingDeliveryNotes = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task LoadDeliveryNotes(LoadDataArgs args)
    {
        if (paiement.ClientId > 0)
        {
            await LoadDeliveryNotesForClient(paiement.ClientId);
        }
    }

    void ToggleFactureSelection(int invoiceId, bool? selected)
    {
        if (selected == true)
        {
            if (!selectedFactureIds.Contains(invoiceId))
            {
                selectedFactureIds = new List<int>(selectedFactureIds) { invoiceId };
            }
        }
        else
        {
            selectedFactureIds = selectedFactureIds.Where(id => id != invoiceId).ToList();
        }
    }

    void ToggleBonDeLivraisonSelection(int blId, bool? selected)
    {
        if (selected == true)
        {
            if (!selectedBonDeLivraisonIds.Contains(blId))
            {
                selectedBonDeLivraisonIds = new List<int>(selectedBonDeLivraisonIds) { blId };
            }
        }
        else
        {
            selectedBonDeLivraisonIds = selectedBonDeLivraisonIds.Where(id => id != blId).ToList();
        }
    }

    void ApplyAttachmentChoice()
    {
        // #region agent log
        DebugLog.Write("CreatePaiementFromBlDialog.ApplyAttachmentChoice", "Called", new { _attachmentChoice, HasBothBlAndInvoice, InvoiceId }, "H4");
        // #endregion
        if (!HasBothBlAndInvoice) return;
        selectedFactureIds = new List<int>();
        selectedBonDeLivraisonIds = new List<int>();
        if (_attachmentChoice == AttachmentFacture)
            selectedFactureIds = new List<int> { InvoiceId!.Value };
        else
            selectedBonDeLivraisonIds = new List<int> { DeliveryNoteId };
    }

    void OnMethodePaiementChanged(object? value)
    {
        if (value is string methode)
        {
            paiement.MethodePaiement = methode;
            if (methode != MethodePaiementConsts.Cheque && methode != MethodePaiementConsts.Traite)
            {
                paiement.NumeroChequeTraite = null;
                paiement.BanqueId = null;
                paiement.DateEcheance = null;
            }
        }
    }

    async Task OpenAddBanqueDialog()
    {
        // TODO: Implement dialog to add new banque
        // For now, reload banques
        await LoadBanquesAsync();
    }

    async Task SavePaiement()
    {
        if (paiement.ClientId <= 0)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Validation"],
                Detail = Localizer["Select_Client_Validation"]
            });
            return;
        }

        if (activeAccountingYear == null)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Validation"],
                Detail = Localizer["No_Accounting_Year_Validation"]
            });
            return;
        }

        if (string.IsNullOrWhiteSpace(paiement.MethodePaiement))
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Validation"],
                Detail = Localizer["Select_Methode_Validation"]
            });
            return;
        }

        // Validate exclusivity
        if (selectedFactureIds.Count > 0 && selectedBonDeLivraisonIds.Count > 0)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Validation"],
                Detail = "Vous ne pouvez pas sélectionner à la fois des factures et des bons de livraison"
            });
            return;
        }

        // Assign selected IDs to paiement
        paiement.FactureIds = selectedFactureIds.Count > 0 ? selectedFactureIds : null;
        paiement.BonDeLivraisonIds = selectedBonDeLivraisonIds.Count > 0 ? selectedBonDeLivraisonIds : null;

        isSaving = true;
        try
        {
            if (IsEditMode)
            {
                var updateRequest = new UpdatePaiementClientRequest
                {
                    NumeroTransactionBancaire = paiement.NumeroTransactionBancaire,
                    ClientId = paiement.ClientId,
                    AccountingYearId = paiement.AccountingYearId,
                    Montant = paiement.Montant,
                    DatePaiement = paiement.DatePaiement,
                    MethodePaiement = paiement.MethodePaiement,
                    FactureIds = selectedFactureIds.Count > 0 ? selectedFactureIds : null,
                    BonDeLivraisonIds = selectedBonDeLivraisonIds.Count > 0 ? selectedBonDeLivraisonIds : null,
                    NumeroChequeTraite = paiement.NumeroChequeTraite,
                    BanqueId = paiement.BanqueId,
                    DateEcheance = paiement.DateEcheance,
                    Commentaire = paiement.Commentaire
                };
                var updateResult = await PaiementClientService.UpdatePaiementClientAsync(PaiementId!.Value, updateRequest, cancellationTokenSource.Token);
                if (updateResult.IsSuccess)
                {
                    ToastService.Notify(new(ToastType.Success, Localizer["Paiement_Modifie"]));
                    DialogService.Close(true);
                }
                else
                {
                    ToastService.Notify(new(ToastType.Danger, $"{Localizer["Erreur"]}: {updateResult.Errors.FirstOrDefault()?.Message}"));
                }
            }
            else
            {
                if (activeAccountingYear != null)
                    paiement.AccountingYearId = activeAccountingYear.Id;
                var result = await PaiementClientService.CreatePaiementClientAsync(paiement, cancellationTokenSource.Token);
                if (result.IsT0)
                {
                    ToastService.Notify(new(ToastType.Success, Localizer["Paiement_Cree"]));
                    DialogService.Close(true);
                }
                else
                {
                    var badRequest = result.AsT1;
                    ToastService.Notify(new(ToastType.Danger, $"Erreur: {badRequest.Detail}"));
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Sauvegarde"]}: {ex.Message}"
            });
        }
        finally
        {
            isSaving = false;
        }
    }

    void Cancel()
    {
        DialogService.Close(false);
    }

    public void Dispose()
    {
        cancellationTokenSource.Cancel();
        cancellationTokenSource.Dispose();
    }
}
