@page "/AddOrUpdateDeliveryNote"
@page "/AddOrUpdateDeliveryNote/{num?}"

@using Radzen.Blazor
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Localization
@using Microsoft.JSInterop
@using System.Text.Json
@using TunNetCom.SilkRoadErp.Sales.Contracts.AppParameters
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote.Requests
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote.Responses
@using TunNetCom.SilkRoadErp.Sales.Contracts.Invoice
@using TunNetCom.SilkRoadErp.Sales.Contracts.Sorting
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AppParameters
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Customers
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.DeliveryNote
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Invoices
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Products
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Reports.DeliveryNotes.PrintDeliveryNote
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Infrastructure
@using TunNetCom.SilkRoadErp.Sales.Contracts.Tags
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Tags
@using TunNetCom.SilkRoadErp.Sales.Contracts.InstallationTechnician.Responses
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.InstallationTechnician
@inject ITagsApiClient TagsService
@inject IInstallationTechnicianApiClient TechnicianService

@inject IStringLocalizer<SharedResource> Localizer
@inject ToastService toastService
@inject NotificationService NotificationService
@inject IJSRuntime JSRuntime
@inject IDeliveryNoteApiClient deliveryNoteApiClient
@inject IProductsApiClient productsApiClient
@inject IInvoicesApiClient invoicesApiClient
@inject ICustomersApiClient customersApiClient
@inject IAppParametersClient appParametersClient
@inject ILogger<AddOrUpdateDeliveryNote> logger
@inject DialogService DialogService
@inject PrintDeliveryNoteService PrintDeliveryNoteService
@inject IPrintService PrintService
@inject ITagsApiClient TagsService

<style>
    /* Header actions container */
    .header-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
        padding: 12px 24px;
        border-bottom: 1px solid #e5e7eb;
        width: 100%;
    }

    /* Action buttons container */
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }

    /* Button styling */
    .action-button {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 6px;
        transition: background-color 0.2s, box-shadow 0.2s;
        background-color: #3b82f6;
        border: none;
    }

        .action-button:hover:not(:disabled) {
            background-color: #2563eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .action-button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }

    /* Success button styling */
    .success-button {
        background-color: #10b981;
    }

        .success-button:hover:not(:disabled) {
            background-color: #059669;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

    /* Summary card styling */
    .summary-card {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        flex: 0 0 auto;
    }

    /* Summary stack */
    .summary-stack {
        gap: 1.5rem;
    }

    /* Summary text */
    .summary-text {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        line-height: 1.5;
    }

        .summary-text strong {
            font-weight: 600;
        }

    /* Responsive design */
    @@media (max-width: 768px) {
        .header-actions {
            flex-direction: column;
            align-items: flex-start;
            padding: 12px 16px;
            gap: 12px;
        }

        .action-buttons {
            flex-direction: column;
            width: 100%;
            gap: 8px;
        }

        .action-button,
        .success-button {
            width: 100%;
            text-align: center;
            font-size: 12px;
            padding: 10px;
        }

        .summary-card {
            width: 100%;
            padding: 8px 12px;
        }

        .summary-stack {
            flex-direction: column;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .summary-text {
            font-size: 12px;
        }
    }

    .delivery-note-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .delivery-note-form {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
        flex-grow: 1;
    }
</style>

<!-- Loading Indicator -->
@if (isLoading)
{
    <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else
{
    <!-- Delivery Note Container with Form and Summary -->
    <div class="delivery-note-container">
        <div class="delivery-note-form">
            <RadzenLabel Text="@Localizer["delivery_note_number"]" Component="DeliveryNoteNumber" AriaLabel="@Localizer["delivery_note_number"]" />
            <RadzenTextBox @bind-Value="deliveryNoteNumber" Name="DeliveryNoteNumber" Style="width: 120px;" ReadOnly="true" AriaReadOnly="true" />

            <RadzenLabel Text="@Localizer["date"]" />
            <RadzenDatePicker @bind-Value="deliveryNoteDate" Name="DeliveryNoteDate" Style="width: 200px;" DateFormat="d MMMM yyyy" ShowTime="false" />

            <RadzenLabel Text="@Localizer["customer"]" />
            <RadzenDropDownDataGrid AllowClear="true"
                                    IsLoading="@isLoadingCustomers"
                                    @bind-Value="@selectedCustomerId"
                                    LoadData="@LoadCustomers"
                                    AllowFiltering="true"
                                    Style="width: 350px;"
                                    Data="@_filteredCustomers"
                                    TextProperty="@nameof(CustomerResponse.Name)"
                                    ValueProperty="@nameof(CustomerResponse.Id)"
                                    Placeholder="@Localizer["select_customer"]">
                <Columns>
                    <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Id)" Title="ID" Width="80px" />
                    <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Name)" Title="@Localizer["name"]" Width="220px" />
                </Columns>
            </RadzenDropDownDataGrid>

            <RadzenLabel Text="Installateur" />
            <RadzenDropDownDataGrid AllowClear="true"
                                    IsLoading="@isLoadingTechnicians"
                                    @bind-Value="@selectedTechnicianId"
                                    LoadData="@LoadTechnicians"
                                    AllowFiltering="true"
                                    Style="width: 350px;"
                                    Data="@_filteredTechnicians"
                                    TextProperty="@nameof(InstallationTechnicianBaseInfo.Nom)"
                                    ValueProperty="@nameof(InstallationTechnicianBaseInfo.Id)"
                                    Placeholder="Sélectionner un installateur">
                <Template Context="technician">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        @if (!string.IsNullOrEmpty(technician.Photo))
                        {
                            <img src="@technician.Photo" alt="@technician.Nom" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;" />
                        }
                        else
                        {
                            <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center;">
                                <RadzenIcon Icon="person" Style="font-size: 16px;" />
                            </div>
                        }
                        <span>@technician.Nom</span>
                    </div>
                </Template>
                <Columns>
                    <RadzenDropDownDataGridColumn Property="@nameof(InstallationTechnicianBaseInfo.Id)" Title="ID" Width="80px" />
                    <RadzenDropDownDataGridColumn Property="@nameof(InstallationTechnicianBaseInfo.Nom)" Title="Nom" Width="220px" />
                </Columns>
            </RadzenDropDownDataGrid>

            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="Radzen.AlignItems.Center">
                <RadzenLabel Text="@Localizer["invoice_number"]" />
                <RadzenDropDownDataGrid AllowClear="true"
                                        IsLoading="@isLoadingInvoices"
                                        @bind-Value="@_selectedInvoiceId"
                                        LoadData="@LoadCustomerInvoices"
                                        AllowFiltering="true"
                                        Style="width: 350px;"
                                        Data="@_filteredInvoices"
                                        TextProperty="@nameof(InvoiceResponse.Number)"
                                        ValueProperty="@nameof(InvoiceResponse.Number)"
                                        Placeholder="@Localizer["select_invoice"]">
                    <Columns>
                        <RadzenDropDownDataGridColumn Property="@nameof(InvoiceResponse.Number)" Title="Num" Width="100px" />
                        <RadzenDropDownDataGridColumn Property="@nameof(InvoiceResponse.Date)" Title="Date" Width="100px" />
                        <RadzenDropDownDataGridColumn Property="@nameof(InvoiceResponse.TotalIncludingTaxAmount)" Title="@Localizer["tot_ttc"]" Width="200px" />
                    </Columns>
                </RadzenDropDownDataGrid>
                <RadzenButton Icon="add" 
                              ButtonStyle="ButtonStyle.Success" 
                              Variant="Variant.Flat"
                              Size="ButtonSize.Medium"
                              Disabled="@(!selectedCustomerId.HasValue)"
                              Click="@CreateNewInvoice"
                              Title="@Localizer["create_new_invoice"]"
                              AriaLabel="@Localizer["create_new_invoice"]" />
            </RadzenStack>
        </div>
    </div>

    <!-- Order Lines Grid -->
    <LineItemsGrid TItem="DeliveryNoteDetailResponse"
                   Items="@orders"
                   ItemsChanged="@OnItemsChanged"
                   OnDeleteItem="@DeleteRow"
                   OnProductSelectedCallback="@OnProductSelectedHandler"
                   LoadProducts="@LoadData"
                   GetProductList="@GetCurrentProductList"
                   ProductCount="@count"
                   AppParameters="@getAppParametersResponse"
                   OnShowPriceHistory="@ShowDialog"
                   ShowPriceHistoryDialog="true"
                   ShowPrintButton="true"
                   ShowSaveButton="true"
                   ShowSummary="true"
                   OnSave="@SaveDeliveryNote"
                   OnPrint="@PrintDeliveryNote"
                   TotalHt="@totalHt"
                   TotalVat="@totalVat"
                   TotalTtc="@totalTtc"
                   Localizer="@Localizer"
                   GetProductReference="@(item => item.ProductReference)"
                   SetProductReference="@((item, value) => item.ProductReference = value)"
                   GetProductDescription="@(item => item.Description)"
                   SetProductDescription="@((item, value) => item.Description = value)"
                   ProductTextProperty="ProductReferenceAndDescription"
                   ProductValueProperty="ProductReference"
                   CreateNewItem="@(() => new DeliveryNoteDetailResponse { Quantity = 1, DeliveredQuantity = 1, HasPartialDelivery = false })" />

    <!-- Tags Section -->
    @if (!string.IsNullOrEmpty(deliveryNoteNumber) && int.TryParse(deliveryNoteNumber, out var blNumber))
    {
        <TagSelector @ref="tagSelectorRef"
                    DocumentType="BonDeLivraison" 
                    DocumentId="@blNumber"
                    SaveOnChange="false" />
    }
}

@code {
    [Parameter] public string? num { get; set; }
    List<DeliveryNoteDetailResponse> orders;
    List<DeliveryNoteDetailResponse> searchList;
    int count;
    private const int DefaultPageSize = 7;
    private CancellationTokenSource _cancellationTokenSource = new();
    private List<CustomerResponse> _filteredCustomers { get; set; } = new();
    private List<InvoiceResponse> _filteredInvoices { get; set; } = new();
    private List<InstallationTechnicianBaseInfo> _filteredTechnicians { get; set; } = new();
    private bool isLoading = true;
    bool isLoadingCustomers = false;
    bool isLoadingInvoices = false;
    bool isLoadingTechnicians = false;
    private int? selectedTechnicianId;
    decimal totalHt;
    decimal totalVat;
    decimal totalTtc;
    string deliveryNoteNumber;
    DateTime deliveryNoteDate = DateTime.Now;
    private GetAppParametersResponse getAppParametersResponse;
    private TagSelector? tagSelectorRef;
    private int? _selectedCustomerId;
    int? selectedCustomerId
    {
        get => _selectedCustomerId;
        set
        {
            if (_selectedCustomerId != value)
            {
                _selectedCustomerId = value;
                selectedInvoiceId = null;
                _filteredInvoices = new List<InvoiceResponse>();
                _ = LoadCustomerInvoices(new LoadDataArgs());
                StateHasChanged();
            }
        }
    }

    private int? _selectedInvoiceId;
    int? selectedInvoiceId
    {
        get => _selectedInvoiceId;
        set
        {
            if (_selectedInvoiceId != value)
            {
                _selectedInvoiceId = value;
                StateHasChanged();
            }
        }
    }


    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        searchList = new List<DeliveryNoteDetailResponse>();
        orders = new List<DeliveryNoteDetailResponse>();
        var param = await appParametersClient.GetAppParametersAsync(_cancellationTokenSource.Token);
        getAppParametersResponse = param.AsT0;
        await LoadCustomers(null);
        await LoadTechnicians(null);
        await FetchDeliveryNote();
        // Only load invoices if customer is already selected (edit mode or from quotation)
        if (selectedCustomerId.HasValue)
        {
            await LoadCustomerInvoices(null);
        }
        isLoading = false;
    }

    private async Task SaveDeliveryNote()
    {
        try
        {
            if (!_selectedCustomerId.HasValue)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = $"{Localizer["select_customer"]}"
                });
                return;
            }
            // Valider le stock pour toutes les lignes avant la soumission
            var stockErrors = new List<string>();
            var bloquerVenteStockInsuffisant = getAppParametersResponse?.BloquerVenteStockInsuffisant ?? true;
            
            foreach (var order in orders)
            {
                if (!string.IsNullOrEmpty(order.ProductReference) && order.Quantity > 0)
                {
                    var stockResult = await productsApiClient.GetProductStockAsync(order.ProductReference, _cancellationTokenSource.Token);
                    if (stockResult.IsT0)
                    {
                        var stock = stockResult.AsT0;
                        if (stock.StockDisponible < order.Quantity)
                        {
                            stockErrors.Add($"{order.ProductReference}: {Localizer["stock_insuffisant"]} ({stock.StockDisponible} {Localizer["quantite_disponible"]}, {order.Quantity} {Localizer["quantite_demandee"]})");
                        }
                    }
                }
            }

            // Afficher une alerte dans tous les cas
            if (stockErrors.Any())
            {
                var errorMessage = $"{Localizer["alerte_stock"]}: {string.Join("; ", stockErrors)}";
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["alerte_stock"],
                    Detail = errorMessage
                });
                
                // Bloquer uniquement si le paramètre est activé
                if (bloquerVenteStockInsuffisant)
                {
                    isLoading = false;
                    StateHasChanged();
                    return;
                }
                // Si le paramètre est désactivé, on continue malgré l'alerte
            }

            isLoading = true;
            StateHasChanged();

            var request = new CreateDeliveryNoteRequest
            {
                Date = deliveryNoteDate,
                TotalExcludingTax = totalHt,
                TotalVat = totalVat,
                TotalAmount = totalTtc,
                DeliveryTime = TimeOnly.FromDateTime(DateTime.Now),
                InvoiceNumber = _selectedInvoiceId,
                CustomerId = _selectedCustomerId,
                InstallationTechnicianId = selectedTechnicianId,
                Items = orders.Select(o => new DeliveryNoteItemRequest
                {
                    Id = o.Id,
                    ProductReference = o.ProductReference,
                    Description = o.Description,
                    Quantity = o.Quantity,
                    DeliveredQuantity = o.DeliveredQuantity ?? o.Quantity,
                    UnitPriceExcludingTax = o.UnitPriceExcludingTax,
                    DiscountPercentage = o.DiscountPercentage,
                    TotalExcludingTax = o.TotalExcludingTax,
                    VatPercentage = o.VatPercentage,
                    TotalIncludingTax = o.TotalIncludingTax
                }).ToList()
            };

            // Check if we're in edit mode (delivery note number exists)
            int deliveryNoteNum = 0;
            bool isEditMode = !string.IsNullOrEmpty(deliveryNoteNumber) && int.TryParse(deliveryNoteNumber, out deliveryNoteNum);
            
            if (isEditMode)
            {
                // Update existing delivery note
                var updateResponse = await deliveryNoteApiClient.UpdateDeliveryNoteAsync(deliveryNoteNum, request, _cancellationTokenSource.Token);
                
                if (updateResponse.IsSuccess)
                {
                    // Sauvegarder les tags après la mise à jour du document
                    await SaveTags();
                    
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = Localizer["success"],
                        Detail = Localizer["delivery_note_updated_successfully"] ?? Localizer["delivery_note_saved_successfully"]
                    });
                }
                else
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = Localizer["error"],
                        Detail = $"{Localizer["failed_to_save_delivery_note"]}: {updateResponse.Errors.First().Message}"
                    });
                }
            }
            else
            {
                // Create new delivery note
                var createResponse = await deliveryNoteApiClient.CreateDeliveryNoteAsync(request, _cancellationTokenSource.Token);
                
                if (createResponse.IsSuccess)
                {
                    var newDeliveryNoteNum = createResponse.ValueOrDefault;
                    deliveryNoteNumber = newDeliveryNoteNum.ToString();
                    await InvokeAsync(StateHasChanged);
                    
                            // Recharger les données du BL pour s'assurer que tout est à jour
                    await FetchDeliveryNote();
                    
                    // Sauvegarder les tags après la création du document
                    await SaveTags();
                    
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = Localizer["success"],
                        Detail = Localizer["delivery_note_saved_successfully"]
                    });
                }
                else
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = Localizer["error"],
                        Detail = $"{Localizer["failed_to_save_delivery_note"]}: {createResponse.Errors.First().Message}"
                    });
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"{Localizer["failed_to_save_delivery_note"]}: {ex.Message}"
            });
            logger.LogError(ex, "Failed to save delivery note");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task FetchDeliveryNote()
    {
        // Vérifier d'abord si on a des données depuis un devis dans sessionStorage
        try
        {
            var deliveryNoteDataJson = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "deliveryNoteFromQuotation");
            if (!string.IsNullOrEmpty(deliveryNoteDataJson))
            {
                var deliveryNoteRequest = JsonSerializer.Deserialize<CreateDeliveryNoteRequest>(deliveryNoteDataJson);
                if (deliveryNoteRequest != null)
                {
                    // Pré-remplir l'interface avec les données du devis
                    deliveryNoteDate = deliveryNoteRequest.Date;
                    selectedCustomerId = deliveryNoteRequest.CustomerId;
                    selectedInvoiceId = deliveryNoteRequest.InvoiceNumber;
                    totalHt = deliveryNoteRequest.TotalExcludingTax;
                    totalVat = deliveryNoteRequest.TotalVat;
                    totalTtc = deliveryNoteRequest.TotalAmount;

                    // Convertir les DeliveryNoteItemRequest en DeliveryNoteDetailResponse
                    orders = deliveryNoteRequest.Items?.Select(item => new DeliveryNoteDetailResponse
                    {
                        Id = item.Id,
                        ProductReference = item.ProductReference,
                        Description = item.Description,
                        Quantity = item.Quantity,
                        DeliveredQuantity = item.DeliveredQuantity ?? item.Quantity,
                        HasPartialDelivery = item.DeliveredQuantity.HasValue && item.DeliveredQuantity.Value < item.Quantity,
                        UnitPriceExcludingTax = item.UnitPriceExcludingTax,
                        DiscountPercentage = item.DiscountPercentage,
                        TotalExcludingTax = item.TotalExcludingTax,
                        VatPercentage = item.VatPercentage,
                        TotalIncludingTax = item.TotalIncludingTax
                    }).ToList() ?? new List<DeliveryNoteDetailResponse>();

                    // Supprimer les données de sessionStorage après utilisation
                    await JSRuntime.InvokeVoidAsync("sessionStorage.removeItem", "deliveryNoteFromQuotation");

                    // Charger les factures du client si un client est sélectionné
                    if (selectedCustomerId.HasValue)
                    {
                        await LoadCustomerInvoices(null);
                    }

                    await InvokeAsync(StateHasChanged);
                    return;
                }
            }
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to load delivery note data from sessionStorage");
        }

        // Si pas de données dans sessionStorage, vérifier si on est en mode édition
        // Utiliser deliveryNoteNumber si num est vide (cas où on vient de sauvegarder)
        var deliveryNoteNumToLoad = num;
        if (string.IsNullOrEmpty(deliveryNoteNumToLoad) && !string.IsNullOrEmpty(deliveryNoteNumber))
        {
            deliveryNoteNumToLoad = deliveryNoteNumber;
        }
        
        if (string.IsNullOrEmpty(deliveryNoteNumToLoad))
        {
            orders = new List<DeliveryNoteDetailResponse>();
            totalHt = 0;
            totalVat = 0;
            totalTtc = 0;
            return;
        }

        try
        {
            if (int.TryParse(deliveryNoteNumToLoad, out var numAsInt))
            {
                var deliveryNote = await deliveryNoteApiClient.GetDeliveryNoteByNumAsync(
                    numAsInt,
                    _cancellationTokenSource.Token);

                if (deliveryNote != null)
                {
                    deliveryNoteNumber = deliveryNote.DeliveryNoteNumber.ToString();
                    deliveryNoteDate = deliveryNote.Date;
                    selectedCustomerId = deliveryNote.CustomerId;
                    selectedTechnicianId = deliveryNote.InstallationTechnicianId;
                    selectedInvoiceId = deliveryNote.InvoiceNumber;

                    if (deliveryNote.Items != null && deliveryNote.Items.Any())
                    {
                        orders = deliveryNote.Items;
                    }
                    else
                    {
                        orders = new List<DeliveryNoteDetailResponse>();
                    }

                    totalHt = deliveryNote.TotalExcludingTax;
                    totalVat = deliveryNote.TotalVat;
                    totalTtc = deliveryNote.TotalAmount;
                }
            }

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception e)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"{Localizer["failed_to_fetch_delivery_note"]}: {e.Message}"
            });

            logger.LogError(e, "Failed to save delivery note");
            await InvokeAsync(StateHasChanged);
        }
    }

    async Task DeleteRow(DeliveryNoteDetailResponse order)
    {
        // Try to remove by reference first (most reliable for exact match)
        if (orders.Contains(order))
        {
            orders.Remove(order);
        }
        else if (order.Id > 0)
        {
            // If reference match fails but item has Id, find by Id
            // This handles cases where DataGrid passes a different instance
            var itemToRemove = orders.FirstOrDefault(t => t.Id == order.Id && t.Id > 0);
            if (itemToRemove != null)
            {
                orders.Remove(itemToRemove);
            }
        }

        UpdateTotals();
        await OnItemsChanged(orders);
        StateHasChanged();
    }

    private List<DeliveryNoteDetailResponse> GetCurrentProductList(DeliveryNoteDetailResponse currentOrder)
    {
        var resultList = new List<DeliveryNoteDetailResponse>();
        
        // If current order has a product reference, ensure it's in the list
        if (!string.IsNullOrEmpty(currentOrder.ProductReference))
        {
            var currentProduct = searchList.FirstOrDefault(p => p.ProductReference == currentOrder.ProductReference);
            
            if (currentProduct != null)
            {
                // Product is already in searchList, add it first
                resultList.Add(currentProduct);
            }
            else
            {
                // Product is not in searchList yet (e.g., when editing existing delivery note)
                // Create a product entry from the current order so it appears in the dropdown
                resultList.Add(new DeliveryNoteDetailResponse
                {
                    ProductReference = currentOrder.ProductReference,
                    Description = currentOrder.Description,
                    UnitPriceExcludingTax = currentOrder.UnitPriceExcludingTax,
                    Quantity = 1
                });
            }
            
            // Add all other products from searchList
            resultList.AddRange(searchList.Where(p => p.ProductReference != currentOrder.ProductReference));
        }
        else
        {
            // No current product, return all products from searchList
            resultList.AddRange(searchList);
        }
        
        return resultList;
    }

    async Task LoadData(LoadDataArgs args)
    {
        string _sortProperty = null;
        string _sortOrder = null;
        if (args.Sorts != null && args.Sorts.Any())
        {
            var sort = args.Sorts.First();
            _sortProperty = sort.Property;
            _sortOrder = sort.SortOrder == SortOrder.Ascending ? SortConstants.Ascending : SortConstants.Descending;
        }
        var parameters = new QueryStringParameters
        {
            PageNumber = (args.Skip.Value / DefaultPageSize) + 1,
            PageSize = DefaultPageSize,
            SearchKeyword = args.Filter,
            SortOrder = _sortOrder,
            SortProprety = _sortProperty
        };

        try
        {
            var pagedProducts = await productsApiClient.GetPagedAsync(parameters, _cancellationTokenSource.Token);
            searchList = pagedProducts.Items.Select(
                p => new DeliveryNoteDetailResponse
                {
                    ProductReference = p.Reference,
                    Description = p.Name,
                    UnitPriceExcludingTax = p.Price,
                    Quantity = 1,
                    DiscountPercentage = p.DiscountPourcentage,
                    VatPercentage = p.VatRate,
                }).ToList();

            count = pagedProducts.TotalCount;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"{Localizer["failed_to_load_products"]}: {ex.Message}"
            });
            searchList = new List<DeliveryNoteDetailResponse>();
            count = 0;
        }

        await InvokeAsync(StateHasChanged);
    }

    async Task LoadCustomers(LoadDataArgs args)
    {
        isLoadingCustomers = true;
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 10,
            SearchKeyword = args?.Filter ?? string.Empty
        };

        try
        {
            var pagedCustomers = await customersApiClient.GetAsync(parameters, _cancellationTokenSource.Token);
            _filteredCustomers = pagedCustomers.Items;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"{Localizer["failed_to_load_customers"]}: {ex.Message}"
            });
            _filteredCustomers = new List<CustomerResponse>();
        }

        isLoadingCustomers = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task LoadTechnicians(LoadDataArgs args)
    {
        isLoadingTechnicians = true;

        try
        {
            _filteredTechnicians = await TechnicianService.GetInstallationTechniciansBaseInfosAsync(_cancellationTokenSource.Token);
            
            // Apply filter if provided
            if (!string.IsNullOrEmpty(args?.Filter))
            {
                _filteredTechnicians = _filteredTechnicians
                    .Where(t => t.Nom.Contains(args.Filter, StringComparison.OrdinalIgnoreCase))
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Erreur",
                Detail = $"Erreur lors du chargement des installateurs: {ex.Message}"
            });
            _filteredTechnicians = new List<InstallationTechnicianBaseInfo>();
        }

        isLoadingTechnicians = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task LoadCustomerInvoices(LoadDataArgs args)
    {
        if (!selectedCustomerId.HasValue)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["select_a_customer_before"],
            });
            return;
        }

        isLoadingInvoices = true;
        
        // Extract sort parameters from LoadDataArgs
        string sortProperty = null;
        string sortOrder = null;
        if (args?.Sorts != null && args.Sorts.Any())
        {
            var sort = args.Sorts.First();
            sortProperty = sort.Property;
            sortOrder = sort.SortOrder == SortOrder.Ascending ? SortConstants.Ascending : SortConstants.Descending;
        }
        else
        {
            // Default: sort by Date descending to get the latest invoices first (most recent first)
            sortProperty = nameof(InvoiceResponse.Date);
            sortOrder = SortConstants.Descending;
        }

        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 5, // Get only the last 5 invoices
            SearchKeyword = args?.Filter,
            SortProprety = sortProperty,
            SortOrder = sortOrder
        };

        try
        {
            var result = await invoicesApiClient.GetInvoicesByCustomerIdWithSummary(
                selectedCustomerId.Value,
                parameters,
                _cancellationTokenSource.Token);

            if (result.IsT0)
            {
                _filteredInvoices = result.AsT0.Invoices.Items;
            }
            else
            {
                _filteredInvoices = new List<InvoiceResponse>();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"{Localizer["failed_to_load_customers"]}: {ex.Message}"
            });
            _filteredInvoices = new List<InvoiceResponse>();
        }

        isLoadingInvoices = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task CreateNewInvoice()
    {
        if (!selectedCustomerId.HasValue)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["error"],
                Detail = Localizer["select_a_customer_before"]
            });
            return;
        }

        var result = await DialogService.OpenAsync<CreateInvoiceDialog>(
            Localizer["create_new_invoice"],
            new Dictionary<string, object> { { "InitialDate", DateTime.Now.Date } },
            new DialogOptions()
            {
                Width = "400px",
                Resizable = false,
                Draggable = true
            });

        if (result is DateTime selectedDate)
        {
            await CreateInvoiceWithDate(selectedDate);
        }
    }

    async Task CreateInvoiceWithDate(DateTime invoiceDate)
    {
        isLoadingInvoices = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var request = new CreateInvoiceRequest
            {
                Date = invoiceDate,
                ClientId = selectedCustomerId!.Value
            };

            var result = await invoicesApiClient.CreateInvoice(request, _cancellationTokenSource.Token);

            if (result.IsT0) // Succès
            {
                var invoiceNumber = result.AsT0;
                
                // Recharger la liste des factures
                await LoadCustomerInvoices(new LoadDataArgs());
                
                // Sélectionner automatiquement la nouvelle facture
                _selectedInvoiceId = invoiceNumber;
                
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = Localizer["success"],
                    Detail = $"{Localizer["invoice_created_successfully"]}: {invoiceNumber}"
                });
            }
            else // Erreur
            {
                var badRequest = result.AsT1;
                var errorMessage = badRequest.errors?.Any() == true
                    ? string.Join(", ", badRequest.errors.SelectMany(e => e.Value))
                    : (badRequest.Detail ?? Localizer["failed_to_create_invoice"]);

                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = errorMessage
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"{Localizer["failed_to_create_invoice"]}: {ex.Message}"
            });
        }
        finally
        {
            isLoadingInvoices = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    async Task OnProductSelectedHandler(DeliveryNoteDetailResponse order)
    {
        // Vérifier le stock disponible avant d'ajouter le produit
        if (!string.IsNullOrEmpty(order.ProductReference) && order.Quantity > 0)
        {
            var stockResult = await productsApiClient.GetProductStockAsync(order.ProductReference, _cancellationTokenSource.Token);
            if (stockResult.IsT0)
            {
                var stock = stockResult.AsT0;
                if (stock.StockDisponible < order.Quantity)
                {
                    var bloquerVenteStockInsuffisant = getAppParametersResponse?.BloquerVenteStockInsuffisant ?? true;
                    
                    // Si le blocage est activé, afficher le dialog
                    if (bloquerVenteStockInsuffisant)
                    {
                        // Afficher l'alerte de stock
                        var dialogResult = await DialogService.OpenAsync<StockWarningDialog>(
                            Localizer["alerte_stock"],
                            new Dictionary<string, object>
                            {
                                { "StockDisponible", stock.StockDisponible },
                                { "QuantiteDemandee", order.Quantity }
                            },
                            new DialogOptions { Width = "500px", Resizable = false });

                        if (dialogResult == null || (dialogResult is bool boolResult && !boolResult) || (dialogResult is string strResult && (strResult == "false" || strResult == "cancel")))
                        {
                            // Annuler - retirer le produit de la liste
                            orders.Remove(order);
                            UpdateTotals();
                            await InvokeAsync(StateHasChanged);
                            return;
                        }
                        else if (dialogResult is string strDialogResult && strDialogResult == "adjust")
                        {
                            // Ajuster la quantité au stock disponible
                            order.Quantity = stock.StockDisponible;
                            order.DeliveredQuantity = stock.StockDisponible;
                        }
                        // Si "force", on continue avec la quantité demandée
                    }
                    else
                    {
                        // Si le blocage est désactivé, afficher juste une notification d'avertissement
                        NotificationService.Notify(new NotificationMessage
                        {
                            Severity = NotificationSeverity.Warning,
                            Summary = Localizer["alerte_stock"],
                            Detail = $"{order.ProductReference}: {Localizer["stock_insuffisant"]} ({stock.StockDisponible} {Localizer["quantite_disponible"]}, {order.Quantity} {Localizer["quantite_demandee"]})"
                        });
                    }
                }
            }
        }

        // Product selection is handled in the component, this is just for any additional logic
        UpdateTotals();
        await InvokeAsync(StateHasChanged);
    }

    private async Task PrintDeliveryNote()
    {
        try
        {
            if (!orders.Any())
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["warning"],
                    Detail = Localizer["no_items_to_print"] ?? "No items to print"
                });
                return;
            }

            Result<byte[]> pdfResult;

            // Check if delivery note is saved (has a number)
            if (!string.IsNullOrEmpty(deliveryNoteNumber) && int.TryParse(deliveryNoteNumber, out var deliveryNoteNum))
            {
                // Print saved delivery note
                pdfResult = await PrintDeliveryNoteService.GenerateDeliveryNotePdfAsync(
                    deliveryNoteNum,
                    _cancellationTokenSource.Token);
            }
            else
            {
                // Print from current data (not saved yet)
                var printModel = new PrintDeliveryNoteModel
                {
                    Num = 0, // Not saved yet
                    Date = deliveryNoteDate,
                    DeliveryTime = TimeOnly.FromDateTime(DateTime.Now),
                    CustomerId = selectedCustomerId,
                    InvoiceNumber = _selectedInvoiceId,
                    TotalExcludingTax = totalHt,
                    TotalVat = totalVat,
                    TotalAmount = totalTtc,
                    Lines = orders.Select(o => new DeliveryNoteLineModel
                    {
                        Id = o.Id,
                        RefProduit = o.ProductReference,
                        DesignationLi = o.Description,
                        QteLi = o.Quantity,
                        PrixHt = o.UnitPriceExcludingTax,
                        Remise = o.DiscountPercentage,
                        TotHt = o.TotalExcludingTax,
                        Tva = o.VatPercentage,
                        TotTtc = o.TotalIncludingTax
                    }).ToList()
                };

                pdfResult = await PrintDeliveryNoteService.GenerateDeliveryNotePdfFromDataAsync(
                    printModel,
                    _cancellationTokenSource.Token);
            }

            if (pdfResult.IsSuccess)
            {
                var fileName = string.IsNullOrEmpty(deliveryNoteNumber)
                    ? $"Bon de Livraison - {deliveryNoteDate:yyyy-MM-dd}.pdf"
                    : $"Bon de Livraison {deliveryNoteNumber}.pdf";

                // Show print mode selection dialog
                var printModeResult = await DialogService.OpenAsync<PrintModeDialog>(
                    Localizer["print_mode"],
                    new Dictionary<string, object>(),
                    new DialogOptions()
                    {
                        Width = "400px",
                        Resizable = false,
                        Draggable = true
                    });

                if (printModeResult is PrintMode selectedMode)
                {
                    var printOptions = new PrintOptions
                    {
                        Mode = selectedMode,
                        FileName = fileName
                    };

                    if (selectedMode == PrintMode.DirectPrint)
                    {
                        // Show printer selection dialog
                        var printerResult = await DialogService.OpenAsync<PrinterSelectionDialog>(
                            Localizer["select_printer"],
                            new Dictionary<string, object> { { "PdfBytes", pdfResult.Value } },
                            new DialogOptions()
                            {
                                Width = "500px",
                                Resizable = false,
                                Draggable = true
                            });

                        if (printerResult is PrinterSelectionResult printerSelection)
                        {
                            printOptions.PrinterName = printerSelection.PrinterName;
                            printOptions.Copies = printerSelection.Copies;
                            printOptions.Duplex = printerSelection.Duplex;
                        }
                        else
                        {
                            return; // User cancelled
                        }
                    }

                    var printResult = await PrintService.PrintAsync(pdfResult.Value, printOptions, _cancellationTokenSource.Token);

                    if (!printResult.IsSuccess)
                    {
                        NotificationService.Notify(new NotificationMessage
                        {
                            Severity = NotificationSeverity.Error,
                            Summary = Localizer["error"],
                            Detail = $"{Localizer["failed_to_print_delivery_note"] ?? "Failed to print delivery note"}: {printResult.ErrorMessage}"
                        });
                    }
                    else if (selectedMode == PrintMode.DirectPrint)
                    {
                        NotificationService.Notify(new NotificationMessage
                        {
                            Severity = NotificationSeverity.Success,
                            Summary = Localizer["success"],
                            Detail = Localizer["print_job_submitted"] ?? "Print job submitted successfully"
                        });
                    }
                }
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = $"{Localizer["failed_to_print_delivery_note"] ?? "Failed to print delivery note"}: {pdfResult.Errors.First().Message}"
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"{Localizer["failed_to_print_delivery_note"] ?? "Failed to print delivery note"}: {ex.Message}"
            });
            logger.LogError(ex, "Failed to print delivery note");
        }
    }

    async Task OnItemsChanged(List<DeliveryNoteDetailResponse> items)
    {
        orders = items;
        UpdateTotals();
        await InvokeAsync(StateHasChanged);
    }

    private void UpdateTotals()
    {
        LineItemCalculator.UpdateTotals(orders, out totalHt, out totalVat, out totalTtc);
    }

    private async Task SaveTags()
    {
        if (tagSelectorRef == null || string.IsNullOrEmpty(deliveryNoteNumber) || !int.TryParse(deliveryNoteNumber, out var blNumber))
        {
            logger.LogWarning("Cannot save tags: tagSelectorRef={TagSelectorRef}, deliveryNoteNumber={DeliveryNoteNumber}", 
                tagSelectorRef == null ? "null" : "not null", deliveryNoteNumber);
            return;
        }

        try
        {
            // Récupérer les tags à ajouter et à supprimer
            var tagsToAdd = tagSelectorRef.GetTagsToAdd();
            var tagIdsToRemove = tagSelectorRef.GetTagIdsToRemove();

            logger.LogInformation("Saving tags for delivery note {Number}: {AddCount} to add, {RemoveCount} to remove", 
                blNumber, tagsToAdd.Count, tagIdsToRemove.Count);

            // Supprimer les tags (seulement ceux qui ont un Id > 0, car les tags avec Id = 0 ne sont pas encore en base)
            var validTagIdsToRemove = tagIdsToRemove.Where(id => id > 0).ToList();
            if (validTagIdsToRemove.Any())
            {
                var removeRequest = new RemoveTagsFromDocumentRequest { TagIds = validTagIdsToRemove };
                var removeSuccess = await TagsService.RemoveTagsFromDocumentAsync("BonDeLivraison", blNumber, removeRequest);
                if (!removeSuccess)
                {
                    logger.LogWarning("Failed to remove tags from delivery note {Number}", blNumber);
                }
            }

            // Ajouter les nouveaux tags
            if (tagsToAdd.Any())
            {
                var addRequest = new AddTagsToDocumentByNameRequest { TagNames = tagsToAdd };
                var addSuccess = await TagsService.AddTagsToDocumentByNameAsync("BonDeLivraison", blNumber, addRequest);
                if (!addSuccess)
                {
                    logger.LogWarning("Failed to add tags to delivery note {Number}", blNumber);
                }
            }

            // Recharger les tags dans le TagSelector pour mettre à jour InitialTags
            if (tagSelectorRef != null)
            {
                await tagSelectorRef.LoadDocumentTags();
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to save tags for delivery note {Number}", deliveryNoteNumber);
            // Ne pas bloquer la sauvegarde du document si les tags échouent
            // Afficher une notification pour informer l'utilisateur
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"] ?? "Warning",
                Detail = "Les tags n'ont pas pu être sauvegardés, mais le document a été enregistré."
            });
        }
    }


    public async Task ShowDialog(string ProductReference)
    {
        await LoadStateAsync();

        await DialogService.OpenAsync<ProductHistoryDialog>($"{Localizer["history"]} {Localizer["article"]} {ProductReference}",
            new Dictionary<string, object>() { { "ProductReference", ProductReference } },
            new DialogOptions()
            {
                Resizable = true,
                Draggable = true,
                Resize = OnResize,
                Drag = OnDrag,
                Width = Settings != null ? Settings.Width : "700px",
                Height = Settings != null ? Settings.Height : "512px",
                Left = Settings != null ? Settings.Left : null,
                Top = Settings != null ? Settings.Top : null
            });

        await SaveStateAsync();
    }

    void OnDrag(System.Drawing.Point point)
    {
        JSRuntime.InvokeVoidAsync("eval", $"console.log('Dialog drag. Left:{point.X}, Top:{point.Y}')");

        if (Settings == null)
        {
            Settings = new DialogSettings();
        }

        Settings.Left = $"{point.X}px";
        Settings.Top = $"{point.Y}px";

        InvokeAsync(SaveStateAsync);
    }

    void OnResize(System.Drawing.Size size)
    {
        JSRuntime.InvokeVoidAsync("eval", $"console.log('Dialog resize. Width:{size.Width}, Height:{size.Height}')");

        if (Settings == null)
        {
            Settings = new DialogSettings();
        }

        Settings.Width = $"{size.Width}px";
        Settings.Height = $"{size.Height}px";

        InvokeAsync(SaveStateAsync);
    }

    DialogSettings _settings;
    public DialogSettings Settings
    {
        get
        {
            return _settings;
        }
        set
        {
            if (_settings != value)
            {
                _settings = value;
                InvokeAsync(SaveStateAsync);
            }
        }
    }

    private async Task LoadStateAsync()
    {
        await Task.CompletedTask;

        var result = await JSRuntime.InvokeAsync<string>("window.localStorage.getItem", "DialogSettings");
        if (!string.IsNullOrEmpty(result))
        {
            _settings = JsonSerializer.Deserialize<DialogSettings>(result);
        }
    }

    private async Task SaveStateAsync()
    {
        await Task.CompletedTask;

        await JSRuntime.InvokeVoidAsync("window.localStorage.setItem", "DialogSettings", JsonSerializer.Serialize<DialogSettings>(Settings));
    }

    public class DialogSettings
    {
        public string Left { get; set; }
        public string Top { get; set; }
        public string Width { get; set; }
        public string Height { get; set; }
    }
}