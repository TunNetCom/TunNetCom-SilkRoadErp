@page "/delivery-notes"
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote.Responses
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.DeliveryNote
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@inject IDeliveryNoteApiClient DeliveryNoteService
@inject ICustomersApiClient CustomersService
@inject IStringLocalizer<SharedResource> Localizer
@inject ODataService ODataService
@inject ILogger<DeliveryNotesList> _logger
@using Radzen.Blazor
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Customers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@inject NavigationManager NavigationManager
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@using TunNetCom.SilkRoadErp.Sales.Contracts.Tags
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Tags
@using TunNetCom.SilkRoadErp.Sales.Contracts.InstallationTechnician.Responses
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.InstallationTechnician
@inject ITagsApiClient TagsService
@inject IInstallationTechnicianApiClient TechnicianService
@inject Radzen.NotificationService NotificationService
@inject DialogService DialogService
@inject IInvoicesApiClient InvoicesService
@inject IJSRuntime JS
@using TunNetCom.SilkRoadErp.Sales.Domain.Entites
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Invoices
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@using TunNetCom.SilkRoadErp.Sales.Contracts.Sorting


<div class="delivery-notes-list-container">
    <div class="search-header">
        <PeriodFilter @bind-SelectedPeriod="searchCriteria.PeriodFilter"
                     @bind-StartDate="searchCriteria.StartDate"
                     @bind-EndDate="searchCriteria.EndDate"
                     OnPeriodChanged="@OnPeriodFilterChanged" />
        <div class="search-field">
            <label for="customer">Client</label>
            <RadzenDropDownDataGrid id="customer"
                                    AllowClear="true"
                                    @bind-Value="@searchCriteria.SelectedCustomerId"
                                    LoadData="@LoadCustomers"
                                    AllowFiltering="true"
                                    class="w-100 search-input"
                                    Data="@_filteredCustomers"
                                    TextProperty="@nameof(CustomerResponse.Name)"
                                    ValueProperty="@nameof(CustomerResponse.Id)"
                                    Placeholder="Selectionner un client">
                <Columns>
                    <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Id)" Title="ID" Width="80px" />
                    <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Name)" Title="@Localizer["name"]" Width="220px" />
                </Columns>
            </RadzenDropDownDataGrid>
        </div>
        <div class="search-field">
            <label for="technician">Installateur</label>
            <RadzenDropDownDataGrid id="technician"
                                    AllowClear="true"
                                    @bind-Value="@searchCriteria.SelectedTechnicianId"
                                    LoadData="@LoadTechnicians"
                                    AllowFiltering="true"
                                    Count="@techniciansCount"
                                    PageSize="15"
                                    class="w-100 search-input"
                                    Data="@_filteredTechnicians"
                                    TextProperty="@nameof(InstallationTechnicianResponse.Nom)"
                                    ValueProperty="@nameof(InstallationTechnicianResponse.Id)"
                                    Placeholder="Sélectionner un installateur">
                <Template Context="technician">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        @if (!string.IsNullOrEmpty(technician.Photo))
                        {
                            <img src="@technician.Photo" alt="@technician.Nom" style="width: 18px; height: 18px; border-radius: 50%; object-fit: cover;" />
                        }
                        else
                        {
                            <div style="width: 18px; height: 18px; border-radius: 50%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center;">
                                <RadzenIcon Icon="person" Style="font-size: 10px;" />
                            </div>
                        }
                        <span>@technician.Nom @(string.IsNullOrEmpty(technician.Tel) ? "" : $"({technician.Tel})")</span>
                    </div>
                </Template>
                <ValueTemplate Context="technician">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        @if (!string.IsNullOrEmpty(technician?.Photo))
                        {
                            <img src="@technician.Photo" alt="@technician.Nom" style="width: 18px; height: 18px; border-radius: 50%; object-fit: cover;" />
                        }
                        else
                        {
                            <div style="width: 18px; height: 18px; border-radius: 50%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center;">
                                <RadzenIcon Icon="person" Style="font-size: 10px;" />
                            </div>
                        }
                        <span>@technician?.Nom</span>
                    </div>
                </ValueTemplate>
                <Columns>
                    <RadzenDropDownDataGridColumn Property="@nameof(InstallationTechnicianResponse.Id)" Title="ID" Width="80px" />
                    <RadzenDropDownDataGridColumn Property="@nameof(InstallationTechnicianResponse.Nom)" Title="Nom" Width="180px" />
                    <RadzenDropDownDataGridColumn Property="@nameof(InstallationTechnicianResponse.Tel)" Title="Téléphone" Width="120px" />
                </Columns>
            </RadzenDropDownDataGrid>
        </div>
        <TagSearchFilter SelectedTagIds="@searchCriteria.SelectedTagIds"
                       SelectedTagIdsChanged="@OnTagIdsChanged" />
        <div class="search-field">
            <label>Statut</label>
            <RadzenDropDown @bind-Value="@searchCriteria.Status"
                            Data="@(Enum.GetValues(typeof(DocumentStatus)).Cast<DocumentStatus>().Select(e => new { Value = (int?)e, Text = e.ToString() }).Prepend(new { Value = (int?)null, Text = "Tous" }))"
                            TextProperty="Text"
                            ValueProperty="Value"
                            class="w-100 search-input" />
        </div>
        <div class="search-button" style="display: flex; gap: 8px;">
            <RadzenButton Icon="today"
                          ButtonStyle="ButtonStyle.Info"
                          Click="@FilterToday"
                          Title="Aujourd'hui"
                          AriaLabel="Aujourd'hui"
                          class="action-button" />
            <RadzenButton Icon="search"
                          ButtonStyle="ButtonStyle.Primary"
                          Click="@SearchDeliveryNotes"
                          class="action-button" />
            <RadzenButton Icon="check_circle"
                          ButtonStyle="ButtonStyle.Success"
                          Click="@ValidateSelectedDeliveryNotes"
                          Disabled="@(selectedDeliveryNotes == null || !selectedDeliveryNotes.Any())"
                          Title="Valider la sélection"
                          AriaLabel="Valider la sélection"
                          class="action-button" />
            <RadzenButton Icon="table_chart"
                          ButtonStyle="ButtonStyle.Info"
                          Click="@ExportToExcelAsync"
                          class="action-button"
                          Style="margin-left: 8px;"
                          Title="Exporter vers Excel"
                          AriaLabel="Exporter vers Excel" />
            <RadzenButton Icon="picture_as_pdf"
                          ButtonStyle="ButtonStyle.Warning"
                          Click="@ExportToPdfAsync"
                          class="action-button"
                          Style="margin-left: 8px;"
                          Title="Exporter vers PDF"
                          AriaLabel="Exporter vers PDF" />
        </div>
    </div>
    <div class="list-card">
        <h2>Bons de livraison</h2>
        <RadzenDataGrid @ref="deliveryNotesGrid"
                        Data="@deliveryNotesList"
                        LoadData="@Callback"
                        TItem="GetDeliveryNoteBaseInfos"
                        SelectionMode="DataGridSelectionMode.Multiple"
                        @bind-Value="selectedDeliveryNotes"
                        AllowSorting="true"
                        AllowFiltering="true"
                        AllowPaging="true"
                        PageSize="@pageSize"
                        PageSizeOptions="@GridPageSizeConstants.PageSizeOptions"
                        Count="@totalCount"
                        AllowColumnResize="true"
                        Loading="@_isLoadingList">
            <EmptyTemplate>
                <p style="font-size: 24px; text-align: center; margin: 2rem;">No records to display.</p>
            </EmptyTemplate>
            <Columns>
                <RadzenDataGridColumn TItem="GetDeliveryNoteBaseInfos" Width="40px" Sortable="false" Filterable="false">
                    <HeaderTemplate>
                        <RadzenCheckBox TriState="false" TValue="bool" Value="@(deliveryNotesList != null && deliveryNotesList.Any() && selectedDeliveryNotes != null && deliveryNotesList.All(i => selectedDeliveryNotes.Contains(i)))"
                                        Change="@(args => { if(args == true) { selectedDeliveryNotes = deliveryNotesList.ToList(); } else { selectedDeliveryNotes = new List<GetDeliveryNoteBaseInfos>(); } })" />
                    </HeaderTemplate>
                    <Template Context="data">
                        <RadzenCheckBox TriState="false" Value="@(selectedDeliveryNotes != null && selectedDeliveryNotes.Contains(data))" 
                                        TValue="bool" Change="@(args => { if(selectedDeliveryNotes == null) selectedDeliveryNotes = new List<GetDeliveryNoteBaseInfos>(); if(args) { if(!selectedDeliveryNotes.Contains(data)) selectedDeliveryNotes.Add(data); } else { selectedDeliveryNotes.Remove(data); } })" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="GetDeliveryNoteBaseInfos" Property="Statut" Title="Statut" Width="100px">
                    <Template Context="item">
                        <span class="status-tag" style="@GetStatusStyle(item.Statut)">
                            @(item.Statut == 1 ? "Validé" : "Brouillon")
                        </span>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="GetDeliveryNoteBaseInfos"
                                      Property="@nameof(GetDeliveryNoteBaseInfos.Number)"
                                      Title="Numéro"
                                      Width="150px" />
                <RadzenDataGridColumn TItem="GetDeliveryNoteBaseInfos"
                                      Property="@nameof(GetDeliveryNoteBaseInfos.Date)"
                                      Title="@Localizer["date"]"
                                      Width="150px"
                                      FormatString="{0:d MMMM yyyy}" />
                <RadzenDataGridColumn TItem="GetDeliveryNoteBaseInfos"
                                      Property="@nameof(GetDeliveryNoteBaseInfos.CustomerName)"
                                      Title="Client"
                                      Width="200px" />
                <RadzenDataGridColumn TItem="GetDeliveryNoteBaseInfos"
                                      Property="@nameof(GetDeliveryNoteBaseInfos.NetAmount)"
                                      Title="@Localizer["total_net"]"
                                      Width="150px">
                    <Template Context="item">
                        @item.NetAmount.FormatAmount()
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="GetDeliveryNoteBaseInfos"
                                      Title="Tags"
                                      Width="300px"
                                      Sortable="false"
                                      Filterable="false"
                                      Resizable="true">
                    <Template Context="item">
                        <div style="width: 100%; padding: 4px;">
                            <TagSelector DocumentType="BonDeLivraison"
                                         DocumentId="@item.Number"
                                         SaveOnChange="true" />
                        </div>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="GetDeliveryNoteBaseInfos"
                                      Title="@Localizer["actions_label"]"
                                      Width="200px"
                                      Sortable="false"
                                      Filterable="false">
                    <Template Context="item">
                        @if (item.Statut == 1)
                        {
                            <RadzenButton Icon="visibility"
                                          ButtonStyle="ButtonStyle.Info"
                                          Variant="Variant.Flat"
                                          Size="ButtonSize.Small"
                                          Click="@(() => ViewDeliveryNote(item.Number.ToString()))"
                                          Title="@Localizer["View"]"
                                          AriaLabel="@Localizer["View"]" 
                                          Style="margin-right: 4px;" />
                        }
                        else
                        {
                            <RadzenButton Icon="edit"
                                          ButtonStyle="ButtonStyle.Primary"
                                          Variant="Variant.Flat"
                                          Size="ButtonSize.Small"
                                          Click="@(() => ViewDeliveryNote(item.Number.ToString()))"
                                          Title="@Localizer["Edit"]"
                                          AriaLabel="@Localizer["Edit"]" 
                                          Style="margin-right: 4px;" />
                            <RadzenButton Icon="check_circle"
                                          ButtonStyle="ButtonStyle.Success"
                                          Variant="Variant.Flat"
                                          Size="ButtonSize.Small"
                                          Click="@(() => ValidateDeliveryNote(item))"
                                          Title="@Localizer["Validate"]"
                                          AriaLabel="@Localizer["Validate"]"
                                          Style="margin-right: 4px;" />
                        }
                        <RadzenButton Icon="payment"
                                      ButtonStyle="ButtonStyle.Info"
                                      Variant="Variant.Flat"
                                      Size="ButtonSize.Small"
                                      Click="@(() => OpenCreatePaiementDialog(item))"
                                      Disabled="@(!item.CustomerId.HasValue)"
                                      Title="@(item.CustomerId.HasValue ? "Ajouter Paiement" : "Ajouter Paiement (Client requis)")"
                                      AriaLabel="Ajouter Paiement" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
        <RadzenCard class="summary-card" Variant="Variant.Outlined">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal"
                         Gap="1.5rem"
                         JustifyContent="JustifyContent.End"
                         class="summary-stack">
                <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                    HT: <strong>@totalGrossAmount.FormatAmount()</strong>
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                    @Localizer["total_vat"]: <strong>@totalVatAmount.FormatAmount()</strong>
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                    @Localizer["total_net"]: <strong>@totalNetAmount.FormatAmount()</strong>
                </RadzenText>
            </RadzenStack>
        </RadzenCard>
    </div>
</div>

@* CSS remains unchanged *@
<style>
    .status-tag {
        font-size: 0.75rem;
        padding: 0.125rem 0.5rem;
        display: inline-flex;
        align-items: center;
        border-radius: 3px;
        line-height: 1.5;
        font-weight: 500;
    }

    .delivery-notes-list-container {
        padding: 0;
        min-height: 100%;
    }

    .list-card {
        width: 100%;
        margin: 0;
    }

    h2 {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 20px;
        margin: 0 0 16px 0;
        padding: 0;
    }

    /* Action button styles (unchanged) */
    .action-button {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        font-weight: 500;
        padding: 6px 12px;
        border-radius: 6px;
        background-color: #3b82f6;
        border: none;
        transition: background-color 0.2s, box-shadow 0.2s;
    }

        .action-button:hover:not(:disabled) {
            background-color: #2563eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .action-button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }

    /* Search header styles */
    .search-header {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin: 0 0 16px 0;
        align-items: end;
        padding: 0;
    }

    .search-field {
        display: flex;
        flex-direction: column;
    }

        .search-field label {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
        }

    .search-input {
        width: 100% !important;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        padding: 8px;
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

        .search-input:hover {
            border-color: #9ca3af;
        }

        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

    .search-button {
        display: flex;
        align-items: flex-end;
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .delivery-notes-list-container {
            padding: 0;
        }

        h2 {
            font-size: 18px;
        }

        .action-button {
            font-size: 12px;
            padding: 6px 10px;
        }

        .search-header {
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .search-field {
            min-width: 100%;
        }

            .search-field label {
                font-size: 12px;
            }

        .search-input {
            font-size: 13px;
            padding: 6px;
        }

        .search-button {
            margin-bottom: 0;
        }
    }

    .summary-card {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        flex: 0 0 auto;
    }
    /* Summary stack */
    .summary-stack {
        gap: 1.5rem;
    }
    /* Summary text */
    .summary-text {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        line-height: 1.5;
    }

        .summary-text strong {
            font-weight: 600;
        }

    @@media (min-width: 769px) and (max-width: 1024px) {
        .search-header {
            grid-template-columns: repeat(2, 1fr);
        }

        .summary-card {
            width: 100%;
            padding: 8px 12px;
        }

        .summary-stack {
            flex-direction: column;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .summary-text {
            font-size: 12px;
        }
    }

    /* Style pour le bouton "Oui" dans les modals de confirmation */
    ::deep .rz-dialog-footer button:first-child {
        background-color: #4CAF50 !important;
        color: white !important;
        border-color: #4CAF50 !important;
    }

    ::deep .rz-dialog-footer button:first-child:hover {
        background-color: #45a049 !important;
        border-color: #45a049 !important;
    }
</style>

@code {
    private const int CustomerDropdownPageSize = 10;
    
    private RadzenDataGrid<GetDeliveryNoteBaseInfos> deliveryNotesGrid = default!;
    private List<GetDeliveryNoteBaseInfos> deliveryNotesList = new();
    private IList<GetDeliveryNoteBaseInfos> selectedDeliveryNotes = new List<GetDeliveryNoteBaseInfos>();
    private int totalCount = 0;
    private decimal totalNetAmount = 0;
    private decimal totalVatAmount = 0;
    private decimal totalGrossAmount = 0;
    private int pageSize = GridPageSizeConstants.PageSize10;
    private SearchCriteria searchCriteria = new SearchCriteria();
    private List<CustomerResponse> _filteredCustomers = new();
    private List<InstallationTechnicianResponse> _filteredTechnicians = new();
    private int techniciansCount = 0;
    private string? _lastSortProperty;
    private string? _lastSortOrder;
    private bool _isLoadingList;

    protected override async Task OnInitializedAsync()
    {
        _logger.LogInformation("DeliveryNotesList.OnInitializedAsync called");
        
        await LoadCustomers(new LoadDataArgs { Filter = string.Empty });

        // Set default period to CurrentMonth and calculate dates
        searchCriteria.PeriodFilter = "CurrentMonth";
        var (startDate, endDate) = PeriodFilterHelper.GetDateRangeFromPeriod(
            searchCriteria.PeriodFilter, 
            searchCriteria.StartDate, 
            searchCriteria.EndDate);
        searchCriteria.StartDate = startDate;
        searchCriteria.EndDate = endDate;

        // Load initial data
        _logger.LogInformation("Calling Callback to load initial data");
        await Callback(new LoadDataArgs { Skip = 0, Top = pageSize });
    }

    async Task LoadCustomers(LoadDataArgs args)
    {
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = CustomerDropdownPageSize,
            SearchKeyword = args?.Filter ?? string.Empty
        };

        try
        {
            var pagedCustomers = await CustomersService.SearchCustomers(parameters, default);
            _filteredCustomers = pagedCustomers != null && pagedCustomers.Items != null 
                ? pagedCustomers.Items.ToList() 
                : new List<CustomerResponse>();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading customers: {Message}", ex.Message);
            _filteredCustomers = new List<CustomerResponse>();
        }

        await InvokeAsync(StateHasChanged);
    }

    async Task LoadTechnicians(LoadDataArgs args)
    {
        try
        {
            var effectiveArgs = args ?? new LoadDataArgs { Skip = 0, Top = 15 };
            if (!effectiveArgs.Top.HasValue || effectiveArgs.Top.Value <= 0)
                effectiveArgs = new LoadDataArgs { Skip = effectiveArgs.Skip ?? 0, Top = 15, Filter = effectiveArgs.Filter };

            var response = await ODataService.QueryAsync<InstallationTechnicianResponse>(
                entitySet: "InstallationTechnicianBaseInfos",
                args: effectiveArgs,
                cancellationToken: default);

            _filteredTechnicians = response.Value ?? new List<InstallationTechnicianResponse>();
            techniciansCount = response.ODataCount ?? _filteredTechnicians.Count;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading technicians: {Message}", ex.Message);
            _filteredTechnicians = new List<InstallationTechnicianResponse>();
            techniciansCount = 0;
        }

        await InvokeAsync(StateHasChanged);
    }

    private void ViewDeliveryNote(string id)
    {
        NavigationManager.NavigateTo($"/AddOrUpdateDeliveryNote/{id}");
    }

    private async Task SearchDeliveryNotes()
    {
        // Trigger a refresh by calling Callback with current args
        await Callback(new LoadDataArgs { Skip = 0, Top = pageSize });
    }

    private async Task FilterToday()
    {
        var today = DateTime.Today;
        searchCriteria.StartDate = today;
        searchCriteria.EndDate = today.AddDays(1).AddTicks(-1);
        searchCriteria.PeriodFilter = "CustomPeriod";
        await SearchDeliveryNotes();
    }

    private async Task ValidateSelectedDeliveryNotes()
    {
        if (selectedDeliveryNotes == null || !selectedDeliveryNotes.Any())
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Warning, Summary = Localizer["Attention"], Detail = Localizer["Select_At_Least_One_DeliveryNote"] });
            return;
        }

        var count = selectedDeliveryNotes.Count;
        var confirmed = await DialogService.Confirm(
            string.Format(Localizer["Confirmation_Validation_DeliveryNotes"], count, count > 1 ? "s" : ""),
            Localizer["Confirmation_Validation_Titre"],
            new ConfirmOptions() { OkButtonText = Localizer["Oui"], CancelButtonText = Localizer["Non"] });

        if (confirmed != true)
        {
            return;
        }
        
        var ids = selectedDeliveryNotes.Select(d => d.Number).ToList();
        var result = await DeliveryNoteService.ValidateDeliveryNotesAsync(ids, default);
        
        if (result.IsSuccess)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = Localizer["Success"], Detail = Localizer["Validation_Success_DeliveryNotes"] });
            selectedDeliveryNotes.Clear();
            if (deliveryNotesGrid != null)
            {
                await deliveryNotesGrid.Reload();
            }
            else
            {
                await SearchDeliveryNotes();
            }
        }
        else
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = Localizer["Error"], Detail = result.Errors.FirstOrDefault()?.Message ?? Localizer["Unexpected_Error"] });
        }
    }

    private async Task ValidateDeliveryNote(GetDeliveryNoteBaseInfos item)
    {
        var confirmed = await DialogService.Confirm(
            string.Format(Localizer["Confirmation_Validation_DeliveryNote"], item.Number),
            Localizer["Confirmation_Validation_Titre"],
            new ConfirmOptions() { OkButtonText = Localizer["Oui"], CancelButtonText = Localizer["Non"] });

        if (confirmed != true)
        {
            return;
        }

        var result = await DeliveryNoteService.ValidateDeliveryNotesAsync(new List<int> { item.Number }, default);
        
        if (result.IsSuccess)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = Localizer["Success"], Detail = Localizer["Validation_Success_DeliveryNote"] });
            if (deliveryNotesGrid != null)
            {
                await deliveryNotesGrid.Reload();
            }
            else
            {
                await SearchDeliveryNotes();
            }
        }
        else
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = Localizer["Error"], Detail = result.Errors.FirstOrDefault()?.Message ?? Localizer["Unexpected_Error"] });
        }
    }

    private async Task Callback(LoadDataArgs args)
    {
        _logger.LogInformation("DeliveryNotesList.Callback called with Skip: {Skip}, Top: {Top}", args.Skip, args.Top);
        _isLoadingList = true;
        // Update pageSize if Top is provided
        if (args.Top.HasValue && args.Top.Value > 0)
        {
            pageSize = args.Top.Value;
        }
        
        // Ensure pageSize is valid
        if (pageSize <= 0)
        {
            pageSize = GridPageSizeConstants.PageSize10;
        }
        
        var (startDate, endDate) = PeriodFilterHelper.GetDateRangeFromPeriod(
            searchCriteria.PeriodFilter,
            searchCriteria.StartDate,
            searchCriteria.EndDate);

        _logger.LogInformation("Date range: StartDate: {StartDate}, EndDate: {EndDate}", startDate, endDate);

        try
        {
            _logger.LogInformation("Calling DeliveryNoteService.GetDeliveryNotesWithSummariesAsync");
            
            // Calculate page number from Skip and pageSize
            var skip = args.Skip ?? 0;
            var pageNumber = skip / pageSize + 1;
            
            // Determine sort order and property from args (default: by document number ascending)
            string? sortOrder = null;
            string? sortProperty = null;
            if (args.Sorts != null && args.Sorts.Any())
            {
                var firstSort = args.Sorts.First();
                sortOrder = firstSort.SortOrder == SortOrder.Ascending ? SortConstants.Ascending : SortConstants.Descending;
                sortProperty = firstSort.Property;
            }
            else
            {
                sortProperty = nameof(GetDeliveryNoteBaseInfos.Number);
                sortOrder = SortConstants.Ascending;
            }
            _lastSortProperty = sortProperty;
            _lastSortOrder = sortOrder;

            // Determine isInvoiced from InvoiceStatus filter
            bool? isInvoiced = null;
            if (searchCriteria.InvoiceStatus == "Facturé")
            {
                isInvoiced = true;
            }
            else if (searchCriteria.InvoiceStatus == "Non facturé")
            {
                isInvoiced = false;
            }

            var response = await DeliveryNoteService.GetDeliveryNotesWithSummariesAsync(
                customerId: searchCriteria.SelectedCustomerId,
                invoiceId: null,
                isInvoiced: isInvoiced,
                sortOrder: sortOrder,
                sortProperty: sortProperty,
                pageNumber: pageNumber,
                pageSize: pageSize,
                searchKeyword: args.Filter,
                startDate: startDate,
                EndDate: endDate,
                status: searchCriteria.Status,
                technicianId: searchCriteria.SelectedTechnicianId,
                tagIds: searchCriteria.SelectedTagIds?.Any() == true ? searchCriteria.SelectedTagIds : null,
                cancellationToken: default);

            deliveryNotesList = response.GetDeliveryNoteBaseInfos.Items?.ToList() ?? new List<GetDeliveryNoteBaseInfos>();
            totalCount = response.GetDeliveryNoteBaseInfos.TotalCount;

            // Use totals from response (calculated across all pages)
            totalNetAmount = response.TotalNetAmount;
            totalVatAmount = response.TotalVatAmount;
            totalGrossAmount = response.TotalGrossAmount;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading delivery notes: {Message}", ex.Message);
            deliveryNotesList = new List<GetDeliveryNoteBaseInfos>();
            totalCount = 0;
            totalNetAmount = 0;
            totalVatAmount = 0;
            totalGrossAmount = 0;
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = Localizer["Error"], 
                Detail = $"Erreur lors du chargement des données: {ex.Message}" 
            });
        }
        finally
        {
            _isLoadingList = false;
        }

        await InvokeAsync(StateHasChanged);
    }

    private string GetStatusStyle(int statut)
    {
        return statut == 1 
            ? "background-color: #388e3c; color: #fff;" 
            : "background-color: #e1e1e1; color: #333;";
    }

    public class SearchCriteria
    {
        public string PeriodFilter { get; set; } = "CurrentMonth";
        public DateTime? StartDate { get; set; }
        public DateTime? EndDate { get; set; }
        public int? SelectedCustomerId { get; set; }
        public int? SelectedTechnicianId { get; set; }
        public string InvoiceStatus { get; set; } = "Tous";
        public List<int> SelectedTagIds { get; set; } = new();
        public int? Status { get; set; }
    }

    private void OnPeriodFilterChanged()
    {
        StateHasChanged();
    }

    private async Task OnTagIdsChanged(List<int> tagIds)
    {
        searchCriteria.SelectedTagIds = tagIds;
        await SearchDeliveryNotes();
    }

    private async Task OpenCreatePaiementDialog(GetDeliveryNoteBaseInfos item)
    {
        int? invoiceId = null;
        
        // Si le BL a une facture associée, récupérer son ID
        if (item.NumFacture.HasValue)
        {
            var invoiceIdResult = await InvoicesService.GetInvoiceIdByNumberAsync(item.NumFacture.Value, default);
            if (invoiceIdResult.IsSuccess)
            {
                invoiceId = invoiceIdResult.Value;
            }
        }
        
        var result = await DialogService.OpenAsync<CreatePaiementFromBlDialog>(
            "Nouveau Paiement",
            new Dictionary<string, object>
            {
                { "DeliveryNoteId", item.Id },
                { "CustomerId", item.CustomerId.Value },
                { "InvoiceId", invoiceId }
            },
            new DialogOptions
            {
                Width = "800px",
                Height = "90%",
                Resizable = true,
                Draggable = true
            });
        
        if (result == true)
        {
            // Optionnel : recharger la liste des BL
            await SearchDeliveryNotes();
        }
    }

    private async Task ExportToExcelAsync()
    {
        try
        {
            _logger.LogInformation("ExportToExcelAsync called for delivery notes");

            var (startDate, endDate) = PeriodFilterHelper.GetDateRangeFromPeriod(
                searchCriteria.PeriodFilter,
                searchCriteria.StartDate,
                searchCriteria.EndDate);

            var columnsToExport = new[] { "Number", "Date", "CustomerName", "NetAmount", "VatAmount" };
            var orderBy = !string.IsNullOrEmpty(_lastSortProperty) && _lastSortOrder != null
                ? $"{_lastSortProperty} {(_lastSortOrder == SortConstants.Ascending ? SortConstants.Ascending : SortConstants.Descending)}"
                : null;

            var (content, fileName) = await DeliveryNoteService.ExportDeliveryNotesToExcelAsync(
                startDate,
                endDate,
                searchCriteria.SelectedCustomerId,
                searchCriteria.SelectedTechnicianId,
                searchCriteria.SelectedTagIds?.Any() == true ? searchCriteria.SelectedTagIds : null,
                searchCriteria.Status,
                columnsToExport,
                orderBy,
                default);

            await JS.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(content));

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = Localizer["Success"],
                Detail = "Export Excel réussi"
            });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error exporting delivery notes to Excel");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Error"],
                Detail = $"Erreur lors de l'export: {ex.Message}"
            });
        }
    }

    private async Task ExportToPdfAsync()
    {
        try
        {
            _logger.LogInformation("ExportToPdfAsync called for delivery notes");

            var (startDate, endDate) = PeriodFilterHelper.GetDateRangeFromPeriod(
                searchCriteria.PeriodFilter,
                searchCriteria.StartDate,
                searchCriteria.EndDate);

            var columnsToExport = new[] { "Number", "Date", "CustomerName", "NetAmount", "VatAmount" };
            var orderBy = !string.IsNullOrEmpty(_lastSortProperty) && _lastSortOrder != null
                ? $"{_lastSortProperty} {(_lastSortOrder == SortConstants.Ascending ? SortConstants.Ascending : SortConstants.Descending)}"
                : null;

            var (content, fileName) = await DeliveryNoteService.ExportDeliveryNotesToPdfAsync(
                startDate,
                endDate,
                searchCriteria.SelectedCustomerId,
                searchCriteria.SelectedTechnicianId,
                searchCriteria.SelectedTagIds?.Any() == true ? searchCriteria.SelectedTagIds : null,
                searchCriteria.Status,
                columnsToExport,
                orderBy,
                default);

            await DialogService.OpenAsync<PdfViewerDialog>(
                Localizer["print_mode"],
                new Dictionary<string, object>
                {
                    { "PdfBytes", content },
                    { "FileName", fileName }
                },
                new DialogOptions()
                {
                    Width = "900px",
                    Height = "800px",
                    Resizable = true,
                    Draggable = true
                });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error exporting delivery notes to PDF");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Error"],
                Detail = $"Erreur lors de l'export: {ex.Message}"
            });
        }
    }
}
