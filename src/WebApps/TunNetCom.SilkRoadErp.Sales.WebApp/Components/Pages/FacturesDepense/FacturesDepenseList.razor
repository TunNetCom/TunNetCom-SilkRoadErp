@page "/factures-depenses"
@implements IDisposable
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.FactureDepense
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.TiersDepenseFonctionnement
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AccountingYear
@using TunNetCom.SilkRoadErp.Sales.Contracts
@using TunNetCom.SilkRoadErp.Sales.Contracts.FactureDepense
@using TunNetCom.SilkRoadErp.Sales.Contracts.TiersDepenseFonctionnement
@using TunNetCom.SilkRoadErp.Sales.Contracts.AccountingYear
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@using Radzen
@using Radzen.Blazor
@inject IFactureDepenseApiClient FactureDepenseService
@inject ITiersDepenseFonctionnementApiClient TiersDepenseService
@inject IAccountingYearApiClient AccountingYearService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> Localizer
@inject Radzen.NotificationService NotificationService
@inject ToastService ToastService
@inject DialogService DialogService
@inject IDecimalFormatService DecimalFormatService

<div class="factures-container">
    <div class="factures-card">
        <div class="factures-header">
            <h3 class="factures-title">Factures dépenses</h3>
            <RadzenButton Icon="add" Text="Nouvelle facture dépense"
                          ButtonStyle="ButtonStyle.Primary"
                          Click="@(() => NavigationManager.NavigateTo("/factures-depenses/add"))"
                          Class="btn-primary" />
        </div>

        <div class="filters">
            <div class="search-field">
                <label>@Localizer["Tiers_Depenses"]</label>
                <RadzenDropDownDataGrid AllowClear="true"
                                        IsLoading="@isLoadingTiers"
                                        @bind-Value="selectedTiersId"
                                        LoadData="@LoadTiers"
                                        AllowFiltering="true"
                                        Style="width: 280px;"
                                        Data="@_filteredTiers"
                                        TextProperty="Nom"
                                        ValueProperty="Id"
                                        Placeholder="@Localizer["Select_Tiers"]"
                                        Change="@OnFilterChange">
                    <Columns>
                        <RadzenDropDownDataGridColumn Property="Id" Title="ID" Width="80px" />
                        <RadzenDropDownDataGridColumn Property="Nom" Title="@Localizer["Nom"]" Width="220px" />
                    </Columns>
                </RadzenDropDownDataGrid>
            </div>
            <RadzenDropDown @bind-Value="selectedAccountingYearId"
                            Data="@accountingYears"
                            TextProperty="Year"
                            ValueProperty="Id"
                            Placeholder="Exercice"
                            AllowClear="true"
                            Style="width: 180px;"
                            Change="@OnFilterChange" />
            <RadzenButton Text="Rechercher" Icon="search" Click="@LoadData" />
        </div>

        <RadzenDataGrid TItem="FactureDepenseSummaryItem"
                        @ref="factureGrid"
                        Data="@items"
                        AllowPaging="true"
                        PageSize="10"
                        Density="Density.Compact"
                        Class="factures-grid">
            <Columns>
                <RadzenDataGridColumn TItem="FactureDepenseSummaryItem" Property="Num" Title="N°" Width="80px" />
                <RadzenDataGridColumn TItem="FactureDepenseSummaryItem" Property="TiersDepenseFonctionnementNom" Title="Tiers" Width="180px" />
                <RadzenDataGridColumn TItem="FactureDepenseSummaryItem" Property="Date" Title="Date" Width="110px">
                    <Template Context="f">@f.Date.ToString("dd/MM/yyyy")</Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="FactureDepenseSummaryItem" Property="MontantTotal" Title="Montant" Width="120px">
                    <Template Context="f">@f.MontantTotal.FormatAmount(decimalPlaces) TND</Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="FactureDepenseSummaryItem" Property="Statut" Title="Statut" Width="100px" />
                <RadzenDataGridColumn TItem="FactureDepenseSummaryItem" Title="Document" Width="100px" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                    <Template Context="f">
                        @if (f.HasDocument)
                        {
                            <RadzenButton Icon="attachment" ButtonStyle="ButtonStyle.Light" Variant="Variant.Outlined" Size="ButtonSize.Small"
                                          Click="@(() => ViewDocument(f.Id))"
                                          Title="Voir le document" />
                        }
                        else
                        {
                            <span style="color: #999;">-</span>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="FactureDepenseSummaryItem" Title="Tags" Width="250px" Sortable="false" Filterable="false">
                    <Template Context="f">
                        <TagSelector DocumentType="FactureDepense" DocumentId="@f.Id" SaveOnChange="true" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="FactureDepenseSummaryItem" Title="Actions" Filterable="false" Sortable="false" Width="120px" TextAlign="TextAlign.Center">
                    <Template Context="f">
                        <div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                            <RadzenButton Icon="edit" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Success" Variant="Variant.Outlined"
                                          Click="@(() => EditFacture(f.Id))" Title="@Localizer["Modifier"]" />
                            <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Outlined"
                                          Click="@(() => ConfirmDeleteFacture(f.Id))"
                                          Title="@Localizer["Supprimer"]" />
                        </div>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
            <EmptyTemplate>
                <p style="text-align: center; margin: 2rem;">Aucune facture dépense.</p>
            </EmptyTemplate>
        </RadzenDataGrid>
    </div>
</div>

@code {
    private List<FactureDepenseSummaryItem> items = new();
    private List<TiersDepenseFonctionnementResponse> _filteredTiers = new();
    private List<GetAllAccountingYearsResponse> accountingYears = new();
    private int? selectedTiersId;
    private int? selectedAccountingYearId;
    private int pageNumber = 1;
    private const int pageSize = 10;
    private int totalCount;
    private int decimalPlaces = 2;
    private bool isLoadingTiers;
    private CancellationTokenSource _cts = new();
    private RadzenDataGrid<FactureDepenseSummaryItem>? factureGrid;

    protected override async Task OnInitializedAsync()
    {
        decimalPlaces = await DecimalFormatService.GetDecimalPlacesAsync();
        await LoadAccountingYears();
        await LoadData();
    }

    private async Task LoadTiers(LoadDataArgs args)
    {
        isLoadingTiers = true;
        var parameters = new QueryStringParameters
        {
            PageNumber = args.Skip.HasValue && args.Top.HasValue && args.Top.Value > 0 ? (args.Skip.Value / args.Top.Value) + 1 : 1,
            PageSize = args.Top.HasValue && args.Top.Value > 0 ? args.Top.Value : 20,
            SearchKeyword = args.Filter ?? string.Empty
        };
        try
        {
            var result = await TiersDepenseService.GetPagedAsync(parameters, _cts.Token);
            _filteredTiers = result.Items?.ToList() ?? new();
        }
        catch { _filteredTiers = new(); }
        isLoadingTiers = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadAccountingYears()
    {
        var result = await AccountingYearService.GetAllAccountingYearsAsync(_cts.Token);
        accountingYears = result ?? new();
    }

    private async Task OnFilterChange()
    {
        pageNumber = 1;
        await LoadData();
    }

    private async Task LoadData()
    {
        var result = await FactureDepenseService.GetWithSummariesAsync(
            pageNumber, pageSize,
            selectedTiersId, selectedAccountingYearId, null, null, null, _cts.Token);
        items = result.Items ?? new();
        totalCount = result.TotalCount;
        await InvokeAsync(StateHasChanged);
    }

    private void EditFacture(int id)
    {
        NavigationManager.NavigateTo($"/factures-depenses/edit/{id}");
    }

    private void ViewDocument(int factureId)
    {
        var documentUrl = $"/api/factures-depenses/{factureId}/document";
        NavigationManager.NavigateTo(documentUrl, forceLoad: true);
    }

    private async Task ConfirmDeleteFacture(int factureId)
    {
        bool? confirmed = await DialogService.Confirm(Localizer["Confirmation_Suppression"] ?? "Confirmer la suppression", Localizer["Confirmation_Suppression_Titre"] ?? "Supprimer cette facture dépense ?", new ConfirmOptions { OkButtonText = Localizer["Oui"] ?? "Oui", CancelButtonText = Localizer["Non"] ?? "Non" });
        if (confirmed != true) return;
        try
        {
            var result = await FactureDepenseService.DeleteAsync(factureId, _cts.Token);
            if (result.IsSuccess)
            {
                ToastService.Notify(new(ToastType.Success, Localizer["Facture_Supprimee"] ?? "Facture supprimée."));
                await LoadData();
                if (factureGrid != null) await factureGrid.Reload();
            }
            else
            {
                var msg = result.Errors.FirstOrDefault()?.Message ?? Localizer["Erreur_Suppression"] ?? "Erreur lors de la suppression.";
                if (msg.Contains("facture_has_paiement", StringComparison.OrdinalIgnoreCase))
                    msg = Localizer["Facture_Has_Paiement"] ?? "Impossible de supprimer : cette facture est liée à un ou plusieurs paiements.";
                ToastService.Notify(new(ToastType.Danger, msg));
            }
        }
        catch (Exception ex)
        {
            ToastService.Notify(new(ToastType.Danger, ex.Message));
        }
    }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
    }
}

<style>
    .factures-container { padding: 1.25rem; max-width: 1200px; margin: 1rem auto; }
    .factures-card { border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 1.5rem; }
    .factures-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .factures-title { font-weight: 600; margin: 0; font-size: 1.5rem; }
    .filters { display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; }
    .search-field { display: flex; flex-direction: column; gap: 0.25rem; }
    .search-field label { font-weight: 500; font-size: 0.875rem; }
</style>
