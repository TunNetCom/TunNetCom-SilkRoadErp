@page "/soldes-client"
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.Soldes
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Soldes
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Customers
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AccountingYear
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using Radzen.Blazor
@using Radzen
@using TunNetCom.SilkRoadErp.Sales.Contracts.Customers
@using System.Linq
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> Localizer
@inject ISoldesApiClient SoldesService
@inject ICustomersApiClient CustomersService
@inject IAccountingYearApiClient AccountingYearService
@inject NotificationService NotificationService

<div class="soldes-container">
    <div class="soldes-card">
        <div class="soldes-header">
            <h3 class="soldes-title">@Localizer["Soldes_Clients"]</h3>
        </div>

        <div class="search-filters">
            <div class="search-field">
                <label>@Localizer["Client"]</label>
                <RadzenDropDownDataGrid AllowClear="false"
                                        @bind-Value="@selectedClientId"
                                        LoadData="@LoadCustomers"
                                        AllowFiltering="true"
                                        Style="width: 300px;"
                                        Data="@_filteredCustomers"
                                        TextProperty="@nameof(CustomerResponse.Name)"
                                        ValueProperty="@nameof(CustomerResponse.Id)"
                                        Placeholder="@Localizer["Select_Client"]"
                                        Change="@OnClientChanged">
                    <Columns>
                        <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Id)" Title="ID" Width="80px" />
                        <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Name)" Title="@Localizer["Nom"]" Width="220px" />
                    </Columns>
                </RadzenDropDownDataGrid>
            </div>
            <div class="search-button">
                <RadzenButton Text="@Localizer["Rechercher"]"
                              Icon="search"
                              ButtonStyle="ButtonStyle.Primary"
                              Click="@LoadSolde"
                              Class="action-button" />
            </div>
        </div>

        @if (solde != null)
        {
            <div class="solde-summary">
                <RadzenCard>
                    <h4>@Localizer["Solde_Summary"]</h4>
                    <RadzenStack Gap="1rem">
                        <div class="solde-item">
                            <span class="solde-label">@Localizer["Client"]:</span>
                            <span class="solde-value">@solde.ClientNom</span>
                        </div>
                        <div class="solde-item">
                            <span class="solde-label">@Localizer["Total_Factures"]:</span>
                            <span class="solde-value">@solde.TotalFactures.ToString("N2") TND</span>
                        </div>
                        <div class="solde-item">
                            <span class="solde-label">@Localizer["Total_BL_Non_Factures"]:</span>
                            <span class="solde-value">@solde.TotalBonsLivraisonNonFactures.ToString("N2") TND</span>
                        </div>
                        <div class="solde-item">
                            <span class="solde-label">@Localizer["Total_Avoirs"]:</span>
                            <span class="solde-value">@solde.TotalAvoirs.ToString("N2") TND</span>
                        </div>
                        <div class="solde-item">
                            <span class="solde-label">@Localizer["Total_Factures_Avoir"]:</span>
                            <span class="solde-value">@solde.TotalFacturesAvoir.ToString("N2") TND</span>
                        </div>
                        <div class="solde-item">
                            <span class="solde-label">@Localizer["Total_Paiements"]:</span>
                            <span class="solde-value">@solde.TotalPaiements.ToString("N2") TND</span>
                        </div>
                        <div class="solde-item solde-total">
                            <span class="solde-label">@Localizer["Solde"]:</span>
                            <span class="solde-value @(solde.Solde >= 0 ? "solde-positif" : "solde-negatif")">
                                @solde.Solde.ToString("N2") TND
                            </span>
                        </div>
                    </RadzenStack>
                </RadzenCard>
            </div>

            <div class="documents-section">
                <h4>@Localizer["Documents"]</h4>
                <RadzenStack Gap="1rem">
                    <RadzenCard Variant="Variant.Outlined">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1.5rem;" Wrap="FlexWrap.Wrap">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem;">
                                <div>ExpandMode:</div>
                                <RadzenSelectBar @bind-Value="@expandMode" TextProperty="Text" ValueProperty="Value"
                                        Data="@(Enum.GetValues(typeof(DataGridExpandMode)).Cast<DataGridExpandMode>().Select(t => new { Text = $"{t}", Value = t }))" Size="ButtonSize.Small" />
                            </RadzenStack>
                            <RadzenButton Text="Expand all rows" Click="@(args => ToggleRowsExpand(true))" 
                                          Disabled=@(allRowsExpanded == true || expandMode == DataGridExpandMode.Single) />
                            <RadzenButton Text="Collapse all rows" Click="@(args => ToggleRowsExpand(false))" 
                                          Disabled=@(allRowsExpanded == false || expandMode == DataGridExpandMode.Single) />
                        </RadzenStack>
                    </RadzenCard>

                    <RadzenDataGrid @ref="facturesGrid" 
                                    AllowFiltering="true" 
                                    AllowPaging="true" 
                                    PageSize="10" 
                                    AllowSorting="true" 
                                    RowRender="@RowRender" 
                                    ExpandMode="@expandMode"
                                    Data="@factures" 
                                    TItem="DocumentSoldeClient" 
                                    Render="@OnFacturesDataGridRender">
                        <Template Context="facture">
                            <RadzenDataGrid AllowFiltering="true" 
                                            AllowPaging="true" 
                                            AllowSorting="true" 
                                            Data="@(facture.BonsLivraison ?? new List<DocumentSoldeClient>())" 
                                            Render="@OnBlsDataGridRender">
                                <Template Context="bl">
                                    <RadzenCard Variant="Variant.Text" class="rz-background-color-primary-lighter rz-color-on-primary-lighter rz-m-4">
                                        @Localizer["Facture"]: <b>@facture.Numero</b> - @Localizer["Bons_Livraison"]: <b>@bl.Numero</b>
                                    </RadzenCard>
                                    <RadzenDataGrid AllowFiltering="true" 
                                                    AllowPaging="true" 
                                                    AllowSorting="true" 
                                                    Data="@(bl.LignesBl ?? new List<LigneBlSoldeClient>())">
                                        <Columns>
                                            <RadzenDataGridColumn Property="@nameof(LigneBlSoldeClient.RefProduit)" Title="@Localizer["Ref_Produit"]" Width="150px" />
                                            <RadzenDataGridColumn Property="@nameof(LigneBlSoldeClient.DesignationLi)" Title="@Localizer["Description"]" Width="250px" />
                                            <RadzenDataGridColumn Property="@nameof(LigneBlSoldeClient.QteLi)" Title="@Localizer["Quantite"]" Width="100px" />
                                            <RadzenDataGridColumn Property="@nameof(LigneBlSoldeClient.QteLivree)" Title="@Localizer["Quantite_Livree"]" Width="120px">
                                                <Template Context="ligne">
                                                    @(ligne.QteLivree?.ToString() ?? ligne.QteLi.ToString())
                                                </Template>
                                            </RadzenDataGridColumn>
                                            <RadzenDataGridColumn Property="@nameof(LigneBlSoldeClient.QuantiteNonLivree)" Title="@Localizer["Quantite_Non_Livree"]" Width="150px">
                                                <Template Context="ligne">
                                                    <span class="@(ligne.QuantiteNonLivree > 0 ? "quantite-non-livree" : "")">
                                                        @ligne.QuantiteNonLivree
                                                    </span>
                                                </Template>
                                            </RadzenDataGridColumn>
                                        </Columns>
                                    </RadzenDataGrid>
                                </Template>
                                <Columns>
                                    <RadzenDataGridColumn Property="@nameof(DocumentSoldeClient.Numero)" Title="@Localizer["Numero_Col"]" Width="120px" />
                                    <RadzenDataGridColumn Property="@nameof(DocumentSoldeClient.Date)" Title="@Localizer["date"]" FormatString="{0:dd/MM/yyyy}" Width="140px" />
                                    <RadzenDataGridColumn Property="@nameof(DocumentSoldeClient.Montant)" Title="@Localizer["Montant_Col"]" Width="150px">
                                        <Template Context="bl">
                                            @bl.Montant.ToString("N2") TND
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn Title="" Width="50px">
                                        <Template Context="bl">
                                            @if (bl.HasQuantitesNonLivrees)
                                            {
                                                <RadzenIcon Icon="warning" Style="color: #f44336; font-size: 20px;" Title="@Localizer["Quantites_Non_Livrees_Indicator"]" />
                                            }
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        </Template>
                        <Columns>
                            <RadzenDataGridColumn Property="@nameof(DocumentSoldeClient.Numero)" Title="@Localizer["Numero_Col"]" Width="120px" />
                            <RadzenDataGridColumn Property="@nameof(DocumentSoldeClient.Date)" Title="@Localizer["date"]" FormatString="{0:dd/MM/yyyy}" Width="140px" />
                            <RadzenDataGridColumn Property="@nameof(DocumentSoldeClient.Montant)" Title="@Localizer["Montant_Col"]" Width="150px">
                                <Template Context="facture">
                                    @facture.Montant.ToString("N2") TND
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn Title="" Width="50px">
                                <Template Context="facture">
                                    @if (facture.HasQuantitesNonLivrees)
                                    {
                                        <RadzenIcon Icon="warning" Style="color: #f44336; font-size: 20px;" Title="@Localizer["Quantites_Non_Livrees_Indicator"]" />
                                    }
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </RadzenStack>
            </div>

            <div class="paiements-section">
                <h4>@Localizer["Paiements"]</h4>
                <RadzenDataGrid TItem="PaiementSoldeClient"
                                Data="@solde.Paiements"
                                AllowPaging="true"
                                PageSize="10"
                                Density="Density.Compact">
                    <Columns>
                        <RadzenDataGridColumn TItem="PaiementSoldeClient" Property="Numero" Title="@Localizer["Numero_Col"]" Width="150px" />
                        <RadzenDataGridColumn TItem="PaiementSoldeClient" Property="DatePaiement" Title="@Localizer["Date_Paiement_Col"]" Width="150px">
                            <Template Context="paiement">
                                @paiement.DatePaiement.ToString("dd/MM/yyyy")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="PaiementSoldeClient" Property="Montant" Title="@Localizer["Montant_Col"]" Width="150px">
                            <Template Context="paiement">
                                @paiement.Montant.ToString("N2") TND
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="PaiementSoldeClient" Property="MethodePaiement" Title="@Localizer["Methode_Col"]" Width="120px" />
                    </Columns>
                </RadzenDataGrid>
            </div>
        }
    </div>
</div>

<style>
    .soldes-container {
        padding: 0.25rem 1.25rem 1.25rem 1.25rem;
        max-width: 1400px;
        margin: 0.25rem auto 1rem auto;
    }

    .soldes-card {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        padding: 0.75rem 1.5rem 1.5rem 1.5rem;
        border: none;
    }

    .soldes-header {
        margin-bottom: 1.25rem;
    }

    .soldes-title {
        font-weight: 600;
        margin: 0;
        font-size: 2rem;
        line-height: 1.2;
    }

    .search-filters {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        margin-bottom: 1.25rem;
        flex-wrap: wrap;
    }

    .search-field {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .search-field label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #5f6368;
    }

    .search-button {
        display: flex;
        align-items: flex-end;
    }

    .action-button {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 6px;
    }

    .solde-summary {
        margin-bottom: 2rem;
    }

    .solde-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
    }

    .solde-total {
        font-weight: 600;
        font-size: 1.1rem;
        border-top: 2px solid #e0e0e0;
        padding-top: 1rem;
        margin-top: 0.5rem;
    }

    .solde-label {
        font-weight: 500;
    }

    .solde-value {
        font-weight: 600;
    }

    .solde-positif {
        color: #4caf50;
    }

    .solde-negatif {
        color: #f44336;
    }

    .documents-section, .paiements-section {
        margin-bottom: 2rem;
    }

    .documents-section h4, .paiements-section h4 {
        margin-bottom: 1rem;
        font-size: 1.25rem;
        font-weight: 600;
    }

    .facture-bls-detail {
        padding: 1rem;
        background-color: #e3f2fd;
        margin: 0.5rem 0;
        border-radius: 4px;
        border-left: 4px solid #1976d2;
    }

    .bl-lines-detail {
        padding: 1rem;
        background-color: #f5f5f5;
        margin: 0.5rem 0;
        border-radius: 4px;
        border-left: 4px solid #757575;
    }

    .quantite-non-livree {
        color: #f44336;
        font-weight: 600;
    }
</style>

@code {
    private SoldeClientResponse? solde;
    private int? selectedClientId;
    private List<CustomerResponse> _filteredCustomers = new();
    private CancellationTokenSource cancellationTokenSource = new();
    
    DataGridExpandMode expandMode = DataGridExpandMode.Single;
    bool? allRowsExpanded;
    RadzenDataGrid<DocumentSoldeClient>? facturesGrid;
    
    private IEnumerable<DocumentSoldeClient> factures => solde?.Documents.Where(d => d.Type == "Facture" && d.BonsLivraison != null && d.BonsLivraison.Any()) ?? Enumerable.Empty<DocumentSoldeClient>();

    async Task LoadCustomers(LoadDataArgs args)
    {
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 10,
            SearchKeyword = args?.Filter ?? string.Empty
        };

        try
        {
            var pagedCustomers = await CustomersService.GetAsync(parameters, cancellationTokenSource.Token);
            _filteredCustomers = pagedCustomers.Items;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Clients"]}: {ex.Message}"
            });
            _filteredCustomers = new List<CustomerResponse>();
        }
    }

    async Task OnClientChanged(object? value)
    {
        if (value is int clientId && clientId > 0)
        {
            await LoadSolde();
        }
    }

    async Task LoadSolde()
    {
        if (!selectedClientId.HasValue)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Attention"],
                Detail = Localizer["Select_Client_Validation"]
            });
            return;
        }

        try
        {
            // Toujours passer null pour utiliser l'exercice actif automatiquement
            var result = await SoldesService.GetSoldeClientAsync(
                selectedClientId.Value,
                null,
                cancellationTokenSource.Token);

            if (result.IsSuccess)
            {
                solde = result.Value;
                allRowsExpanded = null;
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["Erreur"],
                    Detail = Localizer["Erreur_Chargement_Solde"]
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Solde"]}: {ex.Message}"
            });
        }
    }

    async Task ToggleRowsExpand(bool? value)
    {
        allRowsExpanded = value;

        if (facturesGrid != null)
        {
            if (value == true)
            {
                await facturesGrid.ExpandRows(facturesGrid.PagedView);
            }
            else if (value == false)
            { 
                await facturesGrid.CollapseRows(facturesGrid.PagedView);
            }
        }
    }

    void RowRender(RowRenderEventArgs<DocumentSoldeClient> args)
    {
        args.Expandable = args.Data.BonsLivraison != null && args.Data.BonsLivraison.Any();
    }

    void OnFacturesDataGridRender(DataGridRenderEventArgs<DocumentSoldeClient> args)
    {
        // Pas d'expansion automatique - toutes les lignes sont repliées par défaut
    }

    void OnBlsDataGridRender(DataGridRenderEventArgs<DocumentSoldeClient> args)
    {
        // Pas d'expansion automatique - toutes les lignes sont repliées par défaut
    }

    public void Dispose()
    {
        cancellationTokenSource.Cancel();
        cancellationTokenSource.Dispose();
    }
}

