@page "/soldes-tiers-depenses"
@implements IDisposable
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.Soldes
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Soldes
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.TiersDepenseFonctionnement
@using TunNetCom.SilkRoadErp.Sales.Contracts.TiersDepenseFonctionnement
@using TunNetCom.SilkRoadErp.Sales.Contracts
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@using Radzen.Blazor
@using Radzen
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> Localizer
@inject ISoldesApiClient SoldesService
@inject ITiersDepenseFonctionnementApiClient TiersDepenseService
@inject Radzen.NotificationService NotificationService
@inject IDecimalFormatService DecimalFormatService

<div class="soldes-container">
    <div class="soldes-card">
        <div class="soldes-header">
            <h3 class="soldes-title">Soldes tiers dépenses</h3>
        </div>

        <div class="search-filters">
            <div class="search-field">
                <label>Tiers dépenses</label>
                <RadzenDropDown @bind-Value="selectedTiersId"
                                Data="@tiersList"
                                TextProperty="Nom"
                                ValueProperty="Id"
                                Placeholder="Choisir un tiers"
                                AllowClear="false"
                                Style="width: 300px;"
                                Change="@OnTiersChanged" />
            </div>
            <div class="search-button">
                <RadzenButton Text="@Localizer["Rechercher"]"
                              Icon="search"
                              ButtonStyle="ButtonStyle.Primary"
                              Click="@LoadSolde"
                              Class="action-button" />
            </div>
        </div>

        @if (solde != null)
        {
            <div class="solde-summary">
                <RadzenCard>
                    <h4>Récapitulatif</h4>
                    <RadzenStack Gap="1rem">
                        <div class="solde-item">
                            <span class="solde-label">Tiers:</span>
                            <span class="solde-value">@solde.TiersDepenseFonctionnementNom</span>
                        </div>
                        <div class="solde-item">
                            <span class="solde-label">Total factures dépenses:</span>
                            <span class="solde-value">@solde.TotalFacturesDepense.FormatAmount(decimalPlaces) TND</span>
                        </div>
                        <div class="solde-item">
                            <span class="solde-label">Total paiements:</span>
                            <span class="solde-value">@solde.TotalPaiements.FormatAmount(decimalPlaces) TND</span>
                        </div>
                        <div class="solde-item solde-total">
                            <span class="solde-label">@Localizer["Solde"]:</span>
                            <span class="solde-value @(solde.Solde >= 0 ? "solde-positif" : "solde-negatif")">
                                @solde.Solde.FormatAmount(decimalPlaces) TND
                            </span>
                        </div>
                    </RadzenStack>
                </RadzenCard>
            </div>

            <div class="documents-section">
                <h4>@Localizer["Documents"]</h4>
                <RadzenDataGrid TItem="DocumentSoldeTiersDepense"
                                Data="@solde.Documents"
                                AllowPaging="true"
                                PageSize="10"
                                Density="Density.Compact">
                    <Columns>
                        <RadzenDataGridColumn TItem="DocumentSoldeTiersDepense" Property="Type" Title="@Localizer["Type"]" Width="150px" />
                        <RadzenDataGridColumn TItem="DocumentSoldeTiersDepense" Property="Numero" Title="@Localizer["Numero_Col"]" Width="100px" />
                        <RadzenDataGridColumn TItem="DocumentSoldeTiersDepense" Property="Date" Title="@Localizer["date"]" Width="120px">
                            <Template Context="doc">
                                @doc.Date.ToString("dd/MM/yyyy")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="DocumentSoldeTiersDepense" Property="Montant" Title="@Localizer["Montant_Col"]" Width="150px">
                            <Template Context="doc">
                                @doc.Montant.FormatAmount(decimalPlaces) TND
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="DocumentSoldeTiersDepense" Property="Description" Title="Description" Width="200px" />
                    </Columns>
                </RadzenDataGrid>
            </div>

            <div class="paiements-section">
                <h4>@Localizer["Paiements"]</h4>
                <RadzenDataGrid TItem="PaiementSoldeTiersDepense"
                                Data="@solde.Paiements"
                                AllowPaging="true"
                                PageSize="10"
                                Density="Density.Compact">
                    <Columns>
                        <RadzenDataGridColumn TItem="PaiementSoldeTiersDepense" Property="NumeroTransactionBancaire" Title="@Localizer["Numero_Col"]" Width="150px" />
                        <RadzenDataGridColumn TItem="PaiementSoldeTiersDepense" Property="DatePaiement" Title="@Localizer["Date_Paiement_Col"]" Width="150px">
                            <Template Context="paiement">
                                @paiement.DatePaiement.ToString("dd/MM/yyyy")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="PaiementSoldeTiersDepense" Property="Montant" Title="@Localizer["Montant_Col"]" Width="150px">
                            <Template Context="paiement">
                                @paiement.Montant.FormatAmount(decimalPlaces) TND
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="PaiementSoldeTiersDepense" Property="MethodePaiement" Title="@Localizer["Methode_Col"]" Width="120px" />
                    </Columns>
                </RadzenDataGrid>
            </div>
        }
    </div>
</div>

<style>
    .soldes-container { padding: 0.25rem 1.25rem 1.25rem 1.25rem; max-width: 1400px; margin: 0.25rem auto 1rem auto; }
    .soldes-card { border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); padding: 0.75rem 1.5rem 1.5rem 1.5rem; }
    .soldes-header { margin-bottom: 1.25rem; }
    .soldes-title { font-weight: 600; margin: 0; font-size: 2rem; }
    .search-filters { display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1.25rem; flex-wrap: wrap; }
    .search-field { display: flex; flex-direction: column; gap: 0.5rem; }
    .search-field label { font-size: 0.875rem; font-weight: 500; color: #5f6368; }
    .search-button { display: flex; align-items: flex-end; }
    .solde-summary { margin-bottom: 2rem; }
    .solde-item { display: flex; justify-content: space-between; padding: 0.5rem 0; }
    .solde-total { font-weight: 600; font-size: 1.1rem; border-top: 2px solid #e0e0e0; padding-top: 1rem; margin-top: 0.5rem; }
    .solde-label { font-weight: 500; }
    .solde-value { font-weight: 600; }
    .solde-positif { color: #4caf50; }
    .solde-negatif { color: #f44336; }
    .documents-section, .paiements-section { margin-bottom: 2rem; }
    .documents-section h4, .paiements-section h4 { margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600; }
</style>

@code {
    private SoldeTiersDepenseResponse? solde;
    private int? selectedTiersId;
    private List<TiersDepenseFonctionnementResponse> tiersList = new();
    private CancellationTokenSource _cts = new();
    private int decimalPlaces = 2;

    protected override async Task OnInitializedAsync()
    {
        decimalPlaces = await DecimalFormatService.GetDecimalPlacesAsync();
        var result = await TiersDepenseService.GetPagedAsync(new QueryStringParameters { PageNumber = 1, PageSize = 500 }, _cts.Token);
        tiersList = result.Items?.ToList() ?? new();
    }

    private async Task OnTiersChanged(object? value)
    {
        if (value is int id && id > 0)
        {
            await LoadSolde();
        }
    }

    private async Task LoadSolde()
    {
        if (!selectedTiersId.HasValue)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Attention"],
                Detail = "Veuillez sélectionner un tiers."
            });
            return;
        }

        try
        {
            var result = await SoldesService.GetSoldeTiersDepenseAsync(
                selectedTiersId.Value,
                null,
                _cts.Token);

            if (result.IsSuccess)
            {
                solde = result.Value;
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["Erreur"],
                    Detail = Localizer["Erreur_Chargement_Solde"]
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Solde"]}: {ex.Message}"
            });
        }
    }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
    }
}
