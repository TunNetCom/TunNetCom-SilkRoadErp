@page "/add_or_update_reciption_notes"
@page "/add_or_update_reciption_notes/{num?}"

@using Radzen.Blazor
@using Microsoft.Extensions.Localization
@using Microsoft.JSInterop
@using TunNetCom.SilkRoadErp.Sales.Contracts.AppParameters
@using TunNetCom.SilkRoadErp.Sales.Contracts.ReceiptNote.Responses
@using TunNetCom.SilkRoadErp.Sales.Contracts.Sorting
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AppParameters
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Products
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Providers
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ReceiptNote
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@using TunNetCom.SilkRoadErp.Sales.Contracts.Tags
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Tags

@inject IStringLocalizer<SharedResource> Localizer
@inject ITagsApiClient TagsService
@inject ToastService toastService
@inject NotificationService NotificationService
@inject IJSRuntime JSRuntime
@inject IReceiptNoteApiClient receiptNoteApiClient
@inject IProductsApiClient productsApiClient
@inject IProvidersApiClient providerApiClient
@inject IAppParametersClient appParametersClient
@inject ILogger<AddOrUpdateRecipietNote> logger
@inject DialogService DialogService

<style>
    /* Header actions container */
    .header-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
        padding: 12px 24px;
        border-bottom: 1px solid #e5e7eb;
        width: 100%;
    }

    /* Action buttons container */
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }

    /* Button styling */
    .action-button {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 6px;
        transition: background-color 0.2s, box-shadow 0.2s;
        background-color: #3b82f6;
        border: none;
    }

        .action-button:hover:not(:disabled) {
            background-color: #2563eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .action-button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }

    /* Success button styling */
    .success-button {
        background-color: #10b981;
    }

        .success-button:hover:not(:disabled) {
            background-color: #059669;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

    /* Summary card styling */
    .summary-card {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        flex: 0 0 auto;
    }

    /* Summary stack */
    .summary-stack {
        gap: 1.5rem;
    }

    /* Summary text */
    .summary-text {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        line-height: 1.5;
    }

        .summary-text strong {
            font-weight: 600;
        }

    /* Responsive design */
    @@media (max-width: 768px) {
        .header-actions {
            flex-direction: column;
            align-items: flex-start;
            padding: 12px 16px;
            gap: 12px;
        }

        .action-buttons {
            flex-direction: column;
            width: 100%;
            gap: 8px;
        }

        .action-button,
        .success-button {
            width: 100%;
            text-align: center;
            font-size: 12px;
            padding: 10px;
        }

        .summary-card {
            width: 100%;
            padding: 8px 12px;
        }

        .summary-stack {
            flex-direction: column;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .summary-text {
            font-size: 12px;
        }
    }

    .receipt-note-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .receipt-note-form {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
        flex-grow: 1;
    }
</style>

<!-- Loading Indicator -->
@if (isLoading)
{
    <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else
{
    <!-- Receipt Note Container with Form and Summary -->
    <div class="receipt-note-container">
        <div class="receipt-note-form">
            <RadzenLabel Text="Numéro bon de réception" Component="ReceiptNoteNumber" AriaLabel="Numéro bon de réception" />
            <RadzenTextBox @bind-Value="receiptNoteNumber" Name="ReceiptNoteNumber" Style="width: 120px;" ReadOnly="true" AriaReadOnly="true" />

            <RadzenLabel Text="@Localizer["date"]" />
            <RadzenDatePicker @bind-Value="receiptNoteDate" Name="ReceiptNoteDate" Style="width: 200px;" DateFormat="d MMMM yyyy" ShowTime="false" />

            <RadzenLabel Text="@Localizer["provider"]" />
            <RadzenDropDownDataGrid AllowClear="true"
                                    IsLoading="@isLoadingProvider"
                                    @bind-Value="@selectedProviderId"
                                    LoadData="@LoadProviders"
                                    AllowFiltering="true"
                                    Style="width: 350px;"
                                    Data="@_filteredProviders"
                                    TextProperty="@nameof(ProviderResponse.Nom)"
                                    ValueProperty="@nameof(ProviderResponse.Id)"
                                    Placeholder="@Localizer["select_provider"]">
                <Columns>
                    <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Id)" Title="ID" Width="80px" />
                    <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Nom)" Title="@Localizer["name"]" Width="220px" />
                </Columns>
            </RadzenDropDownDataGrid>

            <RadzenLabel Text="Numéro bon fournisseur" />
            <RadzenNumeric @bind-Value="numBonFournisseur" Name="NumBonFournisseur" Style="width: 150px;" Min="0" />

            <RadzenLabel Text="Date livraison" />
            <RadzenDatePicker @bind-Value="dateLivraison" Name="DateLivraison" Style="width: 200px;" DateFormat="d MMMM yyyy" ShowTime="false" />
        </div>
    </div>

    <!-- Order Lines Grid -->
    <LineItemsGrid TItem="ReceiptNoteDetailResponse"
                   Items="@orders"
                   ItemsChanged="@OnItemsChanged"
                   OnDeleteItem="@DeleteRow"
                   OnProductSelectedCallback="@OnProductSelectedHandler"
                   LoadProducts="@LoadData"
                   GetProductList="@GetCurrentProductList"
                   ProductCount="@count"
                   AppParameters="@getAppParametersResponse"
                   OnShowPriceHistory="@ShowDialog"
                   ShowPriceHistoryDialog="true"
                   ShowPrintButton="true"
                   ShowSaveButton="true"
                   ShowSummary="true"
                   OnSave="@SaveReceiptNote"
                   OnPrint="@PrintReceiptNote"
                   TotalHt="@totalHt"
                   TotalVat="@totalVat"
                   TotalTtc="@totalTtc"
                   Localizer="@Localizer"
                   GetProductReference="@(item => item.ProductReference)"
                   SetProductReference="@((item, value) => item.ProductReference = value)"
                   GetProductDescription="@(item => item.Description)"
                   SetProductDescription="@((item, value) => item.Description = value)"
                   ProductTextProperty="ProductReferenceAndDescription"
                   ProductValueProperty="ProductReference"
                   CreateNewItem="@(() => new ReceiptNoteDetailResponse { Quantity = 1 })" />

    <!-- Tags Section -->
    @if (!string.IsNullOrEmpty(receiptNoteNumber) && int.TryParse(receiptNoteNumber, out var receiptNumber))
    {
        <TagSelector @ref="tagSelectorRef"
                    DocumentType="BonDeReception" 
                    DocumentId="@receiptNumber"
                    SaveOnChange="false" />
    }
}
