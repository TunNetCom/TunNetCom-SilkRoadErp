@page "/add_or_update_reciption_notes"
@page "/add_or_update_reciption_notes/{num?}"

@if (isLoading)
{
    <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else
{
    <!-- Delivery Note Container with Form and Summary -->
    <div class="delivery-note-container">
        <div class="delivery-note-form">
            <RadzenLabel Text="@Localizer["delivery_note_number"]" Component="DeliveryNoteNumber" AriaLabel="@Localizer["delivery_note_number"]" />
            <RadzenTextBox @bind-Value="deliveryNoteNumber" Name="DeliveryNoteNumber" Style="width: 200px;" ReadOnly="true" AriaReadOnly="true" />

            <RadzenLabel Text="@Localizer["date"]" />
            <RadzenDatePicker @bind-Value="deliveryNoteDate" Name="DeliveryNoteDate" Style="width: 200px;" DateFormat="d MMMM yyyy" ShowTime="false" />

            <RadzenLabel Text="@Localizer["customer"]" />
            <RadzenDropDownDataGrid AllowClear="true"
                                    IsLoading="@isLoadingCustomers"
                                    @bind-Value="@selectedCustomerId"
                                    LoadData="@LoadCustomers"
                                    AllowFiltering="true"
                                    Style="width: 350px;"
                                    Data="@_filteredProviders"
                                    TextProperty="@nameof(CustomerResponse.Name)"
                                    ValueProperty="@nameof(CustomerResponse.Id)"
                                    Placeholder="@Localizer["select_customer"]">
                <Columns>
                    <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Id)" Title="ID" Width="80px" />
                    <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Name)" Title="@Localizer["name"]" Width="220px" />
                </Columns>
            </RadzenDropDownDataGrid>

            <RadzenLabel Text="@Localizer["invoice_number"]" />
            <RadzenDropDownDataGrid AllowClear="true"
                                    IsLoading="@isLoadingInvoices"
                                    @bind-Value="@_selectedInvoiceId"
                                    LoadData="@LoadCustomerInvoices"
                                    AllowFiltering="true"
                                    Style="width: 350px;"
                                    Data="@_filteredInvoices"
                                    TextProperty="@nameof(InvoiceResponse.Number)"
                                    ValueProperty="@nameof(InvoiceResponse.Number)"
                                    Placeholder="@Localizer["select_invoice"]">
                <Columns>
                    <RadzenDropDownDataGridColumn Property="@nameof(InvoiceResponse.Number)" Title="Num" Width="100px" />
                    <RadzenDropDownDataGridColumn Property="@nameof(InvoiceResponse.Date)" Title="Date" Width="100px" />
                    <RadzenDropDownDataGridColumn Property="@nameof(InvoiceResponse.TotalIncludingTaxAmount)" Title="@Localizer["tot_ttc"]" Width="200px" />
                </Columns>
            </RadzenDropDownDataGrid>
        </div>
    </div>

    <!-- DataGrid with Actions -->
     <RadzenDataGrid @ref="ordersGrid" AllowAlternatingRows="false"
                    AllowPaging="true"
                    EditMode="@editMode"
                    Data="@orders" TItem="DeliveryNoteDetailResponse"
                    RowUpdate="@OnUpdateRow"
                    RowCreate="@OnCreateRow"
                    Page="@Reset"
                    ColumnWidth="200px">
        <HeaderTemplate>
            <div class="header-actions">
                <div class="action-buttons">
                    <RadzenButton ButtonStyle="ButtonStyle.Success"
                                  Icon="add_circle"
                                  Text="@Localizer["add_new_order"]"
                                  Click="@InsertRow"
                                  Disabled="@(editMode == DataGridEditMode.Single && ordersToInsert.Count() > 0)"
                                  class="action-button success-button"
                                  AriaLabel="@Localizer["add_new_order"]" />

                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                  Icon="print"
                                  Text="@Localizer["print"]"
                                  Variant="Variant.Flat"
                                  Disabled="@(!orders.Any())"
                                  class="action-button"
                                  AriaLabel="@Localizer["print"]" />

                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                  Icon="save"
                                  Text="@Localizer["save"]"
                                  Variant="Variant.Flat"
                                  Click="@SaveDeliveryNote"
                                  Disabled="@(!orders.Any())"
                                  class="action-button"
                                  AriaLabel="@Localizer["save"]" />

                </div>

                <RadzenCard class="summary-card" Variant="Variant.Outlined">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal"
                                 Gap="1.5rem"
                                 JustifyContent="JustifyContent.End"
                                 class="summary-stack">
                        <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                            @Localizer["total_net"]: <strong>@totalTtc.FormatAmount()</strong>
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                            @Localizer["total_gross"]: <strong>@totalHt.FormatAmount()</strong>
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                            @Localizer["total_vat"]: <strong>@totalVat.FormatAmount()</strong>
                        </RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </div>
        </HeaderTemplate>
        <Columns>
            <RadzenDataGridColumn Width="600px" TItem="DeliveryNoteDetailResponse"
                                  Property="@nameof(DeliveryNoteDetailResponse.ProductReferenceAndDescription)"
                                  Title="@Localizer["product"]">
                <Template Context="order">
                    @order.ProductReferenceAndDescription
                </Template>
                <EditTemplate Context="order">
                    <RadzenDropDownDataGrid Style="width: 100%; max-width: 600px;"
                                            AllowClear="true"
                                            @bind-Value="order.ProductReference"
                                            LoadData="@LoadData"
                                            AllowFiltering="true"
                                            Data="@(GetCurrentProductList(order))"
                                            Count="@count"
                                            Change="@(args => OnProductSelected(order, args))"
                                            TextProperty="@nameof(DeliveryNoteDetailResponse.ProductReferenceAndDescription)"
                                            ValueProperty="@nameof(DeliveryNoteDetailResponse.ProductReference)"
                                            Name="DropDownDataGridFilteringLoadData" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Width="100px" Property="@nameof(DeliveryNoteDetailResponse.Quantity)"
                                  Title="@Localizer["quantity"]">
                <EditTemplate Context="order">
                    <RadzenNumeric TValue="int"
                                   Value="order.Quantity"
                                   Change="@(args => OnValueChanged(order, args, nameof(order.Quantity)))"
                                   Style="width:100%;"
                                   Name="Quantity" />
                    <RadzenRequiredValidator Text="@Localizer["quantity_required"]" Component="Quantity" Popup="true" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Width="150px" Property="@nameof(DeliveryNoteDetailResponse.UnitPriceExcludingTax)" Title="@Localizer["unit_price_ht"]">
                <Template Context="order">
                    <div @onclick="() => ShowDialog(order.ProductReference)">@order.UnitPriceExcludingTax.FormatAmount()</div>
                </Template>
            </RadzenDataGridColumn>


            <RadzenDataGridColumn Width="100px" Property="@nameof(DeliveryNoteDetailResponse.DiscountPercentage)"
                                  Title="@Localizer["discount_percentage"]">
                <Template Context="order">
                    @order.DiscountPercentage
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Property="@nameof(DeliveryNoteDetailResponse.TotalExcludingTax)" Title="@Localizer["total_ex_tax"]">
                <Template Context="order">
                    @order.TotalExcludingTax.FormatAmount()
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Width="100px" Property="@nameof(DeliveryNoteDetailResponse.VatPercentage)" Title="@Localizer["vat_percentage"]">
                <Template Context="order">
                    @order.VatPercentage
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Property="@nameof(DeliveryNoteDetailResponse.TotalIncludingTax)" Title="@Localizer["total_incl_tax"]">
                <Template Context="order">
                    @order.TotalIncludingTax.FormatAmount()
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Context="order" Filterable="false" Sortable="false" TextAlign="TextAlign.Right"
                                  Frozen="true" FrozenPosition="FrozenColumnPosition.Right">
                <Template Context="order">
                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat"
                                  Size="ButtonSize.Medium" Click="@(args => EditRow(order))" @onclick:stopPropagation="true">
                    </RadzenButton>
                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat"
                                  Shade="Shade.Lighter" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1"
                                  Click="@(args => DeleteRow(order))" @onclick:stopPropagation="true">
                    </RadzenButton>
                </Template>
                <EditTemplate Context="order">
                    <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat"
                                  Size="ButtonSize.Medium" Click="@((args) => SaveRow(order))" aria-label="Save">
                    </RadzenButton>
                    <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat"
                                  Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1"
                                  Click="@((args) => CancelEdit(order))" aria-label="Cancel">
                    </RadzenButton>
                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat"
                                  Shade="Shade.Lighter" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1"
                                  Click="@(args => DeleteRow(order))" aria-label="Delete">
                    </RadzenButton>
                </EditTemplate>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}