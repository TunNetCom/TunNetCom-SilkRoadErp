@page "/login"
@layout LoginLayout

@using Radzen
@using Radzen.Blazor
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject IAuthService AuthService

<div class="login-page-grid">
    <div class="login-form-section">
        <div class="login-header-section">
            <div class="login-logo-container">
                <div class="login-logo-link">
                    <div class="login-logo-icon">
                        <RadzenIcon Icon="dashboard" />
                    </div>
                    <span class="login-logo-text">Silk Road ERP</span>
                </div>
            </div>
        </div>
        
        <div class="login-form-container">
            <div class="login-form-wrapper">
                <RadzenTemplateForm TItem="LoginModel" Data="@loginModel" Submit="@OnSubmit" class="login-form">
                    <div class="login-form-content">
                        <div class="login-form-header">
                            <h1 class="login-form-title">Login to your account</h1>
                            <p class="login-form-subtitle">Enter your credentials to access your account</p>
                        </div>

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="error-alert">
                                <RadzenIcon Icon="error" />
                                <span>@errorMessage</span>
                            </div>
                        }

                        <div class="form-field-group">
                            <div class="form-field">
                                <label for="username" class="form-label">Username</label>
                                <RadzenTextBox Name="Username" 
                                               @bind-Value="@loginModel.Username" 
                                               Placeholder="Enter your username"
                                               class="form-input" />
                            </div>

                            <div class="form-field">
                                <div class="form-label-row">
                                    <label for="password" class="form-label">Password</label>
                                    <a href="#" class="forgot-password-link">Forgot your password?</a>
                                </div>
                                <RadzenPassword Name="Password" 
                                               @bind-Value="@loginModel.Password" 
                                               Placeholder="Enter your password"
                                               class="form-input" />
                            </div>

                            <div class="form-field">
                                <RadzenButton ButtonType="Radzen.ButtonType.Submit"
                                              Text="@(isLoading ? "Signing in..." : "SIGN IN")"
                                              ButtonStyle="ButtonStyle.Primary"
                                              Disabled="@isLoading"
                                              class="login-submit-button" />
                            </div>
                        </div>
                    </div>
                </RadzenTemplateForm>
            </div>
        </div>
    </div>
    
    <div class="login-image-section" id="login-image-section">
        <img src="/logo.jpg" 
             alt="NISSAF Logo" 
             class="login-background-image"
             onerror="this.style.display='none'; document.getElementById('login-image-section').classList.add('no-image');" />
    </div>
</div>

<style>
    :root {
        --radius: 0.65rem;
        --background: oklch(0.145 0 0);
        --foreground: oklch(0.985 0 0);
        --card: oklch(0.205 0 0);
        --card-foreground: oklch(0.985 0 0);
        --primary: oklch(0.922 0 0);
        --primary-foreground: oklch(0.205 0 0);
        --muted: oklch(0.269 0 0);
        --muted-foreground: oklch(0.708 0 0);
        --border: oklch(1 0 0 / 10%);
        --input: oklch(1 0 0 / 15%);
        --ring: oklch(0.556 0 0);
    }

    .login-page-grid {
        display: grid;
        min-height: 100vh;
        grid-template-columns: 1fr;
        background: var(--background);
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    .login-page-grid * {
        -webkit-tap-highlight-color: transparent;
    }

    .login-page-grid input,
    .login-page-grid button {
        user-select: auto;
        -webkit-user-select: auto;
        -moz-user-select: auto;
        -ms-user-select: auto;
    }

    @@media (min-width: 1024px) {
        .login-page-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    .login-form-section {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 1.5rem;
        background: var(--background);
    }

    @@media (min-width: 768px) {
        .login-form-section {
            padding: 2.5rem;
        }
    }

    .login-header-section {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
    }

    @@media (min-width: 768px) {
        .login-header-section {
            justify-content: flex-start;
        }
    }

    .login-logo-container {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
    }

    @@media (min-width: 768px) {
        .login-logo-container {
            justify-content: flex-start;
        }
    }

    .login-logo-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        text-decoration: none;
        color: var(--foreground);
        cursor: default;
        pointer-events: none;
    }

    .login-logo-icon {
        background: var(--primary);
        color: var(--primary-foreground);
        display: flex;
        width: 1.5rem;
        height: 1.5rem;
        align-items: center;
        justify-content: center;
        border-radius: calc(var(--radius) - 2px);
    }

    .login-logo-icon :deep(.rz-icon) {
        font-size: 1rem;
    }

    .login-logo-text {
        font-size: 1rem;
        font-weight: 500;
    }

    .login-form-container {
        display: flex;
        flex: 1;
        align-items: center;
        justify-content: center;
    }

    .login-form-wrapper {
        width: 100%;
        max-width: 20rem;
    }

    .login-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .login-form-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .login-form-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        text-align: center;
    }

    .login-form-title {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 2rem;
        color: var(--foreground);
        margin: 0;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        outline: none !important;
        border: none !important;
        box-shadow: none !important;
    }

    .login-form-title:focus,
    .login-form-title:active {
        outline: none !important;
        border: none !important;
        box-shadow: none !important;
    }

    .login-form-subtitle {
        font-size: 0.875rem;
        color: var(--muted-foreground);
        margin: 0;
        text-align: center;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        outline: none !important;
    }

    .error-alert {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: oklch(0.577 0.245 27.325 / 0.1);
        border: 1px solid oklch(0.577 0.245 27.325);
        border-radius: var(--radius);
        color: oklch(0.577 0.245 27.325);
        font-size: 0.875rem;
    }

    .form-field-group {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .form-field {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-label-row {
        display: flex;
        align-items: center;
    }

    .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--foreground);
    }

    .forgot-password-link {
        margin-left: auto;
        font-size: 0.875rem;
        text-decoration: underline;
        text-underline-offset: 4px;
        color: var(--foreground);
    }

    .forgot-password-link:hover {
        text-decoration: underline;
    }

    .form-input :deep(.rz-textbox),
    .form-input :deep(.rz-password),
    .form-input :deep(input) {
        width: 100% !important;
        height: 2.5rem;
        padding: 0.5rem 0.75rem;
        background: var(--input);
        border: 1px solid var(--border);
        border-radius: calc(var(--radius) - 2px);
        color: var(--foreground);
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .form-input :deep(.rz-textbox:focus),
    .form-input :deep(.rz-password:focus),
    .form-input :deep(input:focus) {
        outline: none;
        border-color: var(--ring);
        box-shadow: 0 0 0 2px var(--ring);
    }

    .form-input :deep(.rz-textbox::placeholder),
    .form-input :deep(.rz-password::placeholder),
    .form-input :deep(input::placeholder) {
        color: var(--muted-foreground);
    }

    .login-submit-button {
        width: 100% !important;
        height: 2.5rem;
        padding: 0.5rem 1rem !important;
        background: var(--primary) !important;
        color: var(--primary-foreground) !important;
        border: none !important;
        border-radius: calc(var(--radius) - 2px) !important;
        font-size: 0.875rem !important;
        font-weight: 500 !important;
        text-transform: uppercase !important;
        cursor: pointer;
        transition: all 0.2s;
    }

    .login-submit-button:hover {
        opacity: 0.9;
    }

    .login-submit-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .login-submit-button :deep(.rz-button) {
        width: 100% !important;
        height: 100% !important;
        background: var(--primary) !important;
        color: var(--primary-foreground) !important;
        border: none !important;
        text-transform: uppercase !important;
    }

    .login-image-section {
        background: #232A32 !important;
        position: relative;
        display: none;
        overflow: hidden;
    }

    @@media (min-width: 1024px) {
        .login-image-section {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #232A32 !important;
        }
    }

    .login-background-image {
        position: relative;
        height: 90%;
        width: 90%;
        max-width: 600px;
        max-height: 600px;
        object-fit: contain;
        object-position: center;
        z-index: 1;
        pointer-events: none;
        margin: auto;
    }

    .login-image-section::before {
        content: '';
        position: absolute;
        inset: 0;
        background: #232A32 !important;
        z-index: 0;
    }

    /* Fallback si l'image n'existe pas */
    .login-image-section.no-image {
        background: linear-gradient(135deg, oklch(0.269 0 0) 0%, oklch(0.205 0 0) 100%);
    }

    .login-image-section.no-image::after {
        content: 'NISSAF Logo';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--muted-foreground);
        font-size: 1.5rem;
        font-weight: 600;
        opacity: 0.3;
        z-index: 2;
    }

    /* Force dark mode colors */
    .login-page-grid,
    .login-form-section {
        background: oklch(0.145 0 0) !important;
    }

    .login-form-title,
    .login-logo-text,
    .form-label,
    .forgot-password-link {
        color: oklch(0.985 0 0) !important;
    }

    .login-form-subtitle {
        color: oklch(0.708 0 0) !important;
    }

    .form-input :deep(.rz-textbox),
    .form-input :deep(.rz-password),
    .form-input :deep(input) {
        background: oklch(1 0 0 / 15%) !important;
        border-color: oklch(1 0 0 / 10%) !important;
        color: oklch(0.985 0 0) !important;
    }

    .form-input :deep(.rz-textbox::placeholder),
    .form-input :deep(.rz-password::placeholder),
    .form-input :deep(input::placeholder) {
        color: oklch(0.708 0 0) !important;
    }

    .login-submit-button :deep(.rz-button) {
        background: oklch(0.922 0 0) !important;
        color: oklch(0.205 0 0) !important;
    }
</style>

@code {
    public class LoginModel
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }

    private LoginModel loginModel = new LoginModel();
    private bool isLoading = false;
    private string errorMessage = string.Empty;

    private async Task OnSubmit(LoginModel model)
    {
        if (isLoading)
            return;

        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            StateHasChanged();

            var success = await AuthService.LoginAsync(model.Username, model.Password);

            if (success)
            {
                // Don't use forceLoad: true - it recreates the circuit and breaks JS interop
                // Instead, navigate normally and let AuthorizeRouteView handle the auth check
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = "Invalid username or password.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred during login. Please try again.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
