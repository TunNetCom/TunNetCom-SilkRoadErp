@page "/login"
@layout LoginLayout


@using Radzen
@using Radzen.Blazor
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject IAuthService AuthService


<div class="login-container">
    <RadzenCard class="login-card">
        <RadzenTemplateForm TItem="LoginModel" Data="@loginModel" Submit="@OnSubmit">
            <RadzenStack Gap="2rem" AlignItems="AlignItems.Center">
                <div class="app-header">
                    <h1 class="app-title">Silk Road ERP</h1>
                    <p class="app-subtitle">Système de Gestion Intégré</p>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="error-message">
                        <RadzenIcon Icon="error" />
                        <span>@errorMessage</span>
                    </div>
                }

                <RadzenStack Gap="1.5rem" style="width: 100%;">
                    <RadzenFormField Text="Nom d'utilisateur" Variant="Variant.Filled">
                        <RadzenTextBox Name="Username" @bind-Value="@loginModel.Username" Placeholder="Entrez votre nom d'utilisateur" Style="width: 100%;" />
                    </RadzenFormField>

                    <RadzenFormField Text="Mot de passe" Variant="Variant.Filled">
                        <RadzenPassword Name="Password" @bind-Value="@loginModel.Password" Placeholder="Entrez votre mot de passe" Style="width: 100%;" />
                    </RadzenFormField>
                </RadzenStack>

                <RadzenButton ButtonType="Radzen.ButtonType.Submit"
                              Text="@(isLoading ? "Connexion en cours..." : "Se connecter")"
                              ButtonStyle="ButtonStyle.Primary"
                              Disabled="@isLoading"
                              Style="width: 100%; padding: 12px; font-weight: 500;" />

                <div class="forgot-password">
                    <RadzenLink Path="/forgot-password" Text="Mot de passe oublié ?" />
                </div>
            </RadzenStack>
        </RadzenTemplateForm>
    </RadzenCard>
</div>

<style>
    .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        padding: 1rem;
    }

    .login-card {
        width: 450px;
        max-width: 90%;
        padding: 2.5rem;
        box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        border-radius: 12px;
        background: #2d2d2d;
        border: 1px solid #404040;
    }

    .app-header {
        text-align: center;
        margin-bottom: 1rem;
    }

    .app-title {
        color: #ffffff;
        font-size: 2rem;
        font-weight: 600;
        margin: 0;
        letter-spacing: -0.5px;
    }

    .app-subtitle {
        color: #b0b0b0;
        font-size: 1rem;
        margin: 0.5rem 0 0;
    }

    :deep(.rz-textbox), :deep(.rz-password) {
        border-radius: 8px;
        transition: all 0.3s ease;
        background-color: #1e1e1e !important;
        border-color: #404040 !important;
        color: #ffffff !important;
    }

    :deep(.rz-textbox:focus), :deep(.rz-password:focus) {
        box-shadow: 0 0 0 2px rgba(103, 126, 255, 0.3);
        border-color: #677eff !important;
    }

    :deep(.rz-textbox::placeholder), :deep(.rz-password::placeholder) {
        color: #888888 !important;
    }

    :deep(.rz-form-field-label) {
        color: #e0e0e0 !important;
    }

    :deep(.rz-button) {
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    :deep(.rz-button:hover) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(103, 126, 255, 0.3);
    }

    .forgot-password {
        text-align: center;
        margin-top: 0.5rem;
    }

    :deep(.rz-link) {
        color: #677eff;
        text-decoration: none;
        font-size: 0.9rem;
        transition: color 0.3s ease;
    }

    :deep(.rz-link:hover) {
        color: #8a9eff;
        text-decoration: underline;
    }

    .error-message {
        background-color: #3d1f1f;
        border: 1px solid #5a2a2a;
        color: #ff6b6b;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
        font-size: 0.9rem;
    }

    .error-message :deep(.rz-icon) {
        font-size: 1.2rem;
        color: #ff6b6b;
    }

    :deep(.rz-card) {
        background-color: #2d2d2d !important;
        border-color: #404040 !important;
    }
</style>

@code {
    public class LoginModel
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }

    private LoginModel loginModel = new();
    private bool isLoading = false;
    private string errorMessage = string.Empty;

    private async Task OnSubmit()
    {
        try
        {
            // Clear any previous error message
            errorMessage = string.Empty;
            
            // Activer l'état de chargement
            isLoading = true;
            StateHasChanged();

            // Appeler l'API d'authentification
            var success = await AuthService.LoginAsync(loginModel.Username, loginModel.Password);

            if (!success)
            {
                errorMessage = "Nom d'utilisateur ou mot de passe incorrect";
                return;
            }

            // Rediriger vers la page Home
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            errorMessage = "Une erreur est survenue lors de la connexion";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleForgotPassword()
    {
        try
        {
            await DialogService.Alert("Un email de réinitialisation sera envoyé à votre adresse email.", "Réinitialisation du mot de passe");
        }
        catch (Exception ex)
        {
            await DialogService.Alert("Une erreur est survenue. Veuillez réessayer plus tard.", "Erreur");
        }
    }
}