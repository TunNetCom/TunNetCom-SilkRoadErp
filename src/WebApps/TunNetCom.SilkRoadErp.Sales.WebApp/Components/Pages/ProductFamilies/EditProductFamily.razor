@page "/product-families/edit"
@page "/product-families/edit/{Id:int}"
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ProductFamilies
@using TunNetCom.SilkRoadErp.Sales.Contracts.ProductFamilies
@using Radzen
@using Radzen.Blazor
@using BlazorBootstrap
@inject IProductFamiliesApiClient ProductFamiliesService
@inject NavigationManager NavigationManager
@inject ToastService ToastService

<RadzenCard Style="padding: 20px; max-width: 600px; margin: 2rem auto;">
    <RadzenTemplateForm Data="@model" Submit="@((CreateFamilleProduitRequest m) => OnSubmit())">
        <RadzenStack Gap="1rem">
            <h3>@(Id == 0 ? "Créer une famille" : "Modifier une famille")</h3>
            
            <RadzenFormField Text="Nom" class="rz-col-12">
                <RadzenTextBox @bind-Value="@model.Nom" Placeholder="Nom de la famille" />
            </RadzenFormField>

            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                <RadzenButton Text="Annuler" ButtonStyle="ButtonStyle.Light" Click="@Cancel" />
                <RadzenButton Text="@(Id == 0 ? "Créer" : "Modifier")" ButtonType="Radzen.ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" IsBusy="@isSubmitting" />
            </RadzenStack>
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenCard>

@code {
    [Parameter] public int Id { get; set; }
    private CreateFamilleProduitRequest model = new();
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        if (Id > 0)
        {
            var families = await ProductFamiliesService.GetAllAsync();
            var family = families.FirstOrDefault(f => f.Id == Id);
            if (family != null)
            {
                model.Nom = family.Nom;
            }
        }
    }

    private async Task OnSubmit()
    {
        isSubmitting = true;
        try
        {
            if (Id == 0)
            {
                var result = await ProductFamiliesService.CreateAsync(model);
                if (result.IsT0)
                {
                    ToastService.Notify(new(ToastType.Success, "Famille créée avec succès"));
                    NavigationManager.NavigateTo("/product-families");
                }
                else
                {
                    var error = result.AsT1;
                    ToastService.Notify(new(ToastType.Danger, error.Detail ?? "Erreur lors de la création"));
                }
            }
            else
            {
                var updateRequest = new UpdateFamilleProduitRequest { Nom = model.Nom };
                var result = await ProductFamiliesService.UpdateAsync(Id, updateRequest);
                if (result.IsT0)
                {
                    ToastService.Notify(new(ToastType.Success, "Famille modifiée avec succès"));
                    NavigationManager.NavigateTo("/product-families");
                }
                else
                {
                    var error = result.AsT1;
                    ToastService.Notify(new(ToastType.Danger, error.Detail ?? "Erreur lors de la modification"));
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.Notify(new(ToastType.Danger, $"Erreur: {ex.Message}"));
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/product-families");
    }
}

