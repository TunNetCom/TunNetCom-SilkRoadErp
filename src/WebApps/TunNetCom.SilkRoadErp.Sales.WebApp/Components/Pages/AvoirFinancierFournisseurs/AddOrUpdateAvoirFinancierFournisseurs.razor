@page "/AddOrUpdateAvoirFinancierFournisseurs"
@page "/AddOrUpdateAvoirFinancierFournisseurs/{num?}"

@using Radzen.Blazor
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.AvoirFinancierFournisseurs
@using TunNetCom.SilkRoadErp.Sales.Contracts.Providers
@using TunNetCom.SilkRoadErp.Sales.Contracts.Common
@using TunNetCom.SilkRoadErp.Sales.Contracts.ProviderInvoice
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AvoirFinancierFournisseurs
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Providers
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ProviderInvoice
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers

@inject IStringLocalizer<SharedResource> Localizer
@inject Radzen.NotificationService NotificationService
@inject IAvoirFinancierFournisseursApiClient avoirFinancierFournisseursApiClient
@inject IProvidersApiClient providersApiClient
@inject IProviderInvoiceApiClient providerInvoiceApiClient
@inject ILogger<AddOrUpdateAvoirFinancierFournisseurs> logger
@inject NavigationManager NavigationManager

@if (isLoading)
{
    <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else
{
    <div class="avoir-financier-form-container">
        <div class="avoir-financier-form-card">
            <div class="avoir-financier-form-header">
                <h3>@(isEditMode ? "Modifier l'avoir financier fournisseur" : "Nouvel avoir financier fournisseur")</h3>
                <RadzenButton Icon="arrow_back"
                              Text="@Localizer["Retour"]"
                              ButtonStyle="ButtonStyle.Secondary"
                              Variant="Variant.Outlined"
                              Click="@(() => NavigationManager.NavigateTo("/avoir-financier-fournisseurs"))" />
            </div>

            <RadzenStack Gap="1.5rem">
                <RadzenFormField Text="Numéro avoir financier" class="rz-col-12 rz-md-6">
                    <RadzenTextBox @bind-Value="avoirFinancierNumber" Style="width: 100%;" ReadOnly="true" />
                </RadzenFormField>

                <RadzenFormField Text="@Localizer["date"]" class="rz-col-12 rz-md-6">
                    <RadzenDatePicker @bind-Value="avoirFinancierDate" Style="width: 100%;" DateFormat="d MMMM yyyy" ShowTime="false" />
                </RadzenFormField>

                <RadzenFormField Text="Numéro sur page" class="rz-col-12 rz-md-6">
                    <RadzenNumeric @bind-Value="numSurPage" Style="width: 100%;" />
                </RadzenFormField>

                <RadzenFormField Text="Fournisseur" class="rz-col-12 rz-md-6">
                    <RadzenDropDownDataGrid AllowClear="true"
                                            IsLoading="@isLoadingProviders"
                                            @bind-Value="@selectedFournisseurId"
                                            LoadData="@LoadProviders"
                                            AllowFiltering="true"
                                            Style="width: 100%;"
                                            Data="@_filteredProviders"
                                            TextProperty="@nameof(ProviderResponse.Nom)"
                                            ValueProperty="@nameof(ProviderResponse.Id)"
                                            Placeholder="Sélectionner un fournisseur"
                                            Change="@OnFournisseurChanged"
                                            Disabled="@isEditMode">
                        <Columns>
                            <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Id)" Title="ID" Width="80px" />
                            <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Nom)" Title="@Localizer["name"]" Width="220px" />
                        </Columns>
                    </RadzenDropDownDataGrid>
                </RadzenFormField>

                <RadzenFormField Text="Facture fournisseur *" class="rz-col-12 rz-md-6">
                    <RadzenDropDownDataGrid AllowClear="false"
                                            IsLoading="@isLoadingInvoices"
                                            @bind-Value="@selectedFactureFournisseurNum"
                                            LoadData="@LoadInvoices"
                                            AllowFiltering="true"
                                            Style="width: 100%;"
                                            Data="@_filteredInvoices"
                                            TextProperty="@nameof(ProviderInvoiceResponse.ProviderInvoiceNumber)"
                                            ValueProperty="@nameof(ProviderInvoiceResponse.Num)"
                                            Placeholder="Sélectionner une facture fournisseur"
                                            Disabled="@(!selectedFournisseurId.HasValue || isEditMode)">
                        <Columns>
                            <RadzenDropDownDataGridColumn Property="@nameof(ProviderInvoiceResponse.ProviderInvoiceNumber)" Title="Numéro" Width="120px" />
                            <RadzenDropDownDataGridColumn Property="@nameof(ProviderInvoiceResponse.Date)" Title="@Localizer["date"]" Width="100px" FormatString="{0:d MMM yyyy}" />
                        <RadzenDropDownDataGridColumn Property="@nameof(ProviderInvoiceResponse.TotTTC)" Title="Total TTC" Width="120px">
                            <Template Context="item">
                                @AmountHelper.FormatAmount(Convert.ToDecimal((item as ProviderInvoiceResponse)?.TotTTC ?? 0))
                            </Template>
                        </RadzenDropDownDataGridColumn>
                        </Columns>
                    </RadzenDropDownDataGrid>
                </RadzenFormField>

                <RadzenFormField Text="Description" class="rz-col-12">
                    <RadzenTextArea @bind-Value="description" Style="width: 100%;" Rows="3" Placeholder="Description (optionnel)" />
                </RadzenFormField>

                <RadzenFormField Text="Total TTC *" class="rz-col-12 rz-md-6">
                    <RadzenNumeric @bind-Value="totTtc" Style="width: 100%;" FormatString="F2" />
                </RadzenFormField>

                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" class="rz-col-12">
                    <RadzenButton Text="Enregistrer"
                                 Icon="save"
                                 ButtonStyle="ButtonStyle.Primary"
                                 Click="@SaveAvoirFinancierFournisseurs"
                                 IsBusy="@isSaving" />
                    <RadzenButton Text="Annuler"
                                 Icon="cancel"
                                 ButtonStyle="ButtonStyle.Light"
                                 Click="@(() => NavigationManager.NavigateTo("/avoir-financier-fournisseurs"))" />
                </RadzenStack>
            </RadzenStack>
        </div>
    </div>
}

<style>
    .avoir-financier-form-container {
        padding: 0;
        margin: 0;
    }

    .avoir-financier-form-card {
        background: transparent;
        border-radius: 0;
        box-shadow: none;
        padding: 1rem;
    }

    .avoir-financier-form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--rz-base-300, #e0e0e0);
    }

    .avoir-financier-form-header h3 {
        margin: 0;
        font-size: 1.25rem;
    }
</style>

@code {
    [Parameter] public string? num { get; set; }
    
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isLoadingProviders = false;
    private bool isLoadingInvoices = false;
    private bool isEditMode => !string.IsNullOrEmpty(num) && int.TryParse(num, out _);
    
    private string avoirFinancierNumber = string.Empty;
    private DateTime avoirFinancierDate = DateTime.Now;
    private int numSurPage = 1;
    private int? _selectedFournisseurId;
    private int? selectedFournisseurId
    {
        get => _selectedFournisseurId;
        set
        {
            if (_selectedFournisseurId != value)
            {
                _selectedFournisseurId = value;
                selectedFactureFournisseurNum = null;
                _filteredInvoices = new List<ProviderInvoiceResponse>();
                _ = LoadInvoices(null);
            }
        }
    }
    
    private int? selectedFactureFournisseurNum;
    private string? description;
    private decimal totTtc = 0;
    
    private List<ProviderResponse> _filteredProviders = new();
    private List<ProviderInvoiceResponse> _filteredInvoices = new();
    
    private CancellationTokenSource _cancellationTokenSource = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadProviders(null);
        await FetchAvoirFinancierFournisseurs();
        isLoading = false;
    }

    private async Task LoadProviders(LoadDataArgs args)
    {
        isLoadingProviders = true;
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 100,
            SearchKeyword = args?.Filter ?? string.Empty
        };

        try
        {
            var pagedProviders = await providersApiClient.GetPagedAsync(parameters, _cancellationTokenSource.Token);
            _filteredProviders = pagedProviders.Items;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Échec du chargement des fournisseurs: {ex.Message}"
            });
            _filteredProviders = new List<ProviderResponse>();
        }

        isLoadingProviders = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnFournisseurChanged(object? value)
    {
        selectedFactureFournisseurNum = null;
        _filteredInvoices = new List<ProviderInvoiceResponse>();
        await LoadInvoices(null);
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadInvoices(LoadDataArgs? args)
    {
        if (!selectedFournisseurId.HasValue)
        {
            _filteredInvoices = new List<ProviderInvoiceResponse>();
            return;
        }

        isLoadingInvoices = true;
        
        try
        {
            var parameters = new QueryStringParameters
            {
                PageNumber = 1,
                PageSize = 1000,
                SearchKeyword = args?.Filter ?? string.Empty
            };

            var result = await providerInvoiceApiClient.GetProvidersInvoicesAsync(
                selectedFournisseurId.Value,
                parameters,
                _cancellationTokenSource.Token);

            if (result.IsT0)
            {
                _filteredInvoices = result.AsT0.Invoices.Items;
            }
            else
            {
                _filteredInvoices = new List<ProviderInvoiceResponse>();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Échec du chargement des factures fournisseur: {ex.Message}"
            });
            _filteredInvoices = new List<ProviderInvoiceResponse>();
        }

        isLoadingInvoices = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task FetchAvoirFinancierFournisseurs()
    {
        var avoirFinancierNumToLoad = num;
        if (string.IsNullOrEmpty(avoirFinancierNumToLoad))
        {
            return;
        }

        try
        {
            if (int.TryParse(avoirFinancierNumToLoad, out var numAsInt))
            {
                var avoirFinancier = await avoirFinancierFournisseursApiClient.GetFullAvoirFinancierFournisseursAsync(numAsInt, _cancellationTokenSource.Token);

                if (avoirFinancier.IsSuccess && avoirFinancier.Value != null)
                {
                    var data = avoirFinancier.Value;
                    avoirFinancierNumber = data.Num.ToString();
                    avoirFinancierDate = data.Date;
                    numSurPage = data.NumSurPage;
                    description = data.Description;
                    totTtc = data.TotTtc;
                    selectedFournisseurId = data.FactureFournisseur?.ProviderId;
                    await LoadInvoices(null);
                    selectedFactureFournisseurNum = data.FactureFournisseur?.Num;
                }
            }
        }
        catch (Exception e)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Échec du chargement: {e.Message}"
            });

            logger.LogError(e, "Failed to fetch avoir financier fournisseurs");
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task SaveAvoirFinancierFournisseurs()
    {
        if (!selectedFactureFournisseurNum.HasValue)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = "Veuillez sélectionner une facture fournisseur"
            });
            return;
        }

        if (totTtc <= 0)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = "Le total TTC doit être supérieur à 0"
            });
            return;
        }

        try
        {
            isSaving = true;
            StateHasChanged();

            // Check if we're in edit mode
            int avoirFinancierNum = 0;
            bool isEdit = !string.IsNullOrEmpty(avoirFinancierNumber) && int.TryParse(avoirFinancierNumber, out avoirFinancierNum);

            if (isEdit)
            {
                var updateRequest = new UpdateAvoirFinancierFournisseursRequest
                {
                    NumSurPage = numSurPage,
                    Date = avoirFinancierDate,
                    Description = description,
                    TotTtc = totTtc
                };

                var updateResponse = await avoirFinancierFournisseursApiClient.UpdateAvoirFinancierFournisseursAsync(avoirFinancierNum, updateRequest, _cancellationTokenSource.Token);

                if (updateResponse.IsSuccess)
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = Localizer["success"],
                        Detail = "Avoir financier fournisseurs mis à jour avec succès"
                    });
                    NavigationManager.NavigateTo("/avoir-financier-fournisseurs");
                }
                else
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = Localizer["error"],
                        Detail = $"Échec de la mise à jour: {updateResponse.Errors.First().Message}"
                    });
                }
            }
            else
            {
                var createRequest = new CreateAvoirFinancierFournisseursRequest
                {
                    NumFactureFournisseur = selectedFactureFournisseurNum.Value,
                    NumSurPage = numSurPage,
                    Date = avoirFinancierDate,
                    Description = description,
                    TotTtc = totTtc
                };

                var createResponse = await avoirFinancierFournisseursApiClient.CreateAvoirFinancierFournisseurs(createRequest, _cancellationTokenSource.Token);

                if (createResponse.IsT0)
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = Localizer["success"],
                        Detail = "Avoir financier fournisseurs créé avec succès"
                    });
                    NavigationManager.NavigateTo("/avoir-financier-fournisseurs");
                }
                else
                {
                    var badRequest = createResponse.AsT1;
                    var errorMessage = badRequest.errors?.Any() == true
                        ? string.Join(", ", badRequest.errors.SelectMany(e => e.Value))
                        : (badRequest.Detail ?? "Échec de la création");
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = Localizer["error"],
                        Detail = errorMessage
                    });
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Échec de la sauvegarde: {ex.Message}"
            });
            logger.LogError(ex, "Failed to save avoir financier fournisseurs");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
}

