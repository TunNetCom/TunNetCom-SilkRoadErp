@page "/orders"
@page "/commandes"

@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.Commande
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Orders
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@inject IOrderApiClient OrderService
@inject IProvidersApiClient ProvidersService
@inject IStringLocalizer<SharedResource> Localizer
@inject ILogger<OrdersList> _logger
@using Radzen.Blazor
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Providers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@inject NavigationManager NavigationManager
@inject Radzen.NotificationService NotificationService
@inject DialogService DialogService
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@using TunNetCom.SilkRoadErp.Sales.Contracts.Common
@using TunNetCom.SilkRoadErp.Sales.Domain.Entites

<div class="orders-list-container">
    <div class="search-header">
        <div class="search-field">
            <label for="provider">Fournisseur</label>
            <RadzenDropDownDataGrid id="provider"
                                    AllowClear="true"
                                    @bind-Value="@selectedProviderId"
                                    LoadData="@LoadProviders"
                                    AllowFiltering="true"
                                    class="w-100 search-input"
                                    Data="@_filteredProviders"
                                    TextProperty="@nameof(ProviderResponse.Nom)"
                                    ValueProperty="@nameof(ProviderResponse.Id)"
                                    Placeholder="Sélectionner un fournisseur">
                <Columns>
                    <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Id)" Title="ID" Width="80px" />
                    <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Nom)" Title="@Localizer["name"]" Width="220px" />
                </Columns>
            </RadzenDropDownDataGrid>
        </div>
        <div class="search-field">
            <label>Statut</label>
            <RadzenDropDown @bind-Value="@selectedStatus"
                            Data="@(Enum.GetValues(typeof(DocumentStatus)).Cast<DocumentStatus>().Select(e => new { Value = (int?)e, Text = e.ToString() }).Prepend(new { Value = (int?)null, Text = "Tous" }))"
                            TextProperty="Text"
                            ValueProperty="Value"
                            class="w-100 search-input" />
        </div>
        <div class="search-button" style="display: flex; gap: 8px;">
            <RadzenButton Icon="search"
                          ButtonStyle="ButtonStyle.Primary"
                          Click="@SearchOrders"
                          class="action-button" />
            <RadzenButton Icon="check_circle"
                          ButtonStyle="ButtonStyle.Success"
                          Click="@ValidateSelectedOrders"
                          Disabled="@(selectedOrders == null || !selectedOrders.Any())"
                          Title="Valider la sélection"
                          AriaLabel="Valider la sélection"
                          class="action-button" />
        </div>
        <div class="search-button">
            <RadzenButton Text="Nouvelle commande"
                          Icon="add"
                          ButtonStyle="ButtonStyle.Success"
                          Click="@CreateNewOrder"
                          class="action-button" />
        </div>
    </div>
    <div class="list-card">
        <h2>Commandes fournisseur</h2>
        <RadzenDataGrid @ref="ordersGrid"
                        Data="@ordersList"
                        LoadData="@Callback"
                        TItem="OrderSummaryResponse"
                        SelectionMode="DataGridSelectionMode.Multiple"
                        @bind-Value="selectedOrders"
                        AllowSorting="true"
                        AllowFiltering="true"
                        AllowPaging="true"
                        PageSize="@pageSize"
                        PageSizeOptions="@GridPageSizeConstants.PageSizeOptions"
                        Count="@totalCount"
                        AllowColumnResize="true">
            <EmptyTemplate>
                <p style="font-size: 24px; text-align: center; margin: 2rem;">Aucune commande à afficher.</p>
            </EmptyTemplate>
            <Columns>
                <RadzenDataGridColumn TItem="OrderSummaryResponse" Width="40px" Sortable="false" Filterable="false">
                    <HeaderTemplate>
                        <RadzenCheckBox TriState="false" TValue="bool" Value="@(ordersList != null && ordersList.Any() && selectedOrders != null && ordersList.All(i => selectedOrders.Contains(i)))"
                                        Change="@(args => selectedOrders = args ? ordersList.ToList() : new List<OrderSummaryResponse>())" />
                    </HeaderTemplate>
                    <Template Context="data">
                        <RadzenCheckBox TriState="false" Value="@(selectedOrders != null && selectedOrders.Contains(data))" 
                                        TValue="bool" Change="@(args => { if(selectedOrders == null) selectedOrders = new List<OrderSummaryResponse>(); if(args) { if(!selectedOrders.Contains(data)) selectedOrders.Add(data); } else { selectedOrders.Remove(data); } })" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="OrderSummaryResponse" Property="Statut" Title="Statut" Width="100px">
                    <Template Context="item">
                        <span class="status-tag" style="@GetStatusStyle(item.Statut)">
                            @(item.Statut == 1 ? "Validé" : "Brouillon")
                        </span>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="OrderSummaryResponse"
                                      Property="@nameof(OrderSummaryResponse.OrderNumber)"
                                      Title="@Localizer["number"]"
                                      Width="150px" />
                <RadzenDataGridColumn TItem="OrderSummaryResponse"
                                      Property="@nameof(OrderSummaryResponse.Date)"
                                      Title="@Localizer["date"]"
                                      Width="150px"
                                      FormatString="{0:d MMMM yyyy}" />
                <RadzenDataGridColumn TItem="OrderSummaryResponse"
                                      Property="@nameof(OrderSummaryResponse.NetToPay)"
                                      Title="@Localizer["tot_ttc"]"
                                      Width="150px">
                    <Template Context="item">
                        @item.NetToPay.FormatAmount()
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="OrderSummaryResponse"
                                      Title="@Localizer["actions_label"]"
                                      Width="120px"
                                      Sortable="false"
                                      Filterable="false">
                    <Template Context="item">
                        <RadzenButton Icon="edit"
                                      ButtonStyle="ButtonStyle.Primary"
                                      Variant="Variant.Flat"
                                      Size="ButtonSize.Small"
                                      Click="@(() => ViewOrder(item.OrderNumber.ToString()))"
                                      Disabled="@(item.Statut == 1)"
                                      Title="@Localizer["edit"]"
                                      AriaLabel="@Localizer["edit"]" 
                                      Style="margin-right: 4px;" />
                        <RadzenButton Icon="check_circle"
                                      ButtonStyle="ButtonStyle.Success"
                                      Variant="Variant.Flat"
                                      Size="ButtonSize.Small"
                                      Click="@(() => ValidateOrder(item))"
                                      Disabled="@(item.Statut == 1)"
                                      Title="Valider"
                                      AriaLabel="Valider" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
        <RadzenCard class="summary-card" Variant="Variant.Outlined">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal"
                         Gap="1.5rem"
                         JustifyContent="JustifyContent.End"
                         class="summary-stack">
                <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                    @Localizer["tot_ttc"]: <strong>@ordersList.Sum(q => q.NetToPay).FormatAmount()</strong>
                </RadzenText>
            </RadzenStack>
        </RadzenCard>
    </div>
</div>

<style>
    .status-tag {
        font-size: 0.75rem;
        padding: 0.125rem 0.5rem;
        display: inline-flex;
        align-items: center;
        border-radius: 3px;
        line-height: 1.5;
        font-weight: 500;
    }

    .orders-list-container {
        padding: 0;
        min-height: 100%;
    }

    .list-card {
        width: 100%;
        margin: 0;
    }

    h2 {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 20px;
        margin: 0 0 16px 0;
        padding: 0;
    }

    .action-button {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        font-weight: 500;
        padding: 6px 12px;
        border-radius: 6px;
        background-color: #3b82f6;
        border: none;
        transition: background-color 0.2s, box-shadow 0.2s;
    }

        .action-button:hover:not(:disabled) {
            background-color: #2563eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .action-button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }

    .search-header {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin: 0 0 16px 0;
        align-items: end;
        padding: 0;
    }

    .search-field {
        display: flex;
        flex-direction: column;
    }

        .search-field label {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
        }

    .search-input {
        width: 100% !important;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        padding: 8px;
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

        .search-input:hover {
            border-color: #9ca3af;
        }

        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

    .search-button {
        display: flex;
        align-items: flex-end;
    }

    .summary-card {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        flex: 0 0 auto;
    }

    .summary-stack {
        gap: 1.5rem;
    }

    .summary-text {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        line-height: 1.5;
    }

        .summary-text strong {
            font-weight: 600;
        }

    @@media (max-width: 768px) {
        .orders-list-container {
            padding: 8px 12px;
        }

        h2 {
            font-size: 18px;
        }

        .action-button {
            font-size: 12px;
            padding: 6px 10px;
        }

        .search-header {
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .search-field {
            min-width: 100%;
        }

            .search-field label {
                font-size: 12px;
            }

        .search-input {
            font-size: 13px;
            padding: 6px;
        }
    }

    /* Style pour le bouton "Oui" dans les modals de confirmation */
    ::deep .rz-dialog-footer button:first-child {
        background-color: #4CAF50 !important;
        color: white !important;
        border-color: #4CAF50 !important;
    }

    ::deep .rz-dialog-footer button:first-child:hover {
        background-color: #45a049 !important;
        border-color: #45a049 !important;
    }
</style>

@code {
    private RadzenDataGrid<OrderSummaryResponse> ordersGrid = default!;
    private List<OrderSummaryResponse> ordersList = new();
    private IList<OrderSummaryResponse> selectedOrders = new List<OrderSummaryResponse>();
    private int totalCount = 0;
    private int pageSize = GridPageSizeConstants.PageSize10;
    private int? selectedProviderId;
    private int? selectedStatus;
    private List<ProviderResponse> _filteredProviders = new();

    protected override async Task OnInitializedAsync()
    {
        _logger.LogInformation("OrdersList.OnInitializedAsync called");
        
        await LoadProviders(new LoadDataArgs { Filter = string.Empty });

        // Load initial data
        _logger.LogInformation("Calling Callback to load initial data");
        await Callback(new LoadDataArgs { Skip = 0, Top = pageSize });
    }

    async Task LoadProviders(LoadDataArgs args)
    {
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 7,
            SearchKeyword = args?.Filter ?? string.Empty
        };

        try
        {
            var pagedProviders = await ProvidersService.GetPagedAsync(parameters, default);
            _filteredProviders = pagedProviders.Items.ToList();
        }
        catch (Exception ex)
        {
            _filteredProviders = new List<ProviderResponse>();
        }

        await InvokeAsync(StateHasChanged);
    }

    private void ViewOrder(string id)
    {
        NavigationManager.NavigateTo($"/AddOrUpdateOrder/{id}");
    }

    private void CreateNewOrder()
    {
        NavigationManager.NavigateTo("/AddOrUpdateOrder");
    }

    private async Task SearchOrders()
    {
        await Callback(new LoadDataArgs { Skip = 0, Top = pageSize });
    }

    private async Task ValidateSelectedOrders()
    {
        if (selectedOrders == null || !selectedOrders.Any())
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Warning, Summary = Localizer["Attention"], Detail = Localizer["Select_At_Least_One_Order"] });
            return;
        }

        var count = selectedOrders.Count;
        var confirmed = await DialogService.Confirm(
            string.Format(Localizer["Confirmation_Validation_Orders"], count, count > 1 ? "s" : ""),
            Localizer["Confirmation_Validation_Titre"],
            new ConfirmOptions() { OkButtonText = Localizer["Oui"], CancelButtonText = Localizer["Non"] });

        if (confirmed != true)
        {
            return;
        }

        var ids = selectedOrders.Select(d => d.OrderNumber).ToList();
        var result = await OrderService.ValidateOrdersAsync(ids, default);
        
        if (result.IsSuccess)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = Localizer["Success"], Detail = Localizer["Validation_Success_Orders"] });
            selectedOrders.Clear();
            if (ordersGrid != null)
            {
                await ordersGrid.Reload();
            }
            else
            {
                await SearchOrders();
            }
        }
        else
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = Localizer["Error"], Detail = result.Errors.FirstOrDefault()?.Message ?? Localizer["Unexpected_Error"] });
        }
    }

    private async Task ValidateOrder(OrderSummaryResponse item)
    {
        var confirmed = await DialogService.Confirm(
            string.Format(Localizer["Confirmation_Validation_Order"], item.OrderNumber),
            Localizer["Confirmation_Validation_Titre"],
            new ConfirmOptions() { OkButtonText = Localizer["Oui"], CancelButtonText = Localizer["Non"] });

        if (confirmed != true)
        {
            return;
        }

        var result = await OrderService.ValidateOrdersAsync(new List<int> { item.OrderNumber }, default);
        
        if (result.IsSuccess)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = Localizer["Success"], Detail = Localizer["Validation_Success_Order"] });
            if (ordersGrid != null)
            {
                await ordersGrid.Reload();
            }
            else
            {
                await SearchOrders();
            }
        }
        else
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = Localizer["Error"], Detail = result.Errors.FirstOrDefault()?.Message ?? Localizer["Unexpected_Error"] });
        }
    }

    private async Task Callback(LoadDataArgs args)
    {
        _logger.LogInformation("OrdersList.Callback called with Skip: {Skip}, Top: {Top}", args.Skip, args.Top);
        
        // Update pageSize if Top is provided
        if (args.Top.HasValue)
        {
            pageSize = args.Top.Value;
        }

        try
        {
            var allOrders = await OrderService.GetOrdersListAsync(default);
            
            // Filter by provider if selected
            if (selectedProviderId.HasValue)
            {
                allOrders = allOrders.Where(o => o.SupplierId == selectedProviderId.Value).ToList();
            }

            // Filter by status if selected
            if (selectedStatus.HasValue)
            {
                allOrders = allOrders.Where(o => o.Statut == selectedStatus.Value).ToList();
            }

            // Apply paging
            ordersList = allOrders.Skip(args.Skip ?? 0).Take(args.Top ?? pageSize).ToList();
            totalCount = allOrders.Count;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading orders");
            ordersList = new List<OrderSummaryResponse>();
            totalCount = 0;
        }

        await InvokeAsync(StateHasChanged);
    }

    private string GetStatusStyle(int statut)
    {
        return statut == 1 
            ? "background-color: #388e3c; color: #fff;" 
            : "background-color: #e1e1e1; color: #333;";
    }
}
