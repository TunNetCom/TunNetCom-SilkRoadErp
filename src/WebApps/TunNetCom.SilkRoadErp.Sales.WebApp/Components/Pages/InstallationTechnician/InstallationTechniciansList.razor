@page "/installation-technicians"
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.InstallationTechnician.Responses
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.InstallationTechnician
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using Radzen.Blazor
@using Radzen
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> Localizer
@inject IInstallationTechnicianApiClient TechnicianService
@inject ODataService ODataService
@inject ILogger<InstallationTechniciansList> Logger
@inject ToastService ToastService
@inject DialogService DialogService
@inject NotificationService NotificationService

<div class="technicians-container">
    <div class="technicians-card">
        <div class="technicians-header">
            <h3 class="technicians-title">Installateurs</h3>
            <RadzenButton Icon="add" Text="Ajouter Installateur"
                          ButtonStyle="ButtonStyle.Primary"
                          Click="CreateTechnician"
                          Class="btn-primary" />
        </div>

        <div class="search-header">
            <div class="search-field">
                <label for="nomFilter">Nom</label>
                <input id="nomFilter"
                       type="text"
                       @bind="@searchCriteria.NomFilter"
                       @bind:event="oninput"
                       @bind:after="OnFilterChanged"
                       placeholder="Rechercher par nom..."
                       class="w-100 search-input" />
            </div>
            <div class="search-field">
                <label for="telFilter">Téléphone</label>
                <input id="telFilter"
                       type="text"
                       @bind="@searchCriteria.TelFilter"
                       @bind:event="oninput"
                       @bind:after="OnFilterChanged"
                       placeholder="Rechercher dans tous les téléphones..."
                       class="w-100 search-input" />
            </div>
        </div>

        <RadzenDataGrid @ref="technicianGrid"
                        Data="@technicians"
                        TItem="InstallationTechnicianResponse"
                        AllowFiltering="true"
                        AllowPaging="true"
                        PageSize="10"
                        PageSizeOptions="@GridPageSizeConstants.PageSizeOptions"
                        AllowSorting="true"
                        IsLoading="@isLoadingTechnicians"
                        LoadData="@LoadTechnicians"
                        Count="@totalCount"
                        AllowColumnResize="true"
                        Class="technicians-grid">
            <Columns>
                <RadzenDataGridColumn TItem="InstallationTechnicianResponse" Title="Photo" Width="100px" Sortable="false" Filterable="false">
                    <Template Context="technician">
                        @if (!string.IsNullOrEmpty(technician.Photo))
                        {
                            <img src="@technician.Photo" alt="@technician.Nom" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;" />
                        }
                        else
                        {
                            <div style="width: 50px; height: 50px; border-radius: 50%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center;">
                                <RadzenIcon Icon="person" />
                            </div>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="InstallationTechnicianResponse" Property="Nom" Title="Nom" />
                <RadzenDataGridColumn TItem="InstallationTechnicianResponse" Property="Tel" Title="Téléphone 1" />
                <RadzenDataGridColumn TItem="InstallationTechnicianResponse" Property="Tel2" Title="Téléphone 2" />
                <RadzenDataGridColumn TItem="InstallationTechnicianResponse" Property="Tel3" Title="Téléphone 3" />
                <RadzenDataGridColumn TItem="InstallationTechnicianResponse" Property="Email" Title="Email" />
                <RadzenDataGridColumn TItem="InstallationTechnicianResponse" Property="Description" Title="Description" />
                <RadzenDataGridColumn TItem="InstallationTechnicianResponse" Title="Actions" Width="150px" Sortable="false" Filterable="false">
                    <Template Context="technician">
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@(() => EditTechnician(technician.Id))" />
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(() => ConfirmDeleteTechnician(technician.Id))" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </div>
</div>

<style>
    .technicians-container {
        padding: 1.5rem;
        min-height: 100vh;
    }

    .technicians-card {
        background: var(--rz-panel-background-color, white);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1.5rem;
    }

    .technicians-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .technicians-title {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--rz-text-color, #333);
        line-height: 1.2;
    }

    .technicians-grid {
        border-radius: 8px;
        overflow: hidden;
        border: none;
    }

    /* Search header styles */
    .search-header {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin: 0 0 16px 0;
        align-items: end;
        padding: 0;
    }

    .search-field {
        display: flex;
        flex-direction: column;
    }

        .search-field label {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
        }

    .search-input {
        width: 100% !important;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        padding: 8px;
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

        .search-input:hover {
            border-color: #9ca3af;
        }

        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }


    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .search-header {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .search-field {
            min-width: 100%;
        }
    }
</style>

@code {
    private RadzenDataGrid<InstallationTechnicianResponse> technicianGrid = default!;
    private List<InstallationTechnicianResponse> technicians = new();
    private bool isLoadingTechnicians = false;
    private int totalCount = 0;
    private CancellationTokenSource cancellationTokenSource = new();
    private SearchCriteria searchCriteria = new SearchCriteria();

    public class SearchCriteria
    {
        public string? NomFilter { get; set; }
        public string? TelFilter { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        // Load initial data
        await LoadTechnicians(new LoadDataArgs { Skip = 0, Top = 10 });
    }

    async Task LoadTechnicians(LoadDataArgs args)
    {
        isLoadingTechnicians = true;
        await Task.Yield();

        try
        {
            // Ensure args is not null
            args ??= new LoadDataArgs { Skip = 0, Top = 10 };

            Logger.LogInformation("LoadTechnicians called with Skip: {Skip}, Top: {Top}, Filter: {Filter}, OrderBy: {OrderBy}", 
                args.Skip, args.Top, args.Filter, args.OrderBy);

            // Build OData filter from search criteria
            var customFilters = new List<string>();

            if (!string.IsNullOrWhiteSpace(searchCriteria.NomFilter))
            {
                var nomValue = searchCriteria.NomFilter.Trim().Replace("'", "''");
                customFilters.Add($"contains(Nom, '{nomValue}')");
            }

            // Search in all three phone fields with OR logic
            if (!string.IsNullOrWhiteSpace(searchCriteria.TelFilter))
            {
                var telValue = searchCriteria.TelFilter.Trim().Replace("'", "''");
                customFilters.Add($"(contains(Tel, '{telValue}') or contains(Tel2, '{telValue}') or contains(Tel3, '{telValue}'))");
            }

            // Combine custom filters with existing DataGrid filters
            if (customFilters.Any())
            {
                var customFilterString = string.Join(" and ", customFilters);
                
                // If there's already a filter from Radzen grid, combine them
                if (!string.IsNullOrEmpty(args.Filter?.ToString()))
                {
                    args.Filter = $"({args.Filter}) and ({customFilterString})";
                }
                else
                {
                    args.Filter = customFilterString;
                }
            }

            Logger.LogInformation("Final filter: {Filter}", args.Filter);

            var response = await ODataService.QueryAsync<InstallationTechnicianResponse>(
                entitySet: "InstallationTechnicianBaseInfos",
                args: args,
                cancellationToken: cancellationTokenSource.Token);

            technicians = response.Value ?? new List<InstallationTechnicianResponse>();
            totalCount = response.ODataCount ?? technicians.Count;

            Logger.LogInformation("Loaded {Count} technicians, total count: {TotalCount}", technicians.Count, totalCount);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading technicians: {Message}", ex.Message);
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Erreur",
                Detail = $"Erreur lors du chargement des installateurs: {ex.Message}"
            });
            technicians = new List<InstallationTechnicianResponse>();
            totalCount = 0;
        }

        isLoadingTechnicians = false;
        await InvokeAsync(StateHasChanged);
    }

    private CancellationTokenSource? _debounceCts;

    private void OnFilterChanged()
    {
        _ = TriggerSearchAsync();
    }

    private async Task TriggerSearchAsync()
    {
        // Cancel previous debounce
        _debounceCts?.Cancel();
        _debounceCts?.Dispose();
        _debounceCts = new CancellationTokenSource();

        try
        {
            // Wait 300ms before searching (reduced from 500ms for better responsiveness)
            await Task.Delay(300, _debounceCts.Token);
            
            if (technicianGrid != null && !_debounceCts.Token.IsCancellationRequested)
            {
                await InvokeAsync(async () =>
                {
                    if (technicianGrid != null)
                    {
                        await technicianGrid.Reload();
                    }
                });
            }
        }
        catch (TaskCanceledException)
        {
            // Expected when user types again before delay completes
        }
    }

    private void CreateTechnician()
    {
        NavigationManager.NavigateTo("/installation-technician/add");
    }

    private void EditTechnician(int id)
    {
        NavigationManager.NavigateTo($"/installation-technician/edit/{id}");
    }

    async Task ConfirmDeleteTechnician(int technicianId)
    {
        bool? confirmed = await DialogService.Confirm("Êtes-vous sûr de vouloir supprimer cet installateur?",
                                                      "Confirmation de suppression",
                                                      new ConfirmOptions() { OkButtonText = "Oui", CancelButtonText = "Non" });

        if (confirmed == true)
        {
            await DeleteTechnician(technicianId);
        }
    }

    async Task DeleteTechnician(int technicianId)
    {
        try
        {
            await TechnicianService.DeleteInstallationTechnicianAsync(technicianId, cancellationTokenSource.Token);
            
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Succès",
                Detail = "Installateur supprimé avec succès"
            });

            await technicianGrid.Reload();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Erreur",
                Detail = $"Erreur lors de la suppression: {ex.Message}"
            });
        }
    }

    public void Dispose()
    {
        _debounceCts?.Cancel();
        _debounceCts?.Dispose();
        cancellationTokenSource?.Cancel();
        cancellationTokenSource?.Dispose();
    }
}

