@page "/dashboard"
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services.Recap
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services.Dashboard
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Soldes
@using TunNetCom.SilkRoadErp.Sales.Contracts.Dashboard
@inject IStringLocalizer<SharedResource> Localizer
@inject IRecapVentesAchatsService RecapService
@inject IDashboardEvolutionService EvolutionService
@inject ISoldesApiClient SoldesClient
@inject IDecimalFormatService DecimalFormatService
@inject ILogger<Dashboard> Logger

<RadzenStack Gap="1.5rem">
    <RadzenRow JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <RadzenColumn Size="12" SizeMD="8">
            <RadzenText TextStyle="TextStyle.H5">@Localizer["Tableau_de_bord"]</RadzenText>
        </RadzenColumn>
    </RadzenRow>

    <div class="search-header" style="display: flex; flex-wrap: wrap; align-items: flex-end; gap: 1rem;">
        <PeriodFilter @bind-SelectedPeriod="selectedPeriod"
                      @bind-StartDate="startDate"
                      @bind-EndDate="endDate"
                      OnPeriodChanged="@LoadKpisAsync" />
        <RadzenButton Icon="refresh" Text="@Localizer["Actualiser"]" ButtonStyle="ButtonStyle.Primary" Click="@LoadAllAsync" />
    </div>

    @if (error != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="true" Close="@(() => error = null)">
            @error
        </RadzenAlert>
    }

    @if (loading)
    {
        <RadzenProgressBarCircular ShowValue="false" Size="ProgressBarCircularSize.Medium" />
    }

    @if (!loading && recap != null && !recap.HasError)
    {
        <RadzenRow>
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenCard Variant="Variant.Outlined" Style="border-left: 4px solid var(--rz-success);">
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Subtitle2">@Localizer["Ventes_nettes"]</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@Format(recap.VentesNettes.TotalHT)</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">@Localizer["HT"]</RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenCard Variant="Variant.Outlined" Style="border-left: 4px solid var(--rz-danger);">
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Subtitle2">@Localizer["Achats_nets"]</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@Format(recap.AchatsNets.TotalHT)</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">@Localizer["HT"]</RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenCard Variant="Variant.Outlined" Style="border-left: 4px solid var(--rz-primary);">
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Subtitle2">@Localizer["Resultat"]</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@Format(recap.Resultat.TotalHT)</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">@Localizer["HT"]</RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <RadzenRow>
            <RadzenColumn Size="12">
                <RadzenText TextStyle="TextStyle.H6">@Localizer["Evolution_ventes_achats"]</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12">
                <RadzenCard Variant="Variant.Outlined" Style="height: 100%; min-height: 280px;">
                    @if (evolution?.Months?.Count > 0 == true)
                    {
                        <RadzenChart Style="width: 100%; height: 260px;">
                            <RadzenAreaSeries Data="@evolution.Months" ValueProperty="VentesHT" CategoryProperty="MonthLabel" Title="@Localizer["Ventes_nettes"]" Smooth="true" Stroke="var(--rz-success)" Fill="var(--rz-success-lighter)">
                                <RadzenMarkers Visible="true" MarkerType="MarkerType.Circle" />
                            </RadzenAreaSeries>
                            <RadzenAreaSeries Data="@evolution.Months" ValueProperty="AchatsHT" CategoryProperty="MonthLabel" Title="@Localizer["Achats_nets"]" Smooth="true" Stroke="var(--rz-danger)" Fill="var(--rz-danger-lighter)">
                                <RadzenMarkers Visible="true" MarkerType="MarkerType.Circle" />
                            </RadzenAreaSeries>
                            <RadzenValueAxis>
                                <RadzenGridLines Visible="true" />
                            </RadzenValueAxis>
                            <RadzenCategoryAxis Padding="40" />
                            <RadzenLegend Visible="true" />
                        </RadzenChart>
                    }
                    else
                    {
                        <RadzenText TextStyle="TextStyle.Body2">@Localizer["Aucune_donnee_evolution"]</RadzenText>
                    }
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <RadzenRow>
            <RadzenColumn Size="12">
                <RadzenText TextStyle="TextStyle.H6">@Localizer["Alertes_soldes"]</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenCard Variant="Variant.Outlined" Style="height: 100%;">
                    <RadzenStack JustifyContent="JustifyContent.SpaceBetween" Style="height: 100%;">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Subtitle2">@Localizer["Clients_Avec_Problemes_Solde"]</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5">@clientsProblemesCount</RadzenText>
                        </RadzenStack>
                        <RadzenLink Path="/soldes-clients-problemes" Text="@Localizer["Voir_tout"]" Icon="open_in_new" />
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenCard Variant="Variant.Outlined" Style="height: 100%;">
                    <RadzenStack JustifyContent="JustifyContent.SpaceBetween" Style="height: 100%;">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Subtitle2">@Localizer["Fournisseurs_Avec_Problemes_Solde"]</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5">@fournisseursProblemesCount</RadzenText>
                        </RadzenStack>
                        <RadzenLink Path="/soldes-fournisseurs-problemes" Text="@Localizer["Voir_tout"]" Icon="open_in_new" />
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <RadzenRow>
            <RadzenColumn Size="12">
                <RadzenLink Path="@RecapDetailLink" Text="@Localizer["Voir_recap_detaille"]" Icon="summarize" />
            </RadzenColumn>
        </RadzenRow>
    }
</RadzenStack>

@code {
    private string selectedPeriod = "CurrentMonth";
    private DateTime? startDate;
    private DateTime? endDate;
    private RecapVentesAchatsViewModel? recap;
    private EvolutionVentesAchatsResponse? evolution;
    private int clientsProblemesCount;
    private int fournisseursProblemesCount;
    private bool loading;
    private string? error;

    private string RecapDetailLink => "/dashboard/recap-ventes-achats";

    protected override async Task OnInitializedAsync()
    {
        var (s, e) = PeriodFilterHelper.GetDateRangeFromPeriod(selectedPeriod, startDate, endDate);
        startDate = s;
        endDate = e?.Date;
        await LoadAllAsync();
    }

    private async Task LoadAllAsync()
    {
        await LoadKpisAsync();
        await LoadEvolutionAsync();
        await LoadAlertesAsync();
    }

    private async Task LoadKpisAsync()
    {
        var (s, e) = PeriodFilterHelper.GetDateRangeFromPeriod(selectedPeriod, startDate, endDate);
        if (!s.HasValue || !e.HasValue)
            return;
        loading = true;
        error = null;
        StateHasChanged();
        try
        {
            recap = await RecapService.GetRecapAsync(s.Value, e.Value);
            if (recap.HasError)
                error = recap.ErrorMessage;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Dashboard LoadRecap failed");
            error = ex.Message;
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadEvolutionAsync()
    {
        try
        {
            evolution = await EvolutionService.GetEvolutionAsync(12);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Dashboard LoadEvolution failed");
        }
    }

    private async Task LoadAlertesAsync()
    {
        try
        {
            var clients = await SoldesClient.GetClientsAvecProblemesSoldeAsync(1, 5);
            var fournisseurs = await SoldesClient.GetFournisseursAvecProblemesSoldeAsync(1, 5);
            clientsProblemesCount = clients?.TotalCount ?? 0;
            fournisseursProblemesCount = fournisseurs?.TotalCount ?? 0;
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Dashboard LoadAlertes failed");
        }
    }

    private string Format(decimal value) => DecimalFormatService.FormatAmount(value);
}
