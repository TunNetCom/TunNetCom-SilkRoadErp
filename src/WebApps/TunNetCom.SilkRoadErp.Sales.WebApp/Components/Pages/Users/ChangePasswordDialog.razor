@using TunNetCom.SilkRoadErp.Sales.Contracts.Users
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Users
@inject IUsersClient UsersClient
@inject DialogService DialogService
@inject Radzen.NotificationService NotificationService

<RadzenStack Gap="1rem">
    <RadzenFormField Text="Nouveau mot de passe" Variant="Variant.Outlined">
        <RadzenPassword @bind-Value="newPassword" Style="width: 100%;" />
    </RadzenFormField>

    <RadzenFormField Text="Confirmer le mot de passe" Variant="Variant.Outlined">
        <RadzenPassword @bind-Value="confirmPassword" Style="width: 100%;" />
    </RadzenFormField>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat">
            @errorMessage
        </RadzenAlert>
    }

    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
        <RadzenButton Text="Annuler" Click="@Cancel" ButtonStyle="ButtonStyle.Light" />
        <RadzenButton Text="Enregistrer" Click="@Save" ButtonStyle="ButtonStyle.Primary" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter] public int UserId { get; set; }

    private string newPassword = string.Empty;
    private string confirmPassword = string.Empty;
    private string? errorMessage;

    private async Task Save()
    {
        errorMessage = null;

        if (string.IsNullOrWhiteSpace(newPassword))
        {
            errorMessage = "Le mot de passe est requis";
            return;
        }

        if (newPassword.Length < 6)
        {
            errorMessage = "Le mot de passe doit contenir au moins 6 caractÃ¨res";
            return;
        }

        if (newPassword != confirmPassword)
        {
            errorMessage = "Les mots de passe ne correspondent pas";
            return;
        }

        try
        {
            var request = new ChangePasswordRequest { NewPassword = newPassword };
            await UsersClient.ChangePasswordAsync(UserId, request);
            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            errorMessage = $"Erreur: {ex.Message}";
        }
    }

    private void Cancel()
    {
        DialogService.Close(false);
    }
}

