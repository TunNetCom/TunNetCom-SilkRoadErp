@page "/users-debug"
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Users
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@inject IUsersClient UsersClient
@inject IAuthService AuthService
@inject IPermissionService PermissionService

<PageTitle>Debug Utilisateurs</PageTitle>

<RadzenCard Class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H4">Page de Debug - Utilisateurs</RadzenText>
    
    <RadzenStack Gap="2rem" Class="rz-mt-4">
        <RadzenFieldset Text="Informations d'authentification">
            @if (currentUser != null)
            {
                <p><strong>Utilisateur:</strong> @currentUser.Username</p>
                <p><strong>Email:</strong> @currentUser.Email</p>
                <p><strong>DisplayName:</strong> @currentUser.DisplayName</p>
                <p><strong>Est authentifié:</strong> @AuthService.IsAuthenticated</p>
                <p><strong>A ViewUsers:</strong> @hasViewUsersPermission</p>
                <p><strong>Permissions:</strong></p>
                <ul>
                    @foreach (var perm in userPermissions)
                    {
                        <li>@perm</li>
                    }
                </ul>
            }
            else
            {
                <p>Non authentifié</p>
            }
        </RadzenFieldset>

        <RadzenFieldset Text="Test de l'API">
            <RadzenButton Text="Tester GET /users" Click="@TestGetUsers" ButtonStyle="ButtonStyle.Primary" />
            
            @if (apiTestResult != null)
            {
                <div class="rz-mt-3">
                    <RadzenText TextStyle="TextStyle.Subtitle1">Résultat:</RadzenText>
                    <pre style="background: #f5f5f5; padding: 1rem; border-radius: 4px; overflow-x: auto;">@apiTestResult</pre>
                </div>
            }
            
            @if (apiError != null)
            {
                <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Class="rz-mt-3">
                    <strong>Erreur:</strong> @apiError
                </RadzenAlert>
            }
        </RadzenFieldset>
    </RadzenStack>
</RadzenCard>

@code {
    private UserInfo? currentUser;
    private List<string> userPermissions = new();
    private bool hasViewUsersPermission = false;
    private string? apiTestResult;
    private string? apiError;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentUser = AuthService.GetUserInfo();
            userPermissions = (await PermissionService.GetUserPermissionsAsync()).ToList();
            hasViewUsersPermission = await PermissionService.HasPermissionAsync("CanViewUsers");
        }
        catch (Exception ex)
        {
            apiError = $"Erreur lors du chargement: {ex.Message}";
        }
    }

    private async Task TestGetUsers()
    {
        apiTestResult = null;
        apiError = null;
        
        try
        {
            var result = await UsersClient.GetUsersAsync(1, 10);
            
            apiTestResult = $"Succès!\n" +
                          $"Total: {result.TotalCount}\n" +
                          $"Page actuelle: {result.CurrentPage}\n" +
                          $"Items: {result.Items.Count}\n\n" +
                          $"Utilisateurs:\n" +
                          string.Join("\n", result.Items.Select(u => $"- {u.Username} ({u.Email}) - Rôles: {string.Join(", ", u.Roles)}"));
        }
        catch (HttpRequestException ex)
        {
            apiError = $"Erreur HTTP: {ex.StatusCode} - {ex.Message}";
        }
        catch (Exception ex)
        {
            apiError = $"Erreur: {ex.Message}\n\nStackTrace: {ex.StackTrace}";
        }
    }
}

