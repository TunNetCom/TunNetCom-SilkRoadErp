@page "/AddOrUpdateQuotation"
@page "/AddOrUpdateQuotation/{num?}"

@using Radzen.Blazor
@using Microsoft.Extensions.Localization
@using System.Text.Json
@using TunNetCom.SilkRoadErp.Sales.Contracts.AppParameters
@using TunNetCom.SilkRoadErp.Sales.Contracts.Quotations
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote.Requests
@using TunNetCom.SilkRoadErp.Sales.Contracts.Sorting
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AppParameters
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Customers
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Quotations
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Products
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.DeliveryNote
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Reports.Quotations.PrintQuotation
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Infrastructure
@using TunNetCom.SilkRoadErp.Sales.Contracts.Tags
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Tags
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Pages.PrintHistory
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject ITagsApiClient TagsService

@inject IStringLocalizer<SharedResource> Localizer
@inject Radzen.NotificationService NotificationService
@inject IQuotationApiClient quotationApiClient
@inject IProductsApiClient productsApiClient
@inject ICustomersApiClient customersApiClient
@inject IAppParametersClient appParametersClient
@inject IDeliveryNoteApiClient deliveryNoteApiClient
@inject ILogger<AddOrUpdateQuotation> logger
@inject DialogService DialogService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject PrintQuotationService PrintQuotationService
@inject IPrintService PrintService
@inject AuthenticationStateProvider AuthenticationStateProvider

<style>
    .quotation-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .quotation-form {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
        flex-grow: 1;
    }
</style>

<!-- Loading Indicator -->
@if (isLoading)
{
    <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else
{
    <!-- Quotation Container with Form -->
    <div class="quotation-container">
        <div class="quotation-form">
            <RadzenLabel Text="Numéro" Component="QuotationNumber" AriaLabel="Numéro" />
            <RadzenTextBox @bind-Value="quotationNumber" Name="QuotationNumber" Style="width: 120px;" ReadOnly="true" AriaReadOnly="true" />

            <RadzenLabel Text="@Localizer["date"]" />
            <RadzenDatePicker @bind-Value="quotationDate" Name="QuotationDate" Style="width: 200px;" DateFormat="d MMMM yyyy" ShowTime="false" />

            <RadzenLabel Text="@Localizer["customer"]" />
            <RadzenDropDownDataGrid AllowClear="true"
                                    IsLoading="@isLoadingCustomers"
                                    @bind-Value="@selectedCustomerId"
                                    LoadData="@LoadCustomers"
                                    AllowFiltering="true"
                                    Style="width: 350px;"
                                    Data="@_filteredCustomers"
                                    TextProperty="@nameof(CustomerResponse.Name)"
                                    ValueProperty="@nameof(CustomerResponse.Id)"
                                    Placeholder="@Localizer["select_customer"]">
                <Columns>
                    <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Id)" Title="ID" Width="80px" />
                    <RadzenDropDownDataGridColumn Property="@nameof(CustomerResponse.Name)" Title="@Localizer["name"]" Width="220px" />
                </Columns>
            </RadzenDropDownDataGrid>

            @if (!string.IsNullOrEmpty(quotationNumber))
            {
                <RadzenButton Text="Transformer en bon de livraison"
                              Icon="shopping_cart"
                              ButtonStyle="ButtonStyle.Success"
                              Variant="Variant.Flat"
                              Size="ButtonSize.Medium"
                              Click="@ConvertToDeliveryNote"
                              Disabled="@(isLoading || !selectedCustomerId.HasValue || orders == null || !orders.Any())"
                              Title="Transformer ce devis en bon de livraison"
                              AriaLabel="Transformer en bon de livraison" />
            }
        </div>
    </div>

    <!-- Order Lines Grid -->
    <LineItemsGrid TItem="QuotationDetailResponse"
                   Items="@orders"
                   ItemsChanged="@OnItemsChanged"
                   OnDeleteItem="@DeleteRow"
                   OnProductSelectedCallback="@OnProductSelectedHandler"
                   LoadProducts="@LoadData"
                   GetProductList="@GetCurrentProductList"
                   ProductCount="@count"
                   AppParameters="@getAppParametersResponse"
                   OnShowPriceHistory="@ShowDialog"
                   ShowPriceHistoryDialog="true"
                   ShowPrintButton="true"
                   OnPrint="@PrintQuotation"
                   ShowSaveButton="true"
                   ShowSummary="true"
                   OnSave="@SaveQuotation"
                   TotalHt="@totalHt"
                   TotalVat="@totalVat"
                   TotalTtc="@totalTtc"
                   Localizer="@Localizer"
                   GetProductReference="@(item => item.ProductReference)"
                   SetProductReference="@((item, value) => item.ProductReference = value)"
                   GetProductDescription="@(item => item.Description)"
                   SetProductDescription="@((item, value) => item.Description = value)"
                   ProductTextProperty="ProductReferenceAndDescription"
                   ProductValueProperty="ProductReference"
                   CreateNewItem="@(() => new QuotationDetailResponse { Quantity = 1 })" />

    <!-- Tags Section -->
    @if (!string.IsNullOrEmpty(quotationNumber) && int.TryParse(quotationNumber, out var quotationNum))
    {
        <TagSelector @ref="tagSelectorRef"
                    DocumentType="Devis" 
                    DocumentId="@quotationNum"
                    SaveOnChange="false" />
        
        <!-- Print History Button -->
        <RadzenCard Style="margin-top: 1rem;">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem">
                <RadzenButton 
                    Icon="history" 
                    Text="Historique d'impression" 
                    ButtonStyle="ButtonStyle.Info"
                    Click="@ShowPrintHistory" />
            </RadzenStack>
        </RadzenCard>
    }
}

@code {
    [Parameter] public string? num { get; set; }
    List<QuotationDetailResponse> orders = new();
    List<QuotationDetailResponse> searchList = new();
    int count;
    private const int DefaultPageSize = 7;
    private CancellationTokenSource _cancellationTokenSource = new();
    private List<CustomerResponse> _filteredCustomers { get; set; } = new();
    private bool isLoading = true;
    bool isLoadingCustomers = false;
    decimal totalHt;
    decimal totalVat;
    decimal totalTtc;
    string quotationNumber = string.Empty;
    DateTime quotationDate = DateTime.Now;
    private GetAppParametersResponse getAppParametersResponse;
    private int? selectedCustomerId;
    private TagSelector? tagSelectorRef;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        searchList = new List<QuotationDetailResponse>();
        orders = new List<QuotationDetailResponse>();
        var param = await appParametersClient.GetAppParametersAsync(_cancellationTokenSource.Token);
        getAppParametersResponse = param.AsT0;
        await LoadCustomers(null);
        await FetchQuotation();
        isLoading = false;
    }

    private async Task SaveQuotation()
    {
        try
        {
            if (!selectedCustomerId.HasValue)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = $"{Localizer["select_customer"]}"
                });
                return;
            }
            isLoading = true;
            StateHasChanged();

            var request = new CreateQuotationRequest
            {
                IdClient = selectedCustomerId.Value,
                Date = quotationDate,
                TotHTva = totalHt,
                TotTva = totalVat,
                TotTtc = totalTtc,
                Items = (orders ?? new List<QuotationDetailResponse>()).Select(o => new QuotationItemRequest
                {
                    Id = o.Id,
                    ProductReference = o.ProductReference,
                    Description = o.Description,
                    Quantity = o.Quantity,
                    UnitPriceExcludingTax = o.UnitPriceExcludingTax,
                    DiscountPercentage = o.DiscountPercentage,
                    TotalExcludingTax = o.TotalExcludingTax,
                    VatPercentage = o.VatPercentage,
                    TotalIncludingTax = o.TotalIncludingTax
                }).ToList()
            };

            // Check if we're in edit mode (quotation number exists)
            int quotationNum = 0;
            bool isEditMode = !string.IsNullOrEmpty(quotationNumber) && int.TryParse(quotationNumber, out quotationNum);
            
            if (isEditMode)
            {
                // Update existing quotation
                var updateRequest = new UpdateQuotationRequest
                {
                    Num = quotationNum,
                    IdClient = selectedCustomerId.Value,
                    Date = quotationDate,
                    TotHTva = totalHt,
                    TotTva = totalVat,
                    TotTtc = totalTtc,
                    Items = request.Items
                };

                var updateResponse = await quotationApiClient.UpdateQuotationAsync(quotationNum, updateRequest, _cancellationTokenSource.Token);
                
                if (updateResponse.IsSuccess)
                {
                    // Sauvegarder les tags après la mise à jour du document
                    await SaveTags();
                    
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = Localizer["success"],
                        Detail = "Devis mis à jour avec succès"
                    });
                    
                }
                else
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = Localizer["error"],
                        Detail = $"Échec de la mise à jour du devis: {updateResponse.Errors.First().Message}"
                    });
                }
            }
            else
            {
                // Create new quotation
                var createResponse = await quotationApiClient.CreateQuotationAsync(request, _cancellationTokenSource.Token);
                
                if (createResponse.IsSuccess)
                {
                    quotationNumber = createResponse.ValueOrDefault.ToString();
                    await InvokeAsync(StateHasChanged);
                    
                    // Attendre un peu pour que le TagSelector soit mis à jour avec le nouveau DocumentId
                    await Task.Delay(100);
                    
                    // Sauvegarder les tags après la création du document
                    await SaveTags();
                    
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = Localizer["success"],
                        Detail = "Devis créé avec succès"
                    });
                    
                }
                else
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = Localizer["error"],
                        Detail = $"Échec de la création du devis: {createResponse.Errors.First().Message}"
                    });
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Échec de l'enregistrement du devis: {ex.Message}"
            });
            logger.LogError(ex, "Failed to save quotation");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task FetchQuotation()
    {
        if (string.IsNullOrEmpty(num))
        {
            orders = new List<QuotationDetailResponse>();
            totalHt = 0;
            totalVat = 0;
            totalTtc = 0;
            return;
        }

        try
        {
            if (int.TryParse(num, out var numAsInt))
            {
                var quotationResult = await quotationApiClient.GetQuotationByIdAsync(
                    numAsInt,
                    _cancellationTokenSource.Token);

                if (quotationResult.IsSuccess && quotationResult.Value != null)
                {
                    var quotation = quotationResult.Value;
                    quotationNumber = quotation.Num.ToString();
                    quotationDate = quotation.Date;
                    selectedCustomerId = quotation.CustomerId;

                    // S'assurer que le client sélectionné est présent dans _filteredCustomers
                    // pour qu'il s'affiche correctement dans le combo box
                    if (selectedCustomerId.HasValue && 
                        !_filteredCustomers.Any(c => c.Id == selectedCustomerId.Value))
                    {
                        try
                        {
                            var customer = await customersApiClient.GetCustomerByIdAsync(
                                selectedCustomerId.Value, 
                                _cancellationTokenSource.Token);
                            
                            if (customer != null)
                            {
                                _filteredCustomers.Add(customer);
                            }
                        }
                        catch (Exception ex)
                        {
                            logger.LogWarning(ex, "Failed to load customer {CustomerId} for quotation", selectedCustomerId.Value);
                            // Ne pas bloquer le chargement du devis si le client ne peut pas être chargé
                        }
                    }

                    if (quotation.Items != null && quotation.Items.Any())
                    {
                        orders = quotation.Items.ToList();
                    }
                    else
                    {
                        orders = new List<QuotationDetailResponse>();
                    }

                    totalHt = quotation.TotalExcludingTax;
                    totalVat = quotation.TotalVat;
                    totalTtc = quotation.TotalAmount;
                }
                else
                {
                    // S'assurer que orders n'est jamais null
                    orders = new List<QuotationDetailResponse>();
                }
            }

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception e)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Échec du chargement du devis: {e.Message}"
            });

            logger.LogError(e, "Failed to fetch quotation");
            await InvokeAsync(StateHasChanged);
        }
    }

    async Task DeleteRow(QuotationDetailResponse order)
    {
        if (orders == null)
        {
            orders = new List<QuotationDetailResponse>();
        }

        if (orders.Contains(order))
        {
            orders.Remove(order);
        }
        else if (order.Id > 0)
        {
            var itemToRemove = orders.FirstOrDefault(t => t.Id == order.Id && t.Id > 0);
            if (itemToRemove != null)
            {
                orders.Remove(itemToRemove);
            }
        }

        UpdateTotals();
        await OnItemsChanged(orders);
        StateHasChanged();
    }

    private List<QuotationDetailResponse> GetCurrentProductList(QuotationDetailResponse currentOrder)
    {
        var resultList = new List<QuotationDetailResponse>();
        
        if (!string.IsNullOrEmpty(currentOrder.ProductReference))
        {
            var currentProduct = searchList.FirstOrDefault(p => p.ProductReference == currentOrder.ProductReference);
            
            if (currentProduct != null)
            {
                resultList.Add(currentProduct);
            }
            else
            {
                resultList.Add(new QuotationDetailResponse
                {
                    ProductReference = currentOrder.ProductReference,
                    Description = currentOrder.Description,
                    UnitPriceExcludingTax = currentOrder.UnitPriceExcludingTax,
                    Quantity = 1
                });
            }
            
            resultList.AddRange(searchList.Where(p => p.ProductReference != currentOrder.ProductReference));
        }
        else
        {
            resultList.AddRange(searchList);
        }
        
        return resultList;
    }

    async Task LoadData(LoadDataArgs args)
    {
        string _sortProperty = null;
        string _sortOrder = null;
        if (args.Sorts != null && args.Sorts.Any())
        {
            var sort = args.Sorts.First();
            _sortProperty = sort.Property;
            _sortOrder = sort.SortOrder == SortOrder.Ascending ? SortConstants.Ascending : SortConstants.Descending;
        }
        var parameters = new QueryStringParameters
        {
            PageNumber = (args.Skip.Value / DefaultPageSize) + 1,
            PageSize = DefaultPageSize,
            SearchKeyword = args.Filter,
            SortOrder = _sortOrder,
            SortProprety = _sortProperty
        };

        try
        {
            var pagedProducts = await productsApiClient.GetPagedAsync(parameters, _cancellationTokenSource.Token);
            searchList = (pagedProducts?.Items ?? new List<ProductResponse>()).Select(
                p => new QuotationDetailResponse
                {
                    ProductReference = p.Reference,
                    Description = p.Name,
                    UnitPriceExcludingTax = p.Price,
                    Quantity = 1,
                    DiscountPercentage = p.DiscountPourcentage,
                    VatPercentage = p.VatRate,
                }).ToList();

            count = pagedProducts?.TotalCount ?? 0;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"{Localizer["failed_to_load_products"]}: {ex.Message}"
            });
            searchList = new List<QuotationDetailResponse>();
            count = 0;
        }

        await InvokeAsync(StateHasChanged);
    }

    async Task LoadCustomers(LoadDataArgs args)
    {
        isLoadingCustomers = true;
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 10,
            SearchKeyword = args?.Filter ?? string.Empty
        };

        try
        {
            var pagedCustomers = await customersApiClient.GetAsync(parameters, _cancellationTokenSource.Token);
            _filteredCustomers = pagedCustomers.Items;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"{Localizer["failed_to_load_customers"]}: {ex.Message}"
            });
            _filteredCustomers = new List<CustomerResponse>();
        }

        isLoadingCustomers = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task OnProductSelectedHandler(QuotationDetailResponse order)
    {
        UpdateTotals();
        await InvokeAsync(StateHasChanged);
    }

    async Task OnItemsChanged(List<QuotationDetailResponse> items)
    {
        orders = items ?? new List<QuotationDetailResponse>();
        UpdateTotals();
        await InvokeAsync(StateHasChanged);
    }

    private void UpdateTotals()
    {
        if (orders == null)
        {
            orders = new List<QuotationDetailResponse>();
        }
        LineItemCalculator.UpdateTotals(orders, out totalHt, out totalVat, out totalTtc);
    }

    private async Task SaveTags()
    {
        if (tagSelectorRef == null || string.IsNullOrEmpty(quotationNumber) || !int.TryParse(quotationNumber, out var quotationNum))
        {
            logger.LogWarning("Cannot save tags: tagSelectorRef={TagSelectorRef}, quotationNumber={QuotationNumber}", 
                tagSelectorRef == null ? "null" : "not null", quotationNumber);
            return;
        }

        try
        {
            // Récupérer les tags à ajouter et à supprimer
            var tagsToAdd = tagSelectorRef.GetTagsToAdd();
            var tagIdsToRemove = tagSelectorRef.GetTagIdsToRemove();

            logger.LogInformation("Saving tags for quotation {Number}: {AddCount} to add, {RemoveCount} to remove", 
                quotationNum, tagsToAdd.Count, tagIdsToRemove.Count);

            // Supprimer les tags (seulement ceux qui ont un Id > 0, car les tags avec Id = 0 ne sont pas encore en base)
            var validTagIdsToRemove = tagIdsToRemove.Where(id => id > 0).ToList();
            if (validTagIdsToRemove.Any())
            {
                var removeRequest = new RemoveTagsFromDocumentRequest { TagIds = validTagIdsToRemove };
                var removeSuccess = await TagsService.RemoveTagsFromDocumentAsync("Devis", quotationNum, removeRequest);
                if (!removeSuccess)
                {
                    logger.LogWarning("Failed to remove tags from quotation {Number}", quotationNum);
                }
            }

            // Ajouter les nouveaux tags
            if (tagsToAdd.Any())
            {
                var addRequest = new AddTagsToDocumentByNameRequest { TagNames = tagsToAdd };
                var addSuccess = await TagsService.AddTagsToDocumentByNameAsync("Devis", quotationNum, addRequest);
                if (!addSuccess)
                {
                    logger.LogWarning("Failed to add tags to quotation {Number}", quotationNum);
                }
            }

            // Recharger les tags dans le TagSelector pour mettre à jour InitialTags
            if (tagSelectorRef != null)
            {
                await tagSelectorRef.LoadDocumentTags();
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to save tags for quotation {Number}", quotationNumber);
            // Ne pas bloquer la sauvegarde du document si les tags échouent
            // Afficher une notification pour informer l'utilisateur
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"] ?? "Warning",
                Detail = "Les tags n'ont pas pu être sauvegardés, mais le document a été enregistré."
            });
        }
    }

    public async Task ShowDialog(string ProductReference)
    {
        await DialogService.OpenAsync<ProductHistoryDialog>($"{Localizer["history"]} {Localizer["article"]} {ProductReference}",
            new Dictionary<string, object>() { { "ProductReference", ProductReference } },
            new DialogOptions()
            {
                Resizable = true,
                Draggable = true,
                Width = "700px",
                Height = "512px"
            });
    }

    private async Task ConvertToDeliveryNote()
    {
        try
        {
            // Vérifier que le devis est sauvegardé
            if (string.IsNullOrEmpty(quotationNumber))
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["warning"],
                    Detail = "Veuillez d'abord sauvegarder le devis"
                });
                return;
            }

            // Vérifier qu'il y a un client
            if (!selectedCustomerId.HasValue)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = "Un client doit être sélectionné"
                });
                return;
            }

            // Vérifier qu'il y a des lignes de produits
            if (orders == null || !orders.Any())
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = "Le devis doit contenir au moins une ligne de produit"
                });
                return;
            }

            isLoading = true;
            StateHasChanged();

            // S'assurer que orders n'est pas null et contient des éléments
            var itemsToConvert = orders?.Where(o => !string.IsNullOrWhiteSpace(o.ProductReference)).ToList() ?? new List<QuotationDetailResponse>();
            
            if (!itemsToConvert.Any())
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = "Aucune ligne de produit valide à convertir"
                });
                isLoading = false;
                StateHasChanged();
                return;
            }

            // Créer la requête pour le bon de livraison à partir des données du devis
            var deliveryNoteRequest = new CreateDeliveryNoteRequest
            {
                Date = quotationDate,
                TotalExcludingTax = totalHt,
                TotalVat = totalVat,
                TotalAmount = totalTtc,
                DeliveryTime = TimeOnly.FromDateTime(DateTime.Now),
                InvoiceNumber = null, // Pas de facture associée lors de la création depuis un devis
                CustomerId = selectedCustomerId.Value,
                Items = itemsToConvert.Select(o => new DeliveryNoteItemRequest
                {
                    Id = 0, // Nouveau item, pas d'ID
                    ProductReference = o.ProductReference ?? string.Empty,
                    Description = o.Description ?? string.Empty,
                    Quantity = o.Quantity,
                    UnitPriceExcludingTax = o.UnitPriceExcludingTax,
                    DiscountPercentage = o.DiscountPercentage,
                    TotalExcludingTax = o.TotalExcludingTax,
                    VatPercentage = o.VatPercentage,
                    TotalIncludingTax = o.TotalIncludingTax
                }).ToList()
            };

            // Stocker les données dans sessionStorage pour pré-remplir l'interface de création de BL
            var deliveryNoteData = JsonSerializer.Serialize(deliveryNoteRequest);
            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "deliveryNoteFromQuotation", deliveryNoteData);

            // Rediriger vers la page de création du bon de livraison (sans numéro, donc mode création)
            NavigationManager.NavigateTo("/AddOrUpdateDeliveryNote");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Erreur lors de la transformation en bon de livraison: {ex.Message}"
            });
            logger.LogError(ex, "Failed to convert quotation to delivery note");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task PrintQuotation()
    {
        try
        {
            // Check if document is saved before allowing print
            if (string.IsNullOrEmpty(quotationNumber) || !int.TryParse(quotationNumber, out var quotationNum) || quotationNum <= 0)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["warning"],
                    Detail = "Le document doit être enregistré avant d'être imprimé."
                });
                return;
            }

            if (orders == null || !orders.Any())
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["warning"],
                    Detail = Localizer["no_items_to_print"] ?? "No items to print"
                });
                return;
            }

            // Get current user info
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier);
            var usernameClaim = authState.User.FindFirst(ClaimTypes.Name);
            int? userId = userIdClaim != null && int.TryParse(userIdClaim.Value, out var uid) ? uid : null;
            string? username = usernameClaim?.Value;

            Result<byte[]> pdfResult;

            // Print saved quotation - generate with header by default
            pdfResult = await PrintQuotationService.GenerateQuotationPdfAsync(
                quotationNum,
                _cancellationTokenSource.Token,
                includeHeader: true);

            if (pdfResult.IsSuccess)
            {
                var fileName = $"Devis {quotationNumber}.pdf";

                // Show PDF viewer dialog
                await DialogService.OpenAsync<PdfViewerDialog>(
                    Localizer["print_mode"],
                    new Dictionary<string, object>
                    {
                        { "PdfBytes", pdfResult.Value },
                        { "FileName", fileName },
                        { "RegeneratePdfAsync", new Func<bool, Task<Result<byte[]>>>(async (includeHeader) =>
                            await PrintQuotationService.GenerateQuotationPdfAsync(
                                quotationNum,
                                _cancellationTokenSource.Token,
                                includeHeader: includeHeader))
                        }
                    },
                    new DialogOptions()
                    {
                        Width = "800px",
                        Height = "700px",
                        Resizable = true,
                        Draggable = true
                    });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = $"Échec de l'impression du devis: {pdfResult.Errors.First().Message}"
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Erreur lors de l'impression du devis: {ex.Message}"
            });
            logger.LogError(ex, "Failed to print quotation");
        }
    }

    private async Task ShowPrintHistory()
    {
        if (string.IsNullOrEmpty(quotationNumber) || !int.TryParse(quotationNumber, out var quotationNum))
        {
            return;
        }

        await DialogService.OpenAsync<PrintHistoryModal>(
            $"Historique d'impression - Devis #{quotationNumber}",
            new Dictionary<string, object>
            {
                { "DocumentType", "Devis" },
                { "DocumentId", quotationNum }
            },
            new DialogOptions()
            {
                Width = "900px",
                Height = "600px",
                Resizable = true,
                Draggable = true
            });
    }
}

