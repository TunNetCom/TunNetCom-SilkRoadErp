@using Radzen.Blazor
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.FactureAvoirFournisseur
@using TunNetCom.SilkRoadErp.Sales.Contracts.Common
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.FactureAvoirFournisseur
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using Radzen

@inject IStringLocalizer<SharedResource> Localizer
@inject Radzen.NotificationService NotificationService
@inject IFactureAvoirFournisseurApiClient factureAvoirFournisseurApiClient
@inject ILogger<AddOrUpdateFactureAvoirFournisseurDialog> logger
@inject DialogService DialogService

<RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="1.5rem" Style="min-width: 600px; max-width: 800px; padding: 1rem;">
    @if (isLoading)
    {
        <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    }
    else
    {
        <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="1.5rem">
            <RadzenFormField Text="Numéro facture avoir fournisseur *" class="rz-col-12">
                <RadzenTextBox @bind-Value="factureAvoirNumber" 
                              Name="FactureAvoirNumber" 
                              Style="width: 100%;" 
                              Placeholder="Saisir le numéro" />
            </RadzenFormField>

            <RadzenFormField Text="@($"{Localizer["date"]} *")" class="rz-col-12">
                <RadzenDatePicker @bind-Value="factureAvoirDate" 
                                  Name="FactureAvoirDate"
                                  Style="width: 100%;" 
                                  DateFormat="d MMMM yyyy" 
                                  ShowTime="false" />
            </RadzenFormField>
        </RadzenStack>

        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
            <RadzenButton Text="Annuler" 
                          Icon="cancel" 
                          ButtonStyle="ButtonStyle.Light" 
                          Click="@(() => DialogService.Close(false))" />
            <RadzenButton Text="Enregistrer" 
                          Icon="save" 
                          ButtonStyle="ButtonStyle.Primary" 
                          Click="@SaveFactureAvoirFournisseur"
                          IsBusy="@isSaving" />
        </RadzenStack>
    }
</RadzenStack>

@code {
    [Parameter] public int? FactureAvoirId { get; set; }
    [Parameter] public int? InitialFournisseurId { get; set; }
    
    private bool isLoading = true;
    private bool isSaving = false;
    
    private string factureAvoirNumber = string.Empty;
    private DateTime factureAvoirDate = DateTime.Now;
    private int? _selectedFournisseurId;
    
    private CancellationTokenSource _cancellationTokenSource = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        
        // Initialize factureAvoirNumber to empty string
        factureAvoirNumber = string.Empty;
        
        // Set initial fournisseur if provided
        if (InitialFournisseurId.HasValue)
        {
            _selectedFournisseurId = InitialFournisseurId.Value;
        }
        
        await FetchFactureAvoirFournisseur();
        isLoading = false;
        await InvokeAsync(StateHasChanged);
    }


    private async Task FetchFactureAvoirFournisseur()
    {
        if (!FactureAvoirId.HasValue)
        {
            // In create mode, initialize with empty string
            factureAvoirNumber = string.Empty;
            return;
        }

        try
        {
            var factureAvoir = await factureAvoirFournisseurApiClient.GetFullFactureAvoirFournisseurAsync(FactureAvoirId.Value, _cancellationTokenSource.Token);

            if (factureAvoir.IsSuccess && factureAvoir.Value != null)
            {
                var factureAvoirData = factureAvoir.Value;
                factureAvoirNumber = factureAvoirData.NumFactureAvoirFourSurPage.ToString();
                factureAvoirDate = factureAvoirData.Date;
                _selectedFournisseurId = factureAvoirData.IdFournisseur;
            }
        }
        catch (Exception e)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Échec du chargement: {e.Message}"
            });

            logger.LogError(e, "Failed to fetch facture avoir fournisseur");
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task SaveFactureAvoirFournisseur()
    {
        if (!_selectedFournisseurId.HasValue)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = "Le fournisseur est requis"
            });
            return;
        }

        try
        {
            isSaving = true;
            StateHasChanged();

            var avoirFournisseurIds = new List<int>();

            // Check if we're in edit mode
            bool isEditMode = FactureAvoirId.HasValue;

            // Validate and parse NumFactureAvoirFourSurPage from the text field
            if (string.IsNullOrWhiteSpace(factureAvoirNumber))
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = "Le numéro de facture avoir fournisseur est requis"
                });
                isSaving = false;
                StateHasChanged();
                return;
            }

            if (!int.TryParse(factureAvoirNumber, out var numFactureAvoirFourSurPage) || numFactureAvoirFourSurPage <= 0)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = "Le numéro de facture avoir fournisseur doit être un nombre valide supérieur à 0"
                });
                isSaving = false;
                StateHasChanged();
                return;
            }

            if (isEditMode)
            {
                var updateRequest = new UpdateFactureAvoirFournisseurRequest
                {
                    Date = factureAvoirDate,
                    IdFournisseur = _selectedFournisseurId.Value,
                    NumFactureAvoirFourSurPage = numFactureAvoirFourSurPage,
                    NumFactureFournisseur = null,
                    AvoirFournisseurIds = avoirFournisseurIds
                };

                var updateResponse = await factureAvoirFournisseurApiClient.UpdateFactureAvoirFournisseurAsync(FactureAvoirId.Value, updateRequest, _cancellationTokenSource.Token);

                if (updateResponse.IsSuccess)
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = Localizer["success"],
                        Detail = "Facture avoir fournisseur mise à jour avec succès"
                    });
                    DialogService.Close(true);
                }
                else
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = Localizer["error"],
                        Detail = $"Échec de la mise à jour: {updateResponse.Errors.First().Message}"
                    });
                }
            }
            else
            {
                var createRequest = new CreateFactureAvoirFournisseurRequest
                {
                    Date = factureAvoirDate,
                    IdFournisseur = _selectedFournisseurId.Value,
                    NumFactureAvoirFourSurPage = numFactureAvoirFourSurPage,
                    NumFactureFournisseur = null,
                    AvoirFournisseurIds = avoirFournisseurIds
                };

                var createResponse = await factureAvoirFournisseurApiClient.CreateFactureAvoirFournisseur(createRequest, _cancellationTokenSource.Token);

                if (createResponse.IsT0)
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = Localizer["success"],
                        Detail = "Facture avoir fournisseur créée avec succès"
                    });
                    DialogService.Close(true);
                }
                else
                {
                    var badRequest = createResponse.AsT1;
                    var errorMessage = badRequest.errors?.Any() == true
                        ? string.Join(", ", badRequest.errors.SelectMany(e => e.Value))
                        : (badRequest.Detail ?? "Échec de la création");
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = Localizer["error"],
                        Detail = errorMessage
                    });
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Échec de la sauvegarde: {ex.Message}"
            });
            logger.LogError(ex, "Failed to save facture avoir fournisseur");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
}
