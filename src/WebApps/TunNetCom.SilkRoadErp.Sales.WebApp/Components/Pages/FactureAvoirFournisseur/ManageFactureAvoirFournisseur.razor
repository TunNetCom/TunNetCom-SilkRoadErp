@page "/manage-facture-avoir-fournisseur"
@using Microsoft.Extensions.Localization
@using Radzen.Blazor
@using Radzen
@using TunNetCom.SilkRoadErp.Sales.Contracts.FactureAvoirFournisseur
@using TunNetCom.SilkRoadErp.Sales.Contracts.AvoirFournisseur
@using TunNetCom.SilkRoadErp.Sales.Contracts.Providers
@using TunNetCom.SilkRoadErp.Sales.Contracts.Common
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Providers
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.FactureAvoirFournisseur
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AvoirFournisseur
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers

@inject IProvidersApiClient providersService
@inject IFactureAvoirFournisseurApiClient factureAvoirFournisseurService
@inject IAvoirFournisseurApiClient avoirFournisseurService
@inject NavigationManager navigationManager
@inject IStringLocalizer<SharedResource> Localizer
@inject Radzen.NotificationService NotificationService
@inject DialogService DialogService

<div style="padding: 0.5rem 1.5rem 1.5rem 1.5rem; min-height: 100vh;">
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
        <label style="font-weight: 600;
                      font-size: 0.9rem;
                      white-space: nowrap;
                      margin: 0;">
            @Localizer["select_provider"]
        </label>
        <RadzenDropDownDataGrid AllowClear="true"
                                IsLoading="@isLoadingProviders"
                                @bind-Value="@SelectedProviderId"
                                LoadData="@LoadProviders"
                                AllowFiltering="true"
                                Style="flex: 1;
                                       max-width: 500px;
                                       border-radius: 8px;
                                       border: 1px solid #e0e0e0;
                                       transition: all 0.2s ease;"
                                Data="@_providersList"
                                TextProperty="@nameof(ProviderResponse.Nom)"
                                ValueProperty="@nameof(ProviderResponse.Id)"
                                Placeholder="@Localizer["select_provider"]"
                                Class="custom-dropdown">
            <Columns>
                <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Id)"
                                              Title="ID"
                                              Width="100px" />
                <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Nom)"
                                              Title="Name"
                                              Width="300px" />
            </Columns>
        </RadzenDropDownDataGrid>
        <RadzenButton Icon="add"
                      Text="Créer facture avoir fournisseur"
                      ButtonStyle="ButtonStyle.Success"
                      Size="ButtonSize.Small"
                      Disabled="@(SelectedProviderId <= 0)"
                      Click="@CreateNewFactureAvoirFournisseur"
                      Style="border-radius: 6px; padding: 0.4rem 0.8rem; font-weight: 500; font-size: 0.85rem;" />
    </div>

    <!-- Main Content -->
    <RadzenRow Gap="2rem">
        <!-- Facture Avoir Fournisseur Section with Master-Detail -->
        <RadzenColumn Size="12">
            <RadzenCard Variant="Variant.Flat"
                        Style="padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <RadzenDataGrid @ref="FactureAvoirGrid"
                                AllowFiltering="true"
                                AllowPaging="true"
                                PageSize="_defaultPageSize"
                                PagerHorizontalAlign="HorizontalAlign.Left"
                                ShowPagingSummary="true"
                                AllowSorting="true"
                                Count="@_factureAvoirList.FactureAvoirFournisseurs.TotalCount"
                                Data="@_factureAvoirWithAvoirs"
                                LoadData="@LoadFactureAvoir"
                                RowRender="@RowRender"
                                ExpandMode="@expandMode"
                                @bind-Value="@SelectedFactureAvoir"
                                IsLoading="@isLoadingFactureAvoir"
                                SelectionMode="DataGridSelectionMode.Single"
                                Style="border: none;"
                                Class="custom-grid">
                    <EmptyTemplate>
                        <p style="font-size: 24px; text-align: center; margin: 2rem;">No records to display.</p>
                    </EmptyTemplate>
                    <HeaderTemplate>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding-bottom: 0.75rem;">
                            <div style="font-size: 1.1rem; font-weight: 600;">
                                Factures avoir fournisseur
                            </div>
                        </div>
                    </HeaderTemplate>
                    <Template Context="factureAvoirWithAvoirs">
                        @{
                            // Load avoirs when template is rendered for the first time
                            if (!factureAvoirWithAvoirs.AvoirsLoaded && !factureAvoirWithAvoirs.AvoirsLoading)
                            {
                                _ = LoadAvoirsForFactureAvoirAsync(factureAvoirWithAvoirs.FactureAvoir.Num);
                            }
                        }
                        @if (factureAvoirWithAvoirs.AvoirsLoading)
                        {
                            <div style="padding: 1rem; text-align: center; color: #666;">
                                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Medium" />
                                <p style="margin-top: 0.5rem;">@Localizer["loading"]...</p>
                            </div>
                        }
                        else
                        {
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-weight: 600; font-size: 0.9rem;">
                                    Avoirs fournisseur liés
                                </div>
                                <RadzenButton Icon="link_off"
                                              Text="Détacher"
                                              ButtonStyle="ButtonStyle.Danger"
                                              Size="ButtonSize.Small"
                                              Disabled="@(!_selectedAvoirsToDetach.Any())"
                                              Click="@(() => DetachAvoirsFromFactureAvoir(factureAvoirWithAvoirs.FactureAvoir.Num))"
                                              Style="border-radius: 6px; padding: 0.3rem 0.6rem; font-size: 0.8rem;" />
                            </div>
                            <RadzenDataGrid AllowFiltering="true" 
                                            AllowPaging="true" 
                                            AllowSorting="true" 
                                            Data="@(factureAvoirWithAvoirs.Avoirs ?? new List<AvoirFournisseurBaseInfo>())"
                                            TItem="AvoirFournisseurBaseInfo"
                                            Style="margin: 0.5rem 0; border: 1px solid #e0e0e0; border-radius: 4px;"
                                            Class="detail-grid"
                                            SelectionMode="DataGridSelectionMode.Multiple"
                                            @bind-Value="@_selectedAvoirsToDetach">
                                <EmptyTemplate>
                                    <p style="font-size: 14px; text-align: center; margin: 1rem; color: #666;">Aucun avoir fournisseur lié</p>
                                </EmptyTemplate>
                                <Columns>
                                    <RadzenDataGridColumn Property="@nameof(AvoirFournisseurBaseInfo.Num)"
                                                          Title="Numéro"
                                                          Width="120px" />
                                    <RadzenDataGridColumn Property="@nameof(AvoirFournisseurBaseInfo.Date)"
                                                          Title="@Localizer["date"]"
                                                          Width="140px"
                                                          FormatString="{0:d}" />
                                    <RadzenDataGridColumn Property="@nameof(AvoirFournisseurBaseInfo.TotalIncludingTaxAmount)"
                                                          Title="Total TTC"
                                                          Width="140px">
                                        <Template Context="avoir">
                                            @avoir.TotalIncludingTaxAmount.FormatAmount()
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn Property="@nameof(AvoirFournisseurBaseInfo.StatutLibelle)"
                                                          Title="Statut"
                                                          Width="120px">
                                        <Template Context="avoir">
                                            <RadzenBadge BadgeStyle="@(avoir.Statut == 1 ? BadgeStyle.Success : BadgeStyle.Light)" 
                                                         Text="@avoir.StatutLibelle" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        }
                    </Template>
                    <Columns>
                        <RadzenDataGridColumn Property="@nameof(FactureAvoirFournisseurBaseInfo.Num)"
                                              Title="Numéro"
                                              Width="120px">
                            <Template Context="factureAvoirWithAvoirs">
                                @factureAvoirWithAvoirs.FactureAvoir.Num
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(FactureAvoirFournisseurBaseInfo.Date)"
                                              Title="@Localizer["date"]"
                                              FormatString="{0:d}"
                                              Width="140px">
                            <Template Context="factureAvoirWithAvoirs">
                                @factureAvoirWithAvoirs.FactureAvoir.Date.ToString("d")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(FactureAvoirFournisseurBaseInfo.TotalIncludingTaxAmount)"
                                              Title="Total TTC"
                                              Width="140px">
                            <Template Context="factureAvoirWithAvoirs">
                                @factureAvoirWithAvoirs.FactureAvoir.TotalIncludingTaxAmount.FormatAmount()
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(FactureAvoirFournisseurBaseInfo.StatutLibelle)"
                                              Title="Statut"
                                              Width="120px">
                            <Template Context="factureAvoirWithAvoirs">
                                <RadzenBadge BadgeStyle="@(factureAvoirWithAvoirs.FactureAvoir.Statut == 1 ? BadgeStyle.Success : BadgeStyle.Light)" 
                                             Text="@factureAvoirWithAvoirs.FactureAvoir.StatutLibelle" />
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Uninvoiced Avoirs Fournisseur Section -->
    <RadzenRow Style="margin-top: 2rem;">
        <RadzenColumn Size="12">
            <RadzenCard Variant="Variant.Flat"
                        Style="padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <RadzenDataGrid @ref="_avoirGrid"
                                AllowRowSelectOnRowClick="true"
                                AllowFiltering="true"
                                FilterPopupRenderMode="PopupRenderMode.OnDemand"
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                AllowPaging="true"
                                PagerHorizontalAlign="HorizontalAlign.Left"
                                ShowPagingSummary="true"
                                PageSize="_defaultPageSize"
                                Count="@_uninvoicedAvoirsWithSummary.AvoirFournisseurs.TotalCount"
                                AllowSorting="true"
                                Data="@_uninvoicedAvoirsWithSummary.AvoirFournisseurs.Items"
                                LoadData="LoadUninvoicedAvoirs"
                                IsLoading="@isLoadingUninvoicedAvoirs"
                                SelectionMode="DataGridSelectionMode.Multiple"
                                @bind-Value="@_selectedAvoirsToAttach"
                                Style="border: none;"
                                Class="custom-grid">
                    <EmptyTemplate>
                        <p style="font-size: 24px; text-align: center; margin: 2rem;">No records to display.</p>
                    </EmptyTemplate>
                    <HeaderTemplate>
                        <div style="display: flex; align-items: center; margin-bottom: 0.75rem; gap: 1rem;">
                            <div style="font-size: 1.1rem; font-weight: 600;">
                                Avoirs fournisseur non facturés
                            </div>
                            <div style="margin-left: auto; display: flex; gap: 0.5rem;">
                                <RadzenButton Click="@AttachAvoirsToFactureAvoirClick"
                                              Text="Attacher à la facture avoir sélectionnée"
                                              Disabled="@(SelectedFactureAvoirId <= 0 || !_selectedAvoirsToAttach.Any())"
                      ButtonStyle="ButtonStyle.Primary" 
                                              Size="ButtonSize.Small"
                                              Style="border-radius: 6px; padding: 0.4rem 0.8rem; font-weight: 500; font-size: 0.85rem;" />
                                <RadzenButton Click="@CreateFactureAvoirWithSelectedAvoirs"
                                              Text="Créer facture avoir avec les avoirs sélectionnés"
                                              Disabled="@(!_selectedAvoirsToAttach.Any())"
                                              ButtonStyle="ButtonStyle.Success"
                                              Size="ButtonSize.Small"
                                              Style="border-radius: 6px; padding: 0.4rem 0.8rem; font-weight: 500; font-size: 0.85rem;" />
                            </div>
                        </div>
                    </HeaderTemplate>
                    <Columns>
                        <RadzenDataGridColumn Property="@nameof(AvoirFournisseurBaseInfo.Num)"
                                              Title="Numéro"
                                              Width="120px" />
                        <RadzenDataGridColumn Property="@nameof(AvoirFournisseurBaseInfo.Date)"
                                              Title="@Localizer["date"]"
                                              Width="140px"
                                              FormatString="{0:d}" />
                        <RadzenDataGridColumn Property="@nameof(AvoirFournisseurBaseInfo.TotalIncludingTaxAmount)"
                                              Title="Total TTC"
                                              Width="140px">
                            <Template Context="avoir">
                                @avoir.TotalIncludingTaxAmount.FormatAmount()
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(AvoirFournisseurBaseInfo.StatutLibelle)"
                                              Title="Statut"
                                              Width="120px">
                            <Template Context="avoir">
                                <RadzenBadge BadgeStyle="@(avoir.Statut == 1 ? BadgeStyle.Success : BadgeStyle.Light)" 
                                             Text="@avoir.StatutLibelle" />
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
                <!-- Uninvoiced Avoirs Summary -->
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e0e0e0; flex-wrap: wrap;">
                    <span style="font-size: 0.85rem; color: #666;">
                        @Localizer["total_net"]: <strong style="color: #333;">@_uninvoicedAvoirsWithSummary?.TotalNetAmount.FormatAmount()</strong>
                    </span>
                    <span style="font-size: 0.85rem; color: #666;">
                        Total TTC: <strong style="color: #333;">@_uninvoicedAvoirsWithSummary?.TotalIncludingTaxAmount.FormatAmount()</strong>
                    </span>
                </div>
</RadzenCard>
        </RadzenColumn>
    </RadzenRow>
</div>

<style>
    .custom-grid {
        border: none;
    }

    .detail-grid {
        background-color: #f9fafb;
    }

    .custom-dropdown {
        transition: all 0.2s ease;
    }

    .custom-dropdown:hover {
        border-color: #3b82f6;
    }
</style>

@code {
    #region Fields and Properties
    private const int _defaultPageSize = 5;
    private const int _minValueId = 0;
    private int _selectedProviderId;
    private int SelectedProviderId
    {
        get => _selectedProviderId;
        set
        {
            if (_selectedProviderId != value)
            {
                _selectedProviderId = value;
                SelectedFactureAvoirId = _minValueId;
                SelectedFactureAvoir = new List<FactureAvoirFournisseurWithAvoirs>();
                _factureAvoirList = new GetFactureAvoirFournisseurWithSummariesResponse();
                _factureAvoirWithAvoirs = new List<FactureAvoirFournisseurWithAvoirs>();
                _uninvoicedAvoirsWithSummary = new GetAvoirFournisseurWithSummariesResponse();
                if (value > 0)
                {
                    _ = LoadFactureAvoirForProvider();
                    _ = LoadUninvoicedAvoirs(new LoadDataArgs { Skip = 0, Top = _defaultPageSize });
                }
            }
        }
    }
    private int _selectedFactureAvoirId;
    private int SelectedFactureAvoirId
    {
        get => _selectedFactureAvoirId;
        set
        {
            if (_selectedFactureAvoirId != value)
            {
                _selectedFactureAvoirId = value;
            }
        }
    }
    private IList<FactureAvoirFournisseurWithAvoirs> _selectedFactureAvoir = new List<FactureAvoirFournisseurWithAvoirs>();
    private IList<FactureAvoirFournisseurWithAvoirs> SelectedFactureAvoir
    {
        get => _selectedFactureAvoir;
        set
        {
            _selectedFactureAvoir = value;
            SelectedFactureAvoirId = _selectedFactureAvoir?.FirstOrDefault()?.FactureAvoir?.Num ?? _minValueId;
            var selectedFactureAvoir = _selectedFactureAvoir?.FirstOrDefault();
            if (selectedFactureAvoir != null && !selectedFactureAvoir.AvoirsLoaded)
            {
                _ = LoadAvoirsForFactureAvoirAsync(selectedFactureAvoir.FactureAvoir.Num);
            }
        }
    }

    bool isLoadingProviders = false;
    bool isLoadingFactureAvoir = false;
    bool isLoadingUninvoicedAvoirs = false;
    private IList<ProviderResponse> _providersList = new List<ProviderResponse>();
    private IList<AvoirFournisseurBaseInfo> _selectedAvoirsToDetach = new List<AvoirFournisseurBaseInfo>();
    private IList<AvoirFournisseurBaseInfo> _selectedAvoirsToAttach { get; set; } = new List<AvoirFournisseurBaseInfo>();
    private CancellationTokenSource _cancellationTokenSource = new();
    private RadzenDataGrid<AvoirFournisseurBaseInfo> _avoirGrid;
    private RadzenDataGrid<FactureAvoirFournisseurWithAvoirs> FactureAvoirGrid;
    private GetFactureAvoirFournisseurWithSummariesResponse _factureAvoirList = new GetFactureAvoirFournisseurWithSummariesResponse();
    private GetAvoirFournisseurWithSummariesResponse _uninvoicedAvoirsWithSummary = new GetAvoirFournisseurWithSummariesResponse();
    
    // Master-detail model
    public class FactureAvoirFournisseurWithAvoirs
    {
        public FactureAvoirFournisseurBaseInfo FactureAvoir { get; set; } = null!;
        public List<AvoirFournisseurBaseInfo> Avoirs { get; set; } = new();
        public bool AvoirsLoaded { get; set; } = false;
        public bool AvoirsLoading { get; set; } = false;
    }
    
    private List<FactureAvoirFournisseurWithAvoirs> _factureAvoirWithAvoirs = new List<FactureAvoirFournisseurWithAvoirs>();
    DataGridExpandMode expandMode = DataGridExpandMode.Multiple;
    #endregion

    #region Lifecycle Methods
    protected override async Task OnInitializedAsync()
    {
        await LoadProviders(new LoadDataArgs { Skip = 0, Top = 100 });
    }
    #endregion

    #region Load Methods
    private async Task LoadProviders(LoadDataArgs args)
    {
        isLoadingProviders = true;
        try
        {
            var parameters = new QueryStringParameters
            {
                PageNumber = 1,
                PageSize = 100,
                SearchKeyword = args?.Filter ?? string.Empty
            };
            var pagedProviders = await providersService.GetPagedAsync(parameters, _cancellationTokenSource.Token);
            _providersList = pagedProviders.Items.ToList();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Erreur lors du chargement des fournisseurs: {ex.Message}"
            });
        }
        finally
        {
            isLoadingProviders = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadFactureAvoirForProvider()
    {
        if (SelectedProviderId <= 0) return;
        await LoadFactureAvoir(new LoadDataArgs { Skip = 0, Top = _defaultPageSize });
    }

    private async Task LoadFactureAvoir(LoadDataArgs args)
    {
        if (SelectedProviderId <= 0)
        {
            _factureAvoirList = new GetFactureAvoirFournisseurWithSummariesResponse();
            _factureAvoirWithAvoirs = new List<FactureAvoirFournisseurWithAvoirs>();
            return;
        }

        isLoadingFactureAvoir = true;
        try
        {
            // Extract sorting information from LoadDataArgs
            string? sortProperty = null;
            string? sortOrder = null;
            if (args.Sorts != null && args.Sorts.Any())
            {
                var sort = args.Sorts.First();
                // Map StatutLibelle to Statut for sorting (StatutLibelle is computed, Statut is the actual field)
                sortProperty = sort.Property == nameof(FactureAvoirFournisseurBaseInfo.StatutLibelle) 
                    ? nameof(FactureAvoirFournisseurBaseInfo.Statut) 
                    : sort.Property;
                sortOrder = sort.SortOrder == SortOrder.Ascending ? "asc" : "desc";
            }

            var pageNumber = (args.Skip ?? 0) / _defaultPageSize + 1;
            var factureAvoirResult = await factureAvoirFournisseurService.GetFactureAvoirFournisseurWithSummariesAsync(
                idFournisseur: SelectedProviderId,
                numFactureFournisseur: null,
                sortOrder: sortOrder,
                sortProperty: sortProperty,
                pageNumber: pageNumber,
                pageSize: _defaultPageSize,
                searchKeyword: args.Filter,
                startDate: null,
                endDate: null,
                _cancellationTokenSource.Token);

            _factureAvoirList = factureAvoirResult;
            _factureAvoirWithAvoirs = _factureAvoirList.FactureAvoirFournisseurs.Items.Select(f => new FactureAvoirFournisseurWithAvoirs
            {
                FactureAvoir = f,
                Avoirs = new List<AvoirFournisseurBaseInfo>(),
                AvoirsLoaded = false,
                AvoirsLoading = false
            }).ToList();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Erreur lors du chargement des factures avoir: {ex.Message}"
            });
            _factureAvoirList = new GetFactureAvoirFournisseurWithSummariesResponse();
            _factureAvoirWithAvoirs = new List<FactureAvoirFournisseurWithAvoirs>();
        }
        finally
        {
            isLoadingFactureAvoir = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadAvoirsForFactureAvoirAsync(int factureAvoirNum)
    {
        var factureAvoirWithAvoirs = _factureAvoirWithAvoirs.FirstOrDefault(f => f.FactureAvoir.Num == factureAvoirNum);
        if (factureAvoirWithAvoirs == null || factureAvoirWithAvoirs.AvoirsLoading) return;

        factureAvoirWithAvoirs.AvoirsLoading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var avoirsResult = await avoirFournisseurService.GetAvoirFournisseurWithSummariesAsync(
                fournisseurId: null,
                numFactureAvoirFournisseur: factureAvoirNum,
                sortOrder: null,
                sortProperty: null,
                pageNumber: 1,
                pageSize: 1000,
                searchKeyword: null,
                startDate: null,
                endDate: null,
                _cancellationTokenSource.Token);

            factureAvoirWithAvoirs.Avoirs = avoirsResult.AvoirFournisseurs.Items.ToList();
            factureAvoirWithAvoirs.AvoirsLoaded = true;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Erreur lors du chargement des avoirs: {ex.Message}"
            });
        }
        finally
        {
            factureAvoirWithAvoirs.AvoirsLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadUninvoicedAvoirs(LoadDataArgs args)
    {
        if (SelectedProviderId <= 0)
        {
            _uninvoicedAvoirsWithSummary = new GetAvoirFournisseurWithSummariesResponse();
            return;
        }

        isLoadingUninvoicedAvoirs = true;
        try
        {
            // Extract sorting information from LoadDataArgs
            string? sortProperty = null;
            string? sortOrder = null;
            if (args.Sorts != null && args.Sorts.Any())
            {
                var sort = args.Sorts.First();
                sortProperty = sort.Property;
                sortOrder = sort.SortOrder == SortOrder.Ascending ? "asc" : "desc";
            }

            var pageNumber = (args.Skip ?? 0) / _defaultPageSize + 1;
            var avoirsResult = await avoirFournisseurService.GetAvoirFournisseurWithSummariesAsync(
                fournisseurId: SelectedProviderId,
                numFactureAvoirFournisseur: null, // Only uninvoiced (not linked to a facture avoir)
                sortOrder: sortOrder,
                sortProperty: sortProperty,
                pageNumber: pageNumber,
                pageSize: _defaultPageSize,
                searchKeyword: args.Filter,
                startDate: null,
                endDate: null,
                _cancellationTokenSource.Token);

            // Filter to only show uninvoiced avoirs (NumFactureAvoirFournisseur is null)
            avoirsResult.AvoirFournisseurs.Items = avoirsResult.AvoirFournisseurs.Items
                .Where(a => !a.NumFactureAvoirFournisseur.HasValue)
                .ToList();
            // Note: The TotalCount should be recalculated on the server side with the filter
            // For now, we keep the filtered count, but ideally the API should support filtering by NumFactureAvoirFournisseur = null
            avoirsResult.AvoirFournisseurs.TotalCount = avoirsResult.AvoirFournisseurs.Items.Count;

            _uninvoicedAvoirsWithSummary = avoirsResult;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Erreur lors du chargement des avoirs non facturés: {ex.Message}"
            });
            _uninvoicedAvoirsWithSummary = new GetAvoirFournisseurWithSummariesResponse();
        }
        finally
        {
            isLoadingUninvoicedAvoirs = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    #endregion

    #region Action Methods
    private async Task CreateNewFactureAvoirFournisseur()
    {
        var result = await DialogService.OpenAsync<AddOrUpdateFactureAvoirFournisseurDialog>(
            "Créer une facture avoir fournisseur",
            new Dictionary<string, object>
            {
                { "InitialFournisseurId", SelectedProviderId > 0 ? SelectedProviderId : null }
            },
            new DialogOptions
            {
                Width = "800px",
                Height = "400px",
                Resizable = true,
                Draggable = true
            });

        if (result == true)
        {
            // Reload data after successful creation
            await LoadFactureAvoir(new LoadDataArgs { Skip = 0, Top = _defaultPageSize });
            await LoadUninvoicedAvoirs(new LoadDataArgs { Skip = 0, Top = _defaultPageSize });
            _selectedAvoirsToAttach = new List<AvoirFournisseurBaseInfo>();
        }
    }

    private async Task AttachAvoirsToFactureAvoirClick()
    {
        if (SelectedFactureAvoirId <= 0 || !_selectedAvoirsToAttach.Any())
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = "Veuillez sélectionner une facture avoir fournisseur et au moins un avoir fournisseur"
            });
            return;
        }

        try
        {
            var avoirIds = _selectedAvoirsToAttach.Select(a => a.Num).ToList();
            
            // Get the current facture avoir to update
            var factureAvoir = _factureAvoirWithAvoirs.FirstOrDefault(f => f.FactureAvoir.Num == SelectedFactureAvoirId);
            if (factureAvoir == null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = "Facture avoir fournisseur non trouvée"
                });
                return;
            }

            // Get full facture avoir to get current avoirs
            var fullFactureAvoir = await factureAvoirFournisseurService.GetFullFactureAvoirFournisseurAsync(SelectedFactureAvoirId, _cancellationTokenSource.Token);
            if (!fullFactureAvoir.IsSuccess || fullFactureAvoir.Value == null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = "Erreur lors du chargement de la facture avoir fournisseur"
                });
                return;
            }

            // Combine existing avoirs with new ones
            var existingAvoirIds = fullFactureAvoir.Value.AvoirFournisseurs.Select(a => a.Num).ToList();
            var allAvoirIds = existingAvoirIds.Union(avoirIds).ToList();

            var updateRequest = new UpdateFactureAvoirFournisseurRequest
            {
                Date = fullFactureAvoir.Value.Date,
                IdFournisseur = fullFactureAvoir.Value.IdFournisseur,
                NumFactureFournisseur = fullFactureAvoir.Value.NumFactureFournisseur,
                AvoirFournisseurIds = allAvoirIds
            };

            var result = await factureAvoirFournisseurService.UpdateFactureAvoirFournisseurAsync(SelectedFactureAvoirId, updateRequest, _cancellationTokenSource.Token);

            if (result.IsSuccess)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = Localizer["success"],
                    Detail = "Avoirs fournisseur attachés avec succès"
                });

                // Reload data
                _selectedAvoirsToAttach = new List<AvoirFournisseurBaseInfo>();
                await LoadAvoirsForFactureAvoirAsync(SelectedFactureAvoirId);
                await LoadUninvoicedAvoirs(new LoadDataArgs { Skip = 0, Top = _defaultPageSize });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = $"Erreur lors de l'attachement: {result.Errors.First().Message}"
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Erreur lors de l'attachement: {ex.Message}"
            });
        }
    }

    private async Task CreateFactureAvoirWithSelectedAvoirs()
    {
        if (!_selectedAvoirsToAttach.Any())
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = "Veuillez sélectionner au moins un avoir fournisseur"
            });
            return;
        }

        if (SelectedProviderId <= 0)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = "Veuillez sélectionner un fournisseur"
            });
            return;
        }

        // Open dialog to create facture avoir
        var result = await DialogService.OpenAsync<AddOrUpdateFactureAvoirFournisseurDialog>(
            "Créer une facture avoir fournisseur",
            new Dictionary<string, object>
            {
                { "InitialFournisseurId", SelectedProviderId }
            },
            new DialogOptions
            {
                Width = "800px",
                Height = "400px",
                Resizable = true,
                Draggable = true
            });

        if (result == true)
        {
            // Reload data after successful creation
            await LoadFactureAvoir(new LoadDataArgs { Skip = 0, Top = _defaultPageSize });
            await LoadUninvoicedAvoirs(new LoadDataArgs { Skip = 0, Top = _defaultPageSize });
            _selectedAvoirsToAttach = new List<AvoirFournisseurBaseInfo>();
        }
    }

    private async Task DetachAvoirsFromFactureAvoir(int factureAvoirNum)
    {
        if (!_selectedAvoirsToDetach.Any())
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = "Veuillez sélectionner au moins un avoir fournisseur à détacher"
            });
            return;
        }

        try
        {
            // Get the current facture avoir to update
            var fullFactureAvoir = await factureAvoirFournisseurService.GetFullFactureAvoirFournisseurAsync(factureAvoirNum, _cancellationTokenSource.Token);
            if (!fullFactureAvoir.IsSuccess || fullFactureAvoir.Value == null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = "Erreur lors du chargement de la facture avoir fournisseur"
                });
                return;
            }

            // Remove selected avoirs from the list
            var avoirIdsToDetach = _selectedAvoirsToDetach.Select(a => a.Num).ToList();
            var remainingAvoirIds = fullFactureAvoir.Value.AvoirFournisseurs
                .Where(a => !avoirIdsToDetach.Contains(a.Num))
                .Select(a => a.Num)
                .ToList();

            var updateRequest = new UpdateFactureAvoirFournisseurRequest
            {
                Date = fullFactureAvoir.Value.Date,
                IdFournisseur = fullFactureAvoir.Value.IdFournisseur,
                NumFactureFournisseur = fullFactureAvoir.Value.NumFactureFournisseur,
                AvoirFournisseurIds = remainingAvoirIds
            };

            var result = await factureAvoirFournisseurService.UpdateFactureAvoirFournisseurAsync(factureAvoirNum, updateRequest, _cancellationTokenSource.Token);

            if (result.IsSuccess)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = Localizer["success"],
                    Detail = "Avoirs fournisseur détachés avec succès"
                });

                // Reload data
                _selectedAvoirsToDetach = new List<AvoirFournisseurBaseInfo>();
                await LoadAvoirsForFactureAvoirAsync(factureAvoirNum);
                await LoadUninvoicedAvoirs(new LoadDataArgs { Skip = 0, Top = _defaultPageSize });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = $"Erreur lors du détachement: {result.Errors.First().Message}"
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Erreur lors du détachement: {ex.Message}"
            });
        }
    }

    void RowRender(RowRenderEventArgs<FactureAvoirFournisseurWithAvoirs> args)
    {
        // Make row expandable
        args.Expandable = true;
    }
    #endregion
}
