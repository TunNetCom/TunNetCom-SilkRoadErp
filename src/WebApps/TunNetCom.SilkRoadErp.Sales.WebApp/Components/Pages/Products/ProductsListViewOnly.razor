@page "/products_list_view"
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Products
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.Contracts.Products
@using Radzen
@using Radzen.Blazor
@inject IProductsApiClient ProductService
@inject IStringLocalizer<SharedResource> Localizer
@inject ToastService ToastService

<div class="products-container">
    <div class="products-card">
        <div class="products-header">
            <h3 class="products-title">@Localizer["products"]</h3>
        </div>

        <RadzenTextBox Placeholder="@Localizer["Search"]"
                       @bind-Value="searchKeyword"
                       Change="@(async (string value) => await productGrid.Reload())"
                       Class="products-search" />

        <RadzenDataGrid @ref="productGrid"
                        TItem="ProductResponse"
                        Data="@products"
                        Count="@totalProducts"
                        LoadData="@LoadProductData"
                        AllowFiltering="true"
                        AllowPaging="true"
                        AllowSorting="true"
                        FilterPopupRenderMode="PopupRenderMode.OnDemand"
                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                        PageSize="@defaultPageSize"
                        Density="Density.Compact"
                        Class="products-grid"
                        IsLoading="@isLoadingProducts"
                        ShowPagingSummary="true"
                        Responsive="true"
                        RowRender="OnRowRender">
            <EmptyTemplate>
                <p style="color: lightgrey; font-size: 24px; text-align: center; margin: 2rem;">@Localizer["no_records"]</p>
            </EmptyTemplate>
            <Columns>
                <RadzenDataGridColumn TItem="ProductResponse" Property="@nameof(ProductResponse.Reference)" Title="@Localizer["product_refe"]" Width="200px">
                    <Template Context="product">
                        <span class="grid-cell">@product.Reference</span>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProductResponse" Property="@nameof(ProductResponse.Name)" Title="@Localizer["product_name"]" Width="200px">
                    <Template Context="product">
                        <span class="grid-cell">@product.Name</span>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProductResponse" Property="@nameof(ProductResponse.StockCalcule)" Title="@Localizer["stock_calcule"]" Width="200px">
                    <Template Context="product">
                        @if (product.StockCalcule.HasValue)
                        {
                            var stockValue = product.StockCalcule.Value;
                            var badgeClass = stockValue > product.QteLimit ? "stock-badge-green" : 
                                           stockValue > 0 ? "stock-badge-orange" : "stock-badge-red";
                            <RadzenBadge BadgeStyle="BadgeStyle.Info" Variant="Variant.Flat" Size="BadgeSize.Medium" Class="@badgeClass">
                                @stockValue
                            </RadzenBadge>
                        }
                        else
                        {
                            <span class="grid-cell">-</span>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProductResponse" Filterable="false" Sortable="false" Width="200px" TextAlign="TextAlign.Center">
                    <Template Context="product">
                        @if (product.StockCalcule.HasValue && product.StockCalcule.Value < product.QteLimit)
                        {
                            <RadzenButton Icon="highlight_off" IconColor="@Colors.Warning" ButtonStyle="ButtonStyle.Warning" Variant="Variant.Outlined" Size="ButtonSize.Medium" Shade="Shade.Lighter" Class="rz-my-1 rz-ms-1"
                                          Title="@Localizer["manquant!"]" />
                        }
						else
						{
							<RadzenButton Icon="done" IconColor="@Colors.Success" ButtonStyle="ButtonStyle.Success" Variant="Variant.Outlined" Size="ButtonSize.Medium" Shade="Shade.Lighter" Class="rz-my-1 rz-ms-1"
							              Title="@Localizer["disponible"]" />
						}
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </div>
</div>

<style>
    :root {
        --primary-color: #1a73e8;
        --warning-color: #ff9800;
        --success-light: rgba(76, 175, 80, 0.1);
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --card-bg: #ffffff;
        --grid-header-bg: #f5f7fa;
        --grid-header-color: #202124;
        --grid-row-hover: #f1f3f5;
        --border-radius: 8px;
        --border-color: #e0e0e0;
        --text-color: #202124;
    }

    .products-container {
        padding: 1.25rem;
        max-width: 1280px;
        margin: 1rem auto;
    }

    .products-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        padding: 1.5rem;
        border: none;
    }

    .products-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }

    .products-title {
        color: var(--text-color);
        font-weight: 600;
        margin: 0;
        font-size: 2rem;
        line-height: 1.2;
    }

    .products-search {
        width: 100%;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
        padding: 0.75rem 1rem;
        margin-bottom: 1.25rem;
        font-size: 0.95rem;
        color: var(--text-color);
        background: #fafafa;
    }

        .products-search:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
            outline: none;
            background: #ffffff;
        }

    .products-grid {
        border-radius: var(--border-radius);
        overflow: hidden;
        background: var(--card-bg);
        border: none;
    }

        .products-grid .rz-datatable thead {
            background: var(--grid-header-bg);
            color: var(--grid-header-color);
            border-bottom: 1px solid var(--border-color);
        }

            .products-grid .rz-datatable thead th {
                font-weight: 500;
                padding: 0.75rem 1rem;
                text-align: left;
                font-size: 0.9rem;
                text-transform: uppercase;
                letter-spacing: 0.02em;
            }

        .products-grid .rz-datatable tbody tr {
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem 0; /* Added padding to increase row spacing */
        }

            .products-grid .rz-datatable tbody tr:last-child {
                border-bottom: none;
            }

            .products-grid .rz-datatable tbody tr:hover {
                background: var(--grid-row-hover);
            }

        .products-grid .rz-datatable tbody td {
            padding: 0.75rem 1rem; /* Ensure cell padding is consistent */
            vertical-align: middle; /* Center content vertically */
        }

    .grid-cell {
        display: inline-block;
        font-size: 0.95rem;
        color: var(--text-color);
        line-height: 1.5;
    }

    .low-quantity {
        color: var(--warning-color);
        font-weight: bold;
        background-color: rgba(255, 152, 0, 0.1);
        border-radius: 4px;
        padding: 0.25rem 0.5rem; /* Adjusted padding for cell content */
        line-height: 1.5;
    }

    .stock-badge-green {
        background-color: #4CAF50 !important;
        color: white !important;
    }

    .stock-badge-orange {
        background-color: #ff9800 !important;
        color: white !important;
    }

    .stock-badge-red {
        background-color: #d32f2f !important;
        color: white !important;
    }

    .rz-datatable-tbody > tr[style*="background-color: var(--rz-success)"] {
        background-color: var(--success-light) !important;
    }

        .rz-datatable-tbody > tr[style*="background-color: var(--rz-success)"]:hover {
            background-color: rgba(76, 175, 80, 0.2) !important;
        }

    .products-grid .rz-grid-table {
        border-collapse: collapse;
    }
</style>

@code {
    private RadzenDataGrid<ProductResponse> productGrid;
    private IEnumerable<ProductResponse> products = new List<ProductResponse>();
    private int totalProducts;
    private bool isLoadingProducts;
    private string searchKeyword = string.Empty;
    private CancellationTokenSource cancellationTokenSource = new();
    private int defaultPageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadProductData(new LoadDataArgs());
    }

    private async Task LoadProductData(LoadDataArgs args)
    {
        try
        {
            isLoadingProducts = true;
            var filter = args.Filter?.ToString();
            var sort = args.OrderBy?.ToString();
            string sortProperty = null;
            string sortOrder = null;
            if (!string.IsNullOrEmpty(sort))
            {
                var sortParts = sort.Split(' ');
                sortProperty = sortParts[0];
                sortOrder = sortParts.Length > 1 && sortParts[1].ToLower() == "desc" ? "DESC" : "ASC";
            }

            var productsParameters = new QueryStringParameters
                {
                    PageNumber = (args.Skip ?? 0) / defaultPageSize + 1,
                    PageSize = defaultPageSize,
                    SearchKeyword = searchKeyword,
                    SortProprety = sortProperty,
                    SortOrder = sortOrder
                };

            var result = await ProductService.GetPagedAsync(productsParameters, cancellationTokenSource.Token);
            products = result.Items;
            totalProducts = result.TotalCount;
        }
        catch (Exception)
        {
            ToastService.Notify(new(ToastType.Danger, Localizer["loading_error"]));
        }
        finally
        {
            isLoadingProducts = false;
        }
    }

    void OnRowRender(RowRenderEventArgs<ProductResponse> args)
    {
        if (args.Data.StockCalcule.HasValue && args.Data.StockCalcule.Value < args.Data.QteLimit)
        {
            args.Attributes.Add("style", "font-weight:bold; background-color:#28a745");
        }
    }

    public void Dispose()
    {
        cancellationTokenSource?.Cancel();
        cancellationTokenSource?.Dispose();
    }
}