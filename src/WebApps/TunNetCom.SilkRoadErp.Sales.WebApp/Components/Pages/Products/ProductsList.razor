@page "/products_list"
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.HttpClients
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Products
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ProductSubFamilies
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ProductFamilies
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.Contracts.Products
@using TunNetCom.SilkRoadErp.Sales.Contracts.ProductFamilies
@using Radzen
@using Radzen.Blazor
@using BlazorBootstrap
@inject IProductsApiClient productService
@inject IProductSubFamiliesApiClient productSubFamiliesService
@inject IProductFamiliesApiClient productFamiliesService
@inject NavigationManager navigationManager
@inject IStringLocalizer<SharedResource> Localizer
@inject DialogService DialogService
@inject ToastService toastService

<div class="products-container">
    <div class="products-card">
        <div class="products-header">
            <h3 class="products-title">@Localizer["products"]</h3>
            <div style="display: flex; gap: 0.5rem;">
                @if (selectedProducts.Any())
                {
                    <RadzenButton Icon="category" Text="Affecter sous-famille"
                                  ButtonStyle="ButtonStyle.Info"
                                  Click="@ShowAssignSubFamilyDialog"
                                  Class="btn-info" />
                }
                <RadzenButton Icon="add" Text="@Localizer["add_product"]"
                              ButtonStyle="ButtonStyle.Primary"
                              Click="@CreateProduct"
                              Class="btn-primary" />
            </div>
        </div>

        <RadzenTextBox Placeholder="@Localizer["Search"]"
                       @bind-Value="searchKeyword"
                       Change="@(async (string value) => await productGrid.Reload())"
                       Class="products-search" />

        <RadzenCard Style="margin-bottom: 1.25rem; padding: 1.25rem;">
            <RadzenStack Gap="1.25rem">
                <h4 style="margin: 0; font-size: 1.1rem; font-weight: 600;">Filtres</h4>
                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenFormField Text="Famille" Style="margin-bottom: 0;">
                            <RadzenDropDown Value="@selectedFamilleId" 
                                          ValueChanged="@OnFamilleFilterChangedCallback"
                                          Data="@families" 
                                          TextProperty="Nom" 
                                          ValueProperty="Id" 
                                          Placeholder="Toutes les familles" 
                                          AllowClear="true" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenFormField Text="Sous-famille" Style="margin-bottom: 0;">
                            <RadzenDropDown Value="@selectedSousFamilleId" 
                                          ValueChanged="@OnSousFamilleFilterChangedCallback"
                                          Data="@filteredSubFamilies" 
                                          TextProperty="Nom" 
                                          ValueProperty="Id" 
                                          Placeholder="Toutes les sous-familles" 
                                          AllowClear="true" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="2">
                        <RadzenFormField Text="Visibilité" Style="margin-bottom: 0;">
                            <RadzenDropDown Value="@selectedVisibility" 
                                          ValueChanged="@OnVisibilityFilterChangedCallback"
                                          Data="@visibilityOptions" 
                                          TextProperty="Text" 
                                          ValueProperty="Value" 
                                          Placeholder="Tous" 
                                          AllowClear="true" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="2">
                        <RadzenFormField Text="Stock faible uniquement" Style="margin-bottom: 0;">
                            <RadzenCheckBox Value="@stockLowOnly" ValueChanged="@OnStockLowOnlyChangedCallback" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="2" Style="display: flex; align-items: flex-end; padding-bottom: 0;">
                        <RadzenButton Text="Réinitialiser" 
                                    ButtonStyle="ButtonStyle.Secondary" 
                                    Variant="Variant.Outlined"
                                    Click="@ResetFilters" 
                                    Icon="refresh"
                                    Style="width: 100%; margin-top: 0;" />
                    </RadzenColumn>
                </RadzenRow>
                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenFormField Text="Stock calculé (min)" Style="margin-bottom: 0;">
                            <RadzenNumeric Value="@stockCalculeMin" 
                                         ValueChanged="@OnStockCalculeMinChangedCallback"
                                         Placeholder="Min" 
                                         Min="0" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenFormField Text="Stock calculé (max)" Style="margin-bottom: 0;">
                            <RadzenNumeric Value="@stockCalculeMax" 
                                         ValueChanged="@OnStockCalculeMaxChangedCallback"
                                         Placeholder="Max" 
                                         Min="0" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <!-- Espace vide pour l'alignement -->
                    </RadzenColumn>
                </RadzenRow>
            </RadzenStack>
        </RadzenCard>

        <RadzenDataGrid @ref="productGrid"
                        TItem="ProductResponse"
                        Data="@products"
                        Count="@totalProducts"
                        LoadData="@LoadProductData"
                        AllowFiltering="true"
                        AllowPaging="true"
                        AllowSorting="true"
                        FilterPopupRenderMode="PopupRenderMode.OnDemand"
                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                        PageSize="@defaultPageSize"
                        Density="Density.Compact"
                        Class="products-grid"
                        IsLoading="@isLoadingProducts"
                        ShowPagingSummary="true"
                        Responsive="true"
                        RowRender="OnRowRender">
            <EmptyTemplate>
                <p style="font-size: 24px; text-align: center; margin: 2rem;">No records to display.</p>
            </EmptyTemplate>
            <Columns>
                <RadzenDataGridColumn TItem="ProductResponse" Filterable="false" Sortable="false" Width="50px" TextAlign="TextAlign.Center">
                    <Template Context="product">
                        <RadzenCheckBox Value="@GetSelectedState(product)" ValueChanged="@((bool value) => OnProductSelectionChanged(product, value))" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProductResponse" Property="@nameof(ProductResponse.Reference)" Title="@Localizer["product_refe"]" Width="200px">
                    <Template Context="product">
                        <span class="grid-cell">@product.Reference</span>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProductResponse" Property="@nameof(ProductResponse.Name)" Title="@Localizer["product_name"]" Width="200px">
                    <Template Context="product">
                        <span class="grid-cell">@product.Name</span>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProductResponse" Property="@nameof(ProductResponse.SousFamilleProduitNom)" Title="Sous-famille" Width="150px">
                    <Template Context="product">
                        <span class="grid-cell">@(product.SousFamilleProduitNom ?? "-")</span>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProductResponse" Property="@nameof(ProductResponse.StockCalcule)" Title="@Localizer["stock_calcule"]" Width="150px">
                    <Template Context="product">
                        @if (product.StockCalcule.HasValue)
                        {
                            var stockValue = product.StockCalcule.Value;
                            var badgeClass = stockValue > product.QteLimit ? "stock-badge-green" : 
                                           stockValue > 0 ? "stock-badge-orange" : "stock-badge-red";
                            <RadzenBadge BadgeStyle="BadgeStyle.Info" Variant="Variant.Flat" Size="BadgeSize.Medium" Class="@badgeClass">
                                @stockValue
                            </RadzenBadge>
                        }
                        else
                        {
                            <span class="grid-cell">-</span>
                        }
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="ProductResponse" Filterable="false" Sortable="false" Width="200px" TextAlign="TextAlign.Center">
                    <Template Context="product">
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Success" Variant="Variant.Outlined" Size="ButtonSize.Medium" Shade="Shade.Lighter" Class="rz-my-1 rz-ms-1"
                                      Click="@(() => EditProduct(product.Reference))"
                                      Title="@Localizer["edit_button_label"]" />
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Outlined" Size="ButtonSize.Medium" Shade="Shade.Lighter"
                                      Click="@(() => ConfirmDeleteProduct(product.Reference))"
                                      Title="@Localizer["delete_button_label"]" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </div>
</div>



<style>
    :root {
        --primary-color: #1a73e8;
        --primary-hover: #135ab6;
        --danger-color: #d32f2f;
        --danger-hover: #b71c1c;
        --warning-color: #ff9800;
        --warning-hover: #f57c00;
        --success-color: #4CAF50;
        --success-light: rgba(76, 175, 80, 0.1);
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --card-bg: #ffffff;
        --grid-header-bg: #f5f7fa;
        --grid-header-color: #202124;
        --grid-row-hover: #f1f3f5;
        --border-radius: 8px;
        --border-color: #e0e0e0;
        --text-color: #202124;
        --muted-text: #5f6368;

    }
    .products-container {
        padding: 1.25rem;
        max-width: 1280px;
        margin: 1rem auto;
    }

    .products-card {
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        padding: 1.5rem;
        border: none;
    }

    .products-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }

    .products-title {
        font-weight: 600;
        margin: 0;
        font-size: 2rem;
        line-height: 1.2;
    }

    .products-search {
        width: 100%;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
        padding: 0.75rem 1rem;
        margin-bottom: 1.25rem;
        font-size: 0.95rem;
    }

        .products-search:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
            outline: none;
        }

    .products-grid {
        border-radius: var(--border-radius);
        overflow: hidden;
        border: none;
    }

        .products-grid .rz-datatable thead {
            background: var(--grid-header-bg);
            border-bottom: 1px solid var(--border-color);
        }

            .products-grid .rz-datatable thead th {
                font-weight: 500;
                padding: 0.75rem 1rem;
                text-align: left;
                font-size: 0.9rem;
                text-transform: uppercase;
                letter-spacing: 0.02em;
            }

        .products-grid .rz-datatable tbody tr {
            border-bottom: 1px solid var(--border-color);
        }

            .products-grid .rz-datatable tbody tr:last-child {
                border-bottom: none;
            }

            .products-grid .rz-datatable tbody tr:hover {
                background: var(--grid-row-hover);
            }

    .grid-cell {
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    /* Custom row styling for low quantity */
    .rz-datatable-tbody > tr[style*="background-color: var(--rz-success)"] {
    }

        .rz-datatable-tbody > tr[style*="background-color: var(--rz-success)"]:hover {
            background-color: rgba(76, 175, 80, 0.2) !important;
        }

    .low-quantity {
        color: var(--warning-color);
        font-weight: bold;
        background-color: rgba(255, 152, 0, 0.1);
        border-radius: 4px;
        padding: 0.75rem 1rem;
        line-height: 1.5;
    }

    .stock-badge-green {
        background-color: #4CAF50 !important;
        color: white !important;
    }

    .stock-badge-orange {
        background-color: #ff9800 !important;
        color: white !important;
    }

    .stock-badge-red {
        background-color: #d32f2f !important;
        color: white !important;
    }

    .stock-difference {
        margin-left: 0.5rem;
        font-size: 0.85rem;
        color: var(--muted-text);
    }

    .products-grid .rz-grid-table {
        border-collapse: collapse;
    }
</style>
@code {
    private RadzenDataGrid<ProductResponse> productGrid;
    private IEnumerable<ProductResponse> products = new List<ProductResponse>();
    private int totalProducts;
    private bool isLoadingProducts;
    private string searchKeyword = string.Empty;
    private string currentProductRefeToDelete;
    private CancellationTokenSource cancellationTokenSource = new();
    private int defaultPageSize = 10;
    private HashSet<string> selectedProducts = new();
    private List<SousFamilleProduitResponse> subFamilies = new();
    private List<FamilleProduitResponse> families = new();
    private int? selectedFamilleId;
    private int? selectedSousFamilleId;
    private bool? selectedVisibility;
    private bool stockLowOnly = false;
    private int? stockCalculeMin;
    private int? stockCalculeMax;

    private List<SousFamilleProduitResponse> filteredSubFamilies => 
        selectedFamilleId.HasValue 
            ? subFamilies.Where(sf => sf.FamilleProduitId == selectedFamilleId.Value).ToList()
            : subFamilies;

    private List<VisibilityOption> visibilityOptions = new()
    {
        new VisibilityOption { Text = "Visible", Value = true },
        new VisibilityOption { Text = "Non visible", Value = false }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadFamilies();
        await LoadSubFamilies();
        await LoadProductData(new LoadDataArgs());
    }

    private async Task LoadFamilies()
    {
        try
        {
            families = await productFamiliesService.GetAllAsync();
        }
        catch (Exception)
        {
            // Ignorer l'erreur
        }
    }

    private async Task LoadSubFamilies()
    {
        try
        {
            subFamilies = await productSubFamiliesService.GetAllAsync(selectedFamilleId);
        }
        catch (Exception)
        {
            // Ignorer l'erreur
        }
    }

    private EventCallback<int?> OnFamilleFilterChangedCallback => EventCallback.Factory.Create<int?>(this, async (int? value) =>
    {
        selectedFamilleId = value;
        selectedSousFamilleId = null; // Réinitialiser la sous-famille quand la famille change
        await LoadSubFamilies();
        await productGrid.Reload();
    });

    private EventCallback<int?> OnSousFamilleFilterChangedCallback => EventCallback.Factory.Create<int?>(this, async (int? value) =>
    {
        selectedSousFamilleId = value;
        await productGrid.Reload();
    });

    private EventCallback<bool?> OnVisibilityFilterChangedCallback => EventCallback.Factory.Create<bool?>(this, async (bool? value) =>
    {
        selectedVisibility = value;
        await productGrid.Reload();
    });

    private EventCallback<bool> OnStockLowOnlyChangedCallback => EventCallback.Factory.Create<bool>(this, async (bool value) =>
    {
        stockLowOnly = value;
        await productGrid.Reload();
    });

    private EventCallback<int?> OnStockCalculeMinChangedCallback => EventCallback.Factory.Create<int?>(this, async (int? value) =>
    {
        stockCalculeMin = value;
        await productGrid.Reload();
    });

    private EventCallback<int?> OnStockCalculeMaxChangedCallback => EventCallback.Factory.Create<int?>(this, async (int? value) =>
    {
        stockCalculeMax = value;
        await productGrid.Reload();
    });

    private async Task ResetFilters()
    {
        selectedFamilleId = null;
        selectedSousFamilleId = null;
        selectedVisibility = null;
        stockLowOnly = false;
        stockCalculeMin = null;
        stockCalculeMax = null;
        await LoadSubFamilies();
        await productGrid.Reload();
    }

    private bool GetSelectedState(ProductResponse product)
    {
        return selectedProducts.Contains(product.Reference);
    }

    private void OnProductSelectionChanged(ProductResponse product, bool isSelected)
    {
        if (isSelected)
        {
            selectedProducts.Add(product.Reference);
        }
        else
        {
            selectedProducts.Remove(product.Reference);
        }
        StateHasChanged();
    }

    private async Task ShowAssignSubFamilyDialog()
    {
        var result = await DialogService.OpenAsync<AssignSubFamilyDialog>("Affecter une sous-famille",
            new Dictionary<string, object> 
            { 
                { "SubFamilies", subFamilies },
                { "ProductCount", selectedProducts.Count }
            },
            new DialogOptions() 
            { 
                Width = "500px", 
                Height = "300px",
                Resizable = true, 
                Draggable = true 
            });

        if (result != null && result is int)
        {
            await AssignSubFamilyToSelectedProducts((int)result);
        }
    }

    private async Task AssignSubFamilyToSelectedProducts(int subFamilyId)
    {
        try
        {
            isLoadingProducts = true;
            StateHasChanged();

            var productRefs = selectedProducts.ToList();
            int successCount = 0;
            int errorCount = 0;

            foreach (var productRef in productRefs)
            {
                try
                {
                    // Récupérer le produit actuel
                    var productResult = await productService.GetAsync(productRef, cancellationTokenSource.Token);
                    if (productResult.IsT0)
                    {
                        var product = productResult.AsT0;
                        var updateRequest = new UpdateProductRequest
                        {
                            Refe = product.Reference,
                            Nom = product.Name,
                            QteLimite = product.QteLimit,
                            Remise = product.DiscountPourcentage,
                            RemiseAchat = product.DiscountPourcentageOfPurchasing,
                            Tva = product.VatRate,
                            Prix = product.Price,
                            PrixAchat = product.PurchasingPrice,
                            Visibilite = product.Visibility,
                            SousFamilleProduitId = subFamilyId
                        };

                        var updateResult = await productService.UpdateAsync(updateRequest, productRef, cancellationTokenSource.Token);
                        if (updateResult.IsT0)
                        {
                            successCount++;
                        }
                        else
                        {
                            errorCount++;
                        }
                    }
                    else
                    {
                        errorCount++;
                    }
                }
                catch (Exception)
                {
                    errorCount++;
                }
            }

            selectedProducts.Clear();
            await productGrid.Reload();

            if (successCount > 0)
            {
                toastService.Notify(new(ToastType.Success, $"{successCount} produit(s) mis à jour avec succès"));
            }
            if (errorCount > 0)
            {
                toastService.Notify(new(ToastType.Danger, $"{errorCount} erreur(s) lors de la mise à jour"));
            }
        }
        catch (Exception ex)
        {
            toastService.Notify(new(ToastType.Danger, $"Erreur: {ex.Message}"));
        }
        finally
        {
            isLoadingProducts = false;
            StateHasChanged();
        }
    }
    private async Task LoadProductData(LoadDataArgs args)
    {
        isLoadingProducts = true;
        var filter = args.Filter?.ToString();
        var sort = args.OrderBy?.ToString();
        // Parse sort string (e.g., "Number desc" or "Date")
        string sortProperty = null;
        string sortOrder = null;
        if (!string.IsNullOrEmpty(sort))
        {
	        var sortParts = sort.Split(' ');
	        sortProperty = sortParts[0];
	        sortOrder = sortParts.Length > 1 && sortParts[1].ToLower() == "desc" ? "DESC" : "ASC";
        }

        var productsParameters = new QueryStringParameters
            {
                PageNumber = (args.Skip ?? 0) / defaultPageSize + 1,
                PageSize = defaultPageSize,
                SearchKeyword = searchKeyword,
                SortProprety = sortProperty,
                SortOrder = sortOrder,
                FamilleProduitId = selectedFamilleId,
                SousFamilleProduitId = selectedSousFamilleId,
                Visibility = selectedVisibility,
                StockLowOnly = stockLowOnly ? true : null,
                StockCalculeMin = stockCalculeMin,
                StockCalculeMax = stockCalculeMax
            };

        var result = await productService.GetPagedAsync(productsParameters, cancellationTokenSource.Token);
        products = result.Items;
        totalProducts = result.TotalCount;

        isLoadingProducts = false;
    }

    private void CreateProduct()
    {
        navigationManager.NavigateTo("/editproduct");
    }

    private void EditProduct(string reference)
    {
        navigationManager.NavigateTo($"/editproduct/{reference}");
    }

    private async Task ConfirmDeleteProduct(string reference)
    {
	    bool? confirmed = await DialogService.Confirm(Localizer["delete_customer_confirmation"],
		    Localizer["delete_confirmation"],
		    new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" });

	    if (confirmed == true)
	    {
		    await productService.DeleteAsync(reference, cancellationTokenSource.Token);
		    toastService.Notify(new(ToastType.Warning, $"{Localizer["product"]} {Localizer["deleted_with_success"]}"));
		    await productGrid.Reload();
	    }

    }

    void OnRowRender(RowRenderEventArgs<ProductResponse> args)
    {
	    if (args.Data.StockCalcule.HasValue && args.Data.StockCalcule.Value < args.Data.QteLimit)
	    {
            args.Attributes.Add("style", "font-weight:bold; background-color:#28a745");

	    }
    }

    public void Dispose()
	    {
	        cancellationTokenSource.Cancel();
	        cancellationTokenSource.Dispose();
	    }

    private class VisibilityOption
    {
        public string Text { get; set; } = string.Empty;
        public bool? Value { get; set; }
    }
}