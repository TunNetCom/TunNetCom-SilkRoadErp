@page "/manage-providers-invoices"
@using Microsoft.Extensions.Localization
@using Radzen.Blazor
@using Radzen
@using BlazorBootstrap
@using System.Globalization
@using TunNetCom.SilkRoadErp.Sales.Contracts.Customers
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote.Requests
@using TunNetCom.SilkRoadErp.Sales.Contracts.DeliveryNote.Responses
@using TunNetCom.SilkRoadErp.Sales.Contracts.RecieptNotes
@using TunNetCom.SilkRoadErp.Sales.Contracts.Invoice
@using TunNetCom.SilkRoadErp.Sales.Contracts.ProviderInvoice
@using TunNetCom.SilkRoadErp.Sales.Contracts.Sorting
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Customers
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.DeliveryNote
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Providers
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Invoices
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ReceiptNote
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ProviderInvoice
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Reports.Invoices.PrintInvoiceWithDetails
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Reports.Invoices.ProviderInvoices
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Reports.Invoices.RetenueSource
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Reports.Invoices.RetenueSourceFournisseur
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.RetenueSourceFournisseur
@using TunNetCom.SilkRoadErp.Sales.Contracts.RetenueSourceFournisseur
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AppParameters
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.FactureAvoirFournisseur
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AvoirFinancierFournisseurs
@using TunNetCom.SilkRoadErp.Sales.HttpClients
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Pages.Providers

@inject IReceiptNoteApiClient receiptNoteService
@inject IRetenueSourceFournisseurApiClient retenueSourceFournisseurApiClient
@inject IAppParametersClient appParametersClient
@inject IProvidersApiClient providersService
@inject ICustomersApiClient customerService
@inject IInvoicesApiClient invoicesService
@inject IDeliveryNoteApiClient deliveryNoteService
@inject IProviderInvoiceApiClient providerInvoiceService
@inject IFactureAvoirFournisseurApiClient factureAvoirFournisseurService
@inject IAvoirFinancierFournisseursApiClient avoirFinancierFournisseursService
@inject NavigationManager navigationManager
@inject IStringLocalizer<SharedResource> Localizer
@inject ToastService toastService
@inject Radzen.NotificationService NotificationService
@inject PrintRetenuSourceService PrintRetenuSourceService
@inject PrintProviderFullInvoiceService PrintProviderFullInvoiceService
@inject RetenuSourceFournisseurPrintService RetenuSourceFournisseurPrintService
@inject PrintFullInvoiceService PrintFullInvoiceService
@inject DialogService DialogService
@inject IJSRuntime JS
@inject HttpClient HttpClient
@inject IConfiguration Configuration
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Pages.DeliveryNotes

<div style="padding: 0.5rem 1.5rem 1.5rem 1.5rem; min-height: 100vh;">
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
        <label style="font-weight: 600;
                      font-size: 0.9rem;
                      white-space: nowrap;
                      margin: 0;">
            @Localizer["select_provider"]
        </label>
        <RadzenDropDownDataGrid AllowClear="true"
                                IsLoading="@isLoadingProviders"
                                @bind-Value="@SelectedProviderId"
                                LoadData="@LoadProviders"
                                AllowFiltering="true"
                                Style="flex: 1;
                                       max-width: 500px;
                                       border-radius: 8px;
                                       border: 1px solid #e0e0e0;
                                       transition: all 0.2s ease;"
                                Data="@_providersList"
                                TextProperty="@nameof(ProviderResponse.Nom)"
                                ValueProperty="@nameof(ProviderResponse.Id)"
                                Placeholder="@Localizer["select_provider"]"
                                Class="custom-dropdown">
            <Columns>
                <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Id)"
                                              Title="ID"
                                              Width="100px" />
                <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Nom)"
                                              Title="Name"
                                              Width="300px" />
            </Columns>
        </RadzenDropDownDataGrid>
        <!-- Print Buttons -->
        <div style="display: flex; gap: 0.75rem; margin-left: auto;">
            <RadzenButton ButtonStyle="ButtonStyle.Light"
                          Size="ButtonSize.Small"
                          Style="padding: 0.25rem 0.75rem; border-radius: 4px;"
                          Click="@PrintRetenuSourceClick"
                          Disabled="@(SelectedInvoiceId <= _minValueId)">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <RadzenIcon Icon="description" Style="font-size: 14px;" />
                    <span style="font-size: 0.85rem;">Retenu</span>
                </div>
            </RadzenButton>
            <RadzenButton ButtonStyle="ButtonStyle.Light"
                          Size="ButtonSize.Small"
                          Style="padding: 0.25rem 0.75rem; border-radius: 4px;"
                          Click="@PrintInvoiceClick"
                          Disabled="@(SelectedInvoiceId <= _minValueId)">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <RadzenIcon Icon="get_app" Style="font-size: 14px;" />
                    <span style="font-size: 0.85rem;">Facture</span>
                </div>
            </RadzenButton>
            @{
                var selectedInvoice = SelectedInvoices?.FirstOrDefault();
                var canExportTej = selectedInvoice != null && selectedInvoice.Invoice.TotTTC >= _seuilRetenueSource;
            }
            <RadzenButton ButtonStyle="ButtonStyle.Light"
                          Size="ButtonSize.Small"
                          Style="padding: 0.25rem 0.75rem; border-radius: 4px;"
                          Click="@ExportToTejXmlClick"
                          Disabled="@(!canExportTej)">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <RadzenIcon Icon="code" Style="font-size: 14px;" />
                    <span style="font-size: 0.85rem;">XML TEJ</span>
                </div>
            </RadzenButton>
        </div>
    </div>

    <!-- Main Content -->
    <RadzenRow Gap="2rem">
         <!-- Invoices Section with Master-Detail -->
        <RadzenColumn Size="12">
            <RadzenCard Variant="Variant.Flat"
                        Style="padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <RadzenDataGrid @ref="ProviderInvoiceGrid"
                                AllowFiltering="true"
                                AllowPaging="true"
                                PageSize="_defaultPageSize"
                                PagerHorizontalAlign="HorizontalAlign.Left"
                                ShowPagingSummary="true"
                                AllowSorting="true"
                                Count="@_invoicesList.Invoices.TotalCount"
                                Data="@_invoicesWithReceiptNotes"
                                LoadData="@LoadInvoices"
                                RowRender="@RowRender"
                                ExpandMode="@expandMode"
                                @bind-Value="@SelectedInvoices"
                                IsLoading="@isLoadingInvoices"
                                SelectionMode="DataGridSelectionMode.Single"
                                Style="border: none;"
                                Class="custom-grid">
                    <EmptyTemplate>
                        <p style="font-size: 24px; text-align: center; margin: 2rem;">No records to display.</p>
                    </EmptyTemplate>
                    <HeaderTemplate>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding-bottom: 0.75rem; gap: 1.5rem;">
                            <div style="font-size: 1.1rem; font-weight: 600;">
                                @Localizer["provider_invoice_details"]
                            </div>
                            <RadzenButton Icon="add_circle"
                                          Text="@Localizer["create_new_invoice"]"
                                          ButtonStyle="ButtonStyle.Success"
                                          Size="ButtonSize.Medium"
                                          Disabled="@(SelectedProviderId <= 0)"
                                          Click="@CreateNewProviderInvoice"
                                          Style="border-radius: 8px; padding: 0.5rem 1rem; font-weight: 600; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; margin-left: auto;" />
                        </div>
                    </HeaderTemplate>
                    <Template Context="invoiceWithBRs">
                        @{
                            // Load receipt notes when template is rendered for the first time
                            if (!invoiceWithBRs.ReceiptNotesLoaded && !invoiceWithBRs.ReceiptNotesLoading)
                            {
                                _ = LoadReceiptNotesForInvoiceAsync(invoiceWithBRs.Invoice.Num);
                            }
                        }
                        @if (invoiceWithBRs.ReceiptNotesLoading)
                        {
                            <div style="padding: 1rem; text-align: center; color: #666;">
                                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Medium" />
                                <p style="margin-top: 0.5rem;">@Localizer["loading"]...</p>
                            </div>
                        }
                        else
                        {
                            <RadzenDataGrid AllowFiltering="true" 
                                            AllowPaging="true" 
                                            AllowSorting="true" 
                                            Data="@(invoiceWithBRs.ReceiptNotes ?? new List<ReceiptNoteDetailsResponse>())"
                                            TItem="ReceiptNoteDetailsResponse"
                                            SelectionMode="DataGridSelectionMode.Multiple"
                                            @bind-Value="@_selectedReceiptNotesToDetach"
                                            Style="margin: 0.5rem 0; border: 1px solid #e0e0e0; border-radius: 4px;"
                                            Class="detail-grid">
                                <EmptyTemplate>
                                    <p style="font-size: 14px; text-align: center; margin: 1rem; color: #666;">@Localizer["no_receipt_notes_found"]</p>
                                </EmptyTemplate>
                                <HeaderTemplate>
                                    <div style="display: flex; align-items: center; justify-content: flex-end; margin-bottom: 0.75rem; gap: 1rem;">
                                        <RadzenButton 
                                            Text="@Localizer["detach_from_invoice"]"
                                            ButtonStyle="ButtonStyle.Danger"
                                            Size="ButtonSize.Small"
                                            Disabled="@(!_selectedReceiptNotesToDetach.Any())"
                                            Click="@DetachReceiptNotesFromInvoice"
                                            Style="border-radius: 6px; padding: 0.4rem 0.8rem; font-weight: 500; font-size: 0.85rem;" />
                                    </div>
                                </HeaderTemplate>
                                <Columns>
                                    <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailsResponse.Num)"
                                                          Title="@Localizer["number"]"
                                                          Width="140px" />
                                    <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailsResponse.TotHTva)"
                                                          Title="@Localizer["total_ex_tax"]"
                                                          Width="140px">
                                        <Template Context="br">
                                            @br.TotHTva.FormatAmount()
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailsResponse.TotTTC)"
                                                          Title="@Localizer["net_payer"]"
                                                          Width="140px">
                                        <Template Context="br">
                                            @br.TotTTC.FormatAmount()
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        }
                    </Template>
                    <Columns>
                        <RadzenDataGridColumn Property="@nameof(ProviderInvoiceResponse.Num)"
                                              Title="@Localizer["invoice_number"]"
                                              Width="140px">
                            <Template Context="invoiceWithBRs">
                                @invoiceWithBRs.Invoice.Num
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(ProviderInvoiceResponse.ProviderInvoiceNumber)"
                                              Title="@Localizer["provider_invoice_number"]"
                                              Width="220px">
                            <Template Context="invoiceWithBRs">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span>@invoiceWithBRs.Invoice.ProviderInvoiceNumber</span>
                                    <RadzenButton Icon="edit"
                                                  ButtonStyle="ButtonStyle.Light"
                                                  Variant="Variant.Flat"
                                                  Size="ButtonSize.ExtraSmall"
                                                  Click="@(() => EditProviderInvoiceNumber(invoiceWithBRs.Invoice.Num, invoiceWithBRs.Invoice.ProviderInvoiceNumber))"
                                                  Title="Modifier le numéro chez fournisseur" />
                                </div>
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(ProviderInvoiceResponse.Date)"
                                              Title="@Localizer["date"]"
                                              FormatString="{0:d}"
                                              Width="140px">
                            <Template Context="invoiceWithBRs">
                                @invoiceWithBRs.Invoice.Date.ToString("d")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(ProviderInvoiceResponse.TotTTC)"
                                              Title="@Localizer["total_incl_tax"]"
                                              Width="140px">
                            <Template Context="invoiceWithBRs">
                                @invoiceWithBRs.Invoice.TotTTC.FormatAmount()
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Title="@Localizer["retenue_status"]"
                                              Width="120px">
                            <Template Context="invoiceWithBRs">
                                @if (invoiceWithBRs.Invoice.TotTTC >= _seuilRetenueSource)
                                {
                                    @if (invoiceWithBRs.Invoice.HasRetenueSource)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="@Localizer["retenue_exists"]" />
                                    }
                                    else
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@Localizer["retenue_not_exists"]" />
                                    }
                                }
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Title="@Localizer["retenue_action"]"
                                              Width="120px">
                            <Template Context="invoiceWithBRs">
                                @if (invoiceWithBRs.Invoice.TotTTC >= _seuilRetenueSource)
                                {
                                    <RadzenButton Icon="@(invoiceWithBRs.Invoice.HasRetenueSource ? "edit" : "add")" 
                                                  ButtonStyle="ButtonStyle.Info" 
                                                  Size="ButtonSize.Small"
                                                  Title="@Localizer["retenue_source"]"
                                                  Click="@(() => OpenRetenueDialog(invoiceWithBRs.Invoice.Num, invoiceWithBRs.Invoice.TotTTC))" />
                                }
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Title="Facture avoir / Avoir financier"
                                              Width="180px">
                            <Template Context="invoiceWithBRs">
                                <RadzenButton Icon="link" 
                                              ButtonStyle="ButtonStyle.Secondary" 
                                              Size="ButtonSize.Small"
                                              Title="Rattacher facture avoir ou avoir financier"
                                              Click="@(() => OpenAttachDialog(invoiceWithBRs.Invoice.Num, invoiceWithBRs.Invoice.ProviderId))" />
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
                <!-- Invoice Summary -->
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e0e0e0; flex-wrap: wrap;">
                    <span style="font-size: 0.85rem; color: #666;">
                        @Localizer["total_net"]: <strong style="color: #333;">@_invoicesList?.TotalNetAmount.FormatAmount()</strong>
                    </span>
                    <span style="font-size: 0.85rem; color: #666;">
                        @Localizer["total_gross"]: <strong style="color: #333;">@_invoicesList?.TotalGrossAmount.FormatAmount()</strong>
                    </span>
                    <span style="font-size: 0.85rem; color: #666;">
                        @Localizer["total_vat"]: <strong style="color: #333;">@_invoicesList?.TotalVATAmount.FormatAmount()</strong>
                    </span>
                </div>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Uninvoiced Receipt Notes Section -->
    <RadzenRow Style="margin-top: 2rem;">
        <RadzenColumn Size="12">
            <RadzenCard Variant="Variant.Flat"
                        Style="padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <RadzenDataGrid @ref="_receiptNoteGrid"
                                AllowRowSelectOnRowClick="true"
                                AllowFiltering="true"
                                FilterPopupRenderMode="PopupRenderMode.OnDemand"
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                AllowPaging="true"
                                PagerHorizontalAlign="HorizontalAlign.Left"
                                ShowPagingSummary="true"
                                PageSize="_defaultPageSize"
                                Count="@_uninvoicedReceiptNotesWithSummary.ReceiptNotes.TotalCount"
                                AllowSorting="true"
                                Data="@_uninvoicedReceiptNotesWithSummary.ReceiptNotes.Items"
                                LoadData="LoadUninvoicedReceiptNote"
                                IsLoading="@isLoadingUninvoicedDeliveryNotes"
                                SelectionMode="DataGridSelectionMode.Multiple"
                                @bind-Value="@_selectedReceiptNotesToAttach"
                                Style="border: none;"
                                Class="custom-grid">
                    <EmptyTemplate>
                        <p style="font-size: 24px; text-align: center; margin: 2rem;">No records to display.</p>
                    </EmptyTemplate>
                    <HeaderTemplate>
                        <div style="display: flex; align-items: center; margin-bottom: 0.75rem; gap: 1rem;">
                            <div style="font-size: 1.1rem; font-weight: 600;">
                                @Localizer["uninvoiced_receipt_notes_details"]
                            </div>
                            <div style="margin-left: auto;">
                                <RadzenButton Click="@(args => AttachReceiptNotesToInvoiceClick("Primary button"))"
                                              Text="@Localizer["attach_receipt_note_to_invoice"]"
                                              Disabled="@(SelectedInvoiceId == 0 || !_selectedReceiptNotesToAttach.Any())"
                                              ButtonStyle="ButtonStyle.Primary"
                                              Size="ButtonSize.Small"
                                              Style="border-radius: 6px; padding: 0.4rem 0.8rem; font-weight: 500; font-size: 0.85rem;" />
                            </div>
                        </div>
                    </HeaderTemplate>
                    <Columns>
                        <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailsResponse.Num)"
                                              Title="@Localizer["number"]"
                                              Width="140px" />
                        <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailsResponse.TotHTva)"
                                              Title="@Localizer["total_ex_tax"]"
                                              Width="140px">
                            <Template Context="detail">
                                @detail.TotHTva.FormatAmount()
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="@nameof(ReceiptNoteDetailsResponse.TotTTC)"
                                              Title="@Localizer["net_payer"]"
                                              Width="140px">
                            <Template Context="detail">
                                @detail.TotTTC.FormatAmount()
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
                <!-- Uninvoiced Receipt Notes Summary -->
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e0e0e0; flex-wrap: wrap;">
                    <span style="font-size: 0.85rem; color: #666;">
                        @Localizer["total_net"]: <strong style="color: #333;">@_uninvoicedReceiptNotesWithSummary?.TotalNetAmount.FormatAmount()</strong>
                    </span>
                    <span style="font-size: 0.85rem; color: #666;">
                        @Localizer["total_gross"]: <strong style="color: #333;">@_uninvoicedReceiptNotesWithSummary?.TotalGrossAmount.FormatAmount()</strong>
                    </span>
                    <span style="font-size: 0.85rem; color: #666;">
                        @Localizer["total_vat"]: <strong style="color: #333;">@_uninvoicedReceiptNotesWithSummary?.TotalVATAmount.FormatAmount()</strong>
                    </span>
                </div>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
</div>
<style>
    .custom-dropdown {
        --rz-dropdown-border-hover: #4f46e5;
        --rz-dropdown-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
    }
    .custom-dropdown .rz-dropdown-panel {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }
    .custom-dropdown .rz-dropdown-item:hover {
        background: #f9fafb;
    }
    .custom-dropdown:hover {
        border-color: #007bff;
    }
    .custom-grid .rz-datatable {
        border: none !important;
        background-color: transparent;
    }
    .custom-grid .rz-datatable-thead {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
    }
    .custom-grid .rz-datatable-tbody tr:hover {
        background-color: #f1f3f5;
    }
    
    /* Master-Detail Styles */
    .detail-grid {
        background-color: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        margin: 0.5rem 0;
    }
    
    .detail-grid .rz-datatable {
        background-color: transparent;
    }
    
    .detail-grid .rz-datatable-thead {
        background-color: #e3f2fd;
        border-bottom: 1px solid #bbdefb;
    }
    
    .detail-grid .rz-datatable-tbody tr {
        background-color: #ffffff;
    }
    
    .detail-grid .rz-datatable-tbody tr:hover {
        background-color: #e1f5fe;
    }
</style>
@code {
    #region Fields and Properties
    private const int _defaultPageSize = 7;
    private const int _minValueId = 0;

    private int _selectedProviderId;
    private int SelectedProviderId
    {
        get => _selectedProviderId;
        set
        {
            if (_selectedProviderId != value)
            {
                _selectedProviderId = value;
                SelectedInvoiceId = _minValueId;
                SelectedInvoice = new List<ProviderInvoiceWithReceiptNotes>();
                _invoicesList = new GetProviderInvoicesWithSummary();
                _invoicesWithReceiptNotes = new List<ProviderInvoiceWithReceiptNotes>();
                _uninvoicedReceiptNotesWithSummary = new ReceiptNotesWithSummaryResponse();
                if (value > _minValueId)
                {
                    _ = LoadUninvoicedReceiptNote(value);
                    _ = LoadInvoices(value);
                }
            }
        }
    }
    private int _selectedInvoiceId;
    private int SelectedInvoiceId
    {
        get => _selectedInvoiceId;
        set
        {
            if (_selectedInvoiceId != value)
            {
                _selectedInvoiceId = value;
                // Receipt notes will be loaded when the row is expanded
            }
        }
    }
    private IList<ProviderInvoiceWithReceiptNotes> SelectedInvoice { get; set; } = new List<ProviderInvoiceWithReceiptNotes>();
    private IList<ProviderInvoiceWithReceiptNotes> _selectedInvoices = new List<ProviderInvoiceWithReceiptNotes>();
    private IList<ProviderInvoiceWithReceiptNotes> SelectedInvoices
    {
        get => _selectedInvoices;
        set
        {
            _selectedInvoices = value;
            SelectedInvoiceId = _selectedInvoices?.FirstOrDefault()?.Invoice?.Num ?? _minValueId;
            var selectedInvoice = _selectedInvoices?.FirstOrDefault();
            if (selectedInvoice != null && !selectedInvoice.ReceiptNotesLoaded)
            {
                _ = LoadReceiptNotesForInvoiceAsync(selectedInvoice.Invoice.Num);
            }
        }
    }

    bool isLoadingProviders = false;
    bool isLoadingInvoices = false;
    bool isLoadingUninvoicedDeliveryNotes = false;
    private IList<ProviderResponse> _providersList = new List<ProviderResponse>();
    private IList<ReceiptNoteDetailsResponse> _selectedReceiptNotesIdsToDetach = new List<ReceiptNoteDetailsResponse>();
    private IList<ReceiptNoteDetailsResponse> _selectedReceiptNotesToAttach { get; set; } = new List<ReceiptNoteDetailsResponse>();
    private CancellationTokenSource _cancellationTokenSource = new();
    private RadzenDataGrid<ReceiptNoteDetailsResponse> _receiptNoteGrid;
    private RadzenDataGrid<ProviderInvoiceWithReceiptNotes> ProviderInvoiceGrid;
    private GetProviderInvoicesWithSummary _invoicesList = new GetProviderInvoicesWithSummary();
    private ReceiptNotesWithSummaryResponse _uninvoicedReceiptNotesWithSummary = new ReceiptNotesWithSummaryResponse();
    private decimal _seuilRetenueSource = 1000;
    private double _tauxRetenu = 0;
    private decimal _timbre = 0;
    
    // Master-detail model
    public class ProviderInvoiceWithReceiptNotes
    {
        public ProviderInvoiceResponse Invoice { get; set; } = null!;
        public List<ReceiptNoteDetailsResponse> ReceiptNotes { get; set; } = new();
        public bool ReceiptNotesLoaded { get; set; } = false;
        public bool ReceiptNotesLoading { get; set; } = false;
    }
    
    private List<ProviderInvoiceWithReceiptNotes> _invoicesWithReceiptNotes = new List<ProviderInvoiceWithReceiptNotes>();
    DataGridExpandMode expandMode = DataGridExpandMode.Multiple;

    private IList<ReceiptNoteDetailsResponse> _selectedReceiptNotesToDetach
    {
        get => _selectedReceiptNotesIdsToDetach;
        set => _selectedReceiptNotesIdsToDetach = value;
    }
    #endregion


    #region Lifecycle Methods
    protected override async Task OnInitializedAsync()
    {
        await SearchProviders();
        await LoadAppParameters();
    }

    private async Task LoadAppParameters()
    {
        try
        {
            var appParamsResult = await appParametersClient.GetAppParametersAsync(_cancellationTokenSource.Token);
            if (appParamsResult.IsT0)
            {
                var appParams = appParamsResult.AsT0;
                _seuilRetenueSource = appParams.SeuilRetenueSource;
                _tauxRetenu = appParams.PourcentageRetenu;
                _timbre = appParams.Timbre;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["error"],
                Detail = $"Failed to load app parameters: {ex.Message}"
            });
        }
    }

    public void Dispose()
    {
        _cancellationTokenSource.Cancel();
        _cancellationTokenSource.Dispose();
    }
    #endregion

    #region Data Loading Methods (Commented Out)

    private async Task LoadProviders(LoadDataArgs args)
    {
        isLoadingProviders = true;
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = _defaultPageSize,
            SearchKeyword = args.Filter
            };

        try
        {
            var pagedProviders = await providersService.GetPagedAsync(parameters, _cancellationTokenSource.Token);
            _providersList = pagedProviders.Items;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Failed to load providers: {ex.Message}"
                });
            _providersList = new List<ProviderResponse>();
        }

        isLoadingProviders = false;
        await InvokeAsync(StateHasChanged);
    }
    private async Task SearchProviders()
    {
        var parameters = new QueryStringParameters
            {
                PageNumber = 1,
                PageSize = _defaultPageSize,
                SearchKeyword = null
            };

        var pagedProviders = await providersService.GetPagedAsync(parameters, _cancellationTokenSource.Token);
        _providersList = pagedProviders.Items;
        await InvokeAsync(StateHasChanged);
    }
    private async Task LoadUninvoicedReceiptNote(LoadDataArgs args)
    {
        string _sortProperty = null;
        string _sortOrder = null;
        if (args.Sorts != null && args.Sorts.Any())
        {
            var sort = args.Sorts.First();
            _sortProperty = sort.Property;
            _sortOrder = sort.SortOrder == SortOrder.Ascending ? SortConstants.Ascending : SortConstants.Descending;
        }
        var parameters = new QueryStringParameters
            {
                PageNumber = (args.Skip.Value / _defaultPageSize) + 1,
                PageSize = _defaultPageSize,
                SearchKeyword = args.Filter,
                SortOrder = _sortOrder,
                SortProprety = _sortProperty
            };
        var repi = await receiptNoteService.GetReceiptNoteWithSummaries(SelectedProviderId, false, null, parameters, _cancellationTokenSource.Token);

        if (repi.IsSuccess)
            _uninvoicedReceiptNotesWithSummary = repi.Value;
        await InvokeAsync(StateHasChanged);
    }
    private async Task LoadUninvoicedReceiptNote(int _provider)
    {
        var parameters = new QueryStringParameters
			{
				PageNumber = 1,
				PageSize = _defaultPageSize,
				SearchKeyword = null
			};
        var repi = await receiptNoteService.GetReceiptNoteWithSummaries(_provider, false, null, parameters, _cancellationTokenSource.Token);
        if (repi.IsSuccess)
            _uninvoicedReceiptNotesWithSummary = repi.Value;
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadInvoices(LoadDataArgs args)
    { 
        string _sortProperty = null;
        string _sortOrder = null;
        if (args.Sorts != null && args.Sorts.Any())
        {
            var sort = args.Sorts.First();
            _sortProperty = sort.Property;
            _sortOrder = sort.SortOrder == SortOrder.Ascending ? SortConstants.Ascending : SortConstants.Descending;
        }
        var query = new QueryStringParameters
			{
				PageNumber = (args.Skip.Value / _defaultPageSize) + 1,
				PageSize = _defaultPageSize,
				SearchKeyword = args.Filter,
                SortOrder = _sortOrder,
                SortProprety = _sortProperty
			};
        var invoices = await providerInvoiceService.GetProvidersInvoicesAsync(SelectedProviderId, query, default);
        if (invoices.IsT1)
        {
            NotificationService.Notify(new NotificationMessage
				{
					Severity = NotificationSeverity.Error,
					Summary = Localizer["error"],
					Detail = invoices.AsT1.Detail
				});
            return;
        }
        _invoicesList = invoices.AsT0;
        
        // Build _invoicesWithReceiptNotes from _invoicesList
        _invoicesWithReceiptNotes = _invoicesList.Invoices.Items.Select(invoice => new ProviderInvoiceWithReceiptNotes
        {
            Invoice = invoice,
            ReceiptNotes = new List<ReceiptNoteDetailsResponse>(),
            ReceiptNotesLoaded = false
        }).ToList();
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadInvoices(int providerId)
    {
        var query = new QueryStringParameters
			{
				PageNumber = 1,
				PageSize = _defaultPageSize,
				SearchKeyword = null
			};
        var invoices = await providerInvoiceService.GetProvidersInvoicesAsync(providerId, query , default);
        if (invoices.IsT1)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = invoices.AsT1.Detail
                });
            return;
        }
        _invoicesList = invoices.AsT0;
        
        // Build _invoicesWithReceiptNotes from _invoicesList
        _invoicesWithReceiptNotes = _invoicesList.Invoices.Items.Select(invoice => new ProviderInvoiceWithReceiptNotes
        {
            Invoice = invoice,
            ReceiptNotes = new List<ReceiptNoteDetailsResponse>(),
            ReceiptNotesLoaded = false
        }).ToList();
        
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task LoadReceiptNotesForInvoiceAsync(int invoiceNum)
    {
        var invoiceWithBRs = _invoicesWithReceiptNotes.FirstOrDefault(i => i.Invoice.Num == invoiceNum);
        if (invoiceWithBRs == null || invoiceWithBRs.ReceiptNotesLoaded || invoiceWithBRs.ReceiptNotesLoading)
        {
            return;
        }
        
        invoiceWithBRs.ReceiptNotesLoading = true;
        try
        {
            var parameters = new QueryStringParameters
            {
                PageNumber = 1,
                PageSize = 50, // Maximum allowed by API
                SearchKeyword = null
            };
            var repi = await receiptNoteService.GetReceiptNoteWithSummaries(SelectedProviderId, true, invoiceNum, parameters, _cancellationTokenSource.Token);
            if (repi.IsSuccess)
            {
                invoiceWithBRs.ReceiptNotes = repi.Value.ReceiptNotes.Items?.ToList() ?? new List<ReceiptNoteDetailsResponse>();
                invoiceWithBRs.ReceiptNotesLoaded = true;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = $"Failed to load receipt notes for invoice {invoiceNum}: {ex.Message}"
            });
        }
        finally
        {
            invoiceWithBRs.ReceiptNotesLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    void RowRender(RowRenderEventArgs<ProviderInvoiceWithReceiptNotes> args)
    {
        // Make row expandable
        args.Expandable = true;
    }

    private async Task OpenRetenueDialog(int numFactureFournisseur, decimal montantTTC)
    {
        try
        {
            // Check if retenue already exists
            var existingRetenueResult = await retenueSourceFournisseurApiClient.GetRetenueSourceFournisseurAsync(numFactureFournisseur, _cancellationTokenSource.Token);
            var isEditMode = existingRetenueResult.IsSuccess;
            var existingNumTej = isEditMode ? existingRetenueResult.Value?.NumTej : null;
            
            // Load existing PDF if in edit mode
            string? existingPdfBase64 = null;
            if (isEditMode && existingRetenueResult.Value?.HasPdf == true)
            {
                try
                {
                    var pdfResult = await retenueSourceFournisseurApiClient.GetRetenueSourceFournisseurPdfAsync(numFactureFournisseur, _cancellationTokenSource.Token);
                    if (pdfResult.IsSuccess)
                    {
                        existingPdfBase64 = Convert.ToBase64String(pdfResult.Value);
                    }
                }
                catch (Exception ex)
                {
                    // Log but don't block the dialog
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Warning,
                        Summary = Localizer["warning"],
                        Detail = $"Impossible de charger le PDF existant: {ex.Message}"
                    });
                }
            }

            var dialogOptions = new DialogOptions
            {
                Width = "500px",
                Resizable = true,
                Draggable = true
            };

            // Le montantTTC passé est déjà avec timbre (depuis la liste), donc on le passe tel quel
            var result = await DialogService.OpenAsync<RetenueSourceDialog>(
                Localizer["retenue_source"],
                new Dictionary<string, object>
                {
                    { "NumFacture", numFactureFournisseur },
                    { "MontantTTC", montantTTC }, // Déjà avec timbre
                    { "TauxRetenu", _tauxRetenu },
                    { "SeuilRetenueSource", _seuilRetenueSource },
                    { "Timbre", _timbre },
                    { "ExistingNumTej", existingNumTej },
                    { "IsEditMode", isEditMode },
                    { "ExistingPdfBase64", existingPdfBase64 }
                },
                dialogOptions);

            if (result is RetenueSourceDialog.RetenueSourceDialogResult dialogResult)
            {
                if (isEditMode)
                {
                    // Update existing retenue
                    var updateRequest = new UpdateRetenueSourceFournisseurRequest
                    {
                        NumTej = dialogResult.NumTej ?? string.Empty,
                        PdfContent = dialogResult.PdfContent
                    };

                    var updateResult = await retenueSourceFournisseurApiClient.UpdateRetenueSourceFournisseurAsync(numFactureFournisseur, updateRequest, _cancellationTokenSource.Token);
                    if (updateResult.IsSuccess)
                    {
                        toastService.Notify(new(ToastType.Success, Localizer["retenue_source"] + " " + Localizer["updated_with_success"]));
                    }
                    else
                    {
                        toastService.Notify(new(ToastType.Danger, updateResult.Errors.FirstOrDefault()?.Message ?? Localizer["Unexpected_Error"]));
                    }
                }
                else
                {
                    // Create new retenue
                    var createRequest = new CreateRetenueSourceFournisseurRequest
                    {
                        NumFactureFournisseur = numFactureFournisseur,
                        NumTej = dialogResult.NumTej ?? string.Empty,
                        PdfContent = dialogResult.PdfContent
                    };

                    var createResult = await retenueSourceFournisseurApiClient.CreateRetenueSourceFournisseurAsync(createRequest, _cancellationTokenSource.Token);
                    if (createResult.IsT0)
                    {
                        toastService.Notify(new(ToastType.Success, Localizer["retenue_source"] + " " + Localizer["created_with_success"]));
                    }
                    else
                    {
                        var badRequest = createResult.AsT1;
                        toastService.Notify(new(ToastType.Danger, badRequest.Detail ?? "Erreur lors de la création"));
                    }
                }

                // Reload invoices to get updated retenue status
                await LoadInvoices(SelectedProviderId);
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Erreur lors de l'ouverture du popup de retenue: {ex.Message}"
            });
        }
    }

    private async Task OpenAttachDialog(int invoiceNum, int providerId)
    {
        try
        {
            var dialogOptions = new DialogOptions
            {
                Width = "1000px",
                Height = "700px",
                Resizable = true,
                Draggable = true
            };

            var result = await DialogService.OpenAsync<AttachFactureAvoirAvoirFinancierDialog>(
                "Rattacher facture avoir / avoir financier",
                new Dictionary<string, object>
                {
                    { "InvoiceNum", invoiceNum },
                    { "ProviderId", providerId }
                },
                dialogOptions);

            if (result is true)
            {
                // Reload invoices to get updated links
                await LoadInvoices(SelectedProviderId);
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Erreur lors de l'ouverture du popup: {ex.Message}"
            });
        }
    }

    private async Task DetachReceiptNotesFromInvoice()
    {
        try
        {
            var deliveryNoteIds = _selectedReceiptNotesIdsToDetach.Select(dn => dn.Num).ToList();

            var result =await receiptNoteService.DetachReceiptNotesFromInvoiceAsync(SelectedInvoiceId, deliveryNoteIds, _cancellationTokenSource.Token);

            if (result)
                updateInvoiceGridLineAttachmentRecpiet(SelectedInvoiceId, false);

            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = Localizer["success"],
                    Detail = Localizer["receipt_notes_detached"]
                });

            _selectedReceiptNotesIdsToDetach = new List<ReceiptNoteDetailsResponse>();

            await LoadUninvoicedReceiptNote(SelectedProviderId);
            // Reload receipt notes for the selected invoice
            if (SelectedInvoiceId > 0)
            {
                var invoiceWithBRs = _invoicesWithReceiptNotes.FirstOrDefault(i => i.Invoice.Num == SelectedInvoiceId);
                if (invoiceWithBRs != null)
                {
                    invoiceWithBRs.ReceiptNotesLoaded = false;
                    await LoadReceiptNotesForInvoiceAsync(SelectedInvoiceId);
                }
            }
            await LoadInvoices(SelectedProviderId);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = ex.Message
                });
            Console.WriteLine($"Error detaching receipt notes from invoice: {ex.Message}");
        }
    }

    private void updateInvoiceGridLineAttachmentRecpiet(int invoiceId,bool isAttach)
    {
        var invoiceWithBRs = _invoicesWithReceiptNotes.FirstOrDefault(i => i.Invoice.Num == invoiceId);
        if (invoiceWithBRs == null)
            return;
            
        var invoiceline = invoiceWithBRs.Invoice;
        decimal totHtV;
        decimal totHTTC;
        decimal totTVA;
        decimal sumAmount;

        if (isAttach)
        {
            sumAmount = _selectedReceiptNotesToAttach.Sum(m => m.TotTTC);
            invoiceline.TotTTC = invoiceline.TotTTC + sumAmount;
            totHtV = _invoicesList.TotalNetAmount + _selectedReceiptNotesToAttach.Sum(x => x.TotHTva);
            totHTTC = _invoicesList.TotalGrossAmount + _selectedReceiptNotesToAttach.Sum(x => x.TotTTC);
            totTVA = _invoicesList.TotalVATAmount + _selectedReceiptNotesToAttach.Sum(x => x.TotTva);
        }
        else
        {
            sumAmount = _selectedReceiptNotesIdsToDetach.Sum(m => m.TotTTC);
            invoiceline.TotTTC = invoiceline.TotTTC - sumAmount;
            totHtV = _invoicesList.TotalNetAmount - _selectedReceiptNotesIdsToDetach.Sum(x => x.TotHTva);
            totHTTC = _invoicesList.TotalGrossAmount - _selectedReceiptNotesIdsToDetach.Sum(x => x.TotTTC);
            totTVA = _invoicesList.TotalVATAmount - _selectedReceiptNotesIdsToDetach.Sum(x => x.TotTva);
        }

        invoiceWithBRs.Invoice.TotTTC = invoiceline.TotTTC;
        _invoicesList.TotalGrossAmount = totHTTC;
        _invoicesList.TotalNetAmount = totHtV;
        _invoicesList.TotalVATAmount = totTVA;
    }

    private async Task AttachReceiptNotesToInvoiceClick(string text)
    {
        if (SelectedInvoiceId > _minValueId && _selectedReceiptNotesToAttach?.Any() == true)
        {
            var deliveryNoteIds = _selectedReceiptNotesToAttach.Select(dn => dn.Num).ToList();
            var attachToInvoiceRequest = new AttachToInvoiceRequest
                {
                    InvoiceId = SelectedInvoiceId,
                    DeliveryNoteIds = deliveryNoteIds
                };

            var result = await receiptNoteService.AttachReceiptNotesToInvoiceAsync(SelectedInvoiceId, deliveryNoteIds, _cancellationTokenSource.Token);

            if (result)
            {
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = Localizer["success"],
                        Detail = Localizer["receipt_notes_attached"]
                    });

                updateInvoiceGridLineAttachmentRecpiet(SelectedInvoiceId, true);
                _selectedReceiptNotesToAttach = new List<ReceiptNoteDetailsResponse>();

                await LoadUninvoicedReceiptNote(SelectedProviderId);
                // Reload receipt notes for the selected invoice
                if (SelectedInvoiceId > 0)
                {
                    var invoiceWithBRs = _invoicesWithReceiptNotes.FirstOrDefault(i => i.Invoice.Num == SelectedInvoiceId);
                    if (invoiceWithBRs != null)
                    {
                        invoiceWithBRs.ReceiptNotesLoaded = false;
                        await LoadReceiptNotesForInvoiceAsync(SelectedInvoiceId);
                    }
                }
                await LoadInvoices(SelectedProviderId);

            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = Localizer["error"]
                    });
            }
        }
        else
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["warning"],
                    Detail = Localizer["select_invoice_and_receipt_notes"]
                });
        }
    }

    #endregion

    #region Create Invoice Methods
    async Task CreateNewProviderInvoice()
    {
        if (SelectedProviderId <= 0)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = Localizer["select_a_provider_before"]
            });
            return;
        }

        var result = await DialogService.OpenAsync<CreateProviderInvoiceDialog>(
            Localizer["create_new_invoice"],
            new Dictionary<string, object> { { "InitialDate", DateTime.Now.Date } },
            new DialogOptions()
            {
                Width = "400px",
                Resizable = false,
                Draggable = true
            });

        if (result is CreateInvoiceDialogResult dialogResult)
        {
            await CreateProviderInvoiceWithDate(dialogResult.Date, dialogResult.NumFactureFournisseur);
        }
    }

    async Task CreateProviderInvoiceWithDate(DateTime invoiceDate, long numFactureFournisseur)
    {
        isLoadingInvoices = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var request = new CreateProviderInvoiceRequest
            {
                Date = invoiceDate,
                ProviderId = SelectedProviderId,
                NumFactureFournisseur = numFactureFournisseur
            };

            var result = await providerInvoiceService.CreateProviderInvoice(request, _cancellationTokenSource.Token);

            if (result.IsT0) // Success
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = Localizer["success"],
                    Detail = Localizer["invoice_created_successfully"]
                });

                // Refresh invoice list
                await LoadInvoices(SelectedProviderId);
            }
            else if (result.IsT1) // BadRequestResponse
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = result.AsT1.Detail
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Failed to create provider invoice: {ex.Message}"
            });
        }
        finally
        {
            isLoadingInvoices = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    #endregion

    #region Print methods
    private async Task PrintRetenuSourceClick()
    {
        if (SelectedInvoiceId <= _minValueId)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["warning"],
                    Detail = Localizer["select_invoice"]
                });
            return;
        }
        // Print functionality commented out for display-only version

        var invoices = new List<int>() { SelectedInvoiceId };
        var pdfBytes = await RetenuSourceFournisseurPrintService
        .GenerateRetenuSourcePdfAsync(invoices, cancellationToken: _cancellationTokenSource.Token);
        var fileName = $"Retenu à la source {SelectedInvoiceId}.pdf";
        await JS.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(pdfBytes.Value), "application/pdf");

    }

    private async Task PrintInvoiceClick()
    {
        // Show notification if no invoice selected
        if (SelectedInvoiceId <= _minValueId)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["warning"],
                    Detail = Localizer["select_invoice"]
                });
            return;
        }

        // Generate PDF with header by default
        var pdfResult = await PrintProviderFullInvoiceService
            .GenerateInvoicePdfAsync(SelectedInvoiceId, cancellationToken: _cancellationTokenSource.Token, includeHeader: true);

        if (pdfResult.IsSuccess)
        {
            var fileName = $"Invoice {SelectedInvoiceId}.pdf";

            // Show PDF viewer dialog
            await DialogService.OpenAsync<PdfViewerDialog>(
                Localizer["print_mode"],
                new Dictionary<string, object>
                {
                    { "PdfBytes", pdfResult.Value },
                    { "FileName", fileName },
                    { "RegeneratePdfAsync", new Func<bool, Task<Result<byte[]>>>(async (includeHeader) =>
                        await PrintProviderFullInvoiceService.GenerateInvoicePdfAsync(
                            SelectedInvoiceId,
                            _cancellationTokenSource.Token,
                            includeHeader: includeHeader))
                    }
                },
                new DialogOptions()
                {
                    Width = "800px",
                    Height = "700px",
                    Resizable = true,
                    Draggable = true
                });
        }
        else
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Échec de la génération du PDF: {pdfResult.Errors.FirstOrDefault()?.Message ?? "Unknown error"}"
            });
        }
    }

    private async Task ExportToTejXmlClick()
    {
        if (SelectedInvoiceId <= _minValueId)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = Localizer["select_invoice"]
            });
            return;
        }

        var selectedInvoice = SelectedInvoices?.FirstOrDefault();
        if (selectedInvoice == null)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = Localizer["select_invoice"]
            });
            return;
        }

        if (selectedInvoice.Invoice.TotTTC < _seuilRetenueSource)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["warning"],
                Detail = $"Le montant TTC ({selectedInvoice.Invoice.TotTTC:F2}) doit être supérieur ou égal au seuil ({_seuilRetenueSource:F2}) pour pouvoir exporter en XML TEJ."
            });
            return;
        }

        try
        {
            var baseUrl = Configuration.GetValue<string>("ApiSettings:BaseUrl")
                ?? throw new InvalidOperationException("ApiSettings:BaseUrl configuration is missing");

            var url = $"{baseUrl.TrimEnd('/')}/api/provider-invoices/{SelectedInvoiceId}/export/tej-xml";

            var response = await HttpClient.GetAsync(url, _cancellationTokenSource.Token);

            if (!response.IsSuccessStatusCode)
            {
                var errorContent = await response.Content.ReadAsStringAsync(_cancellationTokenSource.Token);
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = response.StatusCode == System.Net.HttpStatusCode.BadRequest
                        ? errorContent
                        : "Erreur lors de l'export en XML TEJ. Veuillez réessayer.",
                    Duration = 4000
                });
                return;
            }

            // Get the file content
            var fileBytes = await response.Content.ReadAsByteArrayAsync(_cancellationTokenSource.Token);
            var fileName = response.Content.Headers.ContentDisposition?.FileName
                ?? $"Facture_Fournisseur_{SelectedInvoiceId}_TEJ_{DateTime.Now:yyyyMMdd_HHmmss}.xml";

            // Remove quotes from filename if present
            fileName = fileName.Trim('"');

            // Download the file using JavaScript
            var base64String = Convert.ToBase64String(fileBytes);
            await JS.InvokeVoidAsync("downloadFile", fileName, base64String, "application/xml; charset=utf-8");

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = Localizer["success"],
                Detail = "Export en XML TEJ réussi.",
                Duration = 3000
            });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Erreur lors de l'export: {ex.Message}",
                Duration = 4000
            });
        }
    }
    #endregion

    #region Edit Provider Invoice Number
    async Task EditProviderInvoiceNumber(int invoiceNum, long currentNumFactureFournisseur)
    {
        var result = await DialogService.OpenAsync<EditProviderInvoiceNumberDialog>(
            Localizer["edit_provider_invoice_number"],
            new Dictionary<string, object> 
            { 
                { "InvoiceNum", invoiceNum },
                { "CurrentNumFactureFournisseur", currentNumFactureFournisseur }
            },
            new DialogOptions()
            {
                Width = "400px",
                Resizable = false,
                Draggable = true
            });

        if (result is EditProviderInvoiceNumberDialogResult dialogResult)
        {
            await UpdateProviderInvoiceNumber(invoiceNum, dialogResult.NumFactureFournisseur);
        }
    }

    async Task UpdateProviderInvoiceNumber(int invoiceNum, long numFactureFournisseur)
    {
        try
        {
            var request = new UpdateProviderInvoiceRequest
            {
                NumFactureFournisseur = numFactureFournisseur
            };

            var result = await providerInvoiceService.UpdateProviderInvoiceAsync(invoiceNum, request, _cancellationTokenSource.Token);

            if (result.IsT0 && result.AsT0 == ResponseTypes.Success)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = Localizer["success"],
                    Detail = "Le numéro chez fournisseur a été mis à jour avec succès"
                });

                // Refresh invoice list
                await LoadInvoices(SelectedProviderId);
            }
            else if (result.IsT0 && result.AsT0 == ResponseTypes.NotFound)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["warning"],
                    Detail = "Facture non trouvée"
                });
            }
            else if (result.IsT1)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["error"],
                    Detail = result.AsT1.Detail ?? "Erreur lors de la mise à jour"
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["error"],
                Detail = $"Erreur lors de la mise à jour: {ex.Message}"
            });
        }
    }
    #endregion
}
