@page "/provider-invoices"

@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.ProviderInvoice
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ProviderInvoice
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AppParameters
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AccountingYear
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.RetenueSourceFournisseur
@using TunNetCom.SilkRoadErp.Sales.Contracts.RetenueSourceFournisseur
@inject IProviderInvoiceApiClient ProviderInvoiceService
@inject IProvidersApiClient ProvidersService
@inject IAppParametersClient appParametersClient
@inject IAccountingYearApiClient accountingYearApiClient
@inject IRetenueSourceFournisseurApiClient retenueSourceFournisseurApiClient
@inject IStringLocalizer<SharedResource> Localizer
@inject ILogger<ProviderInvoicesList> _logger
@using Radzen.Blazor
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Providers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@using TunNetCom.SilkRoadErp.Sales.Contracts.Providers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@using TunNetCom.SilkRoadErp.Sales.Contracts.Tags
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Tags
@inject NavigationManager NavigationManager
@inject ODataService ODataService
@inject ITagsApiClient TagsService
@inject IJSRuntime JS
@inject HttpClient HttpClient
@inject IConfiguration Configuration
@inject Radzen.NotificationService NotificationService
@inject DialogService DialogService
@using TunNetCom.SilkRoadErp.Sales.Domain.Entites

<div class="invoices-list-container">
    <div class="search-header">
        <PeriodFilter @bind-SelectedPeriod="searchCriteria.PeriodFilter"
                     @bind-StartDate="searchCriteria.StartDate"
                     @bind-EndDate="searchCriteria.EndDate"
                     OnPeriodChanged="@OnPeriodFilterChanged" />
        <div class="search-field">
            <label for="provider">Fournisseur</label>
            <RadzenDropDownDataGrid id="provider"
                                    AllowClear="true"
                                    @bind-Value="@searchCriteria.SelectedProviderId"
                                    LoadData="@LoadProviders"
                                    AllowFiltering="true"
                                    class="w-100 search-input"
                                    Data="@_filteredProviders"
                                    TextProperty="@nameof(ProviderResponse.Nom)"
                                    ValueProperty="@nameof(ProviderResponse.Id)"
                                    Placeholder="Selectionner un fournisseur">
                <Columns>
                    <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Id)" Title="ID" Width="80px" />
                    <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Nom)" Title="@Localizer["name"]" Width="220px" />
                </Columns>
            </RadzenDropDownDataGrid>
        </div>
        <TagSearchFilter SelectedTagIds="@searchCriteria.SelectedTagIds"
                       SelectedTagIdsChanged="@OnTagIdsChanged" />
        <div class="search-field">
            <label>Statut</label>
            <RadzenDropDown @bind-Value="@searchCriteria.Status"
                            Data="@(Enum.GetValues(typeof(DocumentStatus)).Cast<DocumentStatus>().Select(e => new { Value = (int?)e, Text = e.ToString() }).Prepend(new { Value = (int?)null, Text = "Tous" }))"
                            TextProperty="Text"
                            ValueProperty="Value"
                            class="w-100 search-input" />
        </div>
        <div class="search-button" style="display: flex; gap: 8px;">
            <RadzenButton Icon="search"
                          ButtonStyle="ButtonStyle.Primary"
                          Click="@SearchProviderInvoices"
                          class="action-button" />
            <RadzenButton Icon="check_circle"
                          ButtonStyle="ButtonStyle.Success"
                          Click="@ValidateSelectedInvoices"
                          Disabled="@(selectedInvoices == null || !selectedInvoices.Any())"
                          Title="Valider la sélection"
                          AriaLabel="Valider la sélection"
                          class="action-button" />
            <RadzenButton Icon="file_download"
                          ButtonStyle="ButtonStyle.Secondary"
                          Click="@ExportToSageErpAsync"
                          class="action-button"
                          Title="Exporter vers Sage ERP"
                          AriaLabel="Exporter vers Sage ERP" />
        </div>
    </div>
    <div class="list-card">
        <h2>Factures fournisseurs</h2>
        <RadzenDataGrid @ref="providerInvoicesGrid"
                        Data="@invoicesList"
                        LoadData="@Callback"
                        TItem="ProviderInvoiceBaseInfo"
                        SelectionMode="DataGridSelectionMode.Multiple"
                        @bind-Value="selectedInvoices"
                        AllowSorting="true"
                        AllowFiltering="true"
                        AllowPaging="true"
                        PageSize="@pageSize"
                        PageSizeOptions="@GridPageSizeConstants.PageSizeOptions"
                        Count="@totalCount"
                        AllowColumnResize="true">
            <EmptyTemplate>
                <p style="font-size: 24px; text-align: center; margin: 2rem;">No records to display.</p>
            </EmptyTemplate>
            <Columns>
                <RadzenDataGridColumn TItem="ProviderInvoiceBaseInfo" Width="40px" Sortable="false" Filterable="false">
                    <HeaderTemplate>
                        <RadzenCheckBox TriState="false" TValue="bool" Value="@(invoicesList != null && invoicesList.Any() && selectedInvoices != null && invoicesList.All(i => selectedInvoices.Contains(i)))"
                                        Change="@(args => { if(args == true) { selectedInvoices = invoicesList.ToList(); } else { selectedInvoices = new List<ProviderInvoiceBaseInfo>(); } })" />
                    </HeaderTemplate>
                    <Template Context="data">
                        <RadzenCheckBox TriState="false" Value="@(selectedInvoices != null && selectedInvoices.Contains(data))" 
                                        TValue="bool" Change="@(args => { if(selectedInvoices == null) selectedInvoices = new List<ProviderInvoiceBaseInfo>(); if(args) { if(!selectedInvoices.Contains(data)) selectedInvoices.Add(data); } else { selectedInvoices.Remove(data); } })" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProviderInvoiceBaseInfo" Property="Statut" Title="Statut" Width="100px">
                    <Template Context="item">
                        <span class="status-tag" style="@GetStatusStyle(item.Statut)">
                            @(item.Statut == 1 ? "Validé" : "Brouillon")
                        </span>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProviderInvoiceBaseInfo"
                                      Property="@nameof(ProviderInvoiceBaseInfo.Number)"
                                      Title="Numéro"
                                      Width="150px" />
                <RadzenDataGridColumn TItem="ProviderInvoiceBaseInfo"
                                      Property="@nameof(ProviderInvoiceBaseInfo.ProviderName)"
                                      Title="@Localizer["Fournisseur"]"
                                      Width="200px" />
                <RadzenDataGridColumn TItem="ProviderInvoiceBaseInfo"
                                      Property="@nameof(ProviderInvoiceBaseInfo.Date)"
                                      Title="@Localizer["date"]"
                                      Width="150px"
                                      FormatString="{0:d MMMM yyyy}" />
                <RadzenDataGridColumn TItem="ProviderInvoiceBaseInfo"
                                      Property="@nameof(ProviderInvoiceBaseInfo.NetAmount)"
                                      Title="@Localizer["total_net"]"
                                      Width="150px">
                    <Template Context="item">
                        @item.NetAmount.FormatAmount()
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProviderInvoiceBaseInfo"
                                      Property="@nameof(ProviderInvoiceBaseInfo.VatAmount)"
                                      Title="@Localizer["total_vat"]"
                                      Width="150px">
                    <Template Context="item">
                        @item.VatAmount.FormatAmount()
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProviderInvoiceBaseInfo"
                                      Title="@Localizer["retenue_status"]"
                                      Width="120px"
                                      Sortable="false"
                                      Filterable="false">
                    <Template Context="item">
                        @{
                            var montantTTC = item.NetAmount + item.VatAmount;
                            var montantTTCWithTimbre = montantTTC + _timbre;
                        }
                        @if (montantTTCWithTimbre >= _seuilRetenueSource)
                        {
                            var hasRetenue = _retenueMap.ContainsKey(item.Number);
                            @if (hasRetenue)
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="@Localizer["retenue_exists"]" />
                            }
                            else
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@Localizer["retenue_not_exists"]" />
                            }
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProviderInvoiceBaseInfo"
                                      Title="@Localizer["retenue_action"]"
                                      Width="120px"
                                      Sortable="false"
                                      Filterable="false">
                    <Template Context="item">
                        @{
                            var montantTTC = item.NetAmount + item.VatAmount;
                            var montantTTCWithTimbre = montantTTC + _timbre;
                        }
                        @if (montantTTCWithTimbre >= _seuilRetenueSource)
                        {
                            <RadzenButton Icon="@(_retenueMap.ContainsKey(item.Number) ? "edit" : "add")" 
                                          ButtonStyle="ButtonStyle.Info" 
                                          Size="ButtonSize.Small"
                                          Title="@Localizer["retenue_source"]"
                                          Click="@(() => OpenRetenueDialog(item.Number, montantTTCWithTimbre))" />
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProviderInvoiceBaseInfo"
                                      Title="Tags"
                                      Width="250px"
                                      Sortable="false"
                                      Filterable="false">
                    <Template Context="item">
                        <TagSelector DocumentType="FactureFournisseur" 
                                    DocumentId="@item.Number"
                                    SaveOnChange="true" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ProviderInvoiceBaseInfo"
                                      Title="@Localizer["actions_label"]"
                                      Width="150px"
                                      Sortable="false"
                                      Filterable="false">
                    <Template Context="item">
                        <RadzenButton Icon="edit"
                                      ButtonStyle="ButtonStyle.Primary"
                                      Variant="Variant.Flat"
                                      Size="ButtonSize.Small"
                                      Click="@(() => ViewProviderInvoice(item.Number.ToString()))"
                                      Disabled="@(item.Statut == 1)"
                                      Title="@Localizer["Edit"]"
                                      AriaLabel="@Localizer["Edit"]"
                                      Style="margin-right: 4px;" />
                        <RadzenButton Icon="check_circle"
                                      ButtonStyle="ButtonStyle.Success"
                                      Variant="Variant.Flat"
                                      Size="ButtonSize.Small"
                                      Click="@(() => ValidateInvoice(item))"
                                      Disabled="@(item.Statut == 1)"
                                      Title="Valider"
                                      AriaLabel="Valider"
                                      Style="margin-right: 4px;" />
                        @{
                            // Calculer le montant TTC (HT + TVA)
                            var montantTTC = item.NetAmount + item.VatAmount;
                        }
                        @* Afficher le bouton Export TEJ uniquement si le montant TTC dépasse le seuil de retenue source *@
                        @if (montantTTC >= _seuilRetenueSource)
                        {
                            <RadzenButton Icon="file_download"
                                          ButtonStyle="ButtonStyle.Info"
                                          Variant="Variant.Flat"
                                          Size="ButtonSize.Small"
                                          Click="@(() => ExportToTejXmlAsync(item.Number))"
                                          Title="Exporter en XML TEJ"
                                          AriaLabel="Exporter en XML TEJ" />
                        }
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
        <RadzenCard class="summary-card" Variant="Variant.Outlined">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal"
                         Gap="1.5rem"
                         JustifyContent="JustifyContent.End"
                         class="summary-stack">
                <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                    @Localizer["total_net"]: <strong>@totalNetAmount.FormatAmount()</strong>
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" class="summary-text">
                    @Localizer["total_vat"]: <strong>@totalVatAmount.FormatAmount()</strong>
                </RadzenText>
            </RadzenStack>
        </RadzenCard>
    </div>
</div>

<style>
    .status-tag {
        font-size: 0.75rem;
        padding: 0.125rem 0.5rem;
        display: inline-flex;
        align-items: center;
        border-radius: 3px;
        line-height: 1.5;
        font-weight: 500;
    }

    .invoices-list-container {
        padding: 0;
        min-height: 100%;
    }

    .list-card {
        width: 100%;
        margin: 0;
    }

    h2 {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 20px;
        margin: 0 0 16px 0;
        padding: 0;
    }

    .action-button {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        font-weight: 500;
        padding: 6px 12px;
        border-radius: 6px;
        background-color: #3b82f6;
        border: none;
        transition: background-color 0.2s, box-shadow 0.2s;
    }

        .action-button:hover:not(:disabled) {
            background-color: #2563eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .action-button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }

    .search-header {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin: 0 0 16px 0;
        align-items: end;
        padding: 0;
    }

    .search-field {
        display: flex;
        flex-direction: column;
    }

        .search-field label {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
        }

    .search-input {
        width: 100% !important;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        padding: 8px;
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

        .search-input:hover {
            border-color: #9ca3af;
        }

        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

    .search-button {
        display: flex;
        align-items: flex-end;
    }

    @@media (max-width: 768px) {
        .invoices-list-container {
            padding: 0;
        }

        h2 {
            font-size: 18px;
        }

        .action-button {
            font-size: 12px;
            padding: 6px 10px;
        }

        .search-header {
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .search-field {
            min-width: 100%;
        }

            .search-field label {
                font-size: 12px;
            }

        .search-input {
            font-size: 13px;
            padding: 6px;
        }

        .search-button {
            margin-bottom: 0;
        }
    }

    .summary-card {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        flex: 0 0 auto;
    }

    .summary-stack {
        gap: 1.5rem;
    }

    .summary-text {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        line-height: 1.5;
    }

        .summary-text strong {
            font-weight: 600;
        }

    @@media (min-width: 769px) and (max-width: 1024px) {
        .search-header {
            grid-template-columns: repeat(2, 1fr);
        }

        .summary-card {
            width: 100%;
            padding: 8px 12px;
        }

        .summary-stack {
            flex-direction: column;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .summary-text {
            font-size: 12px;
        }
    }

    /* Style pour le bouton "Oui" dans les modals de confirmation */
    ::deep .rz-dialog-footer button:first-child {
        background-color: #4CAF50 !important;
        color: white !important;
        border-color: #4CAF50 !important;
    }

    ::deep .rz-dialog-footer button:first-child:hover {
        background-color: #45a049 !important;
        border-color: #45a049 !important;
    }
</style>

@code {
    private RadzenDataGrid<ProviderInvoiceBaseInfo> providerInvoicesGrid = default!;
    private List<ProviderInvoiceBaseInfo> invoicesList = new();
    private IList<ProviderInvoiceBaseInfo> selectedInvoices = new List<ProviderInvoiceBaseInfo>();
    private int totalCount = 0;
    private decimal totalNetAmount = 0;
    private decimal totalVatAmount = 0;
    private int pageSize = GridPageSizeConstants.PageSize10;
    private SearchCriteria searchCriteria = new SearchCriteria();
    private List<ProviderResponse> _filteredProviders = new();
    private Dictionary<int, bool> _retenueMap = new Dictionary<int, bool>();
    private decimal _seuilRetenueSource = 1000;
    private double _tauxRetenu = 0;
    private decimal _timbre = 0;

    protected override async Task OnInitializedAsync()
    {
        _logger.LogInformation("ProviderInvoicesList.OnInitializedAsync called");
        
        await LoadProviders(new LoadDataArgs { Filter = string.Empty });
        await LoadAppParameters();

        // Set default period to CurrentMonth and calculate dates
        searchCriteria.PeriodFilter = "CurrentMonth";
        var (startDate, endDate) = PeriodFilterHelper.GetDateRangeFromPeriod(
            searchCriteria.PeriodFilter,
            searchCriteria.StartDate,
            searchCriteria.EndDate);
        searchCriteria.StartDate = startDate;
        searchCriteria.EndDate = endDate;

        // Load initial data
        _logger.LogInformation("Calling Callback to load initial data");
        await Callback(new LoadDataArgs { Skip = 0, Top = pageSize });
    }

    private async Task LoadAppParameters()
    {
        try
        {
            // Get active accounting year for Timbre and PourcentageRetenu
            var activeAccountingYear = await accountingYearApiClient.GetActiveAccountingYearAsync(default);
            
            // Get app params for SeuilRetenueSource (still in Systeme)
            var appParamsResult = await appParametersClient.GetAppParametersAsync(default);
            if (appParamsResult.IsT0)
            {
                var appParams = appParamsResult.AsT0;
                _seuilRetenueSource = appParams.SeuilRetenueSource;
                // Use accounting year values with fallback to app params
                _tauxRetenu = activeAccountingYear?.PourcentageRetenu ?? appParams.PourcentageRetenu;
                _timbre = activeAccountingYear?.Timbre ?? appParams.Timbre;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Error"],
                Detail = $"Failed to load app parameters: {ex.Message}"
            });
        }
    }

    async Task LoadProviders(LoadDataArgs args)
    {
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 7,
            SearchKeyword = args?.Filter ?? string.Empty
        };

        try
        {
            var pagedProviders = await ProvidersService.GetPagedAsync(parameters, default);
            _filteredProviders = pagedProviders.Items.ToList();
        }
        catch (Exception ex)
        {
            _filteredProviders = new List<ProviderResponse>();
        }

        await InvokeAsync(StateHasChanged);
    }

    private void OnPeriodFilterChanged()
    {
        StateHasChanged();
    }

    private void ViewProviderInvoice(string id)
    {
        // Navigate to manage providers invoices page
        NavigationManager.NavigateTo("/manage-providers-invoices");
    }

    private async Task SearchProviderInvoices()
    {
        // Trigger a refresh by calling Callback with current args
        await Callback(new LoadDataArgs { Skip = 0, Top = pageSize });
    }

    private async Task ValidateSelectedInvoices()
    {
        if (selectedInvoices == null || !selectedInvoices.Any())
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Warning, Summary = Localizer["Attention"], Detail = Localizer["Select_At_Least_One_ProviderInvoice"] });
            return;
        }

        var count = selectedInvoices.Count;
        var confirmed = await DialogService.Confirm(
            string.Format(Localizer["Confirmation_Validation_ProviderInvoices"], count, count > 1 ? "s" : ""),
            Localizer["Confirmation_Validation_Titre"],
            new ConfirmOptions() { OkButtonText = Localizer["Oui"], CancelButtonText = Localizer["Non"] });

        if (confirmed != true)
        {
            return;
        }

        var ids = selectedInvoices.Select(d => d.Number).ToList();
        var result = await ProviderInvoiceService.ValidateProviderInvoicesAsync(ids, default);
        
        if (result.IsSuccess)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = Localizer["Success"], Detail = Localizer["Validation_Success_ProviderInvoices"] });
            selectedInvoices.Clear();
            if (providerInvoicesGrid != null)
            {
                await providerInvoicesGrid.Reload();
            }
            else
            {
                await SearchProviderInvoices();
            }
        }
        else
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = Localizer["Error"], Detail = result.Errors.FirstOrDefault()?.Message ?? Localizer["Unexpected_Error"] });
        }
    }

    private async Task ValidateInvoice(ProviderInvoiceBaseInfo item)
    {
        var confirmed = await DialogService.Confirm(
            string.Format(Localizer["Confirmation_Validation_ProviderInvoice"], item.Number),
            Localizer["Confirmation_Validation_Titre"],
            new ConfirmOptions() { OkButtonText = Localizer["Oui"], CancelButtonText = Localizer["Non"] });

        if (confirmed != true)
        {
            return;
        }

        var result = await ProviderInvoiceService.ValidateProviderInvoicesAsync(new List<int> { item.Number }, default);
        
        if (result.IsSuccess)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = Localizer["Success"], Detail = Localizer["Validation_Success_ProviderInvoice"] });
            if (providerInvoicesGrid != null)
            {
                await providerInvoicesGrid.Reload();
            }
            else
            {
                await SearchProviderInvoices();
            }
        }
        else
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = Localizer["Error"], Detail = result.Errors.FirstOrDefault()?.Message ?? Localizer["Unexpected_Error"] });
        }
    }

    private async Task Callback(LoadDataArgs args)
    {
        _logger.LogInformation("ProviderInvoicesList.Callback called with Skip: {Skip}, Top: {Top}", args.Skip, args.Top);
        
        // Update pageSize if Top is provided
        if (args.Top.HasValue)
        {
            pageSize = args.Top.Value;
        }
        
        var (startDate, endDate) = PeriodFilterHelper.GetDateRangeFromPeriod(
            searchCriteria.PeriodFilter,
            searchCriteria.StartDate,
            searchCriteria.EndDate);

        _logger.LogInformation("Date range: StartDate: {StartDate}, EndDate: {EndDate}", startDate, endDate);

        try
        {
            _logger.LogInformation("Calling ODataService.QueryAsync for ProviderInvoiceBaseInfos");
            
            // Add Status filter to args if selected
            if (searchCriteria.Status.HasValue)
            {
                var statusFilter = $"Statut eq {searchCriteria.Status.Value}";
                if (!string.IsNullOrEmpty(args.Filter))
                {
                    args.Filter = $"({args.Filter}) and ({statusFilter})";
                }
                else
                {
                    args.Filter = statusFilter;
                }
            }

            var response = await ODataService.QueryAsync<ProviderInvoiceBaseInfo>(
                entitySet: "ProviderInvoiceBaseInfos",
                args: args,
                startDate: startDate,
                endDate: endDate,
                providerId: searchCriteria.SelectedProviderId,
                tagIds: searchCriteria.SelectedTagIds,
                cancellationToken: default);

            invoicesList = response.Value;
            totalCount = response.ODataCount ?? response.Value.Count;

            // Calculate totals from current page (for display)
            // Note: For accurate totals across all pages, we'd need a separate aggregation endpoint
            totalNetAmount = invoicesList.Sum(i => i.NetAmount);
            totalVatAmount = invoicesList.Sum(i => i.VatAmount);

            // Load retenue status for all invoices
            await LoadRetenueStatus();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading provider invoices: {Message}", ex.Message);
            invoicesList = new List<ProviderInvoiceBaseInfo>();
            totalCount = 0;
            totalNetAmount = 0;
            totalVatAmount = 0;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadRetenueStatus()
    {
        _retenueMap.Clear();
        if (invoicesList == null)
        {
            return;
        }

        foreach (var invoice in invoicesList)
        {
            try
            {
                var retenueResult = await retenueSourceFournisseurApiClient.GetRetenueSourceFournisseurAsync(invoice.Number, default);
                // Only set to true if the result is successful (IsSuccess = true means the API returned 200 OK with data)
                // If IsSuccess = false, it means either 404 (not found) or another error
                _retenueMap[invoice.Number] = retenueResult.IsSuccess;
            }
            catch
            {
                // On any exception, assume no retenue exists
                _retenueMap[invoice.Number] = false;
            }
        }
    }

    private async Task OpenRetenueDialog(int numFactureFournisseur, decimal montantTTC)
    {
        try
        {
            // Check if retenue already exists
            var existingRetenueResult = await retenueSourceFournisseurApiClient.GetRetenueSourceFournisseurAsync(numFactureFournisseur, default);
            var isEditMode = existingRetenueResult.IsSuccess;
            var existingNumTej = isEditMode ? existingRetenueResult.Value?.NumTej : null;
            
            // Load existing PDF if in edit mode
            string? existingPdfBase64 = null;
            if (isEditMode && existingRetenueResult.Value?.HasPdf == true)
            {
                try
                {
                    var pdfResult = await retenueSourceFournisseurApiClient.GetRetenueSourceFournisseurPdfAsync(numFactureFournisseur, default);
                    if (pdfResult.IsSuccess)
                    {
                        existingPdfBase64 = Convert.ToBase64String(pdfResult.Value);
                    }
                }
                catch (Exception ex)
                {
                    // Log but don't block the dialog
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Warning,
                        Summary = Localizer["warning"],
                        Detail = $"Impossible de charger le PDF existant: {ex.Message}"
                    });
                }
            }

            var dialogOptions = new DialogOptions
            {
                Width = "500px",
                Resizable = true,
                Draggable = true
            };

            // Le montantTTC passé est déjà avec timbre (depuis la liste), donc on le passe tel quel
            var result = await DialogService.OpenAsync<RetenueSourceDialog>(
                Localizer["retenue_source"],
                new Dictionary<string, object>
                {
                    { "NumFacture", numFactureFournisseur },
                    { "MontantTTC", montantTTC }, // Déjà avec timbre
                    { "TauxRetenu", _tauxRetenu },
                    { "SeuilRetenueSource", _seuilRetenueSource },
                    { "Timbre", _timbre },
                    { "ExistingNumTej", existingNumTej },
                    { "IsEditMode", isEditMode },
                    { "ExistingPdfBase64", existingPdfBase64 }
                },
                dialogOptions);

            if (result is RetenueSourceDialog.RetenueSourceDialogResult dialogResult)
            {
                if (isEditMode)
                {
                    // Update existing retenue
                    var updateRequest = new UpdateRetenueSourceFournisseurRequest
                    {
                        NumTej = dialogResult.NumTej ?? string.Empty,
                        PdfContent = dialogResult.PdfContent
                    };

                    var updateResult = await retenueSourceFournisseurApiClient.UpdateRetenueSourceFournisseurAsync(numFactureFournisseur, updateRequest, default);
                    if (updateResult.IsSuccess)
                    {
                        NotificationService.Notify(new NotificationMessage
                        {
                            Severity = NotificationSeverity.Success,
                            Summary = Localizer["Success"],
                            Detail = Localizer["retenue_source"] + " " + Localizer["updated_with_success"]
                        });
                    }
                    else
                    {
                        NotificationService.Notify(new NotificationMessage
                        {
                            Severity = NotificationSeverity.Error,
                            Summary = Localizer["Error"],
                            Detail = updateResult.Errors.FirstOrDefault()?.Message ?? Localizer["Unexpected_Error"]
                        });
                    }
                }
                else
                {
                    // Create new retenue
                    var createRequest = new CreateRetenueSourceFournisseurRequest
                    {
                        NumFactureFournisseur = numFactureFournisseur,
                        NumTej = dialogResult.NumTej ?? string.Empty,
                        PdfContent = dialogResult.PdfContent
                    };

                    var createResult = await retenueSourceFournisseurApiClient.CreateRetenueSourceFournisseurAsync(createRequest, default);
                    if (createResult.IsT0)
                    {
                        NotificationService.Notify(new NotificationMessage
                        {
                            Severity = NotificationSeverity.Success,
                            Summary = Localizer["Success"],
                            Detail = Localizer["retenue_source"] + " " + Localizer["created_with_success"]
                        });
                    }
                    else
                    {
                        var badRequest = createResult.AsT1;
                        NotificationService.Notify(new NotificationMessage
                        {
                            Severity = NotificationSeverity.Error,
                            Summary = Localizer["Error"],
                            Detail = badRequest.Detail ?? "Erreur lors de la création"
                        });
                    }
                }

                // Reload retenue status from API to ensure accuracy
                await LoadRetenueStatus();
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Error"],
                Detail = $"Erreur: {ex.Message}"
            });
        }
    }

    public class SearchCriteria
    {
        public string PeriodFilter { get; set; } = "CurrentMonth";
        public DateTime? StartDate { get; set; }
        public DateTime? EndDate { get; set; }
        public int? SelectedProviderId { get; set; }
        public List<int> SelectedTagIds { get; set; } = new();
        public int? Status { get; set; }
    }

    private async Task OnTagIdsChanged(List<int> tagIds)
    {
        searchCriteria.SelectedTagIds = tagIds;
        await SearchProviderInvoices();
    }

    private async Task ExportToSageErpAsync()
    {
        try
        {
            _logger.LogInformation("ExportToSageErpAsync called for provider invoices");

            // Build query parameters based on current search criteria
            var (startDate, endDate) = PeriodFilterHelper.GetDateRangeFromPeriod(
                searchCriteria.PeriodFilter,
                searchCriteria.StartDate,
                searchCriteria.EndDate);

            var queryParams = new List<string>();

            if (startDate.HasValue)
            {
                queryParams.Add($"startDate={Uri.EscapeDataString(startDate.Value.ToString("yyyy-MM-ddTHH:mm:ss"))}");
            }

            if (endDate.HasValue)
            {
                queryParams.Add($"endDate={Uri.EscapeDataString(endDate.Value.ToString("yyyy-MM-ddTHH:mm:ss"))}");
            }

            if (searchCriteria.SelectedProviderId.HasValue)
            {
                queryParams.Add($"providerId={searchCriteria.SelectedProviderId.Value}");
            }

            if (searchCriteria.SelectedTagIds != null && searchCriteria.SelectedTagIds.Any())
            {
                foreach (var tagId in searchCriteria.SelectedTagIds)
                {
                    queryParams.Add($"tagIds={tagId}");
                }
            }

            var baseUrl = Configuration.GetValue<string>("ApiSettings:BaseUrl") ?? throw new ArgumentNullException("ApiSettings:BaseUrl is not configured.");
            var url = $"{baseUrl}/api/provider-invoices/export/sage";
            if (queryParams.Any())
            {
                url += "?" + string.Join("&", queryParams);
            }

            try
            {
                _logger.LogInformation("Calling Sage ERP export API: {Url}", url);
                var httpClient = new HttpClient();
                var response = await httpClient.GetAsync(url);
                response.EnsureSuccessStatusCode();

                var fileBytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = response.Content.Headers.ContentDisposition?.FileNameStar ?? $"Factures_Fournisseurs_Sage_{DateTime.Now:yyyyMMdd_HHmmss}.txt";
                var contentType = response.Content.Headers.ContentType?.ToString() ?? "text/plain; charset=windows-1252";

                await JS.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes), contentType);

                _logger.LogInformation("Sage ERP export file downloaded successfully.");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error during Sage ERP export: {Message}", ex.Message);
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error in ExportToSageErpAsync: {Message}", ex.Message);
        }
    }

    private string GetStatusStyle(int statut)
    {
        return statut == 1 
            ? "background-color: #388e3c; color: #fff;" 
            : "background-color: #e1e1e1; color: #333;";
    }

    private async Task ExportToTejXmlAsync(int invoiceNumber)
    {
        try
        {
            _logger.LogInformation("ExportToTejXmlAsync called for invoice {InvoiceNumber}", invoiceNumber);

            var baseUrl = Configuration.GetValue<string>("ApiSettings:BaseUrl") 
                ?? throw new InvalidOperationException("ApiSettings:BaseUrl configuration is missing");
            
            var url = $"{baseUrl.TrimEnd('/')}/api/provider-invoices/{invoiceNumber}/export/tej-xml";

            _logger.LogInformation("Calling TEJ XML export endpoint: {Url}", url);

            var response = await HttpClient.GetAsync(url);

            if (!response.IsSuccessStatusCode)
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                _logger.LogError("TEJ XML export failed with status {StatusCode}. Response: {ErrorContent}", 
                    response.StatusCode, errorContent);
                
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Erreur",
                    Detail = response.StatusCode == System.Net.HttpStatusCode.BadRequest 
                        ? errorContent 
                        : "Erreur lors de l'export en XML TEJ. Veuillez réessayer.",
                    Duration = 4000
                });
                return;
            }

            // Get the file content
            var fileBytes = await response.Content.ReadAsByteArrayAsync();
            var fileName = response.Content.Headers.ContentDisposition?.FileName 
                ?? $"Facture_Fournisseur_{invoiceNumber}_TEJ_{DateTime.Now:yyyyMMdd_HHmmss}.xml";

            // Remove quotes from filename if present
            fileName = fileName.Trim('"');

            // Download the file using JavaScript
            var base64String = Convert.ToBase64String(fileBytes);
            await JS.InvokeVoidAsync("downloadFile", fileName, base64String, "application/xml; charset=utf-8");

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Succès",
                Detail = "Export en XML TEJ réussi.",
                Duration = 3000
            });

            _logger.LogInformation("TEJ XML export completed successfully for invoice {InvoiceNumber}", invoiceNumber);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error exporting invoice {InvoiceNumber} to TEJ XML", invoiceNumber);
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Erreur",
                Detail = $"Erreur lors de l'export: {ex.Message}",
                Duration = 4000
            });
        }
    }
}

