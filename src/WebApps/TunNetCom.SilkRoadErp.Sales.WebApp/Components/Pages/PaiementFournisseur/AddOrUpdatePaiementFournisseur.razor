@page "/paiement-fournisseur/add"
@page "/paiement-fournisseur/edit/{Id:int}"
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.PaiementFournisseur
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.PaiementFournisseur
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Providers
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ProviderInvoice
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ReceiptNote
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Banque
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AccountingYear
@using TunNetCom.SilkRoadErp.Sales.Contracts.Providers
@using TunNetCom.SilkRoadErp.Sales.Contracts.ProviderInvoice
@using TunNetCom.SilkRoadErp.Sales.Contracts.RecieptNotes
@using TunNetCom.SilkRoadErp.Sales.Contracts.Banque
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@using Radzen.Blazor
@using Radzen
@using Microsoft.JSInterop
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> Localizer
@inject IPaiementFournisseurApiClient PaiementFournisseurService
@inject IProvidersApiClient ProvidersService
@inject IProviderInvoiceApiClient ProviderInvoiceService
@inject IReceiptNoteApiClient ReceiptNoteService
@inject IBanqueApiClient BanqueService
@inject IAccountingYearApiClient AccountingYearService
@inject ToastService ToastService
@inject Radzen.NotificationService NotificationService
@inject DialogService DialogService
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration
@inject IAuthService AuthService
@inject ILogger<AddOrUpdatePaiementFournisseur> Logger

<div class="paiement-form-container">
    <div class="paiement-form-card">
        <div class="paiement-form-header">
            <h3>@(IsEditMode ? Localizer["Modifier_Paiement"] : Localizer["Nouveau_Paiement_Fournisseur"])</h3>
            <RadzenButton Icon="arrow_back" Text="@Localizer["Retour"]"
                          ButtonStyle="ButtonStyle.Secondary"
                          Click="GoBack"
                          Variant="Variant.Outlined" />
        </div>

        <RadzenStack Gap="1.5rem">
            <RadzenFormField Text="@Localizer["Numero"]" class="rz-col-12 rz-md-6">
                <RadzenTextBox @bind-Value="paiement.NumeroTransactionBancaire" Placeholder="@Localizer["Numero_Transaction_Bancaire"]" />
                <RadzenFormFieldDescription>@Localizer["Numero_Transaction_Bancaire_Description"]</RadzenFormFieldDescription>
            </RadzenFormField>

            <RadzenFormField Text="@($"{Localizer["providers"]} *")" class="rz-col-12 rz-md-6">
                <RadzenDropDownDataGrid AllowClear="false"
                                        IsLoading="@isLoadingProviders"
                                        @bind-Value="@paiement.FournisseurId"
                                        LoadData="@LoadProviders"
                                        AllowFiltering="true"
                                        Style="width: 100%;"
                                        Data="@_filteredProviders"
                                        TextProperty="@nameof(ProviderResponse.Nom)"
                                        ValueProperty="@nameof(ProviderResponse.Id)"
                                        Placeholder="@Localizer["Select_Provider"]"
                                        Change="@OnProviderChanged">
                    <Columns>
                        <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Id)" Title="ID" Width="80px" />
                        <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Nom)" Title="@Localizer["Nom"]" Width="220px" />
                    </Columns>
                </RadzenDropDownDataGrid>
            </RadzenFormField>

            <RadzenFormField Text="@($"{Localizer["Exercice_Comptable"]} *")" class="rz-col-12 rz-md-6">
                <RadzenTextBox Value="@(activeAccountingYear?.Year.ToString() ?? Localizer["Chargement"])" 
                               ReadOnly="true" 
                               Style="width: 100%;" />
            </RadzenFormField>

            <RadzenFormField Text="@($"{Localizer["Montant"]} *")" class="rz-col-12 rz-md-6">
                <RadzenNumeric @bind-Value="paiement.Montant" Min="0" Format="@AmountHelper.FORMAT_N2" Style="width: 100%;" />
            </RadzenFormField>

            <RadzenFormField Text="@($"{Localizer["Date_Paiement"]} *")" class="rz-col-12 rz-md-6">
                <RadzenDatePicker @bind-Value="paiement.DatePaiement" DateFormat="dd/MM/yyyy" ShowTime="false" Style="width: 100%;" />
            </RadzenFormField>

            <RadzenFormField Text="@($"{Localizer["Methode_Paiement"]} *")" class="rz-col-12 rz-md-6">
                <RadzenDropDown @bind-Value="selectedMethodePaiement"
                                Data="@methodePaiementOptions"
                                TextProperty="Text"
                                ValueProperty="Value"
                                Placeholder="@Localizer["Select_Methode"]"
                                AllowClear="false"
                                Style="width: 100%;"
                                Change="@OnMethodePaiementChangedAsync" />
            </RadzenFormField>

            @if (selectedMethodePaiement == "Cheque" || selectedMethodePaiement == "Traite")
            {
                <RadzenFormField Text="@Localizer["Numero_Cheque_Traite"]" class="rz-col-12 rz-md-6">
                    <RadzenTextBox @bind-Value="paiement.NumeroChequeTraite" Placeholder="@Localizer["Numero"]" />
                </RadzenFormField>

                <RadzenFormField Text="@Localizer["Banque"]" class="rz-col-12 rz-md-6">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Style="width: 100%;">
                        <RadzenDropDown @bind-Value="paiement.BanqueId"
                                        Data="@banques"
                                        TextProperty="Nom"
                                        ValueProperty="Id"
                                        Placeholder="@Localizer["Select_Banque"]"
                                        AllowClear="true"
                                        Style="flex: 1;" />
                        <RadzenButton Icon="add" Text="@Localizer["Nouvelle_Banque"]"
                                      ButtonStyle="ButtonStyle.Success"
                                      Variant="Variant.Outlined"
                                      Size="ButtonSize.Small"
                                      Click="@OpenAddBanqueDialog" />
                    </RadzenStack>
                </RadzenFormField>

                @if (selectedMethodePaiement == "Traite")
                {
                    <RadzenFormField Text="@Localizer["Date_Echeance"]" class="rz-col-12 rz-md-6">
                        <RadzenDatePicker @bind-Value="paiement.DateEcheance" DateFormat="dd/MM/yyyy" ShowTime="false" Style="width: 100%;" />
                    </RadzenFormField>
                }
            }

            @if (selectedMethodePaiement == "Traite" || selectedMethodePaiement == "Virement")
            {
                <RadzenFormField Text="@Localizer["RIB_Code_Etablissement"]" class="rz-col-12 rz-md-3">
                    <RadzenTextBox @bind-Value="paiement.RibCodeEtab" Placeholder="@Localizer["Code_Etab"]" MaxLength="10" />
                </RadzenFormField>

                <RadzenFormField Text="@Localizer["RIB_Code_Agence"]" class="rz-col-12 rz-md-3">
                    <RadzenTextBox @bind-Value="paiement.RibCodeAgence" Placeholder="@Localizer["Code_Agence"]" MaxLength="10" />
                </RadzenFormField>

                <RadzenFormField Text="@Localizer["RIB_Numero_Compte"]" class="rz-col-12 rz-md-3">
                    <RadzenTextBox @bind-Value="paiement.RibNumeroCompte" Placeholder="@Localizer["Numero_Compte"]" MaxLength="20" />
                </RadzenFormField>

                <RadzenFormField Text="@Localizer["RIB_Cle"]" class="rz-col-12 rz-md-3">
                    <RadzenTextBox @bind-Value="paiement.RibCle" Placeholder="@Localizer["Cle"]" MaxLength="5" />
                </RadzenFormField>
            }

            @if (paiement.FournisseurId > 0 && !selectedBonDeReceptionIds.Any())
            {
                <RadzenFormField Text="@Localizer["Facture_Fournisseur_Optionnel"]" class="rz-col-12 rz-md-6">
                    <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.5rem">
                        <RadzenDropDown @bind-Value="@selectedInvoiceToAdd"
                                       Data="@AvailableInvoices"
                                       TextProperty="@nameof(ProviderInvoiceResponse.ProviderInvoiceNumber)"
                                       ValueProperty="@nameof(ProviderInvoiceResponse.Id)"
                                       Placeholder="@Localizer["Select_Facture_Fournisseur"]"
                                       AllowFiltering="true"
                                       FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                       Change="@OnInvoiceSelected"
                                       Style="width: 100%;"
                                       Disabled="@isLoadingInvoices" />
                        
                        @if (SelectedInvoices.Any())
                        {
                            <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.5rem" Style="margin-top: 0.5rem;">
                                <RadzenText TextStyle="TextStyle.Body2" Style="font-weight: 600;">@Localizer["Selected_Factures"] (@selectedFactureFournisseurIds.Count)</RadzenText>
                                @foreach (var invoice in SelectedInvoices)
                                {
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Style="align-items: center; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                                        <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0" Style="flex: 1;">
                                            <RadzenText TextStyle="TextStyle.Body2" Style="font-weight: 500;">@invoice.ProviderInvoiceNumber</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Caption" Style="color: #666;">@invoice.DateFacturation.ToString("dd/MM/yyyy") - @invoice.TotTTC.ToString("N2")</RadzenText>
                                        </RadzenStack>
                                        <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" 
                                                    Click="@(() => RemoveInvoice(invoice))" 
                                                    Title="@Localizer["Remove"]" />
                                    </RadzenStack>
                                }
                            </RadzenStack>
                        }
                    </RadzenStack>
                </RadzenFormField>
            }

            @if (paiement.FournisseurId > 0 && !selectedFactureFournisseurIds.Any())
            {
                <RadzenFormField Text="@Localizer["Bon_Reception_Optionnel"]" class="rz-col-12 rz-md-6">
                    <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.5rem">
                        <RadzenDropDown @bind-Value="@selectedReceiptNoteToAdd"
                                       Data="@AvailableReceiptNotes"
                                       TextProperty="@nameof(ReceiptNoteDetailsResponse.Num)"
                                       ValueProperty="@nameof(ReceiptNoteDetailsResponse.Id)"
                                       Placeholder="@Localizer["Select_Bon_Reception"]"
                                       AllowFiltering="true"
                                       FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                       Change="@OnReceiptNoteSelected"
                                       Style="width: 100%;"
                                       Disabled="@isLoadingReceiptNotes" />
                        
                        @if (SelectedReceiptNotes.Any())
                        {
                            <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.5rem" Style="margin-top: 0.5rem;">
                                <RadzenText TextStyle="TextStyle.Body2" Style="font-weight: 600;">@Localizer["Selected_Bon_Reception"] (@selectedBonDeReceptionIds.Count)</RadzenText>
                                @foreach (var receiptNote in SelectedReceiptNotes)
                                {
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Style="align-items: center; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                                        <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0" Style="flex: 1;">
                                            <RadzenText TextStyle="TextStyle.Body2" Style="font-weight: 500;">@receiptNote.Num</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Caption" Style="color: #666;">@receiptNote.Date.ToString("dd/MM/yyyy") - @receiptNote.TotTTC.ToString("N2")</RadzenText>
                                        </RadzenStack>
                                        <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" 
                                                    Click="@(() => RemoveReceiptNote(receiptNote))" 
                                                    Title="@Localizer["Remove"]" />
                                    </RadzenStack>
                                }
                            </RadzenStack>
                        }
                    </RadzenStack>
                </RadzenFormField>
            }

            <RadzenFormField Text="@Localizer["Commentaire"]" class="rz-col-12">
                <RadzenTextArea @bind-Value="paiement.Commentaire" Placeholder="@Localizer["Commentaire_Optionnel"]" Rows="3" Style="width: 100%;" />
            </RadzenFormField>

            @if (selectedMethodePaiement == "Cheque" || selectedMethodePaiement == "Traite" || selectedMethodePaiement == "Virement")
            {
                <RadzenFormField Text="@Localizer["Document_Paiement"]" class="rz-col-12">
                    <RadzenCard Style="padding: 1rem;">
                        <RadzenStack Gap="1rem">
                            @if (!string.IsNullOrWhiteSpace(documentPreview) || !string.IsNullOrWhiteSpace(existingDocumentPath))
                            {
                                <div style="text-align: center;">
                                    @if (!string.IsNullOrWhiteSpace(documentPreview))
                                    {
                                        @if (documentPreview.StartsWith("data:application/pdf", StringComparison.OrdinalIgnoreCase))
                                        {
                                            <RadzenStack Gap="0.5rem">
                                                <iframe src="@documentPreview" style="width: 100%; height: 400px; border: 1px solid #ddd; border-radius: 4px;" frameborder="0"></iframe>
                                                <RadzenButton Text="@Localizer["Supprimer"]" Icon="delete" 
                                                            ButtonStyle="ButtonStyle.Danger" 
                                                            Size="ButtonSize.Small"
                                                            Click="RemoveDocument" />
                                            </RadzenStack>
                                        }
                                        else
                                        {
                                            <RadzenStack Gap="0.5rem">
                                                <img src="@documentPreview" alt="Document preview" style="max-width: 100%; max-height: 400px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" 
                                                     @onclick="@(() => ShowImagePreview(documentPreview))" />
                                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" JustifyContent="Radzen.JustifyContent.Center">
                                                    <RadzenButton Text="@Localizer["Voir_Image"]" Icon="visibility" 
                                                                ButtonStyle="ButtonStyle.Info" 
                                                                Size="ButtonSize.Small"
                                                                Click="@(() => ShowImagePreview(documentPreview))" />
                                                    <RadzenButton Text="@Localizer["Supprimer"]" Icon="delete" 
                                                                ButtonStyle="ButtonStyle.Danger" 
                                                                Size="ButtonSize.Small"
                                                                Click="RemoveDocument" />
                                                </RadzenStack>
                                            </RadzenStack>
                                        }
                                    }
                                    else if (!string.IsNullOrWhiteSpace(existingDocumentPath) && !string.IsNullOrWhiteSpace(existingDocumentPreview))
                                    {
                                        @if (existingDocumentPreview.StartsWith("data:application/pdf", StringComparison.OrdinalIgnoreCase))
                                        {
                                            <RadzenStack Gap="0.5rem">
                                                <iframe src="@existingDocumentPreview" style="width: 100%; height: 400px; border: 1px solid #ddd; border-radius: 4px;" frameborder="0"></iframe>
                                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" JustifyContent="Radzen.JustifyContent.Center">
                                                    <RadzenButton Text="@Localizer["Ouvrir_Dans_Nouvel_Onglet"]" Icon="open_in_new" 
                                                                ButtonStyle="ButtonStyle.Info" 
                                                                Size="ButtonSize.Small"
                                                                Click="@(() => OpenExistingDocumentInNewTab())" />
                                                    <RadzenButton Text="@Localizer["Supprimer"]" Icon="delete" 
                                                                ButtonStyle="ButtonStyle.Danger" 
                                                                Size="ButtonSize.Small"
                                                                Click="RemoveDocument" />
                                                </RadzenStack>
                                            </RadzenStack>
                                        }
                                        else
                                        {
                                            <RadzenStack Gap="0.5rem">
                                                <img src="@existingDocumentPreview" alt="Document preview" style="max-width: 100%; max-height: 400px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" 
                                                     @onclick="@(() => ShowImagePreview(existingDocumentPreview))" />
                                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" JustifyContent="Radzen.JustifyContent.Center">
                                                    <RadzenButton Text="@Localizer["Voir_Image"]" Icon="visibility" 
                                                                ButtonStyle="ButtonStyle.Info" 
                                                                Size="ButtonSize.Small"
                                                                Click="@(() => ShowImagePreview(existingDocumentPreview))" />
                                                    <RadzenButton Text="@Localizer["Ouvrir_Dans_Nouvel_Onglet"]" Icon="open_in_new" 
                                                                ButtonStyle="ButtonStyle.Info" 
                                                                Size="ButtonSize.Small"
                                                                Click="@(() => OpenExistingDocumentInNewTab())" />
                                                    <RadzenButton Text="@Localizer["Supprimer"]" Icon="delete" 
                                                                ButtonStyle="ButtonStyle.Danger" 
                                                                Size="ButtonSize.Small"
                                                                Click="RemoveDocument" />
                                                </RadzenStack>
                                            </RadzenStack>
                                        }
                                    }
                                    else if (!string.IsNullOrWhiteSpace(existingDocumentPath))
                                    {
                                        <RadzenStack Gap="0.5rem">
                                            <RadzenIcon Icon="attach_file" Style="font-size: 48px; color: #2196F3;" />
                                            <div>@Localizer["Chargement_Document"]...</div>
                                        </RadzenStack>
                                    }
                                </div>
                            }
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" JustifyContent="Radzen.JustifyContent.Center">
                                <RadzenButton Text="Caméra" Icon="camera_alt" Size="ButtonSize.Small" 
                                            Click="CaptureDocumentFromCamera" 
                                            Disabled="@isSaving" />
                                <RadzenButton Text="Fichier" Icon="attach_file" Size="ButtonSize.Small" 
                                            ButtonStyle="ButtonStyle.Secondary"
                                            Click="TriggerFileInput" 
                                            Disabled="@isSaving" />
                            </RadzenStack>
                            <InputFile OnChange="HandleFileSelected" 
                                     accept="image/*,application/pdf" 
                                     style="display: none;" 
                                     id="fileInputDocument"
                                     @ref="fileInputElement" />
                        </RadzenStack>
                    </RadzenCard>
                </RadzenFormField>
            }

            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" JustifyContent="Radzen.JustifyContent.End" class="rz-col-12">
                <RadzenButton Text="@Localizer["Annuler"]" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Outlined" Click="GoBack" />
                <RadzenButton Text="@(IsEditMode ? Localizer["Modifier"] : Localizer["Creer"])" 
                              ButtonStyle="ButtonStyle.Primary" 
                              Click="@SavePaiement"
                              IsBusy="@isSaving" />
            </RadzenStack>
        </RadzenStack>
    </div>
</div>

<style>
    .paiement-form-container {
        padding: 0;
        margin: 0;
    }

    .paiement-form-card {
        background: transparent;
        border-radius: 0;
        box-shadow: none;
        padding: 1rem;
    }

    .paiement-form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e0e0e0;
    }

    .paiement-form-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }
</style>

@code {
    [Parameter] public int? Id { get; set; }
    
    private bool IsEditMode => Id.HasValue;
    private bool isLoadingProviders = false;
    private bool isLoadingInvoices = false;
    private bool isLoadingReceiptNotes = false;
    private bool isSaving = false;
    private CreatePaiementFournisseurRequest paiement = new();
    private GetActiveAccountingYearResponse? activeAccountingYear;
    private string? selectedMethodePaiement;
    private List<ProviderResponse> _filteredProviders = new();
    private List<ProviderInvoiceResponse> _filteredInvoices = new();
    private List<ReceiptNoteDetailsResponse> _filteredReceiptNotes = new();
    private List<int> selectedFactureFournisseurIds = new();
    private List<int> selectedBonDeReceptionIds = new();
    private int? selectedInvoiceToAdd;
    private int? selectedReceiptNoteToAdd;
    private List<BanqueResponse> banques = new();
    private CancellationTokenSource cancellationTokenSource = new();

    private List<MethodePaiementOption> methodePaiementOptions = new();

    // Document upload properties
    private string? documentBase64;
    private string? documentPreview;
    private string? existingDocumentPath;
    private string? existingDocumentPreview;
    private InputFile? fileInputElement;

    private class MethodePaiementOption
    {
        public string Text { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            methodePaiementOptions = new()
            {
                new MethodePaiementOption { Text = Localizer["Espece"], Value = "Espece" },
                new MethodePaiementOption { Text = Localizer["Cheque"], Value = "Cheque" },
                new MethodePaiementOption { Text = Localizer["Traite"], Value = "Traite" },
                new MethodePaiementOption { Text = Localizer["Virement"], Value = "Virement" }
            };
            
            await LoadActiveAccountingYearAsync();
            await LoadBanquesAsync();
            
            if (IsEditMode && Id.HasValue)
            {
                await LoadPaiementAsync(Id.Value);
            }
            else
            {
                paiement.DatePaiement = DateTime.Now;
            }
        }
        catch (Exception ex)
        {
            throw;
        }
    }

    async Task LoadActiveAccountingYearAsync()
    {
        try
        {
            activeAccountingYear = await AccountingYearService.GetActiveAccountingYearAsync();
            if (activeAccountingYear == null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["Attention"],
                    Detail = Localizer["No_Accounting_Year"]
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Accounting_Year"]}: {ex.Message}"
            });
        }
    }

    async Task LoadBanquesAsync()
    {
        try
        {
            banques = await BanqueService.GetBanquesAsync(cancellationTokenSource.Token);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Banques"]}: {ex.Message}"
            });
        }
    }

    async Task LoadPaiementAsync(int id)
    {
        try
        {
            var result = await PaiementFournisseurService.GetPaiementFournisseurAsync(id, cancellationTokenSource.Token);
            if (result.IsSuccess)
            {
                var paiementResponse = result.Value;
                paiement = new CreatePaiementFournisseurRequest
                {
                    NumeroTransactionBancaire = paiementResponse.NumeroTransactionBancaire,
                    FournisseurId = paiementResponse.FournisseurId,
                    Montant = paiementResponse.Montant,
                    DatePaiement = paiementResponse.DatePaiement,
                    MethodePaiement = paiementResponse.MethodePaiement,
                    FactureFournisseurIds = paiementResponse.FactureFournisseurIds,
                    BonDeReceptionIds = paiementResponse.BonDeReceptionIds,
                    NumeroChequeTraite = paiementResponse.NumeroChequeTraite,
                    BanqueId = paiementResponse.BanqueId,
                    DateEcheance = paiementResponse.DateEcheance,
                    Commentaire = paiementResponse.Commentaire,
                    RibCodeEtab = paiementResponse.RibCodeEtab,
                    RibCodeAgence = paiementResponse.RibCodeAgence,
                    RibNumeroCompte = paiementResponse.RibNumeroCompte,
                    RibCle = paiementResponse.RibCle
                };
                selectedFactureFournisseurIds = paiementResponse.FactureFournisseurIds?.ToList() ?? new List<int>();
                selectedBonDeReceptionIds = paiementResponse.BonDeReceptionIds?.ToList() ?? new List<int>();
                selectedMethodePaiement = paiementResponse.MethodePaiement;
                existingDocumentPath = paiementResponse.DocumentStoragePath;
                
                // Load existing document preview if available
                if (!string.IsNullOrWhiteSpace(existingDocumentPath))
                {
                    await LoadExistingDocumentPreviewAsync();
                }
                
                if (paiement.FournisseurId > 0)
                {
                    // Load the selected provider into the filtered list so the dropdown can display it
                    var providerResult = await ProvidersService.GetAsync(paiement.FournisseurId, cancellationTokenSource.Token);
                    if (providerResult.IsT0)
                    {
                        var provider = providerResult.AsT0;
                        _filteredProviders = new List<ProviderResponse> { provider };
                        await InvokeAsync(StateHasChanged);
                    }
                    
                    await LoadInvoicesForProvider(paiement.FournisseurId);
                    await LoadReceiptNotesForProvider(paiement.FournisseurId);
                }
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["Erreur"],
                    Detail = Localizer["Erreur_Chargement_Paiement"]
                });
                NavigationManager.NavigateTo("/paiements-fournisseur");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement"]}: {ex.Message}"
            });
        }
    }

    async Task LoadProviders(LoadDataArgs args)
    {
        isLoadingProviders = true;
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 10,
            SearchKeyword = args?.Filter ?? string.Empty
        };

        try
        {
            var pagedProviders = await ProvidersService.GetPagedAsync(parameters, cancellationTokenSource.Token);
            _filteredProviders = pagedProviders.Items;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Providers"]}: {ex.Message}"
            });
            _filteredProviders = new List<ProviderResponse>();
        }

        isLoadingProviders = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task OnProviderChanged(object? value)
    {
        if (value is int providerId && providerId > 0)
        {
            await LoadInvoicesForProvider(providerId);
            await LoadReceiptNotesForProvider(providerId);
            
            // Auto-fill RIB from provider if method is Traite or Virement
            if (selectedMethodePaiement == "Traite" || selectedMethodePaiement == "Virement")
            {
                await FillRibFromProvider(providerId);
            }
        }
        else
        {
            _filteredInvoices = new List<ProviderInvoiceResponse>();
            _filteredReceiptNotes = new List<ReceiptNoteDetailsResponse>();
        }
    }

    async Task LoadInvoicesForProvider(int providerId)
    {
        isLoadingInvoices = true;
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 50,
            SearchKeyword = null
        };

        try
        {
            var result = await ProviderInvoiceService.GetProvidersInvoicesAsync(providerId, parameters, cancellationTokenSource.Token);
            if (result.IsT0)
            {
                _filteredInvoices = result.AsT0.Invoices.Items;
                // Ensure selected invoices are still in the list (for update mode)
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Factures_Fournisseur"]}: {ex.Message}"
            });
        }

        isLoadingInvoices = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task LoadInvoices(LoadDataArgs args)
    {
        if (paiement.FournisseurId > 0)
        {
            await LoadInvoicesForProvider(paiement.FournisseurId);
        }
    }

    async Task LoadReceiptNotesForProvider(int providerId)
    {
        isLoadingReceiptNotes = true;
        try
        {
            var parameters = new QueryStringParameters
            {
                PageNumber = 1,
                PageSize = 50,
                SearchKeyword = null
            };
            
            var result = await ReceiptNoteService.GetReceiptNoteWithSummaries(
                providerId: providerId,
                IsInvoiced: null,
                InvoiceId: null,
                queryParameters: parameters,
                cancellationToken: cancellationTokenSource.Token);
            
            if (result.IsSuccess)
            {
                _filteredReceiptNotes = result.Value.ReceiptNotes.Items;
                // Ensure selected receipt notes are still in the list (for update mode)
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_BR"]}: {ex.Message}"
            });
        }

        isLoadingReceiptNotes = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task LoadReceiptNotes(LoadDataArgs args)
    {
        if (paiement.FournisseurId > 0)
        {
            await LoadReceiptNotesForProvider(paiement.FournisseurId);
        }
    }

    // Computed properties for available and selected items
    private List<ProviderInvoiceResponse> AvailableInvoices => 
        _filteredInvoices.Where(i => !selectedFactureFournisseurIds.Contains(i.Id)).ToList();
    
    private List<ProviderInvoiceResponse> SelectedInvoices => 
        _filteredInvoices.Where(i => selectedFactureFournisseurIds.Contains(i.Id)).ToList();
    
    private List<ReceiptNoteDetailsResponse> AvailableReceiptNotes => 
        _filteredReceiptNotes.Where(r => !selectedBonDeReceptionIds.Contains(r.Id)).ToList();
    
    private List<ReceiptNoteDetailsResponse> SelectedReceiptNotes => 
        _filteredReceiptNotes.Where(r => selectedBonDeReceptionIds.Contains(r.Id)).ToList();

    void OnInvoiceSelected(object? value)
    {
        if (value is int invoiceId && invoiceId > 0)
        {
            var invoice = _filteredInvoices.FirstOrDefault(i => i.Id == invoiceId);
            if (invoice != null && !selectedFactureFournisseurIds.Contains(invoice.Id))
            {
                selectedFactureFournisseurIds.Add(invoice.Id);
                selectedInvoiceToAdd = null; // Reset dropdown
                StateHasChanged();
            }
        }
    }

    void RemoveInvoice(ProviderInvoiceResponse invoice)
    {
        selectedFactureFournisseurIds.Remove(invoice.Id);
        StateHasChanged();
    }

    void OnReceiptNoteSelected(object? value)
    {
        if (value is int receiptNoteId && receiptNoteId > 0)
        {
            var receiptNote = _filteredReceiptNotes.FirstOrDefault(r => r.Id == receiptNoteId);
            if (receiptNote != null && !selectedBonDeReceptionIds.Contains(receiptNote.Id))
            {
                selectedBonDeReceptionIds.Add(receiptNote.Id);
                selectedReceiptNoteToAdd = null; // Reset dropdown
                StateHasChanged();
            }
        }
    }

    void RemoveReceiptNote(ReceiptNoteDetailsResponse receiptNote)
    {
        selectedBonDeReceptionIds.Remove(receiptNote.Id);
        StateHasChanged();
    }

    async Task OnMethodePaiementChangedAsync(object? value)
    {
        if (value is string methode)
        {
            selectedMethodePaiement = methode;
            paiement.MethodePaiement = methode;
            if (methode != "Cheque" && methode != "Traite")
            {
                paiement.NumeroChequeTraite = null;
                paiement.BanqueId = null;
                paiement.DateEcheance = null;
            }
            if (methode != "Traite" && methode != "Virement")
            {
                paiement.RibCodeEtab = null;
                paiement.RibCodeAgence = null;
                paiement.RibNumeroCompte = null;
                paiement.RibCle = null;
            }
            else if ((methode == "Traite" || methode == "Virement") && paiement.FournisseurId > 0)
            {
                // Auto-fill RIB from provider when method changes to Traite or Virement
                await FillRibFromProvider(paiement.FournisseurId);
            }
        }
    }

    async Task FillRibFromProvider(int providerId)
    {
        try
        {
            var providerResult = await ProvidersService.GetAsync(providerId, cancellationTokenSource.Token);
            if (providerResult.IsT0)
            {
                var provider = providerResult.AsT0;
                // Only fill if RIB fields are not already filled and provider has RIB
                if (string.IsNullOrWhiteSpace(paiement.RibCodeEtab) && 
                    !string.IsNullOrWhiteSpace(provider.RibCodeEtab))
                {
                    paiement.RibCodeEtab = provider.RibCodeEtab;
                    paiement.RibCodeAgence = provider.RibCodeAgence;
                    paiement.RibNumeroCompte = provider.RibNumeroCompte;
                    paiement.RibCle = provider.RibCle;
                    await InvokeAsync(StateHasChanged);
                }
            }
        }
        catch (Exception ex)
        {
            // Silently fail - RIB auto-fill is optional
            System.Diagnostics.Debug.WriteLine($"Error loading provider RIB: {ex.Message}");
        }
    }

    async Task OpenAddBanqueDialog()
    {
        await LoadBanquesAsync();
    }

    async Task SavePaiement()
    {
        if (paiement.FournisseurId <= 0)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Validation"],
                Detail = Localizer["Select_Provider_Validation"]
            });
            return;
        }

        if (activeAccountingYear == null)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Validation"],
                Detail = Localizer["No_Accounting_Year_Validation"]
            });
            return;
        }

        if (string.IsNullOrWhiteSpace(paiement.MethodePaiement))
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Validation"],
                Detail = Localizer["Select_Methode_Validation"]
            });
            return;
        }

        isSaving = true;
        try
        {
            if (IsEditMode && Id.HasValue)
            {
                // Validate exclusivity
                if (selectedFactureFournisseurIds.Count > 0 && selectedBonDeReceptionIds.Count > 0)
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Warning,
                        Summary = Localizer["Validation"],
                        Detail = "Vous ne pouvez pas sélectionner à la fois des factures et des bons de réception"
                    });
                    isSaving = false;
                    return;
                }

                var updateRequest = new UpdatePaiementFournisseurRequest
                {
                    NumeroTransactionBancaire = paiement.NumeroTransactionBancaire,
                    FournisseurId = paiement.FournisseurId,
                    Montant = paiement.Montant,
                    DatePaiement = paiement.DatePaiement,
                    MethodePaiement = paiement.MethodePaiement,
                    FactureFournisseurIds = selectedFactureFournisseurIds.Count > 0 ? selectedFactureFournisseurIds : null,
                    BonDeReceptionIds = selectedBonDeReceptionIds.Count > 0 ? selectedBonDeReceptionIds : null,
                    NumeroChequeTraite = paiement.NumeroChequeTraite,
                    BanqueId = paiement.BanqueId,
                    DateEcheance = paiement.DateEcheance,
                    Commentaire = paiement.Commentaire,
                    RibCodeEtab = paiement.RibCodeEtab,
                    RibCodeAgence = paiement.RibCodeAgence,
                    RibNumeroCompte = paiement.RibNumeroCompte,
                    RibCle = paiement.RibCle,
                    DocumentBase64 = documentBase64
                };

                var result = await PaiementFournisseurService.UpdatePaiementFournisseurAsync(Id.Value, updateRequest, cancellationTokenSource.Token);
                if (result.IsSuccess)
                {
                    ToastService.Notify(new(ToastType.Success, Localizer["Paiement_Modifie"]));
                    NavigationManager.NavigateTo("/paiements-fournisseur");
                }
                else
                {
                    ToastService.Notify(new(ToastType.Danger, $"{Localizer["Erreur"]}: {result.Errors.FirstOrDefault()?.Message}"));
                }
            }
            else
            {
                // Validate exclusivity
                if (selectedFactureFournisseurIds.Count > 0 && selectedBonDeReceptionIds.Count > 0)
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Warning,
                        Summary = Localizer["Validation"],
                        Detail = "Vous ne pouvez pas sélectionner à la fois des factures et des bons de réception"
                    });
                    isSaving = false;
                    return;
                }

                paiement.FactureFournisseurIds = selectedFactureFournisseurIds.Count > 0 ? selectedFactureFournisseurIds : null;
                paiement.BonDeReceptionIds = selectedBonDeReceptionIds.Count > 0 ? selectedBonDeReceptionIds : null;
                paiement.DocumentBase64 = documentBase64;

                var result = await PaiementFournisseurService.CreatePaiementFournisseurAsync(paiement, cancellationTokenSource.Token);

                if (result.IsT0)
                {
                    ToastService.Notify(new(ToastType.Success, Localizer["Paiement_Cree"]));
                    NavigationManager.NavigateTo("/paiements-fournisseur");
                }
                else
                {
                    var badRequest = result.AsT1;
                    ToastService.Notify(new(ToastType.Danger, $"{Localizer["Erreur"]}: {badRequest.Detail}"));
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Sauvegarde"]}: {ex.Message}"
            });
        }
        finally
        {
            isSaving = false;
        }
    }

    void GoBack()
    {
        NavigationManager.NavigateTo("/paiements-fournisseur");
    }

    private async Task CaptureDocumentFromCamera()
    {
        try
        {
            var base64Image = await JSRuntime.InvokeAsync<string>("window.captureImageFromCamera");
            
            if (string.IsNullOrEmpty(base64Image))
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["Erreur"],
                    Detail = "Erreur lors de la capture de l'image"
                });
                return;
            }

            // Check image size (base64 is ~33% larger than binary)
            var imageSizeBytes = (base64Image.Length * 3) / 4;
            const long maxImageSize = 5 * 1024 * 1024; // 5MB
            
            if (imageSizeBytes > maxImageSize)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["Erreur"],
                    Detail = $"L'image est trop grande ({(imageSizeBytes / 1024 / 1024):F2} MB). Taille maximale: 5 MB"
                });
                return;
            }

            documentBase64 = base64Image;
            documentPreview = $"data:image/jpeg;base64,{base64Image}";
            existingDocumentPath = null; // Clear existing path when new document is uploaded
            await InvokeAsync(StateHasChanged);
            
            ToastService.Notify(new(ToastType.Success, "Document capturé avec succès"));
        }
        catch (JSException ex)
        {
            var errorMessage = ex.Message.Contains("cancelled") || ex.Message.Contains("annulée")
                ? "Capture annulée" 
                : $"Erreur lors de l'accès à la caméra: {ex.Message}";
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = errorMessage
            });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"Erreur: {ex.Message}"
            });
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file == null) return;

            // Limit file size to 5MB
            const long maxFileSize = 5 * 1024 * 1024;
            if (file.Size > maxFileSize)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["Erreur"],
                    Detail = "La taille maximale du fichier est de 5 MB"
                });
                return;
            }

            // Check file type
            if (!file.ContentType.StartsWith("image/") && file.ContentType != "application/pdf")
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["Erreur"],
                    Detail = "Veuillez sélectionner un fichier image ou PDF"
                });
                return;
            }

            // Read file and convert to base64
            using var stream = file.OpenReadStream(maxFileSize);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var fileBytes = memoryStream.ToArray();
            var base64 = Convert.ToBase64String(fileBytes);

            documentBase64 = base64;
            
            if (file.ContentType == "application/pdf")
            {
                documentPreview = "data:application/pdf;base64," + base64;
            }
            else
            {
                documentPreview = $"data:{file.ContentType};base64,{base64}";
            }
            
            existingDocumentPath = null; // Clear existing path when new document is uploaded
            await InvokeAsync(StateHasChanged);
            
            ToastService.Notify(new(ToastType.Success, "Fichier sélectionné avec succès"));
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"Erreur lors du téléchargement du fichier: {ex.Message}"
            });
        }
    }

    private void RemoveDocument()
    {
        documentBase64 = null;
        documentPreview = null;
        existingDocumentPath = null;
        existingDocumentPreview = null;
        StateHasChanged();
    }

    private async Task TriggerFileInput()
    {
        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('fileInputDocument')?.click()");
    }

    private async Task LoadExistingDocumentPreviewAsync()
    {
        if (!string.IsNullOrWhiteSpace(existingDocumentPath) && Id.HasValue)
        {
            try
            {
                var baseUrl = Configuration.GetValue<string>("ApiSettings:BaseUrl")
                    ?? throw new InvalidOperationException("ApiSettings:BaseUrl configuration is missing");
                
                var url = $"{baseUrl.TrimEnd('/')}/paiement-fournisseur/{Id.Value}/document";
                
                // Create HttpClient with authentication
                using var httpClient = new HttpClient();
                httpClient.BaseAddress = new Uri(baseUrl);
                
                // Add authentication token
                var token = AuthService.AccessToken;
                if (!string.IsNullOrEmpty(token))
                {
                    httpClient.DefaultRequestHeaders.Authorization = 
                        new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
                }
                
                var response = await httpClient.GetAsync(url, cancellationTokenSource.Token);
                
                if (!response.IsSuccessStatusCode)
                {
                    Logger.LogWarning("Unable to load document preview. Status: {StatusCode}", response.StatusCode);
                    return;
                }
                
                var documentBytes = await response.Content.ReadAsByteArrayAsync(cancellationTokenSource.Token);
                var contentType = response.Content.Headers.ContentType?.MediaType ?? "application/octet-stream";
                
                // Detect actual file type from magic bytes (more reliable than Content-Type header)
                if (documentBytes.Length >= 4)
                {
                    // PDF magic bytes: %PDF
                    if (documentBytes[0] == 0x25 && documentBytes[1] == 0x50 && documentBytes[2] == 0x44 && documentBytes[3] == 0x46)
                    {
                        contentType = "application/pdf";
                    }
                    // PNG magic bytes: 89 50 4E 47
                    else if (documentBytes[0] == 0x89 && documentBytes[1] == 0x50 && documentBytes[2] == 0x4E && documentBytes[3] == 0x47)
                    {
                        contentType = "image/png";
                    }
                    // JPEG magic bytes: FF D8 FF
                    else if (documentBytes.Length >= 3 && documentBytes[0] == 0xFF && documentBytes[1] == 0xD8 && documentBytes[2] == 0xFF)
                    {
                        contentType = "image/jpeg";
                    }
                }
                
                // Convert to base64 for preview
                var base64 = Convert.ToBase64String(documentBytes);
                existingDocumentPreview = $"data:{contentType};base64,{base64}";
                
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading document preview");
                // Don't show error to user, just log it
            }
        }
    }

    private async Task ShowImagePreview(string? imageUrl)
    {
        if (string.IsNullOrWhiteSpace(imageUrl))
            return;

        // Check if it's an image (starts with data:image/)
        bool isImage = imageUrl.StartsWith("data:image/", StringComparison.OrdinalIgnoreCase);
        
        // Only show dialog for images, not PDFs
        if (!isImage)
        {
            // For PDFs or other documents, open in new tab
            await OpenExistingDocumentInNewTab();
            return;
        }

        // For images, show in dialog
        await DialogService.OpenAsync<ImagePreviewDialog>("Aperçu de l'image",
            new Dictionary<string, object> { { "ImageUrl", imageUrl } },
            new DialogOptions
            {
                Width = "90%",
                Height = "90%",
                Resizable = true,
                Draggable = true,
                ShowClose = true
            });
    }

    private async Task OpenExistingDocumentInNewTab()
    {
        if (!string.IsNullOrWhiteSpace(existingDocumentPreview))
        {
            // Use blob URL for better browser compatibility
            await JSRuntime.InvokeVoidAsync("openDocumentInNewTab", existingDocumentPreview);
        }
        else if (!string.IsNullOrWhiteSpace(existingDocumentPath) && Id.HasValue)
        {
            // Fallback: load and open
            var baseUrl = Configuration.GetValue<string>("ApiSettings:BaseUrl")
                ?? throw new InvalidOperationException("ApiSettings:BaseUrl configuration is missing");
            
            var url = $"{baseUrl.TrimEnd('/')}/paiement-fournisseur/{Id.Value}/document";
            
            // Create HttpClient with authentication
            using var httpClient = new HttpClient();
            httpClient.BaseAddress = new Uri(baseUrl);
            
            // Add authentication token
            var token = AuthService.AccessToken;
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = 
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            
            var response = await httpClient.GetAsync(url, cancellationTokenSource.Token);
            
            if (!response.IsSuccessStatusCode)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["Erreur"],
                    Detail = "Impossible de télécharger le document"
                });
                return;
            }
            
            var documentBytes = await response.Content.ReadAsByteArrayAsync(cancellationTokenSource.Token);
            var contentType = response.Content.Headers.ContentType?.MediaType ?? "application/octet-stream";
            
            // Convert to base64
            var base64 = Convert.ToBase64String(documentBytes);
            var dataUrl = $"data:{contentType};base64,{base64}";
            
            await JSRuntime.InvokeVoidAsync("openDocumentInNewTab", dataUrl);
        }
    }

    public void Dispose()
    {
        cancellationTokenSource.Cancel();
        cancellationTokenSource.Dispose();
    }
}

