@page "/paiement-fournisseur/add"
@page "/paiement-fournisseur/edit/{Id:int}"
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.PaiementFournisseur
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.PaiementFournisseur
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Providers
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ProviderInvoice
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.ReceiptNote
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Banque
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AccountingYear
@using TunNetCom.SilkRoadErp.Sales.Contracts.Providers
@using TunNetCom.SilkRoadErp.Sales.Contracts.ProviderInvoice
@using TunNetCom.SilkRoadErp.Sales.Contracts.RecieptNotes
@using TunNetCom.SilkRoadErp.Sales.Contracts.Banque
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using Radzen.Blazor
@using Radzen
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> Localizer
@inject IPaiementFournisseurApiClient PaiementFournisseurService
@inject IProvidersApiClient ProvidersService
@inject IProviderInvoiceApiClient ProviderInvoiceService
@inject IReceiptNoteApiClient ReceiptNoteService
@inject IBanqueApiClient BanqueService
@inject IAccountingYearApiClient AccountingYearService
@inject ToastService ToastService
@inject NotificationService NotificationService

<div class="paiement-form-container">
    <div class="paiement-form-card">
        <div class="paiement-form-header">
            <h3>@(IsEditMode ? Localizer["Modifier_Paiement"] : Localizer["Nouveau_Paiement_Fournisseur"])</h3>
            <RadzenButton Icon="arrow_back" Text="@Localizer["Retour"]"
                          ButtonStyle="ButtonStyle.Secondary"
                          Click="GoBack"
                          Variant="Variant.Outlined" />
        </div>

        <RadzenStack Gap="1.5rem">
            <RadzenFormField Text="@Localizer["Numero"]" class="rz-col-12 rz-md-6">
                <RadzenTextBox @bind-Value="paiement.Numero" Placeholder="@Localizer["Numero_Transaction_Bancaire"]" />
                <RadzenFormFieldDescription>@Localizer["Numero_Transaction_Bancaire_Description"]</RadzenFormFieldDescription>
            </RadzenFormField>

            <RadzenFormField Text="@($"{Localizer["providers"]} *")" class="rz-col-12 rz-md-6">
                <RadzenDropDownDataGrid AllowClear="false"
                                        IsLoading="@isLoadingProviders"
                                        @bind-Value="@paiement.FournisseurId"
                                        LoadData="@LoadProviders"
                                        AllowFiltering="true"
                                        Style="width: 100%;"
                                        Data="@_filteredProviders"
                                        TextProperty="@nameof(ProviderResponse.Nom)"
                                        ValueProperty="@nameof(ProviderResponse.Id)"
                                        Placeholder="@Localizer["Select_Provider"]"
                                        Change="@OnProviderChanged">
                    <Columns>
                        <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Id)" Title="ID" Width="80px" />
                        <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Nom)" Title="@Localizer["Nom"]" Width="220px" />
                    </Columns>
                </RadzenDropDownDataGrid>
            </RadzenFormField>

            <RadzenFormField Text="@($"{Localizer["Exercice_Comptable"]} *")" class="rz-col-12 rz-md-6">
                <RadzenTextBox Value="@(activeAccountingYear?.Year.ToString() ?? Localizer["Chargement"])" 
                               ReadOnly="true" 
                               Style="width: 100%;" />
            </RadzenFormField>

            <RadzenFormField Text="@($"{Localizer["Montant"]} *")" class="rz-col-12 rz-md-6">
                <RadzenNumeric @bind-Value="paiement.Montant" Min="0" Format="N2" Style="width: 100%;" />
            </RadzenFormField>

            <RadzenFormField Text="@($"{Localizer["Date_Paiement"]} *")" class="rz-col-12 rz-md-6">
                <RadzenDatePicker @bind-Value="paiement.DatePaiement" DateFormat="dd/MM/yyyy" ShowTime="false" Style="width: 100%;" />
            </RadzenFormField>

            <RadzenFormField Text="@($"{Localizer["Methode_Paiement"]} *")" class="rz-col-12 rz-md-6">
                <RadzenDropDown @bind-Value="selectedMethodePaiement"
                                Data="@methodePaiementOptions"
                                TextProperty="Text"
                                ValueProperty="Value"
                                Placeholder="@Localizer["Select_Methode"]"
                                AllowClear="false"
                                Style="width: 100%;"
                                Change="@OnMethodePaiementChanged" />
            </RadzenFormField>

            @if (selectedMethodePaiement == "Cheque" || selectedMethodePaiement == "Traite")
            {
                <RadzenFormField Text="@Localizer["Numero_Cheque_Traite"]" class="rz-col-12 rz-md-6">
                    <RadzenTextBox @bind-Value="paiement.NumeroChequeTraite" Placeholder="@Localizer["Numero"]" />
                </RadzenFormField>

                <RadzenFormField Text="@Localizer["Banque"]" class="rz-col-12 rz-md-6">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Style="width: 100%;">
                        <RadzenDropDown @bind-Value="paiement.BanqueId"
                                        Data="@banques"
                                        TextProperty="Nom"
                                        ValueProperty="Id"
                                        Placeholder="@Localizer["Select_Banque"]"
                                        AllowClear="true"
                                        Style="flex: 1;" />
                        <RadzenButton Icon="add" Text="@Localizer["Nouvelle_Banque"]"
                                      ButtonStyle="ButtonStyle.Success"
                                      Variant="Variant.Outlined"
                                      Size="ButtonSize.Small"
                                      Click="@OpenAddBanqueDialog" />
                    </RadzenStack>
                </RadzenFormField>

                @if (selectedMethodePaiement == "Traite")
                {
                    <RadzenFormField Text="@Localizer["Date_Echeance"]" class="rz-col-12 rz-md-6">
                        <RadzenDatePicker @bind-Value="paiement.DateEcheance" DateFormat="dd/MM/yyyy" ShowTime="false" Style="width: 100%;" />
                    </RadzenFormField>
                }
            }

            <RadzenFormField Text="@Localizer["Facture_Fournisseur_Optionnel"]" class="rz-col-12 rz-md-6">
                <RadzenDropDownDataGrid AllowClear="true"
                                        IsLoading="@isLoadingInvoices"
                                        @bind-Value="@paiement.FactureFournisseurId"
                                        LoadData="@LoadInvoices"
                                        AllowFiltering="true"
                                        Style="width: 100%;"
                                        Data="@_filteredInvoices"
                                        TextProperty="@nameof(ProviderInvoiceResponse.ProviderInvoiceNumber)"
                                        ValueProperty="@nameof(ProviderInvoiceResponse.Num)"
                                        Placeholder="@Localizer["Select_Facture_Fournisseur"]"
                                        Disabled="@(paiement.FournisseurId <= 0)">
                    <Columns>
                        <RadzenDropDownDataGridColumn Property="@nameof(ProviderInvoiceResponse.ProviderInvoiceNumber)" Title="Num" Width="100px" />
                        <RadzenDropDownDataGridColumn Property="@nameof(ProviderInvoiceResponse.Date)" Title="@Localizer["date"]" Width="100px" />
                        <RadzenDropDownDataGridColumn Property="@nameof(ProviderInvoiceResponse.TotTTC)" Title="Total TTC" Width="150px" />
                    </Columns>
                </RadzenDropDownDataGrid>
            </RadzenFormField>

            <RadzenFormField Text="@Localizer["Bon_Reception_Optionnel"]" class="rz-col-12 rz-md-6">
                <RadzenDropDownDataGrid AllowClear="true"
                                        IsLoading="@isLoadingReceiptNotes"
                                        @bind-Value="@paiement.BonDeReceptionId"
                                        LoadData="@LoadReceiptNotes"
                                        AllowFiltering="true"
                                        Style="width: 100%;"
                                        Data="@_filteredReceiptNotes"
                                        TextProperty="@nameof(ReceiptNoteDetailsResponse.Num)"
                                        ValueProperty="@nameof(ReceiptNoteDetailsResponse.Num)"
                                        Placeholder="@Localizer["Select_Bon_Reception"]"
                                        Disabled="@(paiement.FournisseurId <= 0)">
                    <Columns>
                        <RadzenDropDownDataGridColumn Property="@nameof(ReceiptNoteDetailsResponse.Num)" Title="@Localizer["Numero"]" Width="100px" />
                        <RadzenDropDownDataGridColumn Property="@nameof(ReceiptNoteDetailsResponse.Date)" Title="@Localizer["date"]" Width="100px" />
                        <RadzenDropDownDataGridColumn Property="@nameof(ReceiptNoteDetailsResponse.TotTTC)" Title="Total TTC" Width="150px" />
                    </Columns>
                </RadzenDropDownDataGrid>
            </RadzenFormField>

            <RadzenFormField Text="@Localizer["Commentaire"]" class="rz-col-12">
                <RadzenTextArea @bind-Value="paiement.Commentaire" Placeholder="@Localizer["Commentaire_Optionnel"]" Rows="3" Style="width: 100%;" />
            </RadzenFormField>

            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" JustifyContent="Radzen.JustifyContent.End" class="rz-col-12">
                <RadzenButton Text="@Localizer["Annuler"]" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Outlined" Click="GoBack" />
                <RadzenButton Text="@(IsEditMode ? Localizer["Modifier"] : Localizer["Creer"])" 
                              ButtonStyle="ButtonStyle.Primary" 
                              Click="@SavePaiement"
                              IsBusy="@isSaving" />
            </RadzenStack>
        </RadzenStack>
    </div>
</div>

<style>
    .paiement-form-container {
        padding: 0;
        margin: 0;
    }

    .paiement-form-card {
        background: transparent;
        border-radius: 0;
        box-shadow: none;
        padding: 1rem;
    }

    .paiement-form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e0e0e0;
    }

    .paiement-form-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }
</style>

@code {
    [Parameter] public int? Id { get; set; }
    
    private bool IsEditMode => Id.HasValue;
    private bool isLoadingProviders = false;
    private bool isLoadingInvoices = false;
    private bool isLoadingReceiptNotes = false;
    private bool isSaving = false;
    private CreatePaiementFournisseurRequest paiement = new();
    private GetActiveAccountingYearResponse? activeAccountingYear;
    private string? selectedMethodePaiement;
    private List<ProviderResponse> _filteredProviders = new();
    private List<ProviderInvoiceResponse> _filteredInvoices = new();
    private List<ReceiptNoteDetailsResponse> _filteredReceiptNotes = new();
    private List<BanqueResponse> banques = new();
    private CancellationTokenSource cancellationTokenSource = new();

    private List<MethodePaiementOption> methodePaiementOptions = new();

    private class MethodePaiementOption
    {
        public string Text { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        methodePaiementOptions = new()
        {
            new MethodePaiementOption { Text = Localizer["Espece"], Value = "Espece" },
            new MethodePaiementOption { Text = Localizer["Cheque"], Value = "Cheque" },
            new MethodePaiementOption { Text = Localizer["Traite"], Value = "Traite" }
        };
        
        await LoadActiveAccountingYearAsync();
        await LoadBanquesAsync();
        
        if (IsEditMode && Id.HasValue)
        {
            await LoadPaiementAsync(Id.Value);
        }
        else
        {
            paiement.DatePaiement = DateTime.Now;
        }
    }

    async Task LoadActiveAccountingYearAsync()
    {
        try
        {
            activeAccountingYear = await AccountingYearService.GetActiveAccountingYearAsync();
            if (activeAccountingYear == null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["Attention"],
                    Detail = Localizer["No_Accounting_Year"]
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Accounting_Year"]}: {ex.Message}"
            });
        }
    }

    async Task LoadBanquesAsync()
    {
        try
        {
            banques = await BanqueService.GetBanquesAsync(cancellationTokenSource.Token);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Banques"]}: {ex.Message}"
            });
        }
    }

    async Task LoadPaiementAsync(int id)
    {
        try
        {
            var result = await PaiementFournisseurService.GetPaiementFournisseurAsync(id, cancellationTokenSource.Token);
            if (result.IsSuccess)
            {
                var paiementResponse = result.Value;
                paiement = new CreatePaiementFournisseurRequest
                {
                    Numero = paiementResponse.Numero,
                    FournisseurId = paiementResponse.FournisseurId,
                    Montant = paiementResponse.Montant,
                    DatePaiement = paiementResponse.DatePaiement,
                    MethodePaiement = paiementResponse.MethodePaiement,
                    FactureFournisseurId = paiementResponse.FactureFournisseurId,
                    BonDeReceptionId = paiementResponse.BonDeReceptionId,
                    NumeroChequeTraite = paiementResponse.NumeroChequeTraite,
                    BanqueId = paiementResponse.BanqueId,
                    DateEcheance = paiementResponse.DateEcheance,
                    Commentaire = paiementResponse.Commentaire
                };
                selectedMethodePaiement = paiementResponse.MethodePaiement;
                
                if (paiement.FournisseurId > 0)
                {
                    await LoadInvoicesForProvider(paiement.FournisseurId);
                    await LoadReceiptNotesForProvider(paiement.FournisseurId);
                }
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["Erreur"],
                    Detail = Localizer["Erreur_Chargement_Paiement"]
                });
                NavigationManager.NavigateTo("/paiements-fournisseur");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement"]}: {ex.Message}"
            });
        }
    }

    async Task LoadProviders(LoadDataArgs args)
    {
        isLoadingProviders = true;
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 10,
            SearchKeyword = args?.Filter ?? string.Empty
        };

        try
        {
            var pagedProviders = await ProvidersService.GetPagedAsync(parameters, cancellationTokenSource.Token);
            _filteredProviders = pagedProviders.Items;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Providers"]}: {ex.Message}"
            });
            _filteredProviders = new List<ProviderResponse>();
        }

        isLoadingProviders = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task OnProviderChanged(object? value)
    {
        if (value is int providerId && providerId > 0)
        {
            await LoadInvoicesForProvider(providerId);
            await LoadReceiptNotesForProvider(providerId);
        }
        else
        {
            _filteredInvoices = new List<ProviderInvoiceResponse>();
            _filteredReceiptNotes = new List<ReceiptNoteDetailsResponse>();
        }
    }

    async Task LoadInvoicesForProvider(int providerId)
    {
        isLoadingInvoices = true;
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 50,
            SearchKeyword = null
        };

        try
        {
            var result = await ProviderInvoiceService.GetProvidersInvoicesAsync(providerId, parameters, cancellationTokenSource.Token);
            if (result.IsT0)
            {
                _filteredInvoices = result.AsT0.Invoices.Items;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Factures_Fournisseur"]}: {ex.Message}"
            });
        }

        isLoadingInvoices = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task LoadInvoices(LoadDataArgs args)
    {
        if (paiement.FournisseurId > 0)
        {
            await LoadInvoicesForProvider(paiement.FournisseurId);
        }
    }

    async Task LoadReceiptNotesForProvider(int providerId)
    {
        isLoadingReceiptNotes = true;
        try
        {
            var parameters = new QueryStringParameters
            {
                PageNumber = 1,
                PageSize = 50,
                SearchKeyword = null
            };
            
            var result = await ReceiptNoteService.GetReceiptNoteWithSummaries(
                providerId: providerId,
                IsInvoiced: null,
                InvoiceId: null,
                queryParameters: parameters,
                cancellationToken: cancellationTokenSource.Token);
            
            if (result.IsSuccess)
            {
                _filteredReceiptNotes = result.Value.ReceiptNotes.Items;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_BR"]}: {ex.Message}"
            });
        }

        isLoadingReceiptNotes = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task LoadReceiptNotes(LoadDataArgs args)
    {
        if (paiement.FournisseurId > 0)
        {
            await LoadReceiptNotesForProvider(paiement.FournisseurId);
        }
    }

    void OnMethodePaiementChanged(object? value)
    {
        if (value is string methode)
        {
            paiement.MethodePaiement = methode;
            if (methode != "Cheque" && methode != "Traite")
            {
                paiement.NumeroChequeTraite = null;
                paiement.BanqueId = null;
                paiement.DateEcheance = null;
            }
        }
    }

    async Task OpenAddBanqueDialog()
    {
        await LoadBanquesAsync();
    }

    async Task SavePaiement()
    {
        if (paiement.FournisseurId <= 0)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Validation"],
                Detail = Localizer["Select_Provider_Validation"]
            });
            return;
        }

        if (activeAccountingYear == null)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Validation"],
                Detail = Localizer["No_Accounting_Year_Validation"]
            });
            return;
        }

        if (string.IsNullOrWhiteSpace(paiement.MethodePaiement))
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = Localizer["Validation"],
                Detail = Localizer["Select_Methode_Validation"]
            });
            return;
        }

        isSaving = true;
        try
        {
            if (IsEditMode && Id.HasValue)
            {
                var updateRequest = new UpdatePaiementFournisseurRequest
                {
                    Numero = paiement.Numero,
                    FournisseurId = paiement.FournisseurId,
                    Montant = paiement.Montant,
                    DatePaiement = paiement.DatePaiement,
                    MethodePaiement = paiement.MethodePaiement,
                    FactureFournisseurId = paiement.FactureFournisseurId,
                    BonDeReceptionId = paiement.BonDeReceptionId,
                    NumeroChequeTraite = paiement.NumeroChequeTraite,
                    BanqueId = paiement.BanqueId,
                    DateEcheance = paiement.DateEcheance,
                    Commentaire = paiement.Commentaire
                };

                var result = await PaiementFournisseurService.UpdatePaiementFournisseurAsync(Id.Value, updateRequest, cancellationTokenSource.Token);
                if (result.IsSuccess)
                {
                    ToastService.Notify(new(ToastType.Success, Localizer["Paiement_Modifie"]));
                    NavigationManager.NavigateTo("/paiements-fournisseur");
                }
                else
                {
                    ToastService.Notify(new(ToastType.Danger, $"{Localizer["Erreur"]}: {result.Errors.FirstOrDefault()?.Message}"));
                }
            }
            else
            {
                var result = await PaiementFournisseurService.CreatePaiementFournisseurAsync(paiement, cancellationTokenSource.Token);
                if (result.IsT0)
                {
                    ToastService.Notify(new(ToastType.Success, Localizer["Paiement_Cree"]));
                    NavigationManager.NavigateTo("/paiements-fournisseur");
                }
                else
                {
                    var badRequest = result.AsT1;
                    ToastService.Notify(new(ToastType.Danger, $"{Localizer["Erreur"]}: {badRequest.Detail}"));
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Sauvegarde"]}: {ex.Message}"
            });
        }
        finally
        {
            isSaving = false;
        }
    }

    void GoBack()
    {
        NavigationManager.NavigateTo("/paiements-fournisseur");
    }

    public void Dispose()
    {
        cancellationTokenSource.Cancel();
        cancellationTokenSource.Dispose();
    }
}

