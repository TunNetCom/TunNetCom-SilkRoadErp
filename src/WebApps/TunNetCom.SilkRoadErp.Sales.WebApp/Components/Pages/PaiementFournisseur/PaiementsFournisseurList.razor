@page "/paiements-fournisseur"
@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.Contracts.PaiementFournisseur
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.PaiementFournisseur
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Providers
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.AccountingYear
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@using TunNetCom.SilkRoadErp.Sales.WebApp.Helpers
@using Radzen.Blazor
@using Radzen
@using TunNetCom.SilkRoadErp.Sales.Contracts.Providers
@using TunNetCom.SilkRoadErp.Sales.Contracts.Tags
@using TunNetCom.SilkRoadErp.Sales.HttpClients.Services.Tags
@using TunNetCom.SilkRoadErp.Sales.WebApp.Components.Shared
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Reports.PaiementFournisseur.PrintTraite
@using TunNetCom.SilkRoadErp.Sales.WebApp.PrintEngine.Infrastructure
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@using Microsoft.Extensions.Configuration
@inject NavigationManager NavigationManager
@inject ITagsApiClient TagsService
@inject IStringLocalizer<SharedResource> Localizer
@inject IPaiementFournisseurApiClient PaiementFournisseurService
@inject IProvidersApiClient ProvidersService
@inject IAccountingYearApiClient AccountingYearService
@inject ToastService ToastService
@inject DialogService DialogService
@inject Radzen.NotificationService NotificationService
@inject IDecimalFormatService DecimalFormatService
@inject PrintTraiteService PrintTraiteService
@inject IPrintService PrintService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS
@inject HttpClient HttpClient
@inject IConfiguration Configuration
@inject ILogger<PaiementsFournisseurList> _logger

<div class="paiements-container">
    <div class="paiements-card">
        <div class="paiements-header">
            <h3 class="paiements-title">@Localizer["Paiements_Fournisseurs"]</h3>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <RadzenButton Icon="table_chart" Text="Export Excel"
                              ButtonStyle="ButtonStyle.Success"
                              Click="@ExportToExcelAsync"
                              Variant="Variant.Outlined"
                              Class="btn-export" />
                <RadzenButton Icon="picture_as_pdf" Text="Imprimer PDF"
                              ButtonStyle="ButtonStyle.Danger"
                              Click="@ExportToPdfAsync"
                              Variant="Variant.Outlined"
                              Class="btn-export" />
                <RadzenButton Icon="add" Text="@Localizer["Ajouter_Paiement"]"
                              ButtonStyle="ButtonStyle.Primary"
                              Click="CreatePaiement"
                              Class="btn-primary" />
            </div>
        </div>

        <div class="search-filters">
            <div class="search-field">
                <label>@Localizer["providers"]</label>
                <RadzenDropDownDataGrid AllowClear="true"
                                        @bind-Value="@selectedFournisseurId"
                                        LoadData="@LoadProviders"
                                        AllowFiltering="true"
                                        Style="width: 300px;"
                                        Data="@_filteredProviders"
                                        TextProperty="@nameof(ProviderResponse.Nom)"
                                        ValueProperty="@nameof(ProviderResponse.Id)"
                                        Placeholder="@Localizer["Select_Provider"]">
                    <Columns>
                        <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Id)" Title="ID" Width="80px" />
                        <RadzenDropDownDataGridColumn Property="@nameof(ProviderResponse.Nom)" Title="@Localizer["Nom"]" Width="220px" />
                    </Columns>
                </RadzenDropDownDataGrid>
            </div>
            <div class="search-field">
                <label>@Localizer["Exercice_Comptable_Filter"]</label>
                <RadzenDropDown @bind-Value="@selectedAccountingYearId"
                                Data="@accountingYears"
                                TextProperty="Year"
                                ValueProperty="Id"
                                Placeholder="@Localizer["Tous_Exercices"]"
                                AllowClear="true"
                                Style="width: 200px;" />
            </div>
            <div class="search-field">
                <label>Date Échéance Début</label>
                <RadzenDatePicker @bind-Value="@selectedDateEcheanceFrom"
                                  DateFormat="dd/MM/yyyy"
                                  Placeholder="Date début"
                                  AllowClear="true"
                                  Style="width: 200px;" />
            </div>
            <div class="search-field">
                <label>Date Échéance Fin</label>
                <RadzenDatePicker @bind-Value="@selectedDateEcheanceTo"
                                  DateFormat="dd/MM/yyyy"
                                  Placeholder="Date fin"
                                  AllowClear="true"
                                  Style="width: 200px;" />
            </div>
            <div class="search-field">
                <label>Montant Min</label>
                <RadzenNumeric @bind-Value="@selectedMontantMin"
                              Min="0"
                              Format="@AmountHelper.FORMAT_N3"
                              Step="0.001"
                              Placeholder="Montant min"
                              Style="width: 200px;" />
            </div>
            <div class="search-field">
                <label>Montant Max</label>
                <RadzenNumeric @bind-Value="@selectedMontantMax"
                              Min="0"
                              Format="@AmountHelper.FORMAT_N3"
                              Step="0.001"
                              Placeholder="Montant max"
                              Style="width: 200px;" />
            </div>
            <div class="search-field">
                <label>Statut Règlement</label>
                <RadzenDropDown @bind-Value="@selectedReglementStatus"
                                Data="@reglementStatusOptions"
                                TextProperty="Text"
                                ValueProperty="Value"
                                Placeholder="Tous"
                                AllowClear="true"
                                Style="width: 200px;" />
            </div>
            <div class="search-field">
                <label>Mois</label>
                <RadzenDropDown @bind-Value="@selectedMois"
                                Data="@moisOptions"
                                TextProperty="Text"
                                ValueProperty="Value"
                                Placeholder="Tous"
                                AllowClear="true"
                                Style="width: 200px;" />
            </div>
            <div class="search-button">
                <RadzenButton Text="@Localizer["Rechercher"]"
                              Icon="search"
                              ButtonStyle="ButtonStyle.Primary"
                              Click="@SearchPaiements"
                              Class="action-button" />
            </div>
        </div>

        <RadzenDataGrid @ref="paiementGrid"
                        TItem="PaiementFournisseurResponse"
                        Data="@paiements"
                        Count="@totalPaiements"
                        LoadData="@LoadPaiementData"
                        AllowFiltering="true"
                        AllowPaging="true"
                        AllowSorting="true"
                        FilterPopupRenderMode="PopupRenderMode.OnDemand"
                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                        PageSize="@_defaultPageSize"
                        Density="Density.Compact"
                        Class="paiements-grid"
                        IsLoading="@isLoadingPaiements"
                        ShowPagingSummary="true"
                        Responsive="true">
            <EmptyTemplate>
                <p style="font-size: 24px; text-align: center; margin: 2rem;">@Localizer["Aucun_Paiement"]</p>
            </EmptyTemplate>
            <Columns>
                <RadzenDataGridColumn TItem="PaiementFournisseurResponse" Property="NumeroTransactionBancaire" Title="@Localizer["Numero_Col"]" Width="150px" Visible="false" />
                <RadzenDataGridColumn TItem="PaiementFournisseurResponse" Property="FournisseurNom" Title="@Localizer["providers"]" Width="200px" />
                <RadzenDataGridColumn TItem="PaiementFournisseurResponse" Property="Montant" Title="@Localizer["Montant_Col"]" Width="150px">
                    <Template Context="paiement">
                        @paiement.Montant.FormatAmount(decimalPlaces) TND
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="PaiementFournisseurResponse" Property="DatePaiement" Title="@Localizer["Date_Paiement_Col"]" Width="150px">
                    <Template Context="paiement">
                        @paiement.DatePaiement.ToString("dd/MM/yyyy")
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="PaiementFournisseurResponse" Property="MethodePaiement" Title="@Localizer["Methode_Col"]" Width="120px" />
                <RadzenDataGridColumn TItem="PaiementFournisseurResponse" Property="BanqueNom" Title="@Localizer["Banque_Col"]" Width="150px" Visible="false" />
                <RadzenDataGridColumn TItem="PaiementFournisseurResponse" Property="NumeroTransactionBancaire" Title="N° Transaction Bancaire" Width="180px" Visible="false" />
                <RadzenDataGridColumn TItem="PaiementFournisseurResponse" Title="Document" Width="100px" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                    <Template Context="paiement">
                        @if (paiement.HasDocument)
                        {
                            <RadzenButton Icon="attachment" ButtonStyle="ButtonStyle.Light" Variant="Variant.Outlined" Size="ButtonSize.Small"
                                          Click="@(() => ViewDocument(paiement.Id))"
                                          Title="Voir le document" />
                        }
                        else
                        {
                            <span style="color: #999;">-</span>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="PaiementFournisseurResponse" Title="Tags" Width="250px" Sortable="false" Filterable="false">
                    <Template Context="paiement">
                        <TagSelector DocumentType="PaiementFournisseur" 
                                    DocumentId="@paiement.Id"
                                    SaveOnChange="true" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="PaiementFournisseurResponse" Filterable="false" Sortable="false" Width="250px" TextAlign="TextAlign.Center">
                    <Template Context="paiement">
                        @if (paiement.MethodePaiement == "Traite")
                        {
                            <RadzenButton Icon="print" ButtonStyle="ButtonStyle.Info" Variant="Variant.Outlined" Size="ButtonSize.Medium" Shade="Shade.Lighter"
                                          Click="@(() => PrintTraite(paiement.Id))"
                                          Title="Imprimer Traite" />
                        }
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Success" Variant="Variant.Outlined" Size="ButtonSize.Medium" Shade="Shade.Lighter" Class="rz-my-1 rz-ms-1"
                                      Click="@(() => EditPaiement(paiement.Id))"
                                      Title="@Localizer["Modifier"]" />
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Outlined" Size="ButtonSize.Medium" Shade="Shade.Lighter" Class="rz-my-1 rz-ms-1"
                                      Click="@(() => ConfirmDeletePaiement(paiement.Id))"
                                      Title="@Localizer["Supprimer"]" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </div>
</div>

<style>
    .paiements-container {
        padding: 0.25rem 1.25rem 1.25rem 1.25rem;
        max-width: 1400px;
        margin: 0.25rem auto 1rem auto;
    }

    .paiements-card {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        padding: 0.75rem 1.5rem 1.5rem 1.5rem;
        border: none;
    }

    .paiements-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }

    .paiements-title {
        font-weight: 600;
        margin: 0;
        font-size: 2rem;
        line-height: 1.2;
    }

    .search-filters {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        margin-bottom: 1.25rem;
        flex-wrap: wrap;
    }

    .search-field {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .search-field label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #5f6368;
    }

    .search-button {
        display: flex;
        align-items: flex-end;
    }

    .action-button {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 6px;
    }

    .paiements-grid {
        border-radius: 8px;
        overflow: hidden;
        border: none;
    }
</style>

@code {
    private RadzenDataGrid<PaiementFournisseurResponse> paiementGrid = default!;
    private List<PaiementFournisseurResponse> paiements = new();
    private int totalPaiements;
    private int decimalPlaces = AmountHelper.DEFAULT_DECIMAL_PLACES;
    private bool isLoadingPaiements = false;
    private int? selectedFournisseurId;
    private int? selectedAccountingYearId;
    private DateTime? selectedDateEcheanceFrom;
    private DateTime? selectedDateEcheanceTo;
    private decimal? selectedMontantMin;
    private decimal? selectedMontantMax;
    private int? selectedReglementStatus; // 0 = false (non réglé), 1 = true (réglé), null = tous
    private int? selectedMois;
    private List<ProviderResponse> _filteredProviders = new();
    private List<ReglementStatusOption> reglementStatusOptions = new()
    {
        new ReglementStatusOption { Text = "Régle (avec numéro)", Value = 1 },
        new ReglementStatusOption { Text = "Non réglé (sans numéro)", Value = 0 }
    };
    private List<MoisOption> moisOptions = new()
    {
        new MoisOption { Text = "Janvier", Value = 1 },
        new MoisOption { Text = "Février", Value = 2 },
        new MoisOption { Text = "Mars", Value = 3 },
        new MoisOption { Text = "Avril", Value = 4 },
        new MoisOption { Text = "Mai", Value = 5 },
        new MoisOption { Text = "Juin", Value = 6 },
        new MoisOption { Text = "Juillet", Value = 7 },
        new MoisOption { Text = "Août", Value = 8 },
        new MoisOption { Text = "Septembre", Value = 9 },
        new MoisOption { Text = "Octobre", Value = 10 },
        new MoisOption { Text = "Novembre", Value = 11 },
        new MoisOption { Text = "Décembre", Value = 12 }
    };
    private List<GetAllAccountingYearsResponse> accountingYears = new();
    private CancellationTokenSource cancellationTokenSource = new();
    private const int _defaultPageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        decimalPlaces = await DecimalFormatService.GetDecimalPlacesAsync();
        await LoadAccountingYearsAsync();
    }

    async Task LoadAccountingYearsAsync()
    {
        try
        {
            accountingYears = await AccountingYearService.GetAllAccountingYearsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Accounting_Year"]}: {ex.Message}"
            });
        }
    }

    async Task LoadProviders(LoadDataArgs args)
    {
        var parameters = new QueryStringParameters
        {
            PageNumber = 1,
            PageSize = 10,
            SearchKeyword = args?.Filter ?? string.Empty
        };

        try
        {
            var pagedProviders = await ProvidersService.GetPagedAsync(parameters, cancellationTokenSource.Token);
            _filteredProviders = pagedProviders.Items;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Providers"]}: {ex.Message}"
            });
            _filteredProviders = new List<ProviderResponse>();
        }
    }

    async Task LoadPaiementData(LoadDataArgs args)
    {
        isLoadingPaiements = true;
        await Task.Yield();

        try
        {
            bool? hasNumeroTransactionBancaire = selectedReglementStatus.HasValue 
                ? (selectedReglementStatus.Value == 1) 
                : null;

            var result = await PaiementFournisseurService.GetPaiementsFournisseurAsync(
                selectedFournisseurId,
                selectedAccountingYearId,
                selectedDateEcheanceFrom,
                selectedDateEcheanceTo,
                selectedMontantMin,
                selectedMontantMax,
                hasNumeroTransactionBancaire,
                selectedMois,
                (args.Skip.Value / _defaultPageSize) + 1,
                args.Top ?? _defaultPageSize,
                cancellationTokenSource.Token);

            paiements = result.Items;
            totalPaiements = result.TotalCount;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"{Localizer["Erreur_Chargement_Paiements"]}: {ex.Message}"
            });
            paiements = new List<PaiementFournisseurResponse>();
            totalPaiements = 0;
        }

        isLoadingPaiements = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task SearchPaiements()
    {
        await paiementGrid.Reload();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await paiementGrid.Reload();
        }
    }

    private void CreatePaiement()
    {
        NavigationManager.NavigateTo("/paiement-fournisseur/add");
    }

    private void EditPaiement(int id)
    {
        NavigationManager.NavigateTo($"/paiement-fournisseur/edit/{id}");
    }

    async Task ConfirmDeletePaiement(int paiementId)
    {
        bool? confirmed = await DialogService.Confirm(Localizer["Confirmation_Suppression"],
                                                      Localizer["Confirmation_Suppression_Titre"],
                                                      new ConfirmOptions() { OkButtonText = Localizer["Oui"], CancelButtonText = Localizer["Non"] });

        if (confirmed == true)
        {
            var result = await PaiementFournisseurService.DeletePaiementFournisseurAsync(paiementId, cancellationTokenSource.Token);
            if (result.IsSuccess)
            {
                ToastService.Notify(new(ToastType.Success, Localizer["Paiement_Supprime"]));
                await paiementGrid.Reload();
            }
            else
            {
                ToastService.Notify(new(ToastType.Danger, $"{Localizer["Erreur_Suppression"]}: {result.Errors.FirstOrDefault()?.Message}"));
            }
        }
    }

    private void ViewDocument(int paiementId)
    {
        // Open the document in a new tab using the existing document endpoint
        var documentUrl = $"/api/paiement-fournisseur/{paiementId}/document";
        NavigationManager.NavigateTo(documentUrl, forceLoad: true);
    }

    private async Task PrintTraite(int paiementId)
    {
        try
        {
            // Vérifier que le paiement est sauvegardé
            if (paiementId <= 0)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = Localizer["warning"],
                    Detail = "Le paiement doit être enregistré avant d'être imprimé."
                });
                return;
            }

            // Get current user info
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier);
            var usernameClaim = authState.User.FindFirst(ClaimTypes.Name);
            int? userId = userIdClaim != null && int.TryParse(userIdClaim.Value, out var uid) ? uid : null;
            string? username = usernameClaim?.Value;

            // Générer le PDF
            var pdfResult = await PrintTraiteService.GenerateTraitePdfAsync(
                paiementId,
                cancellationTokenSource.Token);

            if (pdfResult.IsFailed)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = Localizer["Erreur"],
                    Detail = $"Erreur lors de la génération de la Traite: {pdfResult.Errors.FirstOrDefault()?.Message ?? "Erreur inconnue"}"
                });
                return;
            }

            var fileName = $"Traite_Paiement_{paiementId}.pdf";

            // Utiliser le service d'impression centralisé avec suivi de document
            var printOptions = new PrintOptions
            {
                Mode = PrintMode.Download,
                FileName = fileName,
                DocumentType = "PaiementFournisseur",
                DocumentId = paiementId,
                UserId = userId,
                Username = username,
                IsDuplicata = false
            };

            await PrintService.PrintAsync(pdfResult.Value, printOptions, cancellationTokenSource.Token);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = Localizer["Erreur"],
                Detail = $"Erreur lors de l'impression de la Traite: {ex.Message}"
            });
        }
    }

    private async Task ExportToExcelAsync()
    {
        try
        {
            _logger.LogInformation("ExportToExcelAsync called");

            var queryParams = new List<string>();

            if (selectedFournisseurId.HasValue)
            {
                queryParams.Add($"fournisseurId={selectedFournisseurId.Value}");
            }

            if (selectedAccountingYearId.HasValue)
            {
                queryParams.Add($"accountingYearId={selectedAccountingYearId.Value}");
            }

            if (selectedDateEcheanceFrom.HasValue)
            {
                queryParams.Add($"dateEcheanceFrom={Uri.EscapeDataString(selectedDateEcheanceFrom.Value.ToString("yyyy-MM-ddTHH:mm:ss"))}");
            }

            if (selectedDateEcheanceTo.HasValue)
            {
                queryParams.Add($"dateEcheanceTo={Uri.EscapeDataString(selectedDateEcheanceTo.Value.ToString("yyyy-MM-ddTHH:mm:ss"))}");
            }

            if (selectedMontantMin.HasValue)
            {
                queryParams.Add($"montantMin={selectedMontantMin.Value}");
            }

            if (selectedMontantMax.HasValue)
            {
                queryParams.Add($"montantMax={selectedMontantMax.Value}");
            }

            if (selectedReglementStatus.HasValue)
            {
                bool hasNumeroTransactionBancaire = selectedReglementStatus.Value == 1;
                queryParams.Add($"hasNumeroTransactionBancaire={hasNumeroTransactionBancaire.ToString().ToLower()}");
            }

            if (selectedMois.HasValue)
            {
                queryParams.Add($"mois={selectedMois.Value}");
            }

            var baseUrl = Configuration.GetValue<string>("ApiSettings:BaseUrl")
                ?? throw new InvalidOperationException("ApiSettings:BaseUrl configuration is missing");
            
            var url = $"{baseUrl.TrimEnd('/')}/api/paiement-fournisseur/export/excel";
            if (queryParams.Any())
            {
                url += "?" + string.Join("&", queryParams);
            }

            _logger.LogInformation("Calling Excel export endpoint: {Url}", url);

            var response = await HttpClient.GetAsync(url);

            if (!response.IsSuccessStatusCode)
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                _logger.LogError("Excel export failed with status {StatusCode}. Response: {ErrorContent}", 
                    response.StatusCode, errorContent);
                
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Erreur",
                    Detail = "Erreur lors de l'export Excel. Veuillez réessayer.",
                    Duration = 4000
                });
                return;
            }

            var fileBytes = await response.Content.ReadAsByteArrayAsync();
            var fileName = response.Content.Headers.ContentDisposition?.FileName 
                ?? $"Paiements_Fournisseurs_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";

            fileName = fileName.Trim('"');

            var base64String = Convert.ToBase64String(fileBytes);
            await JS.InvokeVoidAsync("downloadFile", fileName, base64String, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Succès",
                Detail = "Export Excel réussi.",
                Duration = 3000
            });

            _logger.LogInformation("Excel export completed successfully");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error exporting to Excel");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Erreur",
                Detail = $"Erreur lors de l'export: {ex.Message}",
                Duration = 4000
            });
        }
    }

    private async Task ExportToPdfAsync()
    {
        try
        {
            _logger.LogInformation("ExportToPdfAsync called");

            var queryParams = new List<string>();

            if (selectedFournisseurId.HasValue)
            {
                queryParams.Add($"fournisseurId={selectedFournisseurId.Value}");
            }

            if (selectedAccountingYearId.HasValue)
            {
                queryParams.Add($"accountingYearId={selectedAccountingYearId.Value}");
            }

            if (selectedDateEcheanceFrom.HasValue)
            {
                queryParams.Add($"dateEcheanceFrom={Uri.EscapeDataString(selectedDateEcheanceFrom.Value.ToString("yyyy-MM-ddTHH:mm:ss"))}");
            }

            if (selectedDateEcheanceTo.HasValue)
            {
                queryParams.Add($"dateEcheanceTo={Uri.EscapeDataString(selectedDateEcheanceTo.Value.ToString("yyyy-MM-ddTHH:mm:ss"))}");
            }

            if (selectedMontantMin.HasValue)
            {
                queryParams.Add($"montantMin={selectedMontantMin.Value}");
            }

            if (selectedMontantMax.HasValue)
            {
                queryParams.Add($"montantMax={selectedMontantMax.Value}");
            }

            if (selectedReglementStatus.HasValue)
            {
                bool hasNumeroTransactionBancaire = selectedReglementStatus.Value == 1;
                queryParams.Add($"hasNumeroTransactionBancaire={hasNumeroTransactionBancaire.ToString().ToLower()}");
            }

            if (selectedMois.HasValue)
            {
                queryParams.Add($"mois={selectedMois.Value}");
            }

            var baseUrl = Configuration.GetValue<string>("ApiSettings:BaseUrl")
                ?? throw new InvalidOperationException("ApiSettings:BaseUrl configuration is missing");
            
            var url = $"{baseUrl.TrimEnd('/')}/api/paiement-fournisseur/export/pdf";
            if (queryParams.Any())
            {
                url += "?" + string.Join("&", queryParams);
            }

            _logger.LogInformation("Calling PDF export endpoint: {Url}", url);

            var response = await HttpClient.GetAsync(url);

            if (!response.IsSuccessStatusCode)
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                _logger.LogError("PDF export failed with status {StatusCode}. Response: {ErrorContent}", 
                    response.StatusCode, errorContent);
                
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Erreur",
                    Detail = "Erreur lors de l'export PDF. Veuillez réessayer.",
                    Duration = 4000
                });
                return;
            }

            var fileBytes = await response.Content.ReadAsByteArrayAsync();
            var fileName = response.Content.Headers.ContentDisposition?.FileName 
                ?? $"Paiements_Fournisseurs_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";

            fileName = fileName.Trim('"');

            var base64String = Convert.ToBase64String(fileBytes);
            await JS.InvokeVoidAsync("downloadFile", fileName, base64String, "application/pdf");

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Succès",
                Detail = "Export PDF réussi.",
                Duration = 3000
            });

            _logger.LogInformation("PDF export completed successfully");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error exporting to PDF");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Erreur",
                Detail = $"Erreur lors de l'export: {ex.Message}",
                Duration = 4000
            });
        }
    }

    public void Dispose()
    {
        cancellationTokenSource.Cancel();
        cancellationTokenSource.Dispose();
    }

    private class ReglementStatusOption
    {
        public string Text { get; set; } = string.Empty;
        public int? Value { get; set; }
    }

    private class MoisOption
    {
        public string Text { get; set; } = string.Empty;
        public int? Value { get; set; }
    }
}



