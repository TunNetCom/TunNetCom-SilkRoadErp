@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@inject IAuthService AuthService
@inject NavigationManager Navigation

@if (IsLoginPage)
{
    <RouteView RouteData="@RouteData" DefaultLayout="@DefaultLayout" />
    <FocusOnNavigate RouteData="@RouteData" Selector="h1" />
}
else if (IsAuthorized)
{
    <RouteView RouteData="@RouteData" DefaultLayout="@DefaultLayout" />
    <FocusOnNavigate RouteData="@RouteData" Selector="h1" />
}
else
{
    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; color: #fff; background: #1a1a1a;">
        <div>VÃ©rification de l'authentification...</div>
    </div>
}

@code {
    [Parameter] public RouteData? RouteData { get; set; }
    [Parameter] public Type? DefaultLayout { get; set; }

    private bool IsAuthorized { get; set; }
    private bool IsLoginPage { get; set; }
    private bool _hasCheckedAuth = false;

    protected override void OnInitialized()
    {
        // Check if this is the login page - allow access immediately
        var currentUri = Navigation.Uri.ToLowerInvariant();
        var pageType = RouteData?.PageType;
        
        // Only allow login page, block everything else
        IsLoginPage = currentUri.EndsWith("/login") || 
                     currentUri.EndsWith("/login/") ||
                     pageType?.Name == "LoginPage" || 
                     pageType?.FullName?.Contains("Login") == true;
        
        // If not login page, set IsAuthorized to false initially to block access
        if (!IsLoginPage)
        {
            IsAuthorized = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Always allow login page without any async checks
        if (IsLoginPage)
            return;

        if (!firstRender || _hasCheckedAuth)
            return;

        _hasCheckedAuth = true;

        try
        {
            // Load token from storage
            await AuthService.LoadTokenFromStorageAsync();

            // Check if user is authenticated
            if (AuthService.IsAuthenticated)
            {
                IsAuthorized = true;
                await InvokeAsync(StateHasChanged);
            }
            else
            {
                // Not authenticated, redirect to login immediately
                IsAuthorized = false;
                await Task.Delay(50);
                Navigation.NavigateTo("/login", forceLoad: true);
            }
        }
        catch (Exception)
        {
            // If there's an error, redirect to login immediately
            IsAuthorized = false;
            await Task.Delay(50);
            Navigation.NavigateTo("/login", forceLoad: true);
        }
    }
}

