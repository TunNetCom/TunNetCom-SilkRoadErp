@using Microsoft.Extensions.Localization
@using TunNetCom.SilkRoadErp.Sales.WebApp.Locales
@using TunNetCom.SilkRoadErp.Sales.WebApp.Services
@using TunNetCom.SilkRoadErp.Sales.WebApp.Constants
@inherits LayoutComponentBase
@inject IStringLocalizer<SharedResource> Localizer
@inject NavigationManager NavigationManager
@inject IAuthService AuthService
@inject ILogger<MainLayout> Logger

<RadzenComponents @rendermode="InteractiveAuto" />

<RadzenLayout>
    <RadzenHeader>
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 0 15px;">
            <!-- Left side -->
            <div style="display: flex; align-items: center; gap: 0;">
                <RadzenSidebarToggle Click="@(() => sidebarExpanded = !sidebarExpanded)" />
                <RadzenLabel Text="@Localizer["Silk_Road_ERP"]" Style="margin-left: 10px" />
            </div>

            <!-- Right side -->
            <div style="display: flex; align-items: center; gap: 20px;">
                <AccountingYearSelector />
                <LanguageSelector />
                <RadzenAppearanceToggle />
                <RadzenButton Click="OpenAccountSettings" Icon="manage_accounts"  Size="ButtonSize.Medium" />
            </div>
        </div>
    </RadzenHeader>
    <RadzenSidebar Responsive="false" Style="width: max-content; display: flex; flex-direction: column;">
        <RadzenPanelMenu DisplayStyle="@(sidebarExpanded? MenuItemDisplayStyle.IconAndText: MenuItemDisplayStyle.Icon)" ShowArrow="false" Style="flex: 1;">
            <RadzenPanelMenuItem Text="@Localizer["Overview"]" Icon="home" />
            <RadzenPanelMenuItem Text="@Localizer["Dashboard"]" Icon="dashboard" />
            <RadzenPanelMenuItem Text="@Localizer["Clients"]" Icon="account_circle">
                <RadzenPanelMenuItem Text="@Localizer["Accounts"]" Icon="description" Path="/customers_list" />
                <RadzenPanelMenuItem Text="@Localizer["manage_invoices"]" Icon="chrome_reader_mode" Path="/manage-invoice" />
                <RadzenPanelMenuItem Text="@Localizer["Invoices_List"]" Icon="receipt" Path="/invoices" />
                <RadzenPanelMenuItem Text="Liste des avoirs" Icon="receipt_long" Path="/avoirs" />
                <RadzenPanelMenuItem Text="Gérer les avoirs" Icon="edit_note" Path="/manage-avoirs" />
                <RadzenPanelMenuItem Text="@Localizer["Delivery_Note"]" Icon="add_shopping_cart" Path="/AddOrUpdateDeliveryNote" />
                <RadzenPanelMenuItem Text="@Localizer["Delivery_Notes_List"]" Icon="pageview" Path="/delivery-notes" />
                <RadzenPanelMenuItem Text="Devis" Icon="description" Path="/AddOrUpdateQuotation" />
                <RadzenPanelMenuItem Text="Liste des devis" Icon="list" Path="/quotations" />
                <RadzenPanelMenuItem Text="@Localizer["Paiements_Clients"]" Icon="payment" Path="/paiements-client" />
                <RadzenPanelMenuItem Text="@Localizer["Soldes_Clients"]" Icon="account_balance" Path="/soldes-client" />
            </RadzenPanelMenuItem>
            <RadzenPanelMenuItem Text="@Localizer["providers"]" Icon="card_travel">
                <RadzenPanelMenuItem Text="@Localizer["Accounts"]" Icon="description" Path="/providers_list" />
                <RadzenPanelMenuItem Text="@Localizer["manage_invoices"]" Icon="chrome_reader_mode" Path="/manage-providers-invoices" />
                <RadzenPanelMenuItem Text="Liste des factures fournisseurs" Icon="receipt" Path="/provider-invoices" />
                <RadzenPanelMenuItem Text="Liste des avoirs fournisseur" Icon="receipt_long" Path="/avoir-fournisseur" />
                <RadzenPanelMenuItem Text="Gérer les avoirs fournisseur" Icon="edit_note" Path="/manage-avoir-fournisseur" />
                <RadzenPanelMenuItem Text="Liste des factures avoir" Icon="description" Path="/facture-avoir-fournisseur" />
                <RadzenPanelMenuItem Text="Gérer les factures avoir" Icon="chrome_reader_mode" Path="/manage-facture-avoir-fournisseur" />
                <RadzenPanelMenuItem Text="Commande" Icon="shopping_cart" Path="/AddOrUpdateOrder" />
                <RadzenPanelMenuItem Text="Liste des commandes" Icon="list" Path="/orders" />
                <RadzenPanelMenuItem Text="@Localizer["Receipt_Note"]" Icon="add_shopping_cart" Path="/add_or_update_reciption_notes" />
                <RadzenPanelMenuItem Text="@Localizer["Receipt_Notes_List"]" Icon="pageview" Path="/reciption_notes" />
                <RadzenPanelMenuItem Text="@Localizer["Paiements_Fournisseurs"]" Icon="payment" Path="/paiements-fournisseur" />
                <RadzenPanelMenuItem Text="@Localizer["Soldes_Fournisseurs"]" Icon="account_balance" Path="/soldes-fournisseur" />
            </RadzenPanelMenuItem>
            <RadzenPanelMenuItem Text="@Localizer["Stock"]" Icon="event_seat">
                <RadzenPanelMenuItem Text="@Localizer["Articles"]" Icon="description" Path="/products_list" />
                <RadzenPanelMenuItem Text="@Localizer["inventaires"]" Icon="inventory" Path="/inventaires" />
            </RadzenPanelMenuItem>
            <RadzenPanelMenuItem Text="Installateurs" Icon="engineering" Path="/installation-technicians" />
            <RadzenPanelMenuItem Text="@Localizer["Banques"]" Icon="account_balance_wallet" Path="/banques" />
            
            <!-- Menu Administration -->
            <RadzenPanelMenuItem Text="Administration" Icon="admin_panel_settings">
                <HasPermission Permission="@Permissions.ViewAuditLogs">
                    <RadzenPanelMenuItem Text="Journal d'Audit" Icon="history" Path="/audit-logs" />
                </HasPermission>
                <HasPermission AnyPermissions="new[] { Permissions.ManageUsers, Permissions.ViewUsers }">
                    <RadzenPanelMenuItem Text="Utilisateurs" Icon="people" Path="/users" />
                </HasPermission>
                <HasPermission AnyPermissions="new[] { Permissions.ManageRoles, Permissions.ViewRoles }">
                    <RadzenPanelMenuItem Text="Rôles" Icon="security" Path="/admin/roles" />
                </HasPermission>
                <HasPermission Permission="@Permissions.ViewAppParameters">
                    <RadzenPanelMenuItem Text="Paramètres" Icon="settings" Path="/app_parameters" />
                </HasPermission>
                <RadzenPanelMenuItem Text="Déconnexion" Icon="logout" Click="@HandleLogout" />
            </RadzenPanelMenuItem>
        </RadzenPanelMenu>
        
        <!-- User section at the bottom of sidebar -->
        <div style="padding: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; gap: 12px;" @onclick:stopPropagation="true">
            @if (userInfo != null)
            {
                <!-- Avatar circulaire -->
                <div style="width: 40px; height: 40px; border-radius: 50%; background: #8b5cf6; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <span style="color: white; font-weight: 600; font-size: 14px; text-transform: uppercase;">
                        @GetInitials(userInfo.DisplayName ?? userInfo.Username)
                    </span>
                </div>
                
                @if (sidebarExpanded)
                {
                    <!-- Informations utilisateur -->
                    <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px;">
                        <span style="color: white; font-weight: 400; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2;">
                            @userInfo.Username
                        </span>
                        <span style="color: rgba(255, 255, 255, 0.7); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2;">
                            @userInfo.Email
                        </span>
                    </div>
                    
                    <!-- Menu avec trois points -->
                    <div style="position: relative;">
                        <RadzenButton Icon="more_vert" 
                                     ButtonStyle="ButtonStyle.Light" 
                                     Variant="Variant.Flat"
                                     Size="ButtonSize.Small"
                                     Click="@(() => showMenu = !showMenu)"
                                     Style="min-width: 32px; height: 32px; padding: 0; background: rgba(255, 255, 255, 0.1); border-radius: 6px;" />
                        @if (showMenu)
                        {
                            <div style="position: absolute; bottom: 100%; right: 0; margin-bottom: 8px; background: var(--rz-base-background-color); border: 1px solid var(--rz-border-color); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 160px; overflow: hidden;">
                                <div style="padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background-color 0.2s;" 
                                     @onclick="@(async () => { showMenu = false; await HandleLogout(); })"
                                     @onclick:stopPropagation="true"
                                     class="menu-item">
                                    <RadzenIcon Icon="logout" Style="font-size: 18px;" />
                                    <span style="font-size: 14px;">Déconnexion</span>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <!-- Menu avec trois points quand sidebar réduite -->
                    <div style="position: relative; margin-left: auto;">
                        <RadzenButton Icon="more_vert" 
                                     ButtonStyle="ButtonStyle.Light" 
                                     Variant="Variant.Flat"
                                     Size="ButtonSize.Small"
                                     Click="@(() => showMenu = !showMenu)"
                                     Style="min-width: 32px; height: 32px; padding: 0; background: rgba(255, 255, 255, 0.1); border-radius: 6px;" />
                        @if (showMenu)
                        {
                            <div style="position: absolute; bottom: 100%; right: 0; margin-bottom: 8px; background: var(--rz-base-background-color); border: 1px solid var(--rz-border-color); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 160px; overflow: hidden;">
                                <div style="padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background-color 0.2s;" 
                                     @onclick="@(async () => { showMenu = false; await HandleLogout(); })"
                                     @onclick:stopPropagation="true"
                                     class="menu-item">
                                    <RadzenIcon Icon="logout" Style="font-size: 18px;" />
                                    <span style="font-size: 14px;">Déconnexion</span>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    </RadzenSidebar>
    <RadzenBody>
        <div class="rz-p-4">
            @Body
        </div>
    </RadzenBody>
    <RadzenFooter>
    </RadzenFooter>
</RadzenLayout>

@code {
    bool sidebarExpanded = true;
    bool isLoggingOut = false;
    bool showMenu = false;
    UserInfo? userInfo;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadUserInfo();
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        // Close menu when clicking outside
        NavigationManager.LocationChanged += (sender, args) => 
        {
            showMenu = false;
            StateHasChanged();
        };
    }

    private async Task LoadUserInfo()
    {
        try
        {
            Logger.LogInformation("MainLayout: Loading token from storage");
            await AuthService.LoadTokenFromStorageAsync();
            Logger.LogInformation("MainLayout: Token loaded. IsAuthenticated: {IsAuthenticated}", AuthService.IsAuthenticated);
            userInfo = AuthService.GetUserInfo();
        }
        catch (InvalidOperationException ioEx) when (ioEx.Message.Contains("prerendering") || ioEx.Message.Contains("statically rendered") || ioEx.Message.Contains("JavaScript interop calls cannot be issued"))
        {
            // JS interop not available during prerendering - this is expected
            Logger.LogInformation("MainLayout: Cannot load token during prerendering. This is expected.");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "MainLayout: Error loading user info");
        }
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name))
            return "U";
        
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return (parts[0][0].ToString() + parts[1][0].ToString()).ToUpper();
        }
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name[0].ToString().ToUpper();
    }

    void OpenAccountSettings()
    {
        NavigationManager.NavigateTo($"/app_parameters");
    }


    private async Task HandleLogout()
    {
        if (isLoggingOut)
            return;

        try
        {
            isLoggingOut = true;
            await AuthService.LogoutAsync();
            NavigationManager.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception)
        {
            // Even if logout fails, redirect to login
            NavigationManager.NavigateTo("/login", forceLoad: true);
        }
        finally
        {
            isLoggingOut = false;
        }
    }
}



<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

<Toasts class="p-3" AutoHide="true" Delay="4000" Placement="ToastsPlacement.TopRight" />

<style>
    .menu-item:hover {
        background-color: var(--rz-base-hover-background-color) !important;
    }
</style>

