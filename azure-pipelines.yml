#trigger:
#- master

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: silkroad-prod
- name: solution
  value: '**/*.sln'
- name: buildConfiguration
  value: 'Release'
- name: dockerRepository
  value: 'tunnetcom/silkroad'
- name: apiTag
  value: 'api-$(Build.BuildId)'
- name: webappTag
  value: 'webapp-$(Build.BuildId)'

stages:
# ============================================================
# 1Ô∏è‚É£ BUILD & PUSH STAGE
# ============================================================
- stage: BuildAndPush
  displayName: Build and Push Docker Images
  jobs:
  - job: BuildPushJob
    displayName: Build & Push
    steps:

    # -----------------------------
    # Login to DockerHub
    # -----------------------------
    - task: Docker@2
      displayName: 'Login to DockerHub'
      inputs:
        command: login
        containerRegistry: 'TunNetCom_Dockerhub_Connection'

    # -----------------------------
    # Use .NET SDK
    # -----------------------------
    - task: UseDotNet@2
      displayName: 'Use .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '10.x'

    # -----------------------------
    # Restore & Build
    # -----------------------------
    - task: DotNetCoreCLI@2
      displayName: 'Restore'
      inputs:
        command: 'restore'
        projects: '$(solution)'

    - task: DotNetCoreCLI@2
      displayName: 'Build'
      inputs:
        command: 'build'
        projects: '$(solution)'
        arguments: '--configuration $(buildConfiguration) --no-restore'

    # -----------------------------
    # Build API Docker Image
    # -----------------------------
    - script: |
        set -e
        echo "üê≥ Building API Docker image..."
        docker build \
          --no-cache \
          --progress=plain \
          --target api \
          -t $(dockerRepository):$(apiTag) \
          -f Dockerfile \
          .
        echo "‚úÖ API image built successfully"
        docker images | grep $(dockerRepository) | grep $(apiTag)
      displayName: 'Build API Docker Image'

    # -----------------------------
    # Tag and Push API (both versioned and latest tags)
    # -----------------------------
    - script: |
        set -e
        echo "üè∑Ô∏è  Tagging API image with latest tag..."
        docker tag $(dockerRepository):$(apiTag) $(dockerRepository):latest-api
        echo "üì§ Pushing API Docker image with versioned tag: $(dockerRepository):$(apiTag)"
        docker push $(dockerRepository):$(apiTag)
        echo "üì§ Pushing API Docker image with latest tag: $(dockerRepository):latest-api"
        docker push $(dockerRepository):latest-api
        echo "‚úÖ API image pushed successfully (both $(apiTag) and latest-api)"
      displayName: 'Push API Docker Image'

    # -----------------------------
    # Build WebApp Docker Image
    # -----------------------------
    - script: |
        set -e
        echo "üê≥ Building WebApp Docker image..."
        docker build \
          --no-cache \
          --progress=plain \
          --target webapp \
          -t $(dockerRepository):$(webappTag) \
          -f Dockerfile \
          .
        echo "‚úÖ WebApp image built successfully"
        docker images | grep $(dockerRepository) | grep $(webappTag)
      displayName: 'Build WebApp Docker Image'

    # -----------------------------
    # Tag and Push WebApp (both versioned and latest tags)
    # -----------------------------
    - script: |
        set -e
        echo "üè∑Ô∏è  Tagging WebApp image with latest tag..."
        docker tag $(dockerRepository):$(webappTag) $(dockerRepository):latest-webapp
        echo "üì§ Pushing WebApp Docker image with versioned tag: $(dockerRepository):$(webappTag)"
        docker push $(dockerRepository):$(webappTag)
        echo "üì§ Pushing WebApp Docker image with latest tag: $(dockerRepository):latest-webapp"
        docker push $(dockerRepository):latest-webapp
        echo "‚úÖ WebApp image pushed successfully (both $(webappTag) and latest-webapp)"
      displayName: 'Push WebApp Docker Image'

    # ============================================================
    # PUBLISH DEPLOYMENT FILES AS ARTIFACT
    # ============================================================
    - script: |
        set -e
        echo "üì¶ Preparing deployment artifacts..."
        mkdir -p $(Build.ArtifactStagingDirectory)/deployments
        cp -v src/deployments/*.yaml $(Build.ArtifactStagingDirectory)/deployments/
        echo "‚úÖ Deployment files copied to artifact staging"
        ls -la $(Build.ArtifactStagingDirectory)/deployments/
      displayName: 'Prepare Deployment Artifacts'

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Deployment Artifacts'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)/deployments'
        artifactName: 'k8s-manifests'
        publishLocation: 'Container'

# ============================================================
# 2Ô∏è‚É£ DEPLOY STAGE TO ON-PREM KUBERNETES
# ============================================================
- stage: Deploy
  displayName: Deploy to On-Prem Kubernetes
  dependsOn: BuildAndPush
  jobs:
  - job: DeployJob
    displayName: Deploy SilkRoad to prod-silkroad
    pool:
      name: OnPremAgents
    steps:

    # ============================================================
    # DOWNLOAD DEPLOYMENT ARTIFACTS
    # ============================================================
    - task: DownloadBuildArtifacts@0
      displayName: 'Download Deployment Manifests'
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'k8s-manifests'
        downloadPath: '$(Pipeline.Workspace)'

    # 1Ô∏è‚É£ Debug folder & files
    - script: |
        set -e
        echo "üìÇ Pipeline workspace: $(Pipeline.Workspace)"
        echo "üìÇ Current directory: $(pwd)"
        echo ""
        echo "üìÑ Downloaded files:"
        find $(Pipeline.Workspace) -type f -name "*.yaml" -o -name "*.yml"
        echo ""
        cd $(Pipeline.Workspace)/k8s-manifests
        echo "üìÑ Listing YAML files in deployment directory:"
        ls -la
      displayName: 'Debug: List deployment files'

    # 2Ô∏è‚É£ Update image tags in YAML
    - script: |
        set -e
        cd $(Pipeline.Workspace)/k8s-manifests
        
        echo "üîß Before substitution:"
        echo "=== prod-deployment.yaml ==="
        grep 'image:' prod-deployment.yaml || echo "No 'image:' found"
        
        echo ""
        echo "üîÑ Running sed substitutions..."
        echo "   Replacing API_TAG_PLACEHOLDER with: $(apiTag)"
        echo "   Replacing WEBAPP_TAG_PLACEHOLDER with: $(webappTag)"
        
        sed -i "s|API_TAG_PLACEHOLDER|$(apiTag)|g" prod-deployment.yaml
        sed -i "s|WEBAPP_TAG_PLACEHOLDER|$(webappTag)|g" prod-deployment.yaml
        
        echo ""
        echo "‚úÖ After substitution:"
        echo "=== prod-deployment.yaml ==="
        grep 'image:' prod-deployment.yaml
      displayName: 'Update image tags'

    # 3Ô∏è‚É£ Create / Update DB secret
    - script: |
        set -e
        echo "üîê Creating/updating database connection secret..."
        kubectl create secret generic silkroad-connection-secret \
          -n silkroad-prod \
          --from-literal=ConnectionStrings__DefaultConnection="$(CONNECTION_STRING)" \
          --dry-run=client -o yaml | kubectl apply -f -
        echo "‚úÖ Database secret created/updated"
      displayName: 'Create DB Connection Secret'

    # 4Ô∏è‚É£ Apply deployment & force new images
    - script: |
        set -e
        
        echo "üîç Kubernetes cluster info:"
        kubectl version --client
        kubectl cluster-info
        
        echo ""
        echo "üßπ Deleting old pods to force fresh image pull..."
        kubectl delete pods -n silkroad-prod -l app=silkroad-api --ignore-not-found=true || true
        kubectl delete pods -n silkroad-prod -l app=silkroad-webapp --ignore-not-found=true || true
        
        echo "‚è≥ Waiting 5 seconds for pods to terminate..."
        sleep 5
        
        echo ""
        echo "üìã Applying deployment manifests..."
        kubectl apply -f $(Pipeline.Workspace)/k8s-manifests/prod-deployment.yaml -n silkroad-prod
        
        echo ""
        echo "üîç Verifying image references in deployment spec:"
        echo "=== silkroad-api ==="
        kubectl get deployment silkroad-api -n silkroad-prod -o jsonpath='{.spec.template.spec.containers[0].image}' || echo "Not found"
        echo ""
        echo "=== silkroad-webapp ==="
        kubectl get deployment silkroad-webapp -n silkroad-prod -o jsonpath='{.spec.template.spec.containers[0].image}' || echo "Not found"
        echo ""
        
        echo "‚è≥ Waiting for rollout to complete (timeout: 5 minutes)..."
        kubectl rollout status deployment/silkroad-api -n silkroad-prod --timeout=5m || { echo "‚ö†Ô∏è  silkroad-api rollout status check failed"; }
        kubectl rollout status deployment/silkroad-webapp -n silkroad-prod --timeout=5m || { echo "‚ö†Ô∏è  silkroad-webapp rollout status check failed"; }
        
        echo ""
        echo "üìä Final pod status:"
        kubectl get pods -n silkroad-prod -o wide
        
        echo ""
        echo "üìä Current deployment images:"
        kubectl get deployments -n silkroad-prod -o wide
        
        echo ""
        echo "‚úÖ Deployment process complete!"
      displayName: 'Deploy to Kubernetes'

    # 5Ô∏è‚É£ Verify deployment
    - script: |
        set -e
        
        echo "üîç Post-deployment verification..."
        echo ""
        
        echo "Checking API pod status:"
        API_POD=$(kubectl get pods -n silkroad-prod -l app=silkroad-api -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "Not found")
        if [ "$API_POD" != "Not found" ]; then
          echo "Pod: $API_POD"
          kubectl describe pod $API_POD -n silkroad-prod | grep -A 5 "Image:"
          echo ""
          kubectl logs $API_POD -n silkroad-prod --tail=50 || echo "No logs available yet"
        else
          echo "‚ùå API pod not found"
        fi
        
        echo ""
        echo "Checking WebApp pod status:"
        WEBAPP_POD=$(kubectl get pods -n silkroad-prod -l app=silkroad-webapp -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "Not found")
        if [ "$WEBAPP_POD" != "Not found" ]; then
          echo "Pod: $WEBAPP_POD"
          kubectl describe pod $WEBAPP_POD -n silkroad-prod | grep -A 5 "Image:"
          echo ""
          kubectl logs $WEBAPP_POD -n silkroad-prod --tail=50 || echo "No logs available yet"
        else
          echo "‚ùå WebApp pod not found"
        fi
        
        echo ""
        echo "Recent events in namespace:"
        kubectl get events -n silkroad-prod --sort-by='.lastTimestamp' | tail -15
        
      displayName: 'Verify Deployment'
      continueOnError: true