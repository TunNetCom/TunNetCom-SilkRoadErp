trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  solution: '**/*.sln'
  buildConfiguration: 'Release'
  dockerRepository: 'tunnetcom/silkroad'      
  apiTag: 'api-$(Build.BuildId)'
  webappTag: 'webapp-$(Build.BuildId)'

steps:
# 1. Setup Docker Buildx for better multi-platform support
- task: Docker@2
  displayName: 'Set up Docker Buildx'
  inputs:
    command: login
    containerRegistry: 'TunNetCom_Dockerhub_Connection'

# 2. .NET Build with warnings as errors disabled
- task: UseDotNet@2
  displayName: 'Use .NET 10 SDK'
  inputs:
    packageType: 'sdk'
    version: '10.x'

- task: DotNetCoreCLI@2
  displayName: 'Restore'
  inputs:
    command: 'restore'
    projects: '$(solution)'
    arguments: '--verbosity normal'

- task: DotNetCoreCLI@2
  displayName: 'Build'
  inputs:
    command: 'build'
    projects: '$(solution)'
    arguments: '--configuration $(buildConfiguration) --no-restore --verbosity normal'

# -----------------------------
# Build API Image
# -----------------------------
- script: |
    echo "Building API image..."
    docker build \
      --progress=plain \
      --target api \
      -t $(dockerRepository):$(apiTag) \
      -t $(dockerRepository):latest-api \
      -f Dockerfile \
      .
    
    echo "Built images:"
    docker images | grep $(dockerRepository)
  displayName: 'Build API Docker Image'
  continueOnError: false

# -----------------------------
# Push API Image
# -----------------------------
- script: |
    echo "Pushing API image..."
    docker push $(dockerRepository):$(apiTag)
    docker push $(dockerRepository):latest-api
  displayName: 'Push API Docker Image'
  continueOnError: false

# -----------------------------
# Build WebApp Image
# -----------------------------
- script: |
    echo "Building WebApp image..."
    docker build \
      --progress=plain \
      --target webapp \
      -t $(dockerRepository):$(webappTag) \
      -t $(dockerRepository):latest-webapp \
      -f Dockerfile \
      .
    
    echo "Built images:"
    docker images | grep $(dockerRepository)
  displayName: 'Build WebApp Docker Image'
  continueOnError: false

# -----------------------------
# Push WebApp Image
# -----------------------------
- script: |
    echo "Pushing WebApp image..."
    docker push $(dockerRepository):$(webappTag)
    docker push $(dockerRepository):latest-webapp
  displayName: 'Push WebApp Docker Image'
  continueOnError: false