# ============================================================
# Dev CI/CD Pipeline for SilkRoad (Deploys to silkroad-dev)
# ============================================================
#trigger:
#- master

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: silkroad-prod    # ‚ö° Use dev-specific variable group containing Connection_String_Dev
- name: solution
  value: '**/*.sln'
- name: buildConfiguration
  value: 'Release'
- name: dockerRepository
  value: 'tunnetcom/silkroad'
- name: apiTag
  value: 'api-$(Build.BuildId)'
- name: webappTag
  value: 'webapp-$(Build.BuildId)'
- name: kubeNamespace
  value: 'silkroad-dev'   # Dev namespace

stages:
# ============================================================
# 1Ô∏è‚É£ BUILD & PUSH STAGE
# ============================================================
- stage: BuildAndPush
  displayName: Build and Push Docker Images
  jobs:
  - job: BuildPushJob
    displayName: Build & Push
    steps:

    # -----------------------------
    # Login to DockerHub
    # -----------------------------
    - task: Docker@2
      displayName: 'Login to DockerHub'
      inputs:
        command: login
        containerRegistry: 'TunNetCom_Dockerhub_Connection'

    # -----------------------------
    # Use .NET SDK
    # -----------------------------
    - task: UseDotNet@2
      displayName: 'Use .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '10.x'

    # -----------------------------
    # Restore & Build
    # -----------------------------
    - task: DotNetCoreCLI@2
      displayName: 'Restore'
      inputs:
        command: 'restore'
        projects: '$(solution)'

    - task: DotNetCoreCLI@2
      displayName: 'Build'
      inputs:
        command: 'build'
        projects: '$(solution)'
        arguments: '--configuration $(buildConfiguration) --no-restore'

    # -----------------------------
    # Build API Docker Image
    # -----------------------------
    - script: |
        set -e
        echo "üê≥ Building API Docker image..."
        docker build --no-cache --progress=plain --target api \
          -t $(dockerRepository):$(apiTag) -f Dockerfile .
        echo "‚úÖ API image built successfully"
      displayName: 'Build API Docker Image'

    # -----------------------------
    # Tag and Push API
    # -----------------------------
    - script: |
        set -e
        docker tag $(dockerRepository):$(apiTag) $(dockerRepository):latest-api
        docker push $(dockerRepository):$(apiTag)
        docker push $(dockerRepository):latest-api
        echo "‚úÖ API image pushed successfully"
      displayName: 'Push API Docker Image'

    # -----------------------------
    # Build WebApp Docker Image
    # -----------------------------
    - script: |
        set -e
        echo "üê≥ Building WebApp Docker image..."
        docker build --no-cache --progress=plain --target webapp \
          -t $(dockerRepository):$(webappTag) -f Dockerfile .
        echo "‚úÖ WebApp image built successfully"
      displayName: 'Build WebApp Docker Image'

    # -----------------------------
    # Tag and Push WebApp
    # -----------------------------
    - script: |
        set -e
        docker tag $(dockerRepository):$(webappTag) $(dockerRepository):latest-webapp
        docker push $(dockerRepository):$(webappTag)
        docker push $(dockerRepository):latest-webapp
        echo "‚úÖ WebApp image pushed successfully"
      displayName: 'Push WebApp Docker Image'

    # -----------------------------
    # Publish Deployment Files as Artifact
    # -----------------------------
    - script: |
        set -e
        mkdir -p $(Build.ArtifactStagingDirectory)/deployments
        cp -v src/deployments/*.yaml $(Build.ArtifactStagingDirectory)/deployments/
        echo "‚úÖ Deployment files copied"
      displayName: 'Prepare Deployment Artifacts'

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Deployment Artifacts'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)/deployments'
        artifactName: 'k8s-manifests'
        publishLocation: 'Container'

# ============================================================
# 2Ô∏è‚É£ DEPLOY STAGE TO DEV KUBERNETES
# ============================================================
- stage: Deploy
  displayName: Deploy to SilkRoad Dev (silkroad-dev)
  dependsOn: BuildAndPush
  jobs:
  - job: DeployJob
    displayName: K8s Deployment
    pool:
      name: OnPremAgents
    steps:

    # -----------------------------
    # Check Cluster Access
    # -----------------------------
    - script: |
        echo "üîç Checking Kubernetes cluster access..."
        kubectl version --client
        kubectl cluster-info
      displayName: 'Check Kubernetes Cluster'

    # -----------------------------
    # Ensure DB Secret in dev namespace
    # -----------------------------
    - script: |
        echo "üîê Creating/updating database connection secret in dev..."
        kubectl create secret generic silkroad-connection-secret \
          -n $(kubeNamespace) \
          --from-literal=ConnectionStrings__DefaultConnection="$(Connection_String_Dev)" \
          --dry-run=client -o yaml | kubectl apply -f -
        echo "‚úÖ DB secret ready"
      displayName: 'Create DB Secret for Dev'
      env:
        Connection_String_Dev: $(Connection_String_Dev)

    # -----------------------------
    # Apply Kubernetes Manifests
    # -----------------------------
    - script: |
        echo "üöÄ Applying Kubernetes manifests to $(kubeNamespace)..."
        kubectl apply -f $(Pipeline.Workspace)/k8s-manifests/prod-deployment.yaml -n $(kubeNamespace)
        echo "‚úÖ Manifests applied"
      displayName: 'Apply Manifests'

    # -----------------------------
    # Update Deployment Images
    # -----------------------------
    - script: |
        echo "üîÑ Updating deployment images to latest tags..."
        kubectl set image deployment/silkroad-api api=$(dockerRepository):latest-api -n $(kubeNamespace)
        kubectl set image deployment/silkroad-webapp webapp=$(dockerRepository):latest-webapp -n $(kubeNamespace)
        echo "‚úÖ Images updated"
      displayName: 'Update Deployment Images'

    # -----------------------------
    # Force Rollout / Pull Latest Images
    # -----------------------------
    - script: |
        echo "üîÑ Restarting deployments to pull latest images..."
        kubectl rollout restart deployment/silkroad-api -n $(kubeNamespace)
        kubectl rollout restart deployment/silkroad-webapp -n $(kubeNamespace)
        echo "‚úÖ Rollout restarted"
      displayName: 'Force Image Refresh'

    # -----------------------------
    # Wait for Rollout Completion
    # -----------------------------
    - script: |
        echo "‚è≥ Waiting for API rollout..."
        kubectl rollout status deployment/silkroad-api -n $(kubeNamespace) --timeout=300s
        echo "‚è≥ Waiting for WebApp rollout..."
        kubectl rollout status deployment/silkroad-webapp -n $(kubeNamespace) --timeout=300s
      displayName: 'Wait for Rollout'

    # -----------------------------
    # Verify Deployment
    # -----------------------------
    - script: |
        echo "üîç Verifying deployed pods..."
        kubectl get pods -n $(kubeNamespace) -o wide
        kubectl get secrets -n $(kubeNamespace)
      displayName: 'Verify Deployment'

    # -----------------------------
    # Final Status
    # -----------------------------
    - script: |
        echo "‚úÖ Dev deployment finished successfully!"
        kubectl get all -n $(kubeNamespace)
      displayName: 'Final Status'
