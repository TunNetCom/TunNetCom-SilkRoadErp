trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  solution: '**/*.sln'
  buildConfiguration: 'Release'
  dockerRepository: 'tunnetcom/silkroad'
  apiTag: 'api-$(Build.BuildId)'
  webappTag: 'webapp-$(Build.BuildId)'

stages:
# ============================================================
# 1Ô∏è‚É£ BUILD & PUSH STAGE
# ============================================================
- stage: BuildAndPush
  displayName: Build and Push Docker Images
  jobs:
  - job: BuildPushJob
    displayName: Build & Push
    steps:

    # -----------------------------
    # Login to DockerHub
    # -----------------------------
    - task: Docker@2
      displayName: 'Login to DockerHub'
      inputs:
        command: login
        containerRegistry: 'TunNetCom_Dockerhub_Connection'

    # -----------------------------
    # Use .NET SDK
    # -----------------------------
    - task: UseDotNet@2
      displayName: 'Use .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '10.x'

    # -----------------------------
    # Restore & Build
    # -----------------------------
    - task: DotNetCoreCLI@2
      displayName: 'Restore'
      inputs:
        command: 'restore'
        projects: '$(solution)'

    - task: DotNetCoreCLI@2
      displayName: 'Build'
      inputs:
        command: 'build'
        projects: '$(solution)'
        arguments: '--configuration $(buildConfiguration) --no-restore'

    # -----------------------------
    # Build API Docker Image
    # -----------------------------
    - script: |
        set -e
        echo "Building API Docker image..."
        docker build \
          --progress=plain \
          --target api \
          -t $(dockerRepository):$(apiTag) \
          -t $(dockerRepository):latest-api \
          -f Dockerfile \
          .

        docker images | grep $(dockerRepository)
      displayName: 'Build API Docker Image'

    # -----------------------------
    # Push API
    # -----------------------------
    - script: |
        set -e
        echo "Pushing API Docker image..."
        docker push $(dockerRepository):$(apiTag)
        docker push $(dockerRepository):latest-api
      displayName: 'Push API Docker Image'

    # -----------------------------
    # Build WebApp Docker Image
    # -----------------------------
    - script: |
        set -e
        WEBAPP_TAG=$(webappTag)
        echo "Building WebApp Docker image with tag $WEBAPP_TAG..."

        docker build \
          --progress=plain \
          --target webapp \
          -t $(dockerRepository):$WEBAPP_TAG \
          -t $(dockerRepository):latest-webapp \
          -f Dockerfile \
          .

        docker images | grep $(dockerRepository)
      displayName: 'Build WebApp Docker Image'

    # -----------------------------
    # Push WebApp
    # -----------------------------
    - script: |
        set -e
        WEBAPP_TAG=$(webappTag)
        echo "Pushing WebApp Docker image with tag $WEBAPP_TAG..."
        docker push $(dockerRepository):$WEBAPP_TAG
        docker push $(dockerRepository):latest-webapp
      displayName: 'Push WebApp Docker Image'


# ============================================================
# 2Ô∏è‚É£ DEPLOY STAGE TO ON-PREM KUBERNETES
# ============================================================
- stage: Deploy
  displayName: Deploy to On-Prem Kubernetes
  dependsOn: BuildAndPush
  jobs:
  - job: DeployJob
    displayName: Deploy SilkRoad to prod-silkroad
    pool:
      name: OnPremAgents

    steps:
    - script: |
        echo "üìÅ Navigating to deployment manifests..."
        cd $(Build.SourcesDirectory)/src/deployments || { echo '‚ùå Deployment folder not found'; exit 1; }

        echo "üìÇ Listing YAML files:"
        ls -l *.yaml

        echo "üîÑ Updating deployment image tags..."
        export API_TAG=$(apiTag)
        export WEB_TAG=$(webappTag)

        # Replace API image
        sed -i "s|image: .*silkroad:.*api.*|image: tunnetcom/silkroad:${API_TAG}|" prod-deployment.yaml

        # Replace WEB image
        sed -i "s|image: .*silkroad:.*webapp.*|image: tunnetcom/silkroad:${WEB_TAG}|" prod-deployment.yaml

        echo "üßæ New image lines:"
        grep 'image:' prod-deployment.yaml

        echo "üîê Checking cluster access..."
        kubectl version --client || { echo '‚ùå kubectl missing'; exit 1; }
        kubectl cluster-info || { echo '‚ùå cluster unreachable'; exit 1; }

        echo "üöÄ Applying manifests..."
        kubectl apply -f prod-deployment.yaml -n silkroad-prod 
        kubectl apply -f prod-service.yaml -n silkroad-prod  || true

        echo "üîÅ Forcing rollout..."
        kubectl rollout restart deployment/silkroad-api -n silkroad-prod  || true
        kubectl rollout restart deployment/silkroad-webapp -n silkroad-prod  || true

        echo "‚è≥ Waiting for rollout..."
        kubectl rollout status deployment/silkroad-api -n silkroad-prod  || { echo '‚ùå API rollout failed'; exit 1; }
        kubectl rollout status deployment/silkroad-webapp -n silkroad-prod  || { echo '‚ùå WebApp rollout failed'; exit 1; }

        echo "‚úÖ Successfully deployed SilkRoad to namespace: prod-silkroad"
      displayName: Deploy to K8s
