trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  solution: '**/*.sln'
  buildConfiguration: 'Release'
  dockerRepository: 'tunnetcom/silkroad'      
  apiTag: 'api-$(Build.BuildId)'
  webappTag: 'webapp-$(Build.BuildId)'

steps:
# .NET Build steps (same as before)
- task: UseDotNet@2
  displayName: 'Use .NET 10 SDK'
  inputs:
    packageType: 'sdk'
    version: '10.x'

- task: DotNetCoreCLI@2
  displayName: 'Restore'
  inputs:
    command: 'restore'
    projects: '$(solution)'

- task: DotNetCoreCLI@2
  displayName: 'Build'
  inputs:
    command: 'build'
    projects: '$(solution)'
    arguments: '--configuration $(buildConfiguration)'

# -----------------------------
# Build and Push API Image using script
# -----------------------------
- task: Bash@3
  displayName: 'Build and Push API Image'
  inputs:
    targetType: 'inline'
    script: |
      # Login to Docker Hub
      echo "$(dockerPassword)" | docker login -u "$(dockerUsername)" --password-stdin
      
      # Build API image with proper tagging
      docker build \
        --target api \
        -t $(dockerRepository):$(apiTag) \
        -t $(dockerRepository):latest-api \
        -f Dockerfile \
        .
      
      # Push both tags
      docker push $(dockerRepository):$(apiTag)
      docker push $(dockerRepository):latest-api
  env:
    dockerUsername: $(DOCKER_USERNAME)  # Set as pipeline variable
    dockerPassword: $(DOCKER_PASSWORD)  # Set as secret variable

# -----------------------------
# Build and Push WebApp Image using script
# -----------------------------
- task: Bash@3
  displayName: 'Build and Push WebApp Image'
  inputs:
    targetType: 'inline'
    script: |
      # Login to Docker Hub (already logged in, but just in case)
      echo "$(dockerPassword)" | docker login -u "$(dockerUsername)" --password-stdin 2>/dev/null || true
      
      # Build WebApp image with proper tagging
      docker build \
        --target webapp \
        -t $(dockerRepository):$(webappTag) \
        -t $(dockerRepository):latest-webapp \
        -f Dockerfile \
        .
      
      # Push both tags
      docker push $(dockerRepository):$(webappTag)
      docker push $(dockerRepository):latest-webapp
  env:
    dockerUsername: $(DOCKER_USERNAME)
    dockerPassword: $(DOCKER_PASSWORD)