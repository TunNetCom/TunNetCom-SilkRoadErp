trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  solution: '**/*.sln'
  buildConfiguration: 'Release'
  dockerRepository: 'tunnetcom/silkroad'
  apiTag: 'api-$(Build.BuildId)'
  webappTag: 'webapp-$(Build.BuildId)'

steps:
# -----------------------------
# 1. Login to DockerHub
# -----------------------------
- task: Docker@2
  displayName: 'Login to DockerHub'
  inputs:
    command: login
    containerRegistry: 'TunNetCom_Dockerhub_Connection'

# -----------------------------
# 2. Use .NET SDK
# -----------------------------
- task: UseDotNet@2
  displayName: 'Use .NET 10 SDK'
  inputs:
    packageType: 'sdk'
    version: '10.x'

# -----------------------------
# 3. Restore & Build Solution
# -----------------------------
- task: DotNetCoreCLI@2
  displayName: 'Restore'
  inputs:
    command: 'restore'
    projects: '$(solution)'
    arguments: '--verbosity normal'

- task: DotNetCoreCLI@2
  displayName: 'Build'
  inputs:
    command: 'build'
    projects: '$(solution)'
    arguments: '--configuration $(buildConfiguration) --no-restore --verbosity normal'

# -----------------------------
# 4. Build API Docker Image
# -----------------------------
- script: |
    set -e
    echo "Building API Docker image..."
    docker build \
      --progress=plain \
      --target api \
      -t $(dockerRepository):$(apiTag) \
      -t $(dockerRepository):latest-api \
      -f Dockerfile \
      .

    echo "Built API images:"
    docker images | grep $(dockerRepository)
  displayName: 'Build API Docker Image'

# -----------------------------
# 5. Push API Docker Image
# -----------------------------
- script: |
    set -e
    echo "Pushing API Docker image..."
    docker push $(dockerRepository):$(apiTag)
    docker push $(dockerRepository):latest-api
  displayName: 'Push API Docker Image'

# -----------------------------
# 6. Build WebApp Docker Image
# -----------------------------
- script: |
    set -e
    WEBAPP_TAG=$(webappTag)
    echo "Building WebApp Docker image with tag $WEBAPP_TAG..."
    
    # Make sure build artifacts exist
    ls -la ./src/WebApps/TunNetCom.SilkRoadErp.Sales.WebApp/bin/Release/net10/publish || true

    docker build \
      --progress=plain \
      --target webapp \
      -t $(dockerRepository):$WEBAPP_TAG \
      -t $(dockerRepository):latest-webapp \
      -f Dockerfile \
      .

    echo "Built WebApp images:"
    docker images | grep $(dockerRepository)
  displayName: 'Build WebApp Docker Image'

# -----------------------------
# 7. Push WebApp Docker Image
# -----------------------------
- script: |
    set -e
    WEBAPP_TAG=$(webappTag)
    echo "Pushing WebApp Docker image with tag $WEBAPP_TAG..."
    docker push $(dockerRepository):$WEBAPP_TAG
    docker push $(dockerRepository):latest-webapp
  displayName: 'Push WebApp Docker Image'
