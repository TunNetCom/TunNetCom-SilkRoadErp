trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: silkroad-prod
- name: solution
  value: '**/*.sln'
- name: buildConfiguration
  value: 'Release'
- name: dockerRepository
  value: 'tunnetcom/silkroad'
- name: apiTag
  value: 'api-$(Build.BuildId)'
- name: webappTag
  value: 'webapp-$(Build.BuildId)'

stages:
# ============================================================
# 1ï¸âƒ£ BUILD & PUSH STAGE
# ============================================================
- stage: BuildAndPush
  displayName: Build and Push Docker Images
  jobs:
  - job: BuildPushJob
    displayName: Build & Push
    steps:

    # -----------------------------
    # Login to DockerHub
    # -----------------------------
    - task: Docker@2
      displayName: 'Login to DockerHub'
      inputs:
        command: login
        containerRegistry: 'TunNetCom_Dockerhub_Connection'

    # -----------------------------
    # Use .NET SDK
    # -----------------------------
    - task: UseDotNet@2
      displayName: 'Use .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '10.x'

    # -----------------------------
    # Restore & Build
    # -----------------------------
    - task: DotNetCoreCLI@2
      displayName: 'Restore'
      inputs:
        command: 'restore'
        projects: '$(solution)'

    - task: DotNetCoreCLI@2
      displayName: 'Build'
      inputs:
        command: 'build'
        projects: '$(solution)'
        arguments: '--configuration $(buildConfiguration) --no-restore'

    # -----------------------------
    # Build API Docker Image
    # -----------------------------
    - script: |
        set -e
        echo "ðŸ³ Building API Docker image..."
        docker build \
          --no-cache \
          --progress=plain \
          --target api \
          -t $(dockerRepository):$(apiTag) \
          -f Dockerfile \
          .
        echo "âœ… API image built successfully"
        docker images | grep $(dockerRepository) | grep $(apiTag)
      displayName: 'Build API Docker Image'

    # -----------------------------
    # Push API
    # -----------------------------
    - script: |
        set -e
        echo "ðŸ“¤ Pushing API Docker image: $(dockerRepository):$(apiTag)"
        docker push $(dockerRepository):$(apiTag)
        echo "âœ… API image pushed successfully"
      displayName: 'Push API Docker Image'

    # -----------------------------
    # Build WebApp Docker Image
    # -----------------------------
    - script: |
        set -e
        echo "ðŸ³ Building WebApp Docker image..."
        docker build \
          --no-cache \
          --progress=plain \
          --target webapp \
          -t $(dockerRepository):$(webappTag) \
          -f Dockerfile \
          .
        echo "âœ… WebApp image built successfully"
        docker images | grep $(dockerRepository) | grep $(webappTag)
      displayName: 'Build WebApp Docker Image'

    # -----------------------------
    # Push WebApp
    # -----------------------------
    - script: |
        set -e
        echo "ðŸ“¤ Pushing WebApp Docker image: $(dockerRepository):$(webappTag)"
        docker push $(dockerRepository):$(webappTag)
        echo "âœ… WebApp image pushed successfully"
      displayName: 'Push WebApp Docker Image'

# ============================================================
# 2ï¸âƒ£ DEPLOY STAGE TO ON-PREM KUBERNETES
# ============================================================
- stage: Deploy
  displayName: Deploy to On-Prem Kubernetes
  dependsOn: BuildAndPush
  jobs:
  - job: DeployJob
    displayName: Deploy SilkRoad to prod-silkroad
    pool:
      name: OnPremAgents
    steps:

    # 1ï¸âƒ£ Debug folder & files
    - script: |
        cd $(Build.SourcesDirectory)/src/deployments || { echo 'âŒ Deployment folder not found'; exit 1; }
        echo "ðŸ“‚ Current folder: $(pwd)"
        echo "ðŸ“„ Listing YAML files:"
        ls -la
      displayName: 'Debug: list deployment files'

    # 2ï¸âƒ£ Update image tags in YAML
    - script: |
        cd $(Build.SourcesDirectory)/src/deployments
        
        echo "ðŸ”§ Before substitution:"
        echo "=== prod-deployment.yaml ==="
        grep 'image:' prod-deployment.yaml
        
        sed -i "s|API_TAG_PLACEHOLDER|$(apiTag)|g" prod-deployment.yaml
        sed -i "s|WEBAPP_TAG_PLACEHOLDER|$(webappTag)|g" prod-deployment.yaml
        
        echo ""
        echo "âœ… After substitution:"
        echo "=== prod-deployment.yaml ==="
        grep 'image:' prod-deployment.yaml
      displayName: 'Update image tags'

    # 3ï¸âƒ£ Create / Update DB secret
    - script: |
        set -e
        echo "ðŸ” Creating/updating database connection secret..."
        kubectl create secret generic silkroad-connection-secret \
          -n silkroad-prod \
          --from-literal=ConnectionStrings__DefaultConnection="$(CONNECTION_STRING)" \
          --dry-run=client -o yaml | kubectl apply -f -
        echo "âœ… Database secret created/updated"
      displayName: 'Create DB Connection Secret'

    # 4ï¸âƒ£ Apply deployment & force new images (FIXED)
    - script: |
        set -e
        
        echo "ðŸ” Kubernetes cluster info:"
        kubectl version --client
        kubectl cluster-info
        
        echo ""
        echo "ðŸ§¹ Deleting old pods to force fresh image pull..."
        kubectl delete pods -n silkroad-prod -l app=silkroad-api --ignore-not-found=true || true
        kubectl delete pods -n silkroad-prod -l app=silkroad-webapp --ignore-not-found=true || true
        
        echo "â³ Waiting 5 seconds for pods to terminate..."
        sleep 5
        
        echo ""
        echo "ðŸ“‹ Applying deployment manifests..."
        kubectl apply -f prod-deployment.yaml -n silkroad-prod
        kubectl apply -f prod-service.yaml -n silkroad-prod || true
        
        echo ""
        echo "ðŸ” Verifying image references in deployment spec:"
        echo "=== silkroad-api ==="
        kubectl get deployment silkroad-api -n silkroad-prod -o jsonpath='{.spec.template.spec.containers[0].image}' || echo "Not found"
        echo ""
        echo "=== silkroad-webapp ==="
        kubectl get deployment silkroad-webapp -n silkroad-prod -o jsonpath='{.spec.template.spec.containers[0].image}' || echo "Not found"
        echo ""
        
        echo "â³ Waiting for rollout to complete (timeout: 5 minutes)..."
        kubectl rollout status deployment/silkroad-api -n silkroad-prod --timeout=5m || { echo "âš ï¸  silkroad-api rollout status check failed"; }
        kubectl rollout status deployment/silkroad-webapp -n silkroad-prod --timeout=5m || { echo "âš ï¸  silkroad-webapp rollout status check failed"; }
        
        echo ""
        echo "ðŸ“Š Final pod status:"
        kubectl get pods -n silkroad-prod -o wide
        
        echo ""
        echo "ðŸ“Š Current deployment images:"
        kubectl get deployments -n silkroad-prod -o wide
        
        echo ""
        echo "âœ… Deployment process complete!"
      displayName: 'Deploy to Kubernetes'

    # 5ï¸âƒ£ Verify deployment (NEW)
    - script: |
        set -e
        
        echo "ðŸ” Post-deployment verification..."
        echo ""
        
        echo "Checking API pod status:"
        API_POD=$(kubectl get pods -n silkroad-prod -l app=silkroad-api -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "Not found")
        if [ "$API_POD" != "Not found" ]; then
          echo "Pod: $API_POD"
          kubectl describe pod $API_POD -n silkroad-prod | grep -A 5 "Image:"
          kubectl get pod $API_POD -n silkroad-prod -o jsonpath='{.status.containerStatuses[0]}'
        fi
        
        echo ""
        echo "Checking WebApp pod status:"
        WEBAPP_POD=$(kubectl get pods -n silkroad-prod -l app=silkroad-webapp -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "Not found")
        if [ "$WEBAPP_POD" != "Not found" ]; then
          echo "Pod: $WEBAPP_POD"
          kubectl describe pod $WEBAPP_POD -n silkroad-prod | grep -A 5 "Image:"
          kubectl get pod $WEBAPP_POD -n silkroad-prod -o jsonpath='{.status.containerStatuses[0]}'
        fi
        
        echo ""
        echo "Recent events:"
        kubectl get events -n silkroad-prod --sort-by='.lastTimestamp' | tail -10
        
      displayName: 'Verify Deployment'
      continueOnError: true