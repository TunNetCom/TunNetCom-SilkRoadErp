trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: silkroad-prod
- name: solution
  value: '**/*.sln'
- name: buildConfiguration
  value: 'Release'
- name: dockerRepository
  value: 'tunnetcom/silkroad'
- name: apiTag
  value: 'api-$(Build.BuildId)'
- name: webappTag
  value: 'webapp-$(Build.BuildId)'

stages:
# ============================================================
# 1Ô∏è‚É£ BUILD & PUSH STAGE
# ============================================================
- stage: BuildAndPush
  displayName: Build and Push Docker Images
  jobs:
  - job: BuildPushJob
    displayName: Build & Push
    steps:

    # -----------------------------
    # Login to DockerHub
    # -----------------------------
    - task: Docker@2
      displayName: 'Login to DockerHub'
      inputs:
        command: login
        containerRegistry: 'TunNetCom_Dockerhub_Connection'

    # -----------------------------
    # Use .NET SDK
    # -----------------------------
    - task: UseDotNet@2
      displayName: 'Use .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '10.x'

    # -----------------------------
    # Restore & Build
    # -----------------------------
    - task: DotNetCoreCLI@2
      displayName: 'Restore'
      inputs:
        command: 'restore'
        projects: '$(solution)'

    - task: DotNetCoreCLI@2
      displayName: 'Build'
      inputs:
        command: 'build'
        projects: '$(solution)'
        arguments: '--configuration $(buildConfiguration) --no-restore'

    # -----------------------------
    # Build API Docker Image
    # -----------------------------
    - script: |
        set -e
        echo "Building API Docker image..."
        docker build \
          --no-cache \
          --progress=plain \
          --target api \
          -t $(dockerRepository):$(apiTag) \
          -t $(dockerRepository):latest-api \
          -f Dockerfile \
          .
        docker images | grep $(dockerRepository)
      displayName: 'Build API Docker Image'

    # -----------------------------
    # Push API
    # -----------------------------
    - script: |
        set -e
        echo "Pushing API Docker image..."
        docker push $(dockerRepository):$(apiTag)
        docker push $(dockerRepository):latest-api
      displayName: 'Push API Docker Image'

    # -----------------------------
    # Build WebApp Docker Image
    # -----------------------------
    - script: |
        set -e
        echo "Building WebApp Docker image..."
        docker build \
          --no-cache \
          --progress=plain \
          --target webapp \
          -t $(dockerRepository):$(webappTag) \
          -t $(dockerRepository):latest-webapp \
          -f Dockerfile \
          .
        docker images | grep $(dockerRepository)
      displayName: 'Build WebApp Docker Image'

    # -----------------------------
    # Push WebApp
    # -----------------------------
    - script: |
        set -e
        echo "Pushing WebApp Docker image..."
        docker push $(dockerRepository):$(webappTag)
        docker push $(dockerRepository):latest-webapp
      displayName: 'Push WebApp Docker Image'

# ============================================================
# 2Ô∏è‚É£ DEPLOY STAGE TO ON-PREM KUBERNETES
# ============================================================
- stage: Deploy
  displayName: Deploy to On-Prem Kubernetes
  dependsOn: BuildAndPush
  jobs:
  - job: DeployJob
    displayName: Deploy SilkRoad to prod-silkroad
    pool:
      name: OnPremAgents
    steps:

    # 1Ô∏è‚É£ Debug folder & files
    - script: |
        cd $(Build.SourcesDirectory)/src/deployments || { echo '‚ùå Deployment folder not found'; exit 1; }
        echo "üìÇ Current folder: $(pwd)"
        echo "üìÑ Listing YAML files:"
        ls -la
      displayName: 'Debug: list deployment files'

    # 2Ô∏è‚É£ Update image tags in YAML
    - script: |
        cd $(Build.SourcesDirectory)/src/deployments
        sed -i "s|API_TAG_PLACEHOLDER|$(apiTag)|g" prod-deployment.yaml
        sed -i "s|WEBAPP_TAG_PLACEHOLDER|$(webappTag)|g" prod-deployment.yaml
        echo "üßæ Deployment YAML after tag update:"
        grep 'image:' prod-deployment.yaml
      displayName: 'Update image tags'

    # 3Ô∏è‚É£ Create / Update DB secret
    - script: |
        kubectl create secret generic silkroad-connection-secret \
          -n silkroad-prod \
          --from-literal=ConnectionStrings__DefaultConnection="$(CONNECTION_STRING)" \
          --dry-run=client -o yaml | kubectl apply -f -
      displayName: 'Create DB Connection Secret'

    # 4Ô∏è‚É£ Apply deployment & force new images
    - script: |
        kubectl version --client
        kubectl cluster-info

        # Apply updated YAMLs
        kubectl apply -f prod-deployment.yaml -n silkroad-prod
        kubectl apply -f prod-service.yaml -n silkroad-prod || true

        # Force rollout with new images
        kubectl set image deployment/silkroad-api \
          api=$(dockerRepository):$(apiTag) -n silkroad-prod --record
        kubectl set image deployment/silkroad-webapp \
          webapp=$(dockerRepository):$(webappTag) -n silkroad-prod --record

        # Wait for rollout completion
        kubectl rollout status deployment/silkroad-api -n silkroad-prod
        kubectl rollout status deployment/silkroad-webapp -n silkroad-prod

        echo "‚úÖ Successfully deployed SilkRoad to namespace: silkroad-prod"
      displayName: 'Deploy to Kubernetes'
